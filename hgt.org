#+TITLE: Urban Tree Height 
#+AUTHOR: erker
#+email: erker@wisc.edu
#+PROPERTY:  header-args:R :cache no :results output :exports both :comments link :session *R:hgt* :eval yes
#+PROPERTY:  header-args:sh :eval yes
#+startup: indent entitiespretty
#+FILETAGS: work allo
#+HTML_HEAD: <link rel="stylesheet" href="main.css" type="text/css">
#+OPTIONS: toc:nil num:t date:t author:nil
#+LATEX_HEADER: \usepackage[margin=1in]{geometry}
#+LATEX_HEADER: \usepackage{natbib}
##+LATEX_HEADER: \usepackage{chemformula}
#+latex_header: \usepackage{adjustbox}
#+LaTeX_HEADER: \RequirePackage{lineno} \def\linenumberfont{\normalfont\small\tt}
#+LATEX_HEADER: \hypersetup{colorlinks=true,linkcolor=black, citecolor=black, urlcolor=black}
#+latex_header: \usepackage{setspace} \doublespacing
#+LATEX_CLASS_OPTIONS: [12pt]
---------------------

* COMMENT list of figures (for presentation and paper)

check my paper in stat consulting office to make sure I got it all

- raw data
  - lidar
    - lazers from a plane illustration
    - point cloud screen shot or gif
    - height difference from tree CHM.
  - hyperspectral imagery
    - aviris-ng
    - hyperspectral cube
    - leaf spectrum
    - 2015 flightlines over Madison.
    - merged trait maps over all of Madison.
  - tree inventories
    - street trees
      - get figure from poster with the summary statistics
    - hill farms
      - make figure like i have for street trees
    - atwood
      - make figure like i have for street trees
  - show tree points colored by growth
  - summary distributions for height growth by species...
  - growth by explanatory variable plots??
  - model plots???
  

[[file:figs/traits_coef_comparison_nogenus.png]]
[[file:figs/traits_coef_comparison.png]]





* key points

- We 

- Percent impervious cover interacts at multiple scales: Trees with low imperivious cover within 20m and high impervious
  cover within 100m have highest growth rates, all else being equal.

- 



* COMMENT work
** creating normalized lidar and also trying to create point clouds with just trees
*** 2005 lidar
**** create lax
#+begin_src sh 
cd /media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2005/LiDAR_PointClouds_LAS/
/home/erker/Downloads/LAStools/bin/lasindex -i *.las
#+end_src

#+begin_src R
  library(lidR)
  l <- readLAS("/media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2005/LiDAR_PointClouds_LAS/tile014.las")
  plot(l, trim = 1000)
#+end_src


**** which have ground?
#+begin_src R
      library(stringr)
      f <- list.files("/media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2005/LiDAR_PointClouds_LAS/", pattern = ".*.las$", full.names = T)
      lapply(f, function(file) {
          i <- str_match(file, ".*tile([0-9]+).*.las$")[,2]
          l <- readLAS(file)
          n <- sum(l@data$Classification == 2)
          return(c(i, n))
    })
#+end_src

**** find ground
#+begin_src R
    ctg2005 <- catalog("/media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2005/LiDAR_PointClouds_LAS/")
    opt_output_files(ctg2005) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/ground/{ORIGINALFILENAME}_ground"
                                            #lasground(ctg2005, csf())
    ws = seq(6,24,6)
    th = seq(.1, 1.5, length.out = length(ws))

 lasground(ctg2005, pmf(ws, th))

  #  plot(ctg2005, map = T)


#+end_src

**** normalize
#+begin_src R 

  ctg2005ground <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/ground/")
  opt_output_files(ctg2005ground) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/{ORIGINALFILENAME}_normalized"
  lasnormalize(ctg2005ground, tin())

#+end_src

**** make lax for normalized
#+begin_src sh 
cd /media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized
/home/erker/Downloads/LAStools/bin/lasindex -i *.las
#+end_src

**** make normalized chm (this includes buildings, but excludes some points)
#+begin_src R
  library(lidR)
    ctg2005norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized")
    opt_output_files(ctg2005norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/all_chm/{ORIGINALFILENAME}_chm"
    opt_filter(ctg2005norm) <- "-drop_z_above 120 -drop_z_below 6"
    chm <- grid_canopy(ctg2005norm, res = 3, p2r(1))
#+end_src

#+RESULTS:
: Be careful, some tiles seem to overlap each other. lidR may return incorrect outputs with edge artifacts when processing this catalog.
: Processing [>-------------------------------------------]   3% (1/34) eta: 39sError: filename exists; use overwrite=TRUE


#+BEGIN_SRC sh 
cd /media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/all_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" grid_canopy.vrt ../height_norm_2005.tif
#+END_SRC


**** get extents
#+begin_src R

  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/"
        fs <-   list.files(dir,
                   pattern = ".las",
                   full.names = F)

    es <-     lapply(fs, function(f) {
        e <- extent(readLAS(paste0(dir, f), select = "", filter = "-keep_every_nth 100"))
        a <- as(e, "SpatialPolygons")
        a <- SpatialPolygonsDataFrame(a, data.frame(tile = f))
        return(a)
    })

  p <- do.call("rbind", es)
  shapefile(p, "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/lidar_extents.shp")

#+end_src

#+RESULTS:


**** Get tree points
#+begin_src R
  library(lidR)
  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/"

  tile <- "tile014_ground_normalized.las"

  l <- readLAS(paste0(dir, tile), filter = "-drop_z_below 6")
  plot(l, trim = 100)

  e <- new("Extent", xmin = 826616.082997855, xmax = 828596.309091884, 
      ymin = 485978.641378534, ymax = 487311.522306307)

  l2 <- lasclip(l, e)

  writeLAS(l2, "test2005.las")


#+end_src

#+RESULTS:
: Error in rgl::rgl.setMouseCallbacks(button, begin, update, dev = dev,  : 
:   unused arguments (dev = dev, subscene = subscene)


#+begin_src R
  library(lidR)
  pct_x_is<- function(x, is) {
      return(list(pct_x = sum(x == is) / length(x)))
  }

  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/normalized/"

  tiles.w.trees <- list.files(dir, 
                              pattern = ".*.las")


  lapply(tiles.w.trees, function(tile) {

      l <- readLAS(paste0(dir, tile), filter = "-drop_z_below 6")

      proj4string(l) <- "+init=epsg:7599"

      lsp <- lasdetectshape(l, shp_plane(th1 = 4, th2 = 4, k = 9), "building")


      first.return.of.many <- (lsp@data$ReturnNumber == 1) & (lsp@data$NumberOfReturns > 1)
      lsp@data$building[first.return.of.many] <- FALSE

      pm <- point_metrics(lsp, ~pct_x_is(x = building, is = TRUE), k = 5)

      lsp@data$building[pm$pct_x <= .2] <- FALSE
      lsp@data$building[first.return.of.many] <- FALSE
  p
      lf <- lasfilter(lsp, building == FALSE)
      lfl <- lasdetectshape(lf, shp_line(th1 = 5, k = 8), "building")

      pm <- point_metrics(lfl, ~pct_x_is(x = building, is = TRUE), k = 20)

      lfl@data$building[pm$pct_x > .8] <- TRUE
      lfl@data$building[pm$pct_x < .2] <- FALSE
      lf <- lasfilter(lfl, building == FALSE)

      writeLAS(lf, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/trees_lidar/",tile))

  })

#+end_src

**** make lax
#+BEGIN_SRC sh 
cd /media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/trees_lidar
/home/erker/Downloads/LAStools/bin/lasindex -i *.las
#+END_SRC

#+RESULTS:

**** tree chm
#+begin_src R
  library(lidR)
    ctg2005trees <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/trees_lidar")
    opt_output_files(ctg2005trees) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/tree_chm/{ORIGINALFILENAME}_tree_chm"
    chm <- grid_canopy(ctg2005trees, res = 3, p2r(1))
#+end_src

#+RESULTS:
: Be careful, some tiles seem to overlap each other. lidR may return incorrect outputs with edge artifacts when processing this catalog.
: Processing [>-------------------------------------------]   3% (1/34) eta:  2mProcessing [==>-----------------------------------------]   6% (2/34) eta:  2mProcessing [===>----------------------------------------]   9% (3/34) eta:  2mProcessing [====>---------------------------------------]  12% (4/34) eta:  1mProcessing [=====>--------------------------------------]  15% (5/34) eta:  1mProcessing [=======>------------------------------------]  18% (6/34) eta:  1mProcessing [========>-----------------------------------]  21% (7/34) eta:  1mProcessing [=========>----------------------------------]  24% (8/34) eta:  1mProcessing [===========>--------------------------------]  26% (9/34) eta:  1mProcessing [============>------------------------------]  29% (10/34) eta:  1mProcessing [=============>-----------------------------]  32% (11/34) eta: 50sProcessing [==============>----------------------------]  35% (12/34) eta: 46sProcessing [===============>---------------------------]  38% (13/34) eta: 45sProcessing [=================>-------------------------]  41% (14/34) eta: 45sProcessing [==================>------------------------]  44% (15/34) eta: 43sProcessing [===================>-----------------------]  47% (16/34) eta: 42sProcessing [=====================>---------------------]  50% (17/34) eta: 38sProcessing [======================>--------------------]  53% (18/34) eta: 36sProcessing [=======================>-------------------]  56% (19/34) eta: 35sProcessing [========================>------------------]  59% (20/34) eta: 33sProcessing [==========================>----------------]  62% (21/34) eta: 31sProcessing [===========================>---------------]  65% (22/34) eta: 29sProcessing [============================>--------------]  68% (23/34) eta: 27sProcessing [=============================>-------------]  71% (24/34) eta: 25sProcessing [===============================>-----------]  74% (25/34) eta: 22sProcessing [================================>----------]  76% (26/34) eta: 19sProcessing [=================================>---------]  79% (27/34) eta: 17sProcessing [==================================>--------]  82% (28/34) eta: 15sProcessing [====================================>------]  85% (29/34) eta: 13sProcessing [=====================================>-----]  88% (30/34) eta: 10sProcessing [======================================>----]  91% (31/34) eta:  8sProcessing [=======================================>---]  94% (32/34) eta:  5sProcessing [=========================================>-]  97% (33/34) eta:  2sProcessing [===========================================] 100% (34/34) eta:  0s

#+BEGIN_SRC sh :session *a*
cd /media/erker/DATA_ERKER/dd/madison_lidar_2005_heights/tree_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" grid_canopy.vrt ../tree_height_norm_2005.tif
#+END_SRC

*** 2009 lidar

**** get tiles just over the tree inventory
This lidar covers all of dane county.  Only get the tiles that
intersect with the madison tree inventory.

#+name: tiles
#+begin_src R 
    library(raster)
    library(rgeos)
    trees <- shapefile("/media/erker/DATA_ERKER/data/madison_tree_inventories/dd/MadisonTrees_WithAttributes.shp")
  tiles <- shapefile("/media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2009/TileIndex/StudyArea.shp")

  trees <- trees[!is.na(trees@data$DBH),]
  trees <- trees[as.numeric(trees@data$DBH) > 0,]

  trees <- spTransform(trees, crs(tiles))

    o <- over(trees, tiles)
    o <- unique(o)

  tiles <- na.omit(o$LASClass)

#+end_src

#+RESULTS: tiles

#+begin_src R :file tree_tiles_2009.txt
writeLines(tiles)
#+end_src

#+RESULTS:
[[file:tree_tiles_2009.txt]]

**** download tiles from wisconsin view ftp.  The data I had from the townsend lab hard drive had been modified and points dropped.

Download those tiles from ftp

#+BEGIN_SRC sh :session *a*

cd /media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2009/LAS/

while IFS= read -r line;
do
tile=${line}.las
wget ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2010_County_Delivery/Classified_LAS/LAS/$tile
done < ~/git/hgt/tree_tiles_2009.txt

#+END_SRC

make lax
#+BEGIN_SRC sh :session *a*

cd /media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2009/LAS/

/home/erker/Downloads/LAStools/bin/lasindex -i *.las

#+END_SRC

**** normalize
#+begin_src R
        library(lidR)
          ctg2009 <- catalog("/media/erker/DATA_ERKER/data/madison_lidar/madison_lidar_2009/LAS")
          opt_output_files(ctg2009) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/{ORIGINALFILENAME}_normalized"
          lasnormalize(ctg2009, tin())


#+end_src

#+RESULTS:
#+begin_example
Loading required package: raster
Loading required package: sp
lidR 2.1.5 using 4 threads. Help on <gis.stackexchange.com>. Bug report on <github.com/Jean-Romain/lidR>.
Be careful, some tiles seem to overlap each other. lidR may return incorrect outputs with edge artifacts when processing this catalog.
Processing [>-------------------------------------------]   1% (1/87) eta: 30mProcessing [>-------------------------------------------]   2% (2/87) eta: 26mProcessing [=>------------------------------------------]   3% (3/87) eta: 25mProcessing [=>------------------------------------------]   5% (4/87) eta: 39mProcessing [==>-----------------------------------------]   6% (5/87) eta:  1hProcessing [==>-----------------------------------------]   7% (6/87) eta:  1hProcessing [===>----------------------------------------]   8% (7/87) eta:  1hProcessing [===>----------------------------------------]   9% (8/87) eta:  1hProcessing [====>---------------------------------------]  10% (9/87) eta:  1hProcessing [====>--------------------------------------]  11% (10/87) eta:  1hProcessing [====>--------------------------------------]  13% (11/87) eta:  1hProcessing [=====>-------------------------------------]  14% (12/87) eta:  1hProcessing [=====>-------------------------------------]  15% (13/87) eta:  1hProcessing [======>------------------------------------]  16% (14/87) eta:  1hProcessing [======>------------------------------------]  17% (15/87) eta:  1hProcessing [=======>-----------------------------------]  18% (16/87) eta: 50mProcessing [=======>-----------------------------------]  20% (17/87) eta: 47mProcessing [========>----------------------------------]  21% (18/87) eta: 45mProcessing [========>----------------------------------]  22% (19/87) eta: 43mProcessing [=========>---------------------------------]  23% (20/87) eta: 41mProcessing [=========>---------------------------------]  24% (21/87) eta: 39mProcessing [==========>--------------------------------]  25% (22/87) eta: 37mProcessing [==========>--------------------------------]  26% (23/87) eta: 36mProcessing [===========>-------------------------------]  28% (24/87) eta: 34mProcessing [===========>-------------------------------]  29% (25/87) eta: 33mProcessing [============>------------------------------]  30% (26/87) eta: 33mProcessing [============>------------------------------]  31% (27/87) eta:  1hProcessing [=============>-----------------------------]  32% (28/87) eta:  1hProcessing [=============>-----------------------------]  33% (29/87) eta:  2hProcessing [==============>----------------------------]  34% (30/87) eta:  2hProcessing [==============>----------------------------]  36% (31/87) eta:  2hProcessing [===============>---------------------------]  37% (32/87) eta:  2hProcessing [===============>---------------------------]  38% (33/87) eta:  2hProcessing [================>--------------------------]  39% (34/87) eta:  2hProcessing [================>--------------------------]  40% (35/87) eta:  1hProcessing [=================>-------------------------]  41% (36/87) eta:  1hProcessing [=================>-------------------------]  43% (37/87) eta:  1hProcessing [==================>------------------------]  44% (38/87) eta:  1hProcessing [==================>------------------------]  45% (39/87) eta:  1hProcessing [===================>-----------------------]  46% (40/87) eta:  1hProcessing [===================>-----------------------]  47% (41/87) eta:  1hProcessing [====================>----------------------]  48% (42/87) eta:  1hProcessing [====================>----------------------]  49% (43/87) eta:  1hProcessing [=====================>---------------------]  51% (44/87) eta:  1hProcessing [=====================>---------------------]  52% (45/87) eta:  1hProcessing [======================>--------------------]  53% (46/87) eta:  1hProcessing [======================>--------------------]  54% (47/87) eta:  1hProcessing [=======================>-------------------]  55% (48/87) eta:  1hProcessing [=======================>-------------------]  56% (49/87) eta:  1hProcessing [========================>------------------]  57% (50/87) eta:  1hProcessing [=========================>-----------------]  60% (52/87) eta: 49mProcessing [=========================>-----------------]  61% (53/87) eta: 47mProcessing [==========================>----------------]  62% (54/87) eta: 45mProcessing [==========================>----------------]  63% (55/87) eta: 43mProcessing [===========================>---------------]  64% (56/87) eta: 45mProcessing [===========================>---------------]  66% (57/87) eta: 43mProcessing [============================>--------------]  67% (58/87) eta: 41mProcessing [=============================>-------------]  69% (60/87) eta: 37mProcessing [=============================>-------------]  70% (61/87) eta: 35mProcessing [==============================>------------]  71% (62/87) eta: 33mProcessing [==============================>------------]  72% (63/87) eta: 32mProcessing [===============================>-----------]  74% (64/87) eta: 30mProcessing [===============================>-----------]  75% (65/87) eta: 28mProcessing [================================>----------]  76% (66/87) eta: 27mProcessing [================================>----------]  77% (67/87) eta: 25mProcessing [=================================>---------]  78% (68/87) eta: 23mProcessing [=================================>---------]  79% (69/87) eta: 22mProcessing [==================================>--------]  80% (70/87) eta: 20mProcessing [==================================>--------]  82% (71/87) eta: 19mProcessing [===================================>-------]  83% (72/87) eta: 18mProcessing [===================================>-------]  84% (73/87) eta: 17mProcessing [====================================>------]  85% (74/87) eta: 15mProcessing [====================================>------]  86% (75/87) eta: 14mProcessing [=====================================>-----]  87% (76/87) eta: 13mProcessing [=====================================>-----]  89% (77/87) eta: 11mProcessing [======================================>----]  90% (78/87) eta: 10mProcessing [======================================>----]  91% (79/87) eta:  9mProcessing [=======================================>---]  92% (80/87) eta:  8mProcessing [=======================================>---]  93% (81/87) eta:  7mProcessing [========================================>--]  94% (82/87) eta:  5mProcessing [========================================>--]  95% (83/87) eta:  4mProcessing [=========================================>-]  97% (84/87) eta:  3mProcessing [=========================================>-]  98% (85/87) eta:  2mProcessing [==========================================>]  99% (86/87) eta:  1mProcessing [===========================================] 100% (87/87) eta:  0s
class       : LAScatalog
extent      : 773349.2 , 852886.3 , 461220.2 , 520962.4 (xmin, xmax, ymin, ymax)
coord. ref. : NA 
area        : 2518.94 kunits²
points      : 466.78 million points
density     : 0.2 points/units²
num. files  : 87 
There were 50 or more warnings (use warnings() to see the first 50)
#+end_example

**** make lax for normalized
#+begin_src sh :session b
cd /media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized
/home/erker/Downloads/LAStools/bin/lasindex -i *.las
#+end_src


**** make normalized chm (this includes buildings, but excludes some points)
#+begin_src R
  library(lidR)
    ctg2009norm <- catalog("~/hgt_data/madison_lidar_2009_heights/normalized")
    opt_output_files(ctg2009norm) <- "~/hgt_data/madison_lidar_2009_heights/all_chm/{ORIGINALFILENAME}_chm"
    opt_filter(ctg2009norm) <- "-drop_z_above 120 -drop_z_below 6"
    chm <- grid_canopy(ctg2009norm, res = 3, p2r(1))
#+end_src

#+BEGIN_SRC sh
cd ~/hgt_data/madison_lidar_2009_heights/all_chm/
gdalbuildvrt ../height_2009.vrt *.tif
#+END_SRC

#+RESULTS:
: 0...10...20...30...40...50...60...70...80...90...100 - done.

#+BEGIN_SRC sh :session *a*
cd /media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/all_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" grid_canopy.vrt ../height_norm_2009.tif
#+END_SRC

**** pulse density
#+begin_src R
  library(lidR)
    ctg2009norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized")
    opt_output_files(ctg2009norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/grid_density/{ORIGINALFILENAME}_gd"
    opt_filter(ctg2009norm) <- "-drop_z_above 120"
  gd <- grid_density(ctg2009norm, res = 15)
#+end_src

#+RESULTS:
: Be careful, some tiles seem to overlap each other. lidR may return incorrect outputs with edge artifacts when processing this catalog.
: Processing [>-------------------------------------------]   1% (1/87) eta:  6mProcessing [>-------------------------------------------]   2% (2/87) eta:  4mProcessing [=>------------------------------------------]   3% (3/87) eta:  4mProcessing [=>------------------------------------------]   5% (4/87) eta:  7mProcessing [==>-----------------------------------------]   6% (5/87) eta:  9mProcessing [==>-----------------------------------------]   7% (6/87) eta: 10mProcessing [===>----------------------------------------]   8% (7/87) eta: 11mProcessing [===>----------------------------------------]   9% (8/87) eta: 11mProcessing [====>---------------------------------------]  10% (9/87) eta: 11mProcessing [====>--------------------------------------]  11% (10/87) eta: 10mProcessing [====>--------------------------------------]  13% (11/87) eta: 10mProcessing [=====>-------------------------------------]  14% (12/87) eta:  9mProcessing [=====>-------------------------------------]  15% (13/87) eta:  9mProcessing [======>------------------------------------]  16% (14/87) eta:  8mProcessing [======>------------------------------------]  17% (15/87) eta:  8mProcessing [=======>-----------------------------------]  18% (16/87) eta:  8mProcessing [=======>-----------------------------------]  20% (17/87) eta:  7mProcessing [========>----------------------------------]  21% (18/87) eta:  7mProcessing [========>----------------------------------]  22% (19/87) eta:  7mProcessing [=========>---------------------------------]  23% (20/87) eta:  6mProcessing [=========>---------------------------------]  24% (21/87) eta:  6mProcessing [==========>--------------------------------]  25% (22/87) eta:  6mProcessing [==========>--------------------------------]  26% (23/87) eta:  5mProcessing [===========>-------------------------------]  28% (24/87) eta:  5mProcessing [===========>-------------------------------]  29% (25/87) eta:  5mProcessing [============>------------------------------]  30% (26/87) eta:  5mProcessing [============>------------------------------]  31% (27/87) eta:  5mProcessing [=============>-----------------------------]  32% (28/87) eta:  5mProcessing [=============>-----------------------------]  33% (29/87) eta:  4mProcessing [==============>----------------------------]  34% (30/87) eta:  4mProcessing [==============>----------------------------]  36% (31/87) eta:  4mProcessing [===============>---------------------------]  37% (32/87) eta:  4mProcessing [===============>---------------------------]  38% (33/87) eta:  4mProcessing [================>--------------------------]  39% (34/87) eta:  4mProcessing [================>--------------------------]  40% (35/87) eta:  4mProcessing [=================>-------------------------]  41% (36/87) eta:  3mProcessing [=================>-------------------------]  43% (37/87) eta:  3mProcessing [==================>------------------------]  44% (38/87) eta:  3mProcessing [==================>------------------------]  45% (39/87) eta:  3mProcessing [===================>-----------------------]  46% (40/87) eta:  3mProcessing [===================>-----------------------]  47% (41/87) eta:  3mProcessing [====================>----------------------]  48% (42/87) eta:  3mProcessing [====================>----------------------]  49% (43/87) eta:  3mProcessing [=====================>---------------------]  51% (44/87) eta:  3mProcessing [=====================>---------------------]  52% (45/87) eta:  3mProcessing [======================>--------------------]  53% (46/87) eta:  2mProcessing [======================>--------------------]  54% (47/87) eta:  2mProcessing [=======================>-------------------]  55% (48/87) eta:  2mProcessing [=======================>-------------------]  56% (49/87) eta:  2mProcessing [========================>------------------]  57% (50/87) eta:  2mProcessing [=========================>-----------------]  60% (52/87) eta:  2mProcessing [=========================>-----------------]  61% (53/87) eta:  2mProcessing [==========================>----------------]  62% (54/87) eta:  2mProcessing [==========================>----------------]  63% (55/87) eta:  2mProcessing [===========================>---------------]  64% (56/87) eta:  2mProcessing [===========================>---------------]  66% (57/87) eta:  2mProcessing [============================>--------------]  67% (58/87) eta:  2mProcessing [=============================>-------------]  69% (60/87) eta:  1mProcessing [=============================>-------------]  70% (61/87) eta:  1mProcessing [==============================>------------]  71% (62/87) eta:  1mProcessing [==============================>------------]  72% (63/87) eta:  1mProcessing [===============================>-----------]  74% (64/87) eta:  1mProcessing [===============================>-----------]  75% (65/87) eta:  1mProcessing [================================>----------]  76% (66/87) eta:  1mProcessing [================================>----------]  77% (67/87) eta:  1mProcessing [=================================>---------]  78% (68/87) eta:  1mProcessing [=================================>---------]  79% (69/87) eta:  1mProcessing [==================================>--------]  80% (70/87) eta:  1mProcessing [==================================>--------]  82% (71/87) eta:  1mProcessing [===================================>-------]  83% (72/87) eta: 47sProcessing [===================================>-------]  84% (73/87) eta: 43sProcessing [====================================>------]  85% (74/87) eta: 40sProcessing [====================================>------]  86% (75/87) eta: 37sProcessing [=====================================>-----]  87% (76/87) eta: 34sProcessing [=====================================>-----]  89% (77/87) eta: 30sProcessing [======================================>----]  90% (78/87) eta: 27sProcessing [======================================>----]  91% (79/87) eta: 24sProcessing [=======================================>---]  92% (80/87) eta: 21sProcessing [=======================================>---]  93% (81/87) eta: 18sProcessing [========================================>--]  94% (82/87) eta: 15sProcessing [========================================>--]  95% (83/87) eta: 12sProcessing [=========================================>-]  97% (84/87) eta:  9sProcessing [=========================================>-]  98% (85/87) eta:  6sProcessing [==========================================>]  99% (86/87) eta:  3sProcessing [===========================================] 100% (87/87) eta:  0s
: There were 50 or more warnings (use warnings() to see the first 50)

it didn't finish, i'mnot sure why

#+begin_src sh
cd ~/hgt_data/madison_lidar_2017_heights/grid_density/

gdalbuildvrt ../gd_2017.vrt *.tif
#+end_src

#+RESULTS:
: 0...10...20...30...40...50...60...70...80...90...100 - done.

**** get extents to select a downtown tile?
#+begin_src R

  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/"
        fs <-   list.files(dir,
                   pattern = ".las",
                   full.names = F)

    es <-     lapply(fs, function(f) {
        e <- extent(readLAS(paste0(dir, f), select = "", filter = "-keep_every_nth 100"))
        a <- as(e, "SpatialPolygons")
        a <- SpatialPolygonsDataFrame(a, data.frame(tile = f))
        return(a)
    })

  p <- do.call("rbind", es)
  shapefile(p, "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/lidar_extents.shp")


#+end_src

#+RESULTS:
: There were 50 or more warnings (use warnings() to see the first 50)

same area as 2016:
"lc2t71007f_ground_normalized.las"
#+begin_src R

  l <- readLAS("/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/lc2t71007f_ground_normalized.las")
  plot(l)
  #chm <- grid_canopy(l, 3, p2r(1))
  #plot(chm)
  #e <- drawExtent()
  e <- new("Extent", xmin = 827161.463391346, xmax = 828579.428253175, 
      ymin = 486162.738356131, ymax = 487289.679000948)
  l1 <- lasclip(l, e)
  writeLAS(l1, "test2009.las")

#+end_src

#+RESULTS:
: Warning message:
: There are 0 points flagged 'synthetic'.
: Error in rgl::rgl.setMouseCallbacks(button, begin, update, dev = dev,  : 
:   unused arguments (dev = dev, subscene = subscene)

testing
#+begin_src R


      pct_x_is<- function(x, is) {
          return(list(pct_x = sum(x == is) / length(x)))
          }

  #l <- readLAS("test2009.las", filter = "-drop_z_below 6")
  l <- readLAS("test2009.las", filter = "-keep_first -drop_z_below 6 -thin_with_voxel 3")  # thin so that point density is constant?
  proj4string(l) <- "+init=epsg:7599"
  plot(l)

    lsp <- lasdetectshape(l, shp_plane(th1 = 6, th2 = 6, k = 8), "building")
    plot(lsp, color = "building")

    pm <- point_metrics(lsp, ~pct_x_is(x = building, is = TRUE), k = 30)

  lsp@data$pct_x <- pm$pct_x
  plot(lsp, color = "pct_x")

    lsp@data$building[pm$pct_x > .6] <- TRUE
    lsp@data$building[pm$pct_x < .4] <- FALSE

  plot(lsp, color = "building")

    lf <- lasfilter(lsp, building == FALSE)
    lfl <- lasdetectshape(lf, shp_line(th1 = 4, k = 15), "building")

  plot(lfl, color = "building")

    pm <- point_metrics(lfl, ~pct_x_is(x = building, is = TRUE), k = 30)

    lfl@data$building[pm$pct_x > .4] <- TRUE
    lfl@data$building[pm$pct_x < .1] <- FALSE
  lf <- lasfilter(lfl, building == FALSE)
  plot(lf)

#+end_src

extract tree points from the lidar, the variable point density might
make this challenging....
#+begin_src R

    library(lidR)

    pct_x_is<- function(x, is) {
        return(list(pct_x = sum(x == is) / length(x)))
    }

  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/"
  tiles.w.trees <- list.files(dir, pattern = ".*.las")

    lapply(tiles.w.trees, function(tile) {
        l <- readLAS(paste0(dir, tile), filter = "-keep_first -drop_z_below 6 -thin_with_voxel 3")
        proj4string(l) <- "+init=epsg:7599"

        lsp <- lasdetectshape(l, shp_plane(th1 = 6, th2 = 6, k = 8), "building")


        pm <- point_metrics(lsp, ~pct_x_is(x = building, is = TRUE), k = 30)

        lsp@data$building[pm$pct_x > .6] <- TRUE
        lsp@data$building[pm$pct_x < .4] <- FALSE



        lf <- lasfilter(lsp, building == FALSE)
        lfl <- lasdetectshape(lf, shp_line(th1 = 4, k = 15), "building")

        pm <- point_metrics(lfl, ~pct_x_is(x = building, is = TRUE), k = 30)

        lfl@data$building[pm$pct_x > .4] <- TRUE
        lfl@data$building[pm$pct_x < .1] <- FALSE
        lf <- lasfilter(lfl, building == FALSE)

        writeLAS(lf, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/trees_lidar/",tile))

    })


#+end_src

create lax
#+begin_src sh

#+end_src

#+begin_src R
  library(lidR)
    ctg2009trees <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/trees_lidar")
    opt_output_files(ctg2009trees) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/tree_chm/{ORIGINALFILENAME}_tree_chm"
    chm <- grid_canopy(ctg2009trees, res = 3, p2r(1))
#+end_src


#+BEGIN_SRC sh :session *a* :results verbatim
cd /media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/tree_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" grid_canopy.vrt ../tree_height_norm_2009.tif
#+END_SRC

#+RESULTS:
: 
: Input file size is 30105, 30256
: 0ERROR 5: lc2t81009f_ground_normalized_tree_chm.tif, band 1: Access window out of range in RasterIO().  Requested
: (0,0) of size 1773x256 on raster of 1771x1788.












chm, quick and easy algorithm
#+begin_src R
  library(lidR)
  ctg2009norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/")
  opt_output_files(ctg2009norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/chm/{ORIGINALFILENAME}_chm"
  grid_canopy(ctg2009norm, 4, p2r(6)) 
#+end_src

#+BEGIN_SRC sh
cd /media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/

gdalbuildvrt chm2.vrt *chm2.tif

#+END_SRC

#+RESULTS:
: 0...10...20...30...40...50...60...70...80...90...100 - done.



chm, pitless algoright, too slow to be worth running.
#+begin_src R :eval no
  library(lidR)
  ctg2009norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/normalized/")
  opt_output_files(ctg2009norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2009_heights/{ORIGINALFILENAME}_chm_pitfree"
  grid_canopy(ctg2009norm, 4, pitfree(c(0,6,12), c(0,1), subcircle = 6)) 
#+end_src

*** TODO FIX THE RESOLUTION!!!!!!!  2010 lidar derived (NGA)

**** create height tif
There is no raw point cloud available.  It's been "destroyed"
(personal communication with John at the NGA (571 721 2159 or maybe
571 721 7999)

In the meta data it says the point cloud has "sub meter ground sample distance".

date april 9 2010

But there is a raster layer of the dem and the dsm (the elevation of
the ground and the elevation of the stuff above the ground).  I can
take their difference to find the height.



elevation
#+begin_src R
library(raster)
ground <- raster("/home/erker/hgt_data/madison_2010_nga_lidar_derived/US Cities/Madison_20100409/Digital Terrain Model (DTM)/DTM - Not Specified/U_US-Cities_dtm_ns_20191101.1118_6.tif")

  e <- new("Extent", xmin = 827161.463391346, xmax = 828579.428253175, 
      ymin = 486162.738356131, ymax = 487289.679000948)
ge <- crop(ground, e)
#+end_src

#+RESULTS:
: 
: Error in .local(x, y, ...) : extents do not overlap

surface
#+begin_src R
first <- raster("/home/erker/hgt_data/madison_2010_nga_lidar_derived/US Cities/Madison_20100409/Digital Surface Model (DSM)/DSM - First Return/U_US-Cities_dsm_first_return_20191101.1118_5.tif")
#+end_src

#+RESULTS:

#+begin_src R
diff <- first - ground
#+end_src

#+RESULTS:

#+begin_src R
    diff <- projectRaster(diff, crs = CRS("+init=epsg:7599"))
  # convert to feet like all the rest of the layers
  diff <- diff * 3.28084
    writeRaster(diff, "~/hgt_data/madison_lidar_2010_heights/height_2010.tif", overwrite = T)
#+end_src


**** tile chm
#+begin_src R
  library(TileManager)

  h2010 <- raster("~/hgt_data/madison_lidar_2010_heights/height_2010.tif")
  ts <- TileScheme(h2010, dimByDist = 10000, buffer = 20)

  lapply(1:length(ts$buffPolygons), function(i) {
      crop(h2010, ts$buffPolygons[i,], filename = paste0("~/hgt_data/madison_lidar_2010_heights/all_chm/",i,"_chm.tif"))
  })
#+end_src

#+RESULTS:

#+BEGIN_SRC sh
cd ~/hgt_data/madison_lidar_2010_heights/all_chm/

gdalbuildvrt ../height_2010.vrt *.tif

#+END_SRC

#+RESULTS:
: 0...10...20...30...40...50...60...70...80...90...100 - done.

*** 2016 lidar
epsg 7599
**** normalize
#+begin_src R
  library(stringr)
  library(lidR)

      f <- list.files("/media/erker/DATA_ERKER/data/madison_lidar_2016/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Madison_2016_City_Delivery/Classified_LAS/LAS/", 
                    pattern = ".*.las$",
                    full.names = T)

                                      #file 72.las seems to have errors, so I skip it.

  lapply(f[204:231], function(file) {
      i <- str_match(file, "([0-9]+).las$")[,2]
      if (i != "72") {
          l <- readLAS(file)
          if(sum(l@data$Classification == 2) != 0) {                  # if there are some ground points
              ln <- lasnormalize(l, tin())
              writeLAS(ln, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/",i,"_normalized.las"))
          }
      }
  })

#+end_src

**** create lax (las index)

i had to download LAStools and run make in the directory.

#+BEGIN_SRC sh :session a
cd /media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/
/home/erker/Downloads/LAStools/bin/lasindex -i *.las

#+END_SRC

#+RESULTS:

**** make normalized chm (this includes buildings, but excludes some points)
#+begin_src R
  library(lidR)
    ctg2016norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar")
    opt_output_files(ctg2016norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/all_chm/{ORIGINALFILENAME}_chm"
    opt_filter(ctg2016norm) <- "-drop_z_above 120 -drop_z_below 6"
    chm <- grid_canopy(ctg2016norm, res = 3, p2r(1))
#+end_src

#+RESULTS:


#+BEGIN_SRC sh :session *a*
cd /media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/all_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" grid_canopy.vrt ../height_norm_2016.tif
#+END_SRC


**** find the tiles that overlap with the madison tree inventory data
#+begin_src R
  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/"
        fs <-   list.files(dir,
                   pattern = ".las",
                   full.names = F)

    es <-     lapply(fs, function(f) {
        e <- extent(readLAS(paste0(dir, f), select = "", filter = "-keep_every_nth 100"))
        a <- as(e, "SpatialPolygons")
        a <- SpatialPolygonsDataFrame(a, data.frame(tile = f))
        return(a)
    })

  p <- do.call("rbind", es)
                                          #shapefile(p, "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/lidar_extents.shp")


  p <- shapefile("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/lidar_extents.shp")

  proj4string(p) <- "+init=epsg:7599"

  trees <- shapefile("/media/erker/DATA_ERKER/data/madison_tree_inventories/MadisonTrees.shp")
  trees <- spTransform(trees, crs(p))

  o <- over(trees, p)
  o <- unique(o)

  tiles.w.trees <- na.omit(o$tile)

#+end_src

#+RESULTS:

#+begin_src R :results output :file tiles.w.trees.txt
writeLines(tiles.w.trees)

#+end_src

#+RESULTS:
[[file:tiles.w.trees.txt]]

**** extract tree points from the lidar
#+begin_src R
  #   library(devtools)
  #   install_github("Jean-Romain/lidR", ref = "devel")

  tiles.w.trees <- readLines("tiles.w.trees.txt")

     library(lidR)

      pct_x_is<- function(x, is) {
          return(list(pct_x = sum(x == is) / length(x)))
          }

     lapply(tiles.w.trees, function(tile) {
         l <- readLAS(paste0(dir, tile))

         proj4string(l) <- "+init=epsg:7599"

         lsp <- lasdetectshape(l, shp_plane(th1 = 4, th2 = 4, k = 10), "building")

         pm <- point_metrics(lsp, ~pct_x_is(x = building, is = TRUE), k = 50)

         lsp@data$building[pm$pct_x > .6] <- TRUE
         lsp@data$building[pm$pct_x < .4] <- FALSE

         lf <- lasfilter(lsp, building == FALSE)
         lfl <- lasdetectshape(lf, shp_line(th1 = 4, k = 15), "building")

         pm <- point_metrics(lfl, ~pct_x_is(x = building, is = TRUE), k = 30)

         lfl@data$building[pm$pct_x > .4] <- TRUE
         lfl@data$building[pm$pct_x < .1] <- FALSE
         lf <- lasfilter(lfl, building == FALSE)

         writeLAS(lf, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/trees_lidar/",tile))

     })


#+end_src


This worked pretty well, but there are some towers that I missed.
I'll need to filter by height when I read in to make the chm.  Or
maybe do another clean up with point metrics.


#+begin_src R
    library(lidR)

    pct_x_is<- function(x, is) {
        return(list(pct_x = sum(x == is) / length(x)))
    }

    dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/trees_lidar/"

  tiles.w.trees <- readLines("tiles.w.trees.txt")


    lapply(tiles.w.trees, function(tile) {
        l <- readLAS(paste0(dir, tile))

        proj4string(l) <- "+init=epsg:7599"

        lsp <- lasdetectshape(l, shp_line(th1 = 10, k = 5), "line")
        lsp@data$line[lsp@data$Z > 140] <- TRUE
        pm <- point_metrics(lsp, ~pct_x_is(x = line, is = TRUE), k = 10)
        lsp@data$line[pm$pct_x > .5] <- TRUE
        lsp@data$line[pm$pct_x < .3] <- FALSE
        pm <- point_metrics(lsp, ~pct_x_is(x = line, is = TRUE), k = 50)
        lsp@data$line[pm$pct_x > .4] <- TRUE
        lf <- lasfilter(lsp, Z < 140, line == FALSE)

        writeLAS(lf, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/trees_lidar_linefiltered/",tile))

    })


#+end_src

#+RESULTS:


**** Create the tree chm
#+begin_src R
  library(lidR)
    ctg2016trees <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/trees_lidar_linefiltered/")
    opt_output_files(ctg2016trees) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/tree_chm/{ORIGINALFILENAME}_tree_chm"
    chm <- grid_canopy(ctg2016trees, res = 3, p2r(1))
#+end_src

#+RESULTS:


#+BEGIN_SRC sh :session *a*
cd /media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/tree_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" grid_canopy.vrt ../tree_height_norm_2016.tif
#+END_SRC


STOP here until I have a good tree chm for each year.




#+begin_src R
  library(raster)
  chm <- raster("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/tree_chm/102_normalized_tree_chm.tif")

  trees <- shapefile("/media/erker/DATA_ERKER/data/madison_tree_inventories/MadisonTrees.shp")
  trees <- spTransform(trees, crs("+init=epsg:7599"))
  crowns = silva2016(chm, trees, max_cr_factor = .6)()  # crowns may be biased small, but I'm focusing on height, so this is OK for now
  writeRaster(crowns, "test2.tif", overwrite = T)


#+end_src

#+RESULTS:






**** testing finding trees






#+begin_src R

   l <- readLAS("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/102_normalized.las",
                 filter = "-drop_class 9 -drop_z_above 200 -drop_z_below 0")
      chm <- grid_canopy(l, res = 3, p2r(1))
  plot(chm)
  #e <- drawExtent()

  e <- new("Extent", xmin = 826616.082997855, xmax = 828596.309091884, 
      ymin = 485978.641378534, ymax = 487311.522306307)

  l2 <- lasclip(l, e)

  writeLAS(l2, "test2016.las")

#+end_src

#+RESULTS:



possible plan, 

- get only those points that are certainly tree
- add back in points that are near the certainly tree points.



I need a rule that if a point is within 1m of something I know for
sure is a building, to call it a building.


try voxel
#+begin_src R
  #install_github("Jean-Romain/lidR", ref = "devel")
  library(lidR) 
  library(devtools)

  pct_x_is<- function(x, is) {
      return(list(pct_x = sum(x == is) / length(x)))
      }

  # point_metrics https://github.com/Jean-Romain/lidR/issues/276
  l <- readLAS("test2016.las", filter = "-drop_z_below 6 -keep_first")
  plot(l)
  lsp <- lasdetectshape(l, shp_plane(th1 = 4, th2 = 4, k = 10), "building")
  plot(lsp, color = "building", col = c("green", "red"))
  lsl <- lasdetectshape(l, shp_line(th1 = 2, k = 17), "building")
  plot(lsl, color = "building", col = c("green", "red"))

  l <- lasadddata(l, (lsp@data$building == T) | (lsl@data$building == T), "building")


  pm <- point_metrics(l, ~pct_x_is(x = building, is = TRUE), k = 20)

  l <- lasadddata(l, pm$pct_x, "pct_x")
  plot(l, color = "pct_x", trim = 1)
  l@data$building[pm$pct_x > .9] <- TRUE
  l@data$building[pm$pct_x < .4] <- FALSE
  plot(l, color = "building", col = c("green", "red"))


  pm <- point_metrics(lsp, ~pct_x_is(x = building, is = TRUE), k = 50)
  lsp@data$building[pm$pct_x > .6] <- TRUE
  lsp@data$building[pm$pct_x < .4] <- FALSE
  plot(lsp, color = "building", col = c("green", "red"))



  # try to get powerlines and tower
  lf <- lasfilter(lsp, building == FALSE)
  lfl <- lasdetectshape(lf, shp_line(th1 = 4, k = 15), "building")   #lfl <- lasdetectshape(lf, shp_line(th1 = 4, k = 15), "building")  
  plot(lfl, color = "building")
  pm <- point_metrics(lfl, ~pct_x_is(x = building, is = TRUE), k = 30)
  lfl <- lasadddata(lfl, pm$pct_x, "pct_x")
  plot(lfl, color = "pct_x", trim = 1)

  lfl@data$building[pm$pct_x > .4] <- TRUE
  lfl@data$building[pm$pct_x < .1] <- FALSE
  plot(lfl, color = "building", col = c("green", "red"))

#+end_src

***** point cloud viewer backedn
#+begin_src R
  l <- readLAS("test2016.las", filter = "-drop_z_below 6 -keep_first")
  plot(l, backend = "pcv")

#+end_src

***** CHM for just trees
#+begin_src R
  library(lidR)
    ctg2016norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar")
    opt_output_files(ctg2016norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/tree_chm/{ORIGINALFILENAME}_tree_chm"
    opt_filter(ctg2016norm) <- "-keep_class 2 -drop_z_above 200 -drop_z_below 0"
    chm <- grid_canopy(ctg2016norm, res = 3, p2r(1))
#+end_src




#+begin_src R

  f2 <- list.files("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/", ".*_normalized.las")

      lapply(f2, function(file) {
            i <- str_match(file, "([0-9]+).*.las$")[,2]
            l <- readLAS(file)
          if(sum(l@data$Classification == 2) != 0) {                  # if there are some ground points
            chm <- grid_canopy(l, res = 3, p2r(1))
            proj4string(chm) <- "+init=epsg:7599"
            writeRaster(chm, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/",i,"_.tif"), overwrite = T)
          }
      })



  ctg <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/")
  opt_output_files(ctg) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/pitfree/{ORIGINALFILENAME}"
  chm.ctg <- grid_canopy(ctg, 3, pitfree(c(0,6,15,30,45), c(0,1), subcircle = 1.5))


      lapply(f2[44:length(f2)], function(file) {
            i <- str_match(file, "([0-9]+).*.las$")[,2]
            l <- readLAS(file)
          if(sum(l@data$Classification == 2) != 0) {                  # if there are some ground points
            chm <- grid_canopy(l, 3, pitfree(c(0,6,15,30,45), c(0,1), subcircle = 1.5))
            proj4string(chm) <- "+init=epsg:7599"
            writeRaster(chm, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/",i,"_pitfree.tif"), overwrite = T)
          }
      })

  f3 <- list.files("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/", ".*_pitfree.tif")


#+end_src

#+RESULTS:

#+BEGIN_SRC sh

cd /media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/

gdalbuildvrt height_.vrt *_.tif
gdalbuildvrt height_pitfree.vrt *_pitfree.tif

#+END_SRC

#+RESULTS:
| 0...10...20...30...40...50...60...70...80...90...100 | 0 | done. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0 | done. |



segment trees
#+begin_src R
      library(lidR)
        i <- 205

      f <- paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/",i,"_.tif")
      chm <- raster(f)


  fl <- paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/",i,"_normalized.las")
  l <- readLAS(fl, filter = "-drop_z_below 0")
  proj4string(l) <- "+init=epsg:7599"
  chm <- grid_canopy(l, res = 1, pitfree(c(0,6,15,30,45), c(0,1), subcircle = 1.5))

  chme <- crop(chm, e)
  writeRaster(chme, "test.tif", overwrite = T)






  library(raster)
  chm <- raster("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/101_pitfree.tif")

  ttops <- tree_detection(chme, lmf(ws = function(h){h+3}, hmin = 6, shape = "circular"))
  crowns = silva2016(chme, ttops)()
  writeRaster(crowns, "test2.tif", overwrite = T)



  trees <- shapefile("/media/erker/DATA_ERKER/data/madison_tree_inventories/MadisonTrees.shp")
  trees <- spTransform(trees, crs("+init=epsg:7599"))


    ttops = tree_detection(l, lmf(100, hmin = 6, shape = "circular"))
    plot(chm)
    plot(ttops, add = T)


  ttops <- tree_detection(
  crowns = silva2016(chme, ttops)()
  writeRaster(crowns, "test2.tif", overwrite = T)
#+end_src

#+RESULTS:
: Local maximum filter: 79%Local maximum filter: 80%Local maximum filter: 81%Local maximum filter: 82%Local maximum filter: 83%Local maximum filter: 84%Local maximum filter: 85%Local maximum filter: 86%Local maximum filter: 87%Local maximum filter: 88%Local maximum filter: 89%Local maximum filter: 90%Local maximum filter: 91%Local maximum filter: 92%Local maximum filter: 93%Local maximum filter: 94%Local maximum filter: 95%Local maximum filter: 96%Local maximum filter: 97%Local maximum filter: 98%Local maximum filter: 99%Local maximum filter: 100%> > > > > > > > > > > > > > > > > > > > > Local maximum filter: 1%Local maximum filter: 2%Local maximum filter: 3%Local maximum filter: 4%Local maximum filter: 5%Local maximum filter: 6%Local maximum filter: 7%Local maximum filter: 8%Local maximum filter: 9%Local maximum filter: 10%Local maximum filter: 11%Local maximum filter: 12%Local maximum filter: 13%Local maximum filter: 14%Local maximum filter: 15%Local maximum filter: 16%Local maximum filter: 17%Local maximum filter: 18%Local maximum filter: 19%Local maximum filter: 20%Local maximum filter: 21%Local maximum filter: 22%Local maximum filter: 23%Local maximum filter: 24%Local maximum filter: 25%Local maximum filter: 26%Local maximum filter: 27%Local maximum filter: 28%Local maximum filter: 29%Local maximum filter: 30%71316 points below 0 found.
: Local maximum filter: 31%Processing [=================================>---------]  79% (27/34) eta:  8mLocal maximum filter: 32%Local maximum filter: 33%Local maximum filter: 34%Local maximum filter: 35%Local maximum filter: 36%Local maximum filter: 37%Local maximum filter: 38%Local maximum filter: 39%Local maximum filter: 40%Local maximum filter: 41%Local maximum filter: 42%Local maximum filter: 43%Local maximum filter: 44%Local maximum filter: 45%Local maximum filter: 46%Local maximum filter: 47%Local maximum filter: 48%Local maximum filter: 49%Local maximum filter: 50%Local maximum filter: 51%Local maximum filter: 52%Local maximum filter: 53%Local maximum filter: 54%Local maximum filter: 55%Local maximum filter: 56%Local maximum filter: 57%Local maximum filter: 58%Local maximum filter: 59%Local maximum filter: 60%Local maximum filter: 61%Local maximum filter: 62%Local maximum filter: 63%Local maximum filter: 64%Local maximum filter: 65%Local maximum filter: 66%Local maximum filter: 67%Local maximum filter: 68%Local maximum filter: 69%Local maximum filter: 70%Local maximum filter: 71%Local maximum filter: 72%Local maximum filter: 73%Local maximum filter: 74%Local maximum filter: 75%Local maximum filter: 76%Local maximum filter: 77%Local maximum filter: 78%Local maximum filter: 79%Local maximum filter: 80%Local maximum filter: 81%Local maximum filter: 82%Local maximum filter: 83%Local maximum filter: 84%Local maximum filter: 85%Local maximum filter: 86%Local maximum filter: 87%Local maximum filter: 88%Local maximum filter: 89%Local maximum filter: 90%Local maximum filter: 91%Local maximum filter: 92%Local maximum filter: 93%Local maximum filter: 94%Local maximum filter: 95%Local maximum filter: 96%Local maximum filter: 97%Local maximum filter: 98%Local maximum filter: 99%Local maximum filter: 100%> > > > > + + Error: unexpected symbol in:
: "crowns = silva2016(chme, ttops)()
: writeRaster"









#+begin_src R
  library(lidR)
  ctg <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/")

i <- 205

  fl <- paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/",i,"_normalized.las")
  fh <- 
  l <- readLAS(f) #should specify only spatial coordinates

  l <- lastrees(l, li2012())

#+end_src

#+RESULTS:
: 1924 points below 0 found.

***** old stuff




CHM for multiple returns (approximately trees)
#+begin_src R
  library(lidR)
    ctg2016norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar")
    opt_output_files(ctg2016norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/multiple_chm/{ORIGINALFILENAME}_tree_chm"
    opt_filter(ctg2016norm) <- "-drop_single -drop_z_above 200 -drop_z_below 0"
    chm <- grid_canopy(ctg2016norm, res = 3, p2r(1))
#+end_src

#+RESULTS:


the multiple return approach also included building edges.  I need to find a way to just get tree points
#+begin_src R
      ctg2016norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar")
      opt_output_files(ctg2016norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/tree_las/{ORIGINALFILENAME}_tree_chm"
      opt_filter(ctg2016norm) <- "-drop_z_above 200 -drop_z_below 0"

  dir <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar/"
    files <- list.files(dir, pattern = ".*.las$",
                        full.names = F)

    lapply(files, function(f) {
        l <- readLAS(paste0(dir,f))
        ls <- lasdetectshape(l, shp_line(th1 = 10, k = 5), "Colinear")
        lsp <- lasdetectshape(ls, shp_plane(th1 = 4, th2 = 4, k = 11), "Coplanar")
        lsp@data[(!lsp@data$Coplanar) & (!lsp@data$Colinear) & (lsp@data$ReturnNumber == 1) & (lsp@data$NumberOfReturns > 1) & (lsp@data$Intensity < 100)]$Classification <- 5L
        writeLAS(lsp, paste0("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar_wtree/",f))
  })



#+end_src

#+RESULTS:

#+begin_src R
  library(lidR)
    ctg2016norm <- catalog("/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/normalized_lidar_wtree")
    opt_output_files(ctg2016norm) <- "/media/erker/DATA_ERKER/dd/madison_lidar_2016_heights/tree_chm/{ORIGINALFILENAME}_chm"
    opt_filter(ctg2016norm) <- "-drop_single -drop_z_above 200 -drop_z_below 0 -keep_class 5"
    chm <- grid_canopy(ctg2016norm, res = 3, p2r(1))
#+end_src

#+RESULTS:














*** 2017 lidar

**** get metadata and reports
#+BEGIN_SRC sh :session a
cd ~/hgt_data/dane_lidar_2017/
wget -r ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Metadata/
wget -r ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Reports/
#+END_SRC
**** download which tiles intersect with tree
download tiles
#+BEGIN_SRC sh
cd /home/erker/hgt_data/dane_lidar_2017/
wget -r ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Tile_Index/
#+END_SRC

find tiles that intersect
#+begin_src R
  library(raster)
  tiles <- shapefile("/home/erker/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Tile_Index/DaneCo_WI_Tile_Index.shp")

  trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")

  trees <- spTransform(trees, crs(tiles))

  tree.tiles <- over(trees, tiles)

  tree.tiles.u <- unique(tree.tiles)

#+end_src

save out to file
#+begin_src R :file tree_tiles_2017.txt
  writeLines(tree.tiles.u$Name_Final)
#+end_src

#+RESULTS:
[[file:tree_tiles_2017.txt]]

Download those tiles from ftp

DOES USGS EVEN WORK? RIGHT HEADER????

do esri instead

actually it just might have been one of the tiles.  I may have to
manually fix the header.....

#+BEGIN_SRC sh :session *a*

cd ~/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/

while IFS= read -r line;
do
tile=${line}_esri.las
wget ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/$tile
done < ~/git/hgt/tree_tiles_2017.txt

#+END_SRC

redoing troublesome tiles
#+BEGIN_SRC sh :session *a*
cd ~/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/
#wget ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/0817_esri.las
wget ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/0671_esri.las
wget ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/0724_esri.las
wget ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/1121_esri.las
#+END_SRC






#+begin_src R
library(lidR)
l <- readLAS("/home/erker/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/0673_esri.las")
#plot(l, trim = 900)
plot(l, color = "Classification")
#+end_src

#+RESULTS:

**** think about checking out their raster dems
#+BEGIN_SRC sh
ftp://ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Raster_DEM_Tiles/
#+END_SRC

**** normlalize the lidar

#+BEGIN_SRC sh

#+END_SRC

#+begin_src R
library(lidR)
#l <- readLAS("/Users/erker/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/USGS/0523_usgs.las")
l <- readLAS("/Users/erker/Downloads/0523_esri.las")
#+end_src

#+RESULTS:

Reclassify water as ground so that normalization is faster.....
#+begin_src R
  dir <- "~/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Classified_LAS/ESRI/"
      fs <- list.files(dir,
                       full.names = F,
                       pattern = ".las$")

  out.dir <- "~/hgt_data/dane_lidar_2017/water_ground/"

    lapply(fs, function(f) {
      l <- readLAS(paste0(dir,f))
      l@data$Classification[l@data$Classification == 9] <- 2L
      writeLAS(l, paste0(out.dir, f))
    })

#+end_src

#+begin_src R
  library(lidR)
  ctg2017 <- catalog("~/hgt_data/dane_lidar_2017/water_ground/")
  opt_output_files(ctg2017) <- "~/hgt_data/dane_lidar_2017/normalized/{ORIGINALFILENAME}_normalized"
  lasnormalize(ctg2017, tin())
#+end_src

#+begin_src R :session *R:hggt2:
library(lidR)
l <- readLAS("/home/erker/hgt_data/dane_lidar_2017/normalized/0869_esri_normalized.las")
plot(l)
#+end_src

#+RESULTS:

**** make lax for normalized
#+begin_src sh :session b
cd /home/erker/hgt_data/dane_lidar_2017/normalized/
/home/erker/LAStools/bin/lasindex -i *.las
#+end_src

**** make normalized chm (this includes buildings, but excludes some points)
#+begin_src R
  library(lidR)
  l <- readLAS("/home/erker/hgt_data/dane_lidar_2017/normalized_notdone/1065_esri_normalized.las",
               filter = "-drop_z_above 120 -drop_z_below 6")
  plot(l)
#+end_src

#+RESULTS:
: Loading required package: raster
: Loading required package: sp
: lidR 2.2.0 using 4 threads. Help on <gis.stackexchange.com>. Bug report on <github.com/Jean-Romain/lidR>.


#+begin_src R
  library(lidR)
  library(stringr)
  dir <- "~/hgt_data/dane_lidar_2017/normalized_notdone/"
      fs <- list.files(dir,
                       full.names = F,
                       pattern = ".las$")

  out.dir <- "~/hgt_data/madison_lidar_2017_heights/all_chm/"

  lapply(fs, function(f) {
      bn <- basename(f)
      bn <- str_sub(bn, 1, -5)
      l <- readLAS(paste0(dir,f), filter = "-drop_z_above 120 -drop_z_below 6")
      chm <- grid_canopy(l, res = 3, p2r(1))
      writeRaster(chm, paste0(out.dir, bn, "_chm.tif"), overwrite = T)
  })

#+end_src

this isn't working well.  But I don't know why?  They run really fast
as singletons.  try just lapply through all the files
#+begin_src R :eval no
  library(lidR)
    ctg2017norm <- catalog("~/hgt_data/dane_lidar_2017/normalized_notdone")
    opt_output_files(ctg2017norm) <- "~/hgt_data/madison_lidar_2017_heights/all_chm/{ORIGINALFILENAME}_chm"
    opt_filter(ctg2017norm) <- "-drop_z_above 120 -drop_z_below 6"
    chm <- grid_canopy(ctg2017norm, res = 3, p2r(1))
#+end_src

#+RESULTS:
: Loading required package: raster
: Loading required package: sp
: lidR 2.2.0 using 4 threads. Help on <gis.stackexchange.com>. Bug report on <github.com/Jean-Romain/lidR>.
: 
:   |                                                                              |                                                                      |   0%  |                                                                              |=                                                                     |   1%Error: filename exists; use overwrite=TRUE

#+begin_src sh
cd ~/hgt_data/madison_lidar_2017_heights/all_chm/

gdalbuildvrt height_2017.vrt *.tif
#+end_src

#+RESULTS:
: 0...10...20...30...40...50...60...70...80...90...100 - done.


#+begin_src sh
cd ~/hgt_data/madison_lidar_2017_heights/all_chm/
gdal_translate -of GTiff -co "TILED=YES" -co "COMPRESS=LZW" -a_srs EPSG:7599 height_2017.vrt ../height_2017.tif
#+end_src

#+RESULTS:
|                                                Input | file | size  | is | 16623, | 8264 |
| 0...10...20...30...40...50...60...70...80...90...100 |    0 | done. |    |        |      |

**** get the pulse density 
#+begin_src R
  library(lidR)
    ctg2017norm <- catalog("~/hgt_data/madison_lidar_2017_heights/normalized")
    opt_output_files(ctg2017norm) <- "~/hgt_data/madison_lidar_2017_heights/grid_density/{ORIGINALFILENAME}_gd"
    opt_filter(ctg2017norm) <- "-drop_z_above 120 -drop_z_below 6 -keep_first"
  gd <- grid_density(ctg2017norm, res = 15)
#+end_src

it didn't finish, i'mnot sure why

#+begin_src sh
cd ~/hgt_data/madison_lidar_2017_heights/grid_density/

gdalbuildvrt ../gd_2017.vrt *.tif
#+end_src

#+RESULTS:
: 0...10...20...30...40...50...60...70...80...90...100 - done.

**** get lidar extents
#+begin_src R

  dir <- "~/hgt_data/madison_lidar_2017_heights/normalized/"
        fs <-   list.files(dir,
                   pattern = ".las",
                   full.names = F)

    es <-     lapply(fs, function(f) {
        e <- extent(readLAS(paste0(dir, f), select = "", filter = "-keep_every_nth 100"))
        a <- as(e, "SpatialPolygons")
        a <- SpatialPolygonsDataFrame(a, data.frame(tile = f))
        return(a)
    })

  p <- do.call("rbind", es)
  shapefile(p, "~/hgt_data/madison_lidar_2017_heights/normalized/lidar_extents.shp")

#+end_src

#+RESULTS:
: 
: Error in rgdal::writeOGR(x, filename, layer, driver = "ESRI Shapefile",  : 
:   Layer creation failed

** make tree buffer shapefile, excluding neighbors that are too close with a lower DBH.  Note: trees with no dbh are dropped.
#+begin_src R
   library(raster)
   library(rgeos)
   library(dplyr)

   trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")
   trees <- spTransform(trees, crs("+init=epsg:7599"))


   genera.to.filter <- dimnames(sort(table(trees@data$Genus), decreasing = T))[[1]][1:42]

   genera.to.filter <- genera.to.filter[!genera.to.filter %in% c("Stump", "Vacant", "Unkown")]

   trees <- trees[trees@data$Genus %in% genera.to.filter,]

   trees <- trees[as.numeric(trees@data$DBH) > 0,]
   trees <- trees[as.numeric(trees@data$DBH) < 200,]


   trees@data <-   select(trees@data, UID, DBH, Genus, Species)

   p <- gBuffer(trees, width = 8, byid = T)
   pa <- aggregate(p)
   pd <- disaggregate(pa)

   o <- over(pd, trees, returnList = T)

   uids <- lapply(o, function(e) {
       set.seed(1)
       sample(e$UID[e$DBH == max(as.numeric(e$DBH), na.rm = T)], 1) # randomly select 1 of many
   })

   po <- p[p@data$UID %in% unlist(uids),]

   po@data$DBH <- as.numeric(po@data$DBH)

   shapefile(po, "/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp", overwrite = T)

 #+end_src

** extract lidar clouds within tree buffers  Note: since I have tree points, I"m going to sample from the entire lidar point cloud

I extract points at each tree from the tree point filtered point clouds, save in
"tree _ year _ treelas".  Extract points at each tree from the
normalized point cloud.

I think that the benefit of having all the points is greater than the
penalty of potentially including some non-tree points.  But I haven't
really tested this.

*** 2017
 #+begin_src R
   library(doParallel)
   library(foreach)
   library(lidR)
   library(dplyr)
   library(stringr)
   library(rgeos)

   b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
   b <- spTransform(b, crs("+init=epsg:7599"))
   b@data <- select(b@data, UID)

   fl <- list.files("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/",
                    pattern = ".*.las",
                    full.names = T)


   # crop the polygons so that a huge object doesn't need to be sent to each node
   tiles.w.trees.i <- unlist(lapply(str_extract_all(fl, "[0-9]{4}"), function(x) x[2]))

   tiles <- shapefile("/home/erker/hgt_data/dane_lidar_2017/ftp.ssec.wisc.edu/pub/wisconsinview/lidar/Dane/Dane_2017_3DEP_Delivery/Tile_Index/DaneCo_WI_Tile_Index.shp")
   tiles <- spTransform(tiles, crs(b))

   tiles.w.trees <- tiles[tiles@data$Name_Final %in% tiles.w.trees.i,]

   lapply(tiles.w.trees.i, function(i) {
       bo <- crop(b, tiles.w.trees[tiles.w.trees@data$Name_Final == i,])
                                           # rather than crop I should just get the tree buffers that are fully within the tile, so that no buffers are cropped to less than a circle.

       if(!is.null(bo)) {    # some will be null because we lost trees with no dbh
           shapefile(bo, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2017cropped/",i,".shp"), overwrite = T)
       }
   })

   rm(b)

   cl <- makeCluster(7)
   registerDoParallel(cl)
   out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
       l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
       i <- str_extract(str_extract(f, "[0-9]{4}_esri_norm"), "[0-9]{4}")
       bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2017cropped/",i,".shp"))
       lapply((1:length(bc)), function(j) {
           if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
               lc <- lasclip(l, bc[j,])
               if(nrow(lc@data) > 0) {
                   writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2017_las/",bc[j,]$UID,"_",i,".las"))
               }
           }
       })
   }
   closeAllConnections()

 #+end_src
*** 2016
 #+begin_src R
   library(doParallel)
   library(foreach)
   library(lidR)
   library(dplyr)
   library(stringr)

#+end_src

#+RESULTS:

#+begin_src R
   b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
   b <- spTransform(b, crs("+init=epsg:7599"))
   b@data <- select(b@data, UID)

   fl <- list.files("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar",
                    pattern = ".*.las",
                    full.names = T)


   # crop the polygons so that a huge object doesn't need to be sent to each node
   cl <- makeCluster(4)
   registerDoParallel(cl)
   out <- foreach(f = fl, .packages = c("stringr","lidR")) %dopar% {
       l <- readLAS(f)
       proj4string(l) <- "+init=epsg:7599"
       bc <- crop(b, extent(l))
       i <- str_extract(f, "[0-9]+_norm")
       shapefile(bc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2016cropped/",i,".shp"))
   }

   closeAllConnections()

   rm(b)
#+end_src

#+begin_src R
   fl <- list.files("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar",
                    pattern = ".*.las",
                    full.names = T)

   cl <- makeCluster(4)
   registerDoParallel(cl)
   out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
       l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
       i <- str_extract(f, "[0-9]+_norm")
       bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2016cropped/",i,".shp"))
       lapply(seq(length(bc)), function(j) {
           if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
               lc <- lasclip(l, bc[j,])
               if(nrow(lc@data) > 0) {
                   writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2016_normlas/",bc[j,]$UID,"_",i,".las"))
               }
           }
       })
   }
   closeAllConnections()

 #+end_src

#+begin_src R
   fl <- list.files("/home/erker/hgt_data/madison_lidar_2016_heights/trees_lidar_linefiltered",
                    pattern = ".*.las",
                    full.names = T)

   cl <- makeCluster(4)
   registerDoParallel(cl)
   out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
       l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
       i <- str_extract(f, "[0-9]+_norm")
       bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2016cropped/",i,".shp"))
       lapply(seq(length(bc)), function(j) {
           if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
               lc <- lasclip(l, bc[j,])
               if(nrow(lc@data) > 0) {
                   writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2016_treelas/",bc[j,]$UID,"_",i,".las"))
               }
           }
       })
   }
   closeAllConnections()

 #+end_src
*** 2009
#+begin_src R
  library(doParallel)
  library(foreach)
  library(lidR)
  library(dplyr)
  library(stringr)

#+end_src

#+RESULTS:

#+begin_src R
  b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
  b <- spTransform(b, crs("+init=epsg:7599"))
  b@data <- select(b@data, UID)

  fl <- list.files("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/",
                   pattern = ".*.las",
                   full.names = T)


  # crop the polygons so that a huge object doesn't need to be sent to each node
  cl <- makeCluster(4)
  registerDoParallel(cl)
  out <- foreach(f = fl, .packages = c("stringr","lidR")) %dopar% {
      l <- readLAS(f)
      proj4string(l) <- "+init=epsg:7599"
      bc <- crop(b, extent(l))
      if(!is.null(bc)) {
          i <- str_extract(f, "lc2t[0-9]+")
          shapefile(bc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2009cropped/",i,".shp"), overwrite = T)
      }
  }
  closeAllConnections()

  rm(b)

#+end_src

#+begin_src R

  fl <- list.files("/home/erker/hgt_data/madison_lidar_2009_heights/normalized",
                   pattern = ".*.las",
                   full.names = T)

  cl <- makeCluster(4)
  registerDoParallel(cl)
  out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
      l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
      i <- str_extract(f, "lc2t[0-9]+")
      bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2009cropped/",i,".shp"))
      lapply(seq(length(bc)), function(j) {
          if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
              lc <- lasclip(l, bc[j,])
              if(nrow(lc@data) > 0) {
                  writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_normlas/",bc[j,]$UID,"_",i,".las"))
              }
          }
      })
  }
  closeAllConnections()

 #+end_src

TREES  I need to rerun the code to separate trees from the
renormalized data.  Do not run this code becuase "tree_lidar" is empty
and needs to get filled with just tree lidar point clouds.
#+begin_src R
   fl <- list.files("/home/erker/hgt_data/madison_lidar_2009_heights/trees_lidar"
                    pattern = ".*.las",
                    full.names = T)

   cl <- makeCluster(4)
   registerDoParallel(cl)
   out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
       l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
       i <- str_extract(f, "[0-9]+_norm")
       bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2009cropped/",i,".shp"))
       lapply(seq(length(bc)), function(j) {
           if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
               lc <- lasclip(l, bc[j,])
               if(nrow(lc@data) > 0) {
                   writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_treelas/",bc[j,]$UID,"_",i,".las"))
               }
           }
       })
   }
   closeAllConnections()

 #+end_src

*** 2005
 #+begin_src R
      library(doParallel)
      library(foreach)
      library(lidR)
      library(dplyr)
      library(stringr)
#+end_src

#+begin_src R
      b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
      b <- spTransform(b, crs("+init=epsg:7599"))
      b@data <- select(b@data, UID)

      fl <- list.files("/home/erker/hgt_data/madison_lidar_2005_heights/trees_lidar",
                       pattern = ".*.las",
                       full.names = T)


      # crop the polygons so that a huge object doesn't need to be sent to each node
      cl <- makeCluster(4)
      registerDoParallel(cl)
      out <- foreach(f = fl, .packages = c("stringr","lidR")) %dopar% {
          l <- readLAS(f)
          proj4string(l) <- "+init=epsg:7599"
          bc <- crop(b, extent(l))
          if(!is.null(bc)) {
              i <- str_extract(f, "tile[0-9]+")
              shapefile(bc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2005cropped/",i,".shp"), overwrite = T)
          }
      }
      closeAllConnections()

      rm(b)
#+end_src

#+begin_src R
      fl <- list.files("/home/erker/hgt_data/madison_lidar_2005_heights/trees_lidar",
                       pattern = ".*.las",
                       full.names = T)

      cl <- makeCluster(4)
      registerDoParallel(cl)
      out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
          l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
          i <- str_extract(f, "tile[0-9]+")
   #if(file.exists(....THE SHAPEFILE)... {
          bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2005cropped/",i,".shp"))
          lapply(seq(length(bc)), function(j) {
              if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
                  lc <- lasclip(l, bc[j,])
                  if(nrow(lc@data) > 0) {
                      writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2005_treelas/",bc[j,]$UID,"_",i,".las"))
                  }
              }
          })
   #}
      }
      closeAllConnections()

 #+end_src

#+begin_src R
      fl <- list.files("/home/erker/hgt_data/madison_lidar_2005_heights/normalized",
                       pattern = ".*.las",
                       full.names = T)

      cl <- makeCluster(4)
      registerDoParallel(cl)
      out <- foreach(f = fl, .packages = c("stringr","lidR", "rgeos")) %dopar% {  
          l <- readLAS(f, filter = "-drop_z_above 120 -drop_z_below 6 -keep_first", select = "")
          i <- str_extract(f, "tile[0-9]+")
   #if(file.exists(....THE SHAPEFILE)... {
          bc <- shapefile(paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh_2005cropped/",i,".shp"))
          lapply(seq(length(bc)), function(j) {
              if(round(gArea(bc[j,])) == 198) {  # make sure we have the full circle.  if radius changes this will need to...
                  lc <- lasclip(l, bc[j,])
                  if(nrow(lc@data) > 0) {
                      writeLAS(lc, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2005_normlas/",bc[j,]$UID,"_",i,".las"))
                  }
              }
          })
   #}
      }
      closeAllConnections()

 #+end_src

*** test
#+begin_src R
library(lidR)

l2009 <- readLAS("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_las/ST45429_lc2t70933.las")
plot(l2009)

#+end_src

#+RESULTS:

** extract height and estimate bias for trees

plan [2019-11-08 Fri]:

Some of the difference in maximum height will be due to the randomness
of the sampling and due to the difference in the sample size across
years. This creates a bias in maximum height estimates. To estimate
the bias due to these factors, I selected trees with negligible growth
and I bootstrapped the lidar point clouds.  I assume that the points
all come from a single lidar collection over a tree tree.  That is,
all the points were acquired at the same time and that there was no
growth.  I assume footprint size is the same and all other
characteristics of the points are the same, the only difference is
that the number of pulses between years.

I select trees that haven't grown


I will then sample from the combined lidar clouds, new clouds for each
year of the same size as the original data.  For example, if there
were 200 pulses in the 2017 cloud and 50 pulses in the 2016 cloud, I
will randomly sample with replacement 200 of the 250 pulses and assign them to a new
2017 cloud and randomly sample with replacement 50 and assign them to a new 2016
cloud. I'll then calculate the maximum of each of these clouds and
find the difference.  This is an estimate of the bias in maximum
height due to differences in sample size.

By repeating the sampling many times (say 1000), I can get an accurate
estimate of the mean bias and the variance of that bias.  For example,
there are sometimes just one or two points from a tree in 2005 lidar.
This means that the bias estimate will be very uncertain.  But there
is some information in those points and it is still worthwhile to keep
them.

I will then correct for the bias by adding the bias to the observed
maximum height.  This is the expected maximum height.  I'll then
perform a weighted regression to estimate height growth rate, where
corrected heights are weighted by the inverse of the bias variance.
That is, the observations with an imprecise bias estimate were
weighted less.

Included implicitly in this method is the canopy structure for each tree.

I combined the two years because this makes sense.  We need the full
sample of points from which we resample from.  Also, later years,
while they usually have more points, don't always have the highest points.




maybe don't worry about it too much.  see if filtering down to a
decent number of points for 2005 gives appropriate biases.

it's never going to be perfect (it can't).



read roussel's paper.  he required a histogram from a very high res.
Do I have a very high res area in 2017 (overlap) that I can use and
assume applies to all trees?  Or maybe a few of them?  2017 is high
res, but still not high enough to know i'm not missing any ranches.
2009 and 2016 tenney oak have higher branches than the 2017.

correcting for pulse density may not correct quite right because of
differences in footprint size....

how to get footprint size?


I think the histogram approach is esstianlly the same as my
resampling.  resampling may be more precise because the lack of
binning, but you need to resample many times.  

The uncertainty in the bias is also important.  Especially wehn few
points.  But less important if averaging across many treees.



*** original extraction of heights and bias correction
#+begin_src R
    library(raster)
    library(dplyr)
    library(stringr)
    library(foreach)
    library(doParallel)

    b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
    b@data <- select(b@data, UID)


                                            #uids <- c("ST14603", "ST14604", "ST14599", "ST14547")

    fs2017 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2017_normlas/", full.names = F)
    fs2016 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2016_normlas/", full.names = F)
    fs2009 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_normlas/", full.names = F)
    fs2005 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2005_normlas/", full.names = F)

                                            #make sure there is only one of each trees
    uids2017 <- str_extract(fs2017, "^[A-Za-z0-9]+")
    head(sort(table(uids2017), decreasing = T))

    uids2016 <- str_extract(fs2016, "^[A-Za-z0-9]+")
    head(sort(table(uids2016), decreasing = T))

    uids2009 <- str_extract(fs2009, "^[A-Za-z0-9]+")
                                            #head(sort(table(uids2009), decreasing = T), 1800)
    head(sort(table(uids2009), decreasing = T))

    uids2005 <- str_extract(fs2005, "^[A-Za-z0-9]+")
    head(sort(table(uids2005), decreasing = T))

                                            # 2009 has more than one lidar file per tree.  around 1700- 1800 duplicates or triplicates.

  #  l1 <- readLAS("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_las/ST01245_lc2t70836.las")
  #  l2 <- readLAS("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_las/ST01245_lc2t70835.las")
  #  l3 <- readLAS("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_las/ST01245_lc2t70826.las")

                                            #They are identical so I'll just select one of the duplicates to use and ignore the others.  This should be fixed upstream in the future.


                                            # put all the uids and las paths for ecah year in a dataframe to loop through

    uids2017 <- data.frame(str_match(fs2017, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2017) <- c("path2017", "uid")

    uids2016 <- data.frame(str_match(fs2016, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2016) <- c("path2016", "uid")

    uids2009 <- data.frame(str_match(fs2009, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2009) <- c("path2009", "uid")
                                            # remove duplicates for 2009
    uids2009 <- uids2009 %>% group_by(uid) %>% summarize(path2009 = path2009[1])


    uids2005 <- data.frame(str_match(fs2005, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2005) <- c("path2005", "uid")


    uids_df <- left_join(uids2017, uids2016)
    uids_df <- left_join(uids_df, uids2009)
    uids_df <- left_join(uids_df, uids2005)


    uids_df <- uids_df[complete.cases(uids_df),]



    treelasdir <- "/home/erker/hgt_data/madison_tree_inventories/hgt/"
    reps <- 1000

    cl <- makeCluster(6)
    registerDoParallel(cl)

    out <- foreach(i = (1:nrow(uids_df)), .packages = c("stringr","lidR", "rgeos"), .combine = "rbind") %dopar% {  

        path2017 <- paste0(treelasdir, "trees_2017_normlas/", uids_df$path2017[i])
        path2016 <- paste0(treelasdir, "trees_2016_normlas/", uids_df$path2016[i])
        path2009 <- paste0(treelasdir, "trees_2009_normlas/", uids_df$path2009[i])
        path2005 <- paste0(treelasdir, "trees_2005_normlas/", uids_df$path2005[i])

        l2017 <- readLAS(path2017, select = "")
        l2017@data$Z <-     l2017@data$Z  * .3048  # convert to meters
        n17 <- nrow(l2017@data)
        emp_max2017 <- max(l2017@data$Z)

        l2016 <- readLAS(path2016, select = "")
        l2016@data$Z <-     l2016@data$Z  * .3048  # convert to meters
        n16 <- nrow(l2016@data)
        emp_max2016 <- max(l2016@data$Z)

        l2009 <- readLAS(path2009, select = "")
        l2009@data$Z <-     l2009@data$Z  * .3048  # convert to meters
        n09 <- nrow(l2009@data)
        emp_max2009 <- max(l2009@data$Z)

        l2005 <- readLAS(path2005, select = "")
        l2005@data$Z <-     l2005@data$Z  * .3048  # convert to meters
        n05 <- nrow(l2005@data)
        emp_max2005 <- max(l2005@data$Z)


                                            # here is where I am [2019-11-07 Thu]  I need to think of which clouds to combine for each calculation of bias?  Should I combine all the clouds??  The years that are adjacent?
      # combine all of them.  this gives a pulse bias.  I may have to do a footprint correction later.


        Z <- c(l2017@data$Z, l2016@data$Z, l2009@data$Z, l2005@data$Z)
        mZ <- max(Z)

        bias_17 <- replicate(reps, mZ - max(sample(Z, n17, replace = T)))
        bias_16 <- replicate(reps, mZ - max(sample(Z, n16, replace = T)))
        bias_09 <- replicate(reps, mZ - max(sample(Z, n09, replace = T)))
        bias_05 <- replicate(reps, mZ - max(sample(Z, n05, replace = T)))

        mean_bias17 <- mean(bias_17)
        var_bias17 <- var(bias_17)

        mean_bias16 <- mean(bias_16)
        var_bias16 <- var(bias_16)

        mean_bias09 <- mean(bias_09)
        var_bias09 <- var(bias_09)

        mean_bias05 <- mean(bias_05)
        var_bias05 <- var(bias_05)



        res <- data.frame(uid = uids_df[i,"uid"],
                 emp_max2017 = emp_max2017,
                 n2017 = n17,
                 emp_max2016 = emp_max2016,
                 n2016 = n16,
                 emp_max2009 = emp_max2009,
                 n2009 = n09,
                 emp_max2005 = emp_max2005,
                 n2005 = n05,
                 mean_bias17 = mean_bias17,
                 mean_bias16 = mean_bias16,
                 mean_bias09 = mean_bias09,
                 mean_bias05 = mean_bias05,
                 var_bias17 = var_bias17,
                 var_bias16 = var_bias16,
                 var_bias09 = var_bias09, 
                 var_bias05 = var_bias05, 
                 stringsAsFactors = F)

        saveRDS(res, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_norm/", uids_df[i,"uid"], ".rds"))
        return(res)

    }
    closeAllConnections()

  saveRDS(out, "/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_norm.rds")

#+end_src


*** plotting the original bias correction method
#+begin_src R
library(lidR)
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
h <-   readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_norm.rds")
#+end_src

#+RESULTS:
#+begin_example
Loading required package: raster
Loading required package: sp
lidR 2.2.0 using 4 threads. Help on <gis.stackexchange.com>. Bug report on <github.com/Jean-Romain/lidR>.

Attaching package: ‘dplyr’

The following objects are masked from ‘package:raster’:

    intersect, select, union

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

Attaching package: ‘tidyr’

The following object is masked from ‘package:raster’:

    extract
#+end_example

which trees have many points
#+begin_src R 
head(arrange(h, desc(n2017)))
#+end_src

#+RESULTS:
#+begin_example
      uid emp_max2017 n2017 emp_max2016 n2016 emp_max2009 n2009 emp_max2005
1 ST16124   13.789152   421    12.87170    25   11.305032    39    8.708136
2 ST31236   18.231002   410    17.61439    23   17.900904    27   16.873728
3 ST12970   15.065350   393    14.83462    31   13.795248    24   13.167360
4 ST20601    7.983931   392     8.15340    27    8.677656    22    6.059424
5 ST27840   17.637557   392    17.34617    68   16.898112   111   16.282416
6 ST37466   11.432743   392    11.05510    21    8.494776    49    5.809488
  n2005 mean_bias17 mean_bias16 mean_bias09 mean_bias05   var_bias17 var_bias16
1     3  0.03373496   0.3338587   0.2512799   1.2480615 0.0018073612 0.04375007
2     4  0.06898173   0.6964613   0.6007227   1.7324329 0.0065914972 0.22087593
3     5  0.02168195   0.2133618   0.2698309   0.6755279 0.0007244736 0.03414513
4     3  0.24741927   0.9385350   0.9903571   1.6825734 0.0953358387 0.09630880
5     4  0.03272760   0.1530587   0.1123551   0.7762921 0.0024155800 0.01080705
6     2  0.03644067   0.5475202   0.2644576   2.2110984 0.0020779359 0.21029391
   var_bias09 var_bias05
1 0.027922314  0.9847051
2 0.174923225  1.3632906
3 0.046877821  0.1161689
4 0.093125578  0.3771462
5 0.007933116  0.2378079
6 0.051733141  1.3968688
#+end_example

#+begin_src R
  library(ggthemes)
      terk <- list(theme_solarized_2(base_size = 16) +
                   theme(legend.title = element_text(size = 10),
                         legend.text = element_text(size = 8),
                         axis.ticks = element_line(size = .3),
                         rect = element_rect(fill = "transparent"),
                         panel.background = element_rect(fill = "transparent"),
                         panel.grid.major = element_line(color = "#839496", size = .1),
                         panel.grid.minor = element_line(color = "#839496", size = .05)))

  base1 <- "#93a1a1"
  blue <- scale_color_solarized("blue")

  red <- solarized_pal("red")(1)

#+end_src

#+RESULTS:


correct heights and add bias uncertainty
#+begin_src R

        hc <- h %>%
          mutate(cor_max2017 = emp_max2017 + mean_bias17,
                 cor_max2016 = emp_max2016 + mean_bias16,
                 cor_max2009 = emp_max2009 + mean_bias09,
                 cor_max2005 = emp_max2005 + mean_bias05,
                 sd17 = sqrt(var_bias17),
                 sd16 = sqrt(var_bias16),
                 sd09 = sqrt(var_bias09),
                 sd05 = sqrt(var_bias05))

    h_corheight <-   hc %>% select(uid, cor_max2017, cor_max2016, cor_max2009, cor_max2005) %>%
        gather(year, cor_height, -uid) %>%
        mutate(year = as.numeric(str_extract(year, "[0-9]{4}")))

    h_empheight <-   hc %>% select(uid, emp_max2017, emp_max2016, emp_max2009, emp_max2005) %>%
        gather(year, emp_height, -uid) %>%
        mutate(year = as.numeric(str_extract(year, "[0-9]{4}")))

    h_sdbias <-   hc %>% select(uid, sd17, sd16, sd09, sd05) %>%
        gather(year, sdbias, -uid) %>%
        mutate(year = as.numeric(paste0("20",str_extract(year, "[0-9]{2}"))))


  hc <- left_join(h_corheight, h_sdbias)

  hc <- left_join(hc, h_empheight)

#+end_src

#+RESULTS:
: 
: Joining, by = c("uid", "year")
: 
: Joining, by = c("uid", "year")

On average, I'd say that this correction looks pretty good!
#+begin_src R :exports results :results graphics :file figs/correction_oldway.png :width 1300 :height 800 :bg transparent :res 100

  n <- 40
  set.seed(4)
  uids <- sample(unique(hc$uid), n)
  hcf <- filter(hc, uid %in% uids)

    ggplot(data = hcf) + 
        geom_line(aes(y = emp_height, x = year, group = uid), color = base1) +
        geom_line(aes(y = cor_height, x = year, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sdbias, ymin = cor_height - 1.96 *sdbias, x = year), color = red) + 
        facet_wrap(~uid, ncol = 8) +
        terk +
        scale_x_continuous(breaks = c(2005,2009, 2017)) +
        theme(axis.text.x = element_text(angle = 60, hjust = 1))


#+end_src

#+RESULTS:
[[file:figs/correction_oldway.png]]

#+begin_src R :exports results :results graphics :file figs/correction_st14603.png :width 300 :height 200 :bg transparent :res 100
  hcf <- filter(hc, uid == "ST14603")

    ggplot(data = hcf) + 
        geom_line(aes(y = emp_height, x = year, group = uid), color = base1) +
        geom_line(aes(y = cor_height, x = year, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sdbias, ymin = cor_height - 1.96 *sdbias, x = year), color = red) + 
#        facet_wrap(~uid, ncol = 1) +
        terk +
        scale_x_continuous(breaks = c(2005, 2009, 2017)) 



#+end_src

#+RESULTS:
[[file:figs/correction_st14603.png]]

#+begin_src R :exports results :results graphics :file figs/correction_st16209.png :width 300 :height 200 :bg transparent :res 100
  hcf <- filter(hc, uid == "ST16209")

    ggplot(data = hcf) + 
        geom_line(aes(y = emp_height, x = year, group = uid), color = base1) +
        geom_line(aes(y = cor_height, x = year, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sdbias, ymin = cor_height - 1.96 *sdbias, x = year), color = red) + 
#        facet_wrap(~uid, ncol = 1) +
        terk +
        scale_x_continuous(breaks = c(2005, 2009, 2017)) 



#+end_src

#+RESULTS:
[[file:figs/correction_st16209.png]]


center hc
#+begin_src R
hc$year <- hc$year - 2005
#+end_src

#+RESULTS:

Good example of why weights are needed
#+begin_src R
dt <- filter(hc, uid == "ST16209")
mw <- lm(cor_height ~ year, weights = 1/ sdbias^2, data = dt)
mnw <- lm(cor_height ~ year, data = dt)
summary(mw)
summary(mnw)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = cor_height ~ year, data = dt, weights = 1/sdbias^2)

Weighted Residuals:
       1        2        3        4 
 0.58168 -0.59071 -0.09986  0.70543 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)   
(Intercept) 15.98340    0.70779  22.582  0.00196 **
year         0.16328    0.07147   2.285  0.14971   
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.7729 on 2 degrees of freedom
Multiple R-squared:  0.723,	Adjusted R-squared:  0.5845 
F-statistic:  5.22 on 1 and 2 DF,  p-value: 0.1497

Call:
lm(formula = cor_height ~ year, data = dt)

Residuals:
      1       2       3       4 
 0.5790 -0.2249 -1.1184  0.7644 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)   
(Intercept) 17.699412   0.888808  19.914  0.00251 **
year        -0.001289   0.106044  -0.012  0.99140   
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.054 on 2 degrees of freedom
Multiple R-squared:  7.39e-05,	Adjusted R-squared:  -0.4999 
F-statistic: 0.0001478 on 1 and 2 DF,  p-value: 0.9914
#+end_example



Coeffiecient estimates are better than if a point were dropped, and
better than if you assume all points contain equal information.

*** Drop Trees with "bad" data

#+begin_src R
  hs <- hc %>% select(uid, year, emp_height) %>% pivot_wider(names_from = year, values_from = emp_height)

  head(hs)

  bad_uids <- hs %>%
      mutate(dif1716_big = abs(`12` - `11`) > 1.5,
             dif1609_big = abs(`11` - `4`) > 10) %>%
      filter(dif1716_big == T | dif1609_big == T) %>%
      pull(uid)

  hc <- filter(hc, ! uid %in% bad_uids)
#+end_src

*** Fitting many weighted regressions and getting estimates
#+begin_src R

        lms <- list()
        uids <- unique(hc$uid)
      for(i in 1:length(uids)) {
            lms[[i]] <- lm(cor_height ~ year, data = subset(hc, uid == uids[i]))
        }
  names(lms) <- uids
    saveRDS(lms, "/home/erker/hgt_data/madison_tree_inventories/hgt/growth_rates_lms_norm.rds")
#+end_src

#+RESULTS:

#+begin_src R
      growth.rates <- sapply(lms, function(lm) coef(lm)[2])
      growth.rates.se <- sapply(lms, function(lm) summary(lm)$coefficients[2,2])
      est.hgt.at2005 <- sapply(lms, function(lm) coef(lm)[1])
      growth.rates <- data.frame(uid = names(lms), 
                                 growth.rate = growth.rates, 
                                 growth.rate.se = growth.rates.se, 
                                 est.hgt.at2005 = est.hgt.at2005, stringsAsFactors = F)
#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/growthrates_lm_n.png :width 1000 :res 120 :bg transparent
  ggplot(growth.rates, aes(x = growth.rate)) + geom_histogram(binwidth = .03, color = base1) +
    terk +
    scale_x_continuous("growth rate (ft/year)")
#+end_src

#+RESULTS:
[[file:figs/growthrates_lm_n.png]]


[[file:figs/growthrates_lm_f.png]]
[[file:figs/growthrates_lm.png]]

#+begin_src R :exports results :results graphics :file figs/growthrates_lm_clip_n.png :width 1000 :res 120 :bg transparent
  ggplot(growth.rates, aes(x = 100 * growth.rate)) + geom_histogram(binwidth = 2, color = base1) +
    terk +
    scale_x_continuous("growth rate (cm/year)", lim = c(-100,100), breaks = c(-100,-50,0, round(mean(growth.rates$growth.rate * 100),1), 50, 100)) +
    geom_vline(data = growth.rates, aes(xintercept = mean(growth.rate)*100), color = red)
#+end_src

#+RESULTS:
[[file:figs/growthrates_lm_clip_n.png]]



[[file:figs/growthrates_lm_clip_f.png]]



#+begin_src R :exports results :results graphics :file figs/rate_by_int.png :bg transparent :width 1000 :res 100
hn <- left_join(h, growth.rates)

  ggplot(hn, aes(x = emp_max2005, y = growth.rate)) + geom_point(color = base1, size = .5, alpha = .5) + terk +
    geom_smooth()
#+end_src

#+RESULTS:
[[file:figs/rate_by_int.png]]


#+begin_src R
saveRDS(hn, "/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates.rds")
#+end_src

#+RESULTS:

join growth rates to trees

#+begin_src R
  library(raster)
  trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")

  hn <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates.rds")

  trees@data <- left_join(trees@data, hn, by = c("UID" = "uid"))

  shapefile(trees, "/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_Withlidarextractedheights_growthrates.rds", overwrite = T)

#+end_src

*** revised bias correction (only trees that have stopped growing)
Revised way of doing bias with just trees already almost at their
maximum height by species.

Becuse there are potentially issues with the trees that are still
growing.  See TS00189 and ts01030: are they over corrected?

Goal is to get a bias correction for every species for every size
point cloud.

Also standard deviation?  for uncertainty.  

Here i'm saying that a tree that hasn't grown can be used to find by
how much the different lidar point densitys underestimate height.


**** read in extracted heights from above and find trees that haven't grown

there is a bit of circularity here so I need to be smart about how I
select which trees haven't grown.

They could be the largest trees for each species......

this is only going to work for large genera.

#+begin_src R
    library(dplyr)
  trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")

  h <-   readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias.rds")

  h <- left_join(h, select(unique(trees@data), UID, Genus, DBH), by = c("uid" = "UID")) # use unique because for some reason there are duplicate trees

#+end_src

#+begin_src R :results org
      library(orgutils)
      #  h %>%
       #     filter(emp_max2009 > emp_max2016)

    large.genera <- c("Fraxinus", "Robinia", "Celtis", "Tilia", "Betula", "Gleditsia", 
  "Acer", "Picea", "Pinus", "Populus", "Juglans",
  "Ulmus", "Quercus", "Abies", "Catalpa", "Salix", 
  "Platanus", "Carya", "Ginkgo", "Gymnocladus")

    broad.genera <- c("Fraxinus", "Robinia", "Celtis", "Tilia", "Betula", "Gleditsia", 
  "Acer", "Pinus", "Populus", "Juglans",
  "Ulmus", "Quercus", "Catalpa", "Salix", 
  "Platanus", "Carya", "Ginkgo", "Gymnocladus")


  #number of big trees to use
  nbigtrees <- 40
        hg <- h %>%
            filter(Genus %in% large.genera) %>%
            mutate(DBH = as.numeric(DBH)) %>%
            filter(DBH > 10) %>%
            filter((Genus %in% broad.genera & DBH > 20) | (!(Genus %in% broad.genera) & DBH > 10)) %>%
            group_by(Genus) %>%
            filter(abs(emp_max2017 - emp_max2016) < 1,
                   abs(emp_max2017 - emp_max2009) < 1,
                   abs(emp_max2016 - emp_max2009) < 1) %>%
        top_n(nbigtrees, emp_max2017) %>%
          arrange(Genus, desc(emp_max2017)) 


      hg %>%  select(Genus, DBH, emp_max2017, emp_max2016, emp_max2009, emp_max2005, n2017, n2016, n2009, n2005, uid) %>% data.frame() %>% toOrg


#+end_src

#+RESULTS:
#+BEGIN_SRC org

| Genus       |              DBH | emp_max2017 | emp_max2016 | emp_max2009 | emp_max2005 | n2017 | n2016 | n2009 | n2005 | uid     |
|-------------+------------------+-------------+-------------+-------------+-------------+-------+-------+-------+-------+---------|
| Abies       |               15 |  15.3866088 |   15.328392 |   14.618208 |   14.456664 |    97 |    18 |    26 |     3 | HF3357  |
| Abies       |               17 |  15.2619456 |    15.28572 |   15.014448 |   14.944344 |    23 |     6 |    15 |     2 | HF847   |
| Abies       |               14 |  13.1966208 |   12.807696 |   12.277344 |    9.162288 |    49 |    34 |    33 |     3 | HF567   |
| Acer        | 55.1181102362205 |  27.5060664 |    27.49296 |   27.267408 |    27.29484 |    31 |    12 |    11 |     5 | AS01583 |
| Acer        |               47 |  26.5310112 |     26.4414 |    26.27376 |   25.530048 |    40 |    49 |    18 |     2 | ST68961 |
| Acer        |               26 |  25.9579872 |   26.493216 |    26.60904 |    23.57628 |    40 |    54 |    15 |     4 | SS01411 |
| Acer        |               36 |  25.8442968 |   26.221944 |   25.630632 |   25.380696 |    70 |    12 |    20 |     2 | SS00855 |
| Acer        |               37 |  25.3041912 |    24.90216 |   25.453848 |   23.557992 |    85 |    33 |    15 |     6 | SS02542 |
| Acer        |               45 |  25.1700792 |   25.152096 |   24.990552 |   24.350472 |   110 |    29 |    28 |     5 | HF1741  |
| Acer        |               40 |  25.0448064 |   25.210008 |   24.655272 |   24.484584 |    95 |    16 |    17 |     4 | SS00226 |
| Acer        |               35 |  24.9652536 |   25.142952 |   25.045416 |   23.009352 |    42 |    53 |    17 |     4 | ST12270 |
| Acer        | 61.8110236220472 |  24.4455696 |    24.41448 |    24.70404 |    23.66772 |    92 |    44 |    19 |     6 | AS04134 |
| Acer        |               21 |  24.4233192 |   24.560784 |   23.981664 |   22.988016 |    48 |    38 |    24 |     4 | ST22647 |
| Acer        |               49 |   24.408384 |    24.21636 |    24.06396 |    23.11908 |    97 |    20 |    28 |     2 | ST04680 |
| Acer        |               29 |   24.382476 |   24.097488 |     24.0792 |   23.289768 |    91 |    17 |    15 |     4 | SS02594 |
| Acer        |               35 |  24.3297456 |     24.3078 |   24.137112 |   22.954488 |   193 |    60 |     5 |     4 | ST12433 |
| Acer        | 49.6062992125984 |  24.3151152 |   24.484584 |   23.731728 |    17.78508 |    49 |    27 |    20 |     1 | AS04058 |
| Acer        |               50 |  24.2919504 |   23.853648 |   23.969472 |   24.054816 |    49 |    28 |    24 |     4 | AS02418 |
| Acer        |               40 |  24.2370864 |   24.289512 |   24.091392 |    23.57628 |   127 |    80 |    34 |     4 | ST46200 |
| Acer        |               50 |  24.1846608 |   24.207216 |   23.658576 |   22.622256 |   104 |    24 |    20 |     2 | SS00221 |
| Acer        |               52 |  24.1328448 |    24.18588 |   23.649432 |   21.942552 |    86 |    21 |    21 |     4 | HF5419  |
| Acer        |               47 |   24.111204 |   24.557736 |    24.81072 |   24.347424 |    41 |    56 |    36 |     8 | ST08304 |
| Acer        |               26 |  24.0758472 |   24.685752 |   24.112728 |   22.984968 |    30 |    34 |    20 |     4 | SS01329 |
| Acer        |               38 |  23.9365536 |   24.057864 |   23.664672 |   23.247096 |    93 |    27 |    18 |     2 | SS00853 |
| Acer        |               46 |  23.9332008 |   23.841456 |   23.673816 |   23.292816 |    65 |    21 |    25 |     2 | SS00852 |
| Acer        |               41 |  23.9121696 |   24.067008 |   23.457408 |   23.356824 |   111 |    22 |    17 |     6 | SS00876 |
| Acer        | 40.5511811023622 |   23.906988 |   23.554944 |   23.183088 |    21.59508 |    47 |    28 |    28 |     4 | AS02623 |
| Acer        |               29 |  23.8938816 |   23.780496 |   23.594568 |   22.933152 |   114 |    72 |    22 |     4 | ST49005 |
| Acer        |               39 |  23.8222536 |   23.655528 |    23.30196 |   20.948904 |    42 |    14 |    24 |     3 | ST71780 |
| Acer        |               37 |  23.8207296 |    23.86584 |   23.603712 |   23.219664 |    88 |    24 |    16 |     6 | SS00877 |
| Acer        |               42 |  23.8057944 |   23.536656 |   23.420832 |   22.497288 |    42 |    23 |    22 |     3 | SS02279 |
| Acer        |               43 |  23.8054896 |   23.405592 |   24.088344 |   22.991064 |   196 |    44 |    14 |     2 | ST12436 |
| Acer        |               36 |  23.7512352 |   24.009096 |   23.487888 |   21.921216 |   119 |    49 |    13 |     4 | ST68195 |
| Acer        |               36 |   23.727156 |   23.594568 |   22.972776 |   21.470112 |   127 |    22 |    28 |     7 | HF4994  |
| Acer        |               39 |  23.7146592 |   23.948136 |   23.369016 |   21.805392 |    43 |    25 |    15 |     1 | ST49174 |
| Acer        | 21.6535433070866 |  23.6985048 |    23.27148 |    22.79904 |   18.519648 |    79 |    30 |    24 |     3 | AS04755 |
| Acer        |               45 |   23.672292 |   23.701248 |   22.942296 |   22.564344 |    91 |    23 |    12 |     3 | SS00227 |
| Acer        |               35 |  23.6530896 |   23.506176 |   22.811232 |   20.080224 |    87 |    20 |    20 |     3 | ST07946 |
| Acer        |               42 |  23.5482384 |    23.48484 |   22.820376 |   21.585936 |   101 |    17 |    35 |     5 | ST42117 |
| Acer        |               46 |   23.518368 |    22.98192 |   23.557992 |   22.329648 |    93 |    22 |    16 |     5 | SS02588 |
| Acer        |               39 |  23.5156248 |   23.625048 |   23.140416 |     21.7932 |    81 |    44 |     9 |     4 | ST68654 |
| Acer        |               36 |  23.4522264 |   23.106888 |   22.978872 |   22.512528 |    87 |    15 |    26 |     4 | SS00442 |
| Acer        |               39 |  23.3144568 |   23.216616 |   22.917912 |    22.06752 |   105 |    21 |    14 |     3 | SS00881 |
| Betula      |               34 |  20.9540856 |    20.97024 |    20.97024 |   20.506944 |    98 |    22 |    22 |     4 | HF31    |
| Betula      |               27 |  18.4720992 |    18.39468 |   17.657064 |   15.995904 |   238 |    41 |    17 |     5 | HF5179  |
| Betula      |               65 |  18.0789072 |   17.614392 |   17.291304 |   14.465808 |    96 |    18 |    27 |     2 | HF1204  |
| Betula      |               28 |  17.9478432 |    17.02308 |   17.791176 |    13.91412 |    55 |    11 |    17 |     2 | HF308   |
| Betula      |               21 |  16.5884352 |   17.288256 |   16.501872 |   15.115032 |    37 |    26 |    13 |     5 | HF1535  |
| Betula      |               38 |  16.3497768 |   16.294608 |   15.755112 |   13.911072 |    98 |    22 |    24 |     1 | HF4208  |
| Betula      |               29 |  16.1851848 |   16.166592 |   16.187928 |   16.050768 |    39 |    21 |    25 |     4 | HF334   |
| Betula      |               26 |  15.9955992 |    15.89532 |   15.060168 |   13.536168 |    86 |    27 |    20 |     4 | HF3315  |
| Betula      |               21 |   15.991332 |     16.2306 |    15.33144 |   15.111984 |    48 |    28 |    18 |     3 | HF5396  |
| Betula      |               22 |  15.6935424 |   15.745968 |   15.413736 |   16.898112 |    39 |    16 |    22 |     6 | HF4179  |
| Betula      |               23 |   15.614904 |   15.739872 |    15.07236 |     9.15924 |   135 |    20 |    17 |     2 | HF3456  |
| Betula      |               21 |  15.5246832 |   15.602712 |   14.697456 |    13.99032 |    46 |    33 |    15 |     5 | HF4882  |
| Betula      |               22 |  15.5195016 |   15.578328 |   15.959328 |   14.849856 |    32 |     5 |     8 |     2 | HF3667  |
| Betula      |               22 |   15.299436 |    15.04188 |   14.487144 |   12.697968 |   118 |    28 |    20 |     5 | HF1758  |
| Betula      |               21 |   15.253716 |   15.203424 |   14.548104 |   14.581632 |    70 |    35 |    22 |     4 | ST40589 |
| Betula      |               27 |  14.9742144 |   15.115032 |   14.612112 |    9.912096 |   101 |    24 |    14 |     3 | HF1562  |
| Betula      |               43 |  14.9629368 |   14.785848 |   14.499336 |   13.810488 |   113 |    23 |    22 |     4 | HF895   |
| Betula      |               28 |  14.9035008 |   15.398496 |   14.852904 |   12.097512 |   116 |    27 |    22 |     3 | HF896   |
| Betula      |               23 |   14.894052 |   14.743176 |    14.35608 |   15.157704 |   117 |    23 |    25 |     2 | HF2049  |
| Betula      |               44 |  14.8657056 |   14.670024 |   13.962888 |   13.911072 |    88 |    23 |    19 |     2 | HF1445  |
| Betula      |               31 |  14.7940776 |   14.816328 |   13.935456 |    12.74064 |    40 |    19 |    15 |     5 | HF6917  |
| Betula      |               23 |  14.6779488 |   14.956536 |    15.42288 |   14.301216 |    14 |     4 |    14 |     2 | HF5858  |
| Betula      |               35 |   14.445996 |   14.161008 |   13.584936 |   13.557504 |    92 |    22 |    12 |     4 | HF5068  |
| Betula      |               24 |  14.3975328 |   14.712696 |   13.978128 |   11.411712 |    39 |    23 |    11 |     1 | HF6913  |
| Betula      |               51 |  14.2762224 |   14.069568 |   13.597128 |   13.734288 |    46 |    36 |    15 |     4 | HF5223  |
| Betula      |               33 |  14.1738096 |    14.21892 |   13.261848 |   13.283184 |    51 |    22 |    18 |     4 | HF366   |
| Betula      |               31 |  14.1677136 |   14.292072 |     13.9446 |    8.220456 |    47 |    11 |    24 |     2 | HF3212  |
| Betula      |               24 |   14.061948 |   14.023848 |   13.341096 |   10.067544 |    74 |    15 |    22 |     2 | HF5250  |
| Betula      |               50 |  14.0595096 |   13.755624 |   13.133832 |   12.036552 |   117 |    22 |    20 |     3 | HF3558  |
| Betula      |               28 |  13.9561824 |   13.511784 |    13.24356 |   13.194792 |    43 |    31 |    24 |     4 | HF6387  |
| Betula      |               33 |   13.947648 |   13.758672 |    13.27404 |    12.00912 |    51 |    39 |    14 |     3 | HF6851  |
| Betula      |               28 |  13.8656568 |   13.938504 |   13.965936 |   14.060424 |    76 |    16 |    20 |     7 | HF1789  |
| Betula      |               34 |  13.8098784 |   13.798296 |      12.954 |    11.52144 |   112 |    21 |    17 |     3 | HF4658  |
| Betula      |               35 |  13.7522712 |   13.597128 |   13.191744 |   12.765024 |    50 |    38 |    22 |     5 | HF6858  |
| Betula      |               49 |    13.73886 |   13.621512 |   12.774168 |    9.595104 |   158 |    15 |    13 |     2 | HF5007  |
| Betula      |               26 |  13.7379456 |    13.31976 |    12.83208 |   12.685776 |   110 |    23 |    20 |     3 | HF3083  |
| Betula      |               31 |  13.7178288 |    14.06652 |   13.706856 |   12.777216 |    46 |    27 |    10 |     1 | HF5282  |
| Betula      |               23 |  13.6846056 |   12.889992 |    13.13688 |   11.542776 |   103 |    17 |    21 |     2 | HF5545  |
| Betula      |               37 |  13.6745472 |   13.862304 |    13.13688 |   12.963144 |   112 |    27 |    22 |     6 | HF3703  |
| Betula      |               23 |   13.659612 |   12.902184 |   13.484352 |   11.667744 |    46 |    38 |    14 |     3 | HF720   |
| Carya       |               26 |  23.8853472 |   24.143208 |   23.487888 |   15.816072 |    34 |    40 |    21 |     4 | ST33238 |
| Carya       |               28 |  22.9685088 |    23.04288 |   22.588728 |   21.543264 |    98 |    20 |    21 |     5 | HF2198  |
| Carya       |               21 |  21.3609936 |     21.1836 |     20.8026 |    20.36064 |    43 |    37 |    25 |     5 | ST66384 |
| Carya       |               26 |  20.9495136 |    20.83308 |    19.97964 |   18.742152 |    48 |    25 |     7 |     4 | SS02758 |
| Carya       |               23 |   20.883372 |   20.903184 |   19.961352 |   19.068288 |    46 |    19 |    28 |     6 | HF1185  |
| Carya       |               23 |  20.8068672 |    21.57984 |   21.720048 |   19.702272 |    40 |    21 |    13 |     4 | SS02185 |
| Carya       |               23 |  20.3874624 |   20.263104 |   20.159472 |   19.680936 |    46 |    52 |    36 |     3 | ST49102 |
| Carya       |               24 |  20.1174096 |   20.183856 |   19.866864 |    20.02536 |    44 |    53 |    23 |     5 | ST73740 |
| Carya       |               24 |  19.6684392 |    20.45208 |   20.022312 |   15.785592 |    43 |    85 |    13 |     2 | ST73743 |
| Carya       |               23 |  19.0902336 |   19.299936 |    18.45564 |    16.93164 |   110 |    28 |    23 |     3 | HF2402  |
| Carya       |               25 |   19.085052 |   19.485864 |   19.053048 |   15.995904 |    46 |    26 |    13 |     2 | ST71962 |
| Carya       |               23 |  18.4794144 |    18.77568 |   18.522696 |   16.605504 |    38 |    48 |    26 |     4 | ST15567 |
| Carya       |               22 |  15.9325056 |    15.30096 |   15.950184 |   14.892528 |    40 |    42 |    19 |     4 | SS03222 |
| Carya       |               22 |    15.83436 |   15.947136 |   15.294864 |    12.86256 |    85 |    20 |    17 |     2 | ST13440 |
| Carya       |               26 |  15.3658824 |    15.27048 |     14.4018 |   13.155168 |    72 |    19 |    21 |     3 | ST40074 |
| Carya       |               28 |  14.5490184 |   14.990064 |     14.3256 |    8.820912 |    37 |    23 |    18 |     3 | HF3475  |
| Carya       |               24 |  14.4865344 |   14.435328 |   13.557504 |    11.52144 |    38 |    37 |    17 |     4 | HF1550  |
| Catalpa     |               33 |  24.2099592 |   25.027128 |   24.301704 |   23.506176 |   242 |    53 |    12 |     1 | ST36828 |
| Catalpa     |               35 |  23.3473752 |   23.762208 |    23.10384 |   21.476208 |    46 |    63 |    11 |     4 | SS02330 |
| Catalpa     |               25 |  21.9449904 |   21.750528 |   21.247608 |   21.500592 |   168 |    30 |    24 |     5 | ST67348 |
| Catalpa     |               23 |  21.0147408 |    21.36648 |     20.4978 |   15.550896 |    47 |    31 |    11 |     3 | SS02052 |
| Catalpa     |               36 |   20.767548 |   20.366736 |    19.87296 |   19.315176 |    48 |    56 |    14 |     4 | ST66824 |
| Catalpa     | 33.8582677165354 |  20.4938376 |   20.506944 |    19.91868 |   19.565112 |   153 |    29 |    16 |     5 | AS04952 |
| Catalpa     | 33.4645669291339 |  20.2268328 |   20.622768 |   20.241768 |    17.84604 |    45 |    27 |    17 |     2 | AS01624 |
| Catalpa     |               35 |  19.4331336 |   18.815304 |   19.315176 |    15.83436 |    45 |    42 |     9 |     4 | ST58930 |
| Catalpa     |               31 |  19.0274448 |   19.062192 |    18.94332 |   16.422624 |    42 |    62 |    22 |     3 | SS02324 |
| Catalpa     | 44.8818897637795 |  18.7113672 |   18.733008 |   18.571464 |   14.557248 |    92 |    44 |    16 |     2 | AS02141 |
| Catalpa     |               27 |  18.2185056 |   18.495264 |   17.931384 |   15.364968 |    29 |    13 |     5 |     2 | SS02043 |
| Catalpa     |               31 |  17.5241712 |   17.385792 |   17.010888 |   15.809976 |   103 |    32 |    20 |     3 | ST72126 |
| Catalpa     |               29 |  17.4647352 |   17.437608 |    16.73352 |   18.010632 |    27 |    18 |     2 |     3 | SS02322 |
| Catalpa     |               41 |  17.2016928 |   17.224248 |    16.80972 |   15.907512 |   118 |    81 |    20 |     4 | ST42767 |
| Catalpa     |               22 |  17.1654216 |   17.090136 |   16.742664 |   14.023848 |   343 |    34 |    21 |     5 | ST12365 |
| Catalpa     |               29 |  16.8840912 |   16.904208 |   16.910304 |    15.98676 |    76 |    20 |    22 |     2 | ST52460 |
| Catalpa     |               25 |  16.7408352 |   17.248632 |   17.041368 |    8.894064 |    82 |    43 |    16 |     1 | ST58927 |
| Catalpa     |               24 |  16.7185848 |   17.016984 |   17.452848 |    13.42644 |     8 |     9 |     3 |     3 | SS02332 |
| Catalpa     |               24 |  16.6838376 |   16.888968 |    16.47444 |    15.94104 |    45 |    68 |    21 |     3 | ST08233 |
| Catalpa     |               26 |  16.6109904 |   16.907256 |   16.480536 |   16.038576 |    97 |    31 |     8 |     5 | ST10611 |
| Catalpa     |               29 |  16.3028376 |   16.666464 |    15.74292 |   13.612368 |    46 |    58 |    15 |     3 | ST58872 |
| Catalpa     | 29.5275590551181 |   15.976092 |   16.029432 |   15.563088 |   11.210544 |    99 |    36 |    25 |     2 | AS02540 |
| Catalpa     |               32 |  15.8901384 |   16.218408 |   15.444216 |    14.87424 |    45 |    34 |    12 |     4 | ST14266 |
| Catalpa     |               21 |  15.4375104 |    15.59052 |   14.990064 |   13.082016 |   125 |    23 |    15 |     2 | ST70097 |
| Catalpa     |               31 |  14.9888448 |    15.25524 |   14.944344 |   13.621512 |   102 |    34 |    20 |     3 | ST67067 |
| Catalpa     | 33.4645669291339 |  14.5642584 |   13.840968 |   13.688568 |   12.752832 |    48 |    29 |    22 |     5 | AS02477 |
| Catalpa     |               27 |  14.3365728 |   14.606016 |   13.859256 |    12.43584 |    46 |    27 |    28 |     3 | ST58871 |
| Catalpa     |               28 |   9.6630744 |   10.040112 |     10.1346 |    9.689592 |    48 |    50 |    65 |     5 | ST87019 |
| Celtis      |               48 |  25.3922784 |   26.295096 |   25.886664 |   24.996648 |    38 |    77 |    30 |     2 | ST11707 |
| Celtis      |               25 |  25.1075952 |   25.408128 |   24.646128 |   23.981664 |    30 |    18 |     9 |    11 | ST26319 |
| Celtis      |               34 |   24.790908 |   24.771096 |   24.390096 |   24.423624 |   100 |    29 |    20 |     3 | ST63692 |
| Celtis      |               35 |  24.1136424 |   24.039576 |   23.969472 |   22.872192 |    41 |    37 |    13 |     5 | SS00615 |
| Celtis      |               22 |  23.6390688 |   23.981664 |   23.006304 |   23.106888 |   175 |    63 |    14 |     5 | ST52946 |
| Celtis      |               40 |   23.612856 |      23.622 |   23.777448 |   20.153376 |    68 |    18 |    22 |     2 | ST63693 |
| Celtis      |               31 |  23.1422448 |    23.37816 |   22.893528 |   20.814792 |    85 |    23 |    23 |     3 | ST32052 |
| Celtis      |               22 |  22.9505256 |   23.237952 |   22.674072 |   22.055328 |    41 |    31 |    13 |     5 | SS03150 |
| Celtis      |               31 |    22.57806 |   22.960584 |   22.924008 |    21.42744 |    51 |    51 |    24 |     3 | SS02271 |
| Celtis      |               29 |   22.491192 |   22.482048 |   22.378416 |   20.549616 |    92 |    23 |    23 |     3 | ST63589 |
| Celtis      |               30 |  21.4539576 |   21.973032 |   21.131784 |   20.973288 |    25 |    26 |    29 |     5 | TS01466 |
| Celtis      |               25 |  21.3929976 |    21.27504 |   21.101304 |    19.26336 |    75 |    19 |    16 |     1 | ST37058 |
| Celtis      |               35 |  21.2793072 |   21.470112 |   21.418296 |    18.10512 |    47 |    47 |    25 |     2 | ST11734 |
| Celtis      |               29 |  21.2680296 |    21.65604 |    21.16836 |   20.439888 |    47 |    26 |    24 |     3 | HF2785  |
| Celtis      |               33 |  21.1589112 |   20.958048 |    20.74164 |     20.4216 |    46 |    27 |    21 |     3 | ST35152 |
| Celtis      |               25 |   21.083016 |    20.86356 |   20.430744 |   20.784312 |   309 |    29 |    25 |     9 | ST78441 |
| Celtis      | 33.0708661417323 |  21.0119976 |   20.747736 |   20.150328 |   20.753832 |    46 |    17 |    24 |     4 | AS05205 |
| Celtis      |               38 |  21.0119976 |   21.147024 |   20.793456 |   20.674584 |   100 |    44 |    21 |     2 | ST28303 |
| Celtis      | 39.7637795275591 |  20.8611216 |    20.98548 |   20.092416 |   20.052792 |    13 |     3 |     3 |     3 | AS05071 |
| Celtis      |               34 |  20.7276192 |   20.948904 |   20.897088 |   19.671792 |    42 |    31 |    19 |     4 | ST63731 |
| Celtis      |               26 |  20.2567032 |   20.897088 |   20.363688 |   19.970496 |    42 |    58 |    25 |     2 | ST11391 |
| Celtis      |               31 |   20.112228 |   20.336256 |   19.757136 |   19.985736 |   107 |    28 |    23 |     4 | ST59637 |
| Celtis      |               29 |    19.85772 |   19.961352 |    19.76628 |   18.751296 |    89 |    44 |    21 |     1 | ST70167 |
| Celtis      |               22 |  19.7717664 |   20.107656 |   19.132296 |    20.07108 |   122 |    24 |     7 |     3 | ST53041 |
| Celtis      |               22 |    19.47672 |   19.348704 |   19.001232 |   17.458944 |    89 |    17 |    11 |     5 | SS02624 |
| Celtis      |               34 |  19.4114928 |   19.665696 |   19.053048 |    18.45564 |    45 |    30 |    23 |     4 | ST58643 |
| Celtis      |               31 |  18.9923928 |   19.257264 |   18.614136 |   17.955768 |   172 |    59 |    32 |     5 | ST25184 |
| Celtis      | 24.0157480314961 |   18.906744 |   18.891504 |   18.778728 |   17.212056 |    77 |    43 |    17 |     4 | AS03201 |
| Celtis      |               36 |   18.838164 |   19.470624 |   19.208496 |    15.98676 |    61 |    19 |    21 |     1 | ST63713 |
| Celtis      |               29 |   18.801588 |   18.894552 |   18.693384 |   18.662904 |    95 |    60 |    24 |     3 | ST70522 |
| Celtis      |               32 |   18.748248 |   18.452592 |   18.495264 |   18.711672 |    94 |    24 |    21 |     4 | ST59390 |
| Celtis      | 36.2204724409449 |  18.7168536 |   19.013424 |   18.339816 |   16.675608 |    41 |    29 |    25 |     3 | AS00498 |
| Celtis      |               30 |  18.6936888 |   18.800064 |   18.202656 |   15.852648 |    31 |    20 |    25 |     1 | ST57275 |
| Celtis      | 40.5511811023622 |  18.6433968 |   18.812256 |   18.220944 |    18.07464 |    56 |    17 |    30 |     3 | AS00452 |
| Celtis      |               28 |    18.47088 |   18.614136 |   17.980152 |   15.630144 |    87 |    39 |    21 |     2 | ST70291 |
| Celtis      |               25 |   18.359628 |   18.824448 |    17.84604 |   16.212312 |    36 |    80 |    14 |     3 | ST40521 |
| Celtis      |               28 |  18.3206136 |   18.291048 |   17.885664 |   17.757648 |    45 |    25 |    29 |     3 | ST48788 |
| Celtis      | 31.1023622047244 |   18.083784 |   18.086832 |    17.31264 |   16.254984 |    45 |    30 |    11 |     2 | AS01697 |
| Celtis      |               34 |   18.009108 |   18.117312 |   17.736312 |   18.080736 |    42 |    30 |    26 |     3 | ST36576 |
| Celtis      |  34.251968503937 |    18.00606 |   17.818608 |     17.6784 |   16.407384 |    72 |    34 |    16 |     2 | AS04775 |
| Fraxinus    |               43 |   25.645872 |   25.767792 |   25.856184 |   25.188672 |   106 |    43 |    32 |     5 | ST14603 |
| Fraxinus    |               36 |  22.9828344 |   22.680168 |   22.546056 |   17.590008 |   147 |    40 |    27 |     1 | ST15038 |
| Fraxinus    |               38 |  22.8045264 |   22.628352 |   22.003512 |   21.387816 |    90 |    51 |    26 |     4 | ST16316 |
| Fraxinus    |               22 |  22.6838256 |   22.698456 |   22.247352 |   22.195536 |    92 |    32 |    20 |     5 | ST89333 |
| Fraxinus    |               31 |  22.5091752 |   23.070312 |    22.46376 |   16.425672 |    43 |    50 |    29 |     3 | SS01331 |
| Fraxinus    |               35 |  22.2583248 |   22.195536 |   21.619464 |   20.525232 |    51 |    50 |    27 |     2 | SS02832 |
| Fraxinus    |               40 |  22.1184216 |   21.942552 |   21.872448 |   20.820888 |   109 |    49 |    37 |     3 | ST70358 |
| Fraxinus    |               38 |    22.09038 |   22.518624 |    21.53412 |   20.449032 |    47 |    50 |    15 |     4 | ST30959 |
| Fraxinus    |               34 |    21.81606 |   22.073616 |   21.195792 |   20.028408 |    90 |    62 |    18 |     4 | ST11212 |
| Fraxinus    |               40 |  21.6313512 |   21.415248 |    21.70176 |   22.683216 |   113 |    23 |    28 |     4 | ST64025 |
| Fraxinus    |               28 |   21.211032 |   20.692872 |   20.503896 |    18.24228 |    54 |    47 |    19 |     1 | ST84293 |
| Fraxinus    |               25 |  21.0519264 |    21.42744 |   21.079968 |   20.958048 |    42 |    38 |    23 |     4 | ST34493 |
| Fraxinus    |               22 |  20.8922112 |   20.442936 |   20.427696 |   18.492216 |    68 |    16 |    17 |     4 | SS00243 |
| Fraxinus    |               24 |  20.7620616 |   20.945856 |    21.13788 |   19.485864 |   118 |    25 |    28 |     3 | ST63747 |
| Fraxinus    |               26 |  20.7495648 |    20.83308 |   20.363688 |   19.373088 |   118 |    55 |    19 |     2 | ST77140 |
| Fraxinus    |               34 |    20.66544 |    20.68068 |   19.775424 |   18.205704 |    99 |    33 |    24 |     2 | ST67815 |
| Fraxinus    |               37 |  20.5139544 |    21.27504 |   20.845272 |   18.492216 |    33 |    31 |    12 |     2 | ST31193 |
| Fraxinus    |               21 |  20.4328776 |   20.156424 |   20.293584 |   20.046696 |    42 |    41 |    27 |     8 | ST08303 |
| Fraxinus    |               31 |  20.4289152 |   20.217384 |   20.311872 |   20.555712 |   106 |    41 |    16 |     3 | ST09952 |
| Fraxinus    |               21 |  20.4045312 |   20.921472 |      20.193 |   20.656296 |    32 |    30 |    12 |     6 | SS01490 |
| Fraxinus    |               25 |  20.3868528 |   20.607528 |   19.623024 |    18.77568 |    39 |    29 |    21 |     2 | ST34786 |
| Fraxinus    |               25 |  20.2877928 |   20.412456 |   19.958304 |   19.117056 |    43 |    85 |    20 |     3 | ST59203 |
| Fraxinus    |               26 |  20.2591416 |   20.403312 |   19.824192 |    18.48612 |   103 |    42 |    25 |     4 | ST67829 |
| Fraxinus    |               26 |  20.2472544 |   20.205192 |     19.8882 |   19.053048 |    30 |    42 |    57 |     5 | ST14285 |
| Fraxinus    |               25 |  20.2085448 |   19.930872 |   19.214592 |   18.559272 |    70 |    21 |    31 |     5 | ST41958 |
| Fraxinus    |               32 |  20.2054968 |   19.976592 |   19.376136 |   18.854928 |    45 |    22 |    23 |     7 | HF2313  |
| Fraxinus    |               21 |  20.1737976 |    20.33016 |     19.3548 |   18.620232 |    26 |    28 |    24 |     5 | ST41695 |
| Fraxinus    |               38 |  20.1658728 |   20.762976 |   20.720304 |   20.022312 |   167 |    49 |    30 |     5 | ST64101 |
| Fraxinus    |               23 |  20.1603864 |   20.080224 |   19.412712 |   18.583656 |   125 |    26 |    21 |     4 | ST21631 |
| Fraxinus    |               22 |  20.1494136 |   20.278344 |   19.366992 |   16.666464 |    88 |    24 |    22 |     1 | ST63696 |
| Fraxinus    |               22 |  20.1451464 |   20.083272 |   20.449032 |   18.275808 |    38 |    48 |    35 |     5 | ST27726 |
| Fraxinus    |               21 |  20.1113136 |    20.33016 |   19.967448 |   20.232624 |   114 |    23 |    25 |     3 | ST63746 |
| Fraxinus    |               26 |  20.1058272 |   20.531328 |   19.601688 |   18.815304 |    70 |    21 |    15 |     3 | ST70506 |
| Fraxinus    |               24 |   20.052792 |   20.144232 |   20.308824 |   17.315688 |    43 |    63 |    22 |     4 | ST59205 |
| Fraxinus    |               22 |  19.9997568 |   20.260056 |     19.5072 |       19.05 |    40 |    47 |    29 |     4 | ST41013 |
| Fraxinus    |               25 |  19.9912224 |   20.531328 |   20.138136 |   17.422368 |    99 |    48 |    26 |     3 | ST68095 |
| Fraxinus    |               22 |  19.9208136 |   20.235672 |   19.257264 |   16.895064 |    44 |    47 |    33 |     1 | ST41303 |
| Fraxinus    |               27 |   19.920204 |    20.08632 |    20.01012 |   18.245328 |   102 |    34 |    29 |     5 | HF5420  |
| Fraxinus    |               30 |  19.9083168 |   19.257264 |   19.955256 |   18.854928 |    82 |    25 |    12 |     4 | ST39200 |
| Fraxinus    |               31 |  19.8784464 |   19.693128 |   19.028664 |   17.568672 |   112 |    22 |    23 |     3 | ST31598 |
| Ginkgo      |               22 |    16.28394 |   16.102584 |   15.752064 |   13.069824 |   105 |    34 |    36 |     4 | ST05181 |
| Ginkgo      |               21 |   15.147036 |   14.764512 |   14.465808 |    9.079992 |    46 |    32 |    14 |     2 | ST72216 |
| Ginkgo      |               21 |   13.565124 |    13.22832 |   13.124688 |    9.823704 |    43 |    41 |    21 |     4 | ST33022 |
| Gleditsia   |               24 |   25.223724 |   24.822912 |   25.167336 |   23.503128 |   102 |    28 |    29 |     6 | HF400   |
| Gleditsia   |               25 |  22.7072952 |   22.792944 |   21.988272 |   19.604736 |   110 |    42 |    22 |     3 | ST49312 |
| Gleditsia   |               44 |  22.6173792 |   22.030944 |   22.015704 |   19.958304 |    38 |    30 |    28 |     4 | ST68174 |
| Gleditsia   | 29.1338582677165 |  22.5728784 |   22.226016 |    21.96084 |   20.211288 |    41 |    30 |    27 |     2 | AS03546 |
| Gleditsia   |               24 |  22.3461072 |   22.088856 |     21.4122 |   19.434048 |   105 |    49 |    27 |     3 | ST49396 |
| Gleditsia   |               21 |  22.3262952 |   22.533864 |   22.165056 |   21.098256 |   104 |    25 |    21 |     3 | HF1983  |
| Gleditsia   |               28 |  22.0626432 |   21.357336 |   21.308568 |   20.016216 |    43 |    45 |    25 |     3 | ST68161 |
| Gleditsia   |               26 |   21.873972 |   22.055328 |   21.220176 |   20.308824 |    23 |    18 |    13 |     2 | HF323   |
| Gleditsia   |               30 |  21.6054432 |   21.979128 |   21.918168 |   17.675352 |    51 |    42 |    24 |     3 | HF654   |
| Gleditsia   |               25 |  21.6023952 |   20.644104 |   20.961096 |    17.32788 |   209 |    24 |    25 |     4 | ST07516 |
| Gleditsia   |               29 |  21.5338152 |   21.445728 |   20.616672 |   15.718536 |    74 |    24 |    23 |     2 | ST49506 |
| Gleditsia   |               26 |   21.476208 |   21.360384 |   20.537424 |   17.638776 |   226 |    50 |    23 |     5 | ST49743 |
| Gleditsia   |               26 |  21.4631016 |   20.717256 |   20.702016 |   16.782288 |   106 |    38 |    26 |     4 | ST18291 |
| Gleditsia   |               29 |  21.3990936 |   21.832824 |   21.022056 |     17.0688 |    52 |    28 |    22 |     3 | HF2781  |
| Gleditsia   |               24 |   21.369528 |   20.887944 |    20.60448 |   17.949672 |    49 |    31 |    25 |     3 | ST35741 |
| Gleditsia   |               25 |  21.1814664 |   20.851368 |   20.317968 |   12.591288 |    45 |    42 |    21 |     3 | ST36690 |
| Gleditsia   |               24 |  21.1616544 |   20.906232 |    20.23872 |   16.873728 |    53 |    61 |    13 |     4 | ST81759 |
| Gleditsia   |               28 |  21.1613496 |    20.98548 |   20.445984 |   17.330928 |    47 |    35 |    20 |     5 | ST67575 |
| Gleditsia   |               23 |  21.1494624 |   21.826728 |   21.070824 |   18.144744 |    37 |    31 |    22 |     4 | ST50401 |
| Gleditsia   |               26 |  21.1275168 |     20.3454 |   20.232624 |     6.58368 |    33 |    15 |    16 |     1 | ST36678 |
| Gleditsia   |               24 |    21.03882 |   20.506944 |   20.427696 |   17.288256 |    88 |    41 |    15 |     4 | ST56095 |
| Gleditsia   |               40 |  21.0180936 |   21.271992 |   20.354544 |   18.376392 |   349 |    60 |    15 |     3 | HF858   |
| Gleditsia   |               24 |   21.011388 |   20.897088 |   20.625816 |   17.172432 |   112 |    20 |    24 |     2 | ST18290 |
| Gleditsia   |               24 |  20.9681064 |   20.260056 |   20.135088 |   15.410688 |    34 |    23 |    18 |     1 | ST03942 |
| Gleditsia   |               23 |  20.9364072 |   20.369784 |   20.007072 |   16.166592 |    42 |    53 |    25 |     3 | ST73079 |
| Gleditsia   |               25 |  20.7760824 |   20.595336 |   20.113752 |   18.172176 |    88 |    51 |    25 |     5 | SS03435 |
| Gleditsia   |               31 |  20.7459072 |    20.46732 |   19.961352 |   16.410432 |   290 |    38 |    18 |     3 | HF1150  |
| Gleditsia   |               28 |    20.66544 |   20.903184 |    20.46732 |   19.702272 |    50 |    57 |    24 |     2 | ST04613 |
| Gleditsia   |               24 |  20.6386176 |    20.58924 |   20.232624 |   16.776192 |    33 |    17 |    18 |     3 | ST50402 |
| Gleditsia   |               22 |  20.6343504 |   20.897088 |   20.455128 |   17.995392 |   108 |    24 |    20 |     3 | ST03515 |
| Gleditsia   |               27 |  20.6300832 |   20.519136 |   20.424648 |   17.035272 |    36 |    24 |    14 |     3 | ST36894 |
| Gleditsia   |               30 |  20.5304136 |   19.714464 |   19.623024 |   15.325344 |    52 |    25 |    24 |     2 | HF645   |
| Gleditsia   |               29 |   20.517612 |   20.494752 |   19.647408 |   18.797016 |   100 |    27 |    19 |     2 | HF1811  |
| Gleditsia   |               27 |   20.473416 |   20.272248 |   19.574256 |    16.80972 |   185 |    17 |    21 |     2 | ST80381 |
| Gleditsia   |               29 |  20.4706728 |   20.290536 |   20.202144 |   17.852136 |    48 |    63 |    17 |     3 | ST36060 |
| Gleditsia   |               22 |    20.46732 |   20.061936 |   19.559016 |    16.24584 |   103 |    43 |    33 |     5 | ST81082 |
| Gleditsia   |               42 |  20.4289152 |   20.369784 |   19.778472 |   17.279112 |   105 |    25 |    16 |     1 | HF4215  |
| Gleditsia   |               23 |    20.39874 |    20.54352 |   19.754088 |   16.014192 |    47 |    57 |    29 |     2 | ST41010 |
| Gleditsia   |               25 |  20.3969112 |   19.863816 |   19.668744 |   15.502128 |   125 |    33 |    16 |     3 | ST19955 |
| Gleditsia   |               22 |  20.3923392 |   20.388072 |   19.747992 |   16.767048 |    43 |    40 |    32 |     3 | ST41654 |
| Gymnocladus |               27 |  17.1559728 |   16.258032 |     16.2306 |   13.786104 |   113 |    26 |    17 |     3 | HF2727  |
| Gymnocladus |               22 |  15.7633416 |   15.944088 |   15.130272 |    11.68908 |   126 |    24 |    26 |     1 | ST10604 |
| Juglans     | 43.3070866141732 |  23.4092496 |   23.609808 |    22.76856 |    21.22932 |    49 |    38 |    23 |     2 | AS03576 |
| Juglans     | 32.6771653543307 |  22.6310952 |   22.945344 |   22.256496 |   16.715232 |   187 |    24 |    22 |     2 | AS04252 |
| Juglans     |  31.496062992126 |  22.4646744 |   22.457664 |   21.521928 |   17.681448 |    52 |    16 |    15 |     1 | AS02810 |
| Juglans     |               26 |  22.2589344 |   22.332696 |    21.70176 |   13.392912 |    55 |    26 |    19 |     2 | ST25012 |
| Juglans     |               21 |  21.6920064 |    21.62556 |     20.8788 |    8.272272 |   166 |    23 |    19 |     2 | TS01463 |
| Juglans     |               22 |  21.5487504 |   22.015704 |   21.750528 |   15.517368 |    38 |    40 |    28 |     2 | SS02285 |
| Juglans     |               26 |  21.4582248 |   21.662136 |     21.0312 |   18.940272 |    77 |    36 |    24 |     4 | ST70191 |
| Juglans     | 24.8031496062992 |  21.3667848 |     20.8788 |    20.98548 |   18.382488 |    98 |    50 |    25 |     2 | AS05388 |
| Juglans     | 20.0787401574803 |  21.2259672 |    20.89404 |   20.485608 |    15.75816 |    48 |    36 |    25 |     3 | AS04782 |
| Juglans     |               36 |  21.0336384 |   21.464016 |   21.524976 |    8.705088 |    38 |    37 |    25 |     2 | SS00721 |
| Juglans     | 27.9527559055118 |   20.904708 |   21.204936 |   20.638008 |   18.876264 |    34 |    30 |    27 |     3 | AS03493 |
| Juglans     | 22.0472440944882 |  20.2195176 |   20.202144 |    19.38528 |   16.102584 |    38 |    49 |    13 |     2 | AS03870 |
| Juglans     | 30.3149606299213 |    20.13966 |   20.293584 |    19.76628 |   14.374368 |    36 |    25 |    23 |     3 | AS03522 |
| Juglans     | 33.4645669291339 |   20.014692 |   20.674584 |   19.882104 |    17.11452 |    41 |    25 |    21 |     2 | AS03505 |
| Juglans     |               23 |  19.8354696 |   19.885152 |   19.815048 |   17.352264 |    37 |    25 |    27 |     2 | ST38309 |
| Juglans     |               36 |  19.7592696 |   19.915632 |   19.373088 |   16.190976 |   123 |    23 |    28 |     3 | HF7297  |
| Juglans     |               31 |  19.7455536 |   20.491704 |   20.287488 |    12.74064 |    37 |    23 |    17 |     2 | ST32779 |
| Juglans     |               24 |  19.5885816 |   19.257264 |   18.830544 |   15.566136 |   150 |    24 |    24 |     5 | ST20528 |
| Juglans     | 23.6220472440945 |   19.578828 |    18.92808 |   19.162776 |   17.077944 |    31 |    23 |    18 |     2 | AS02714 |
| Juglans     |               30 |  19.0762128 |   18.726912 |   18.236184 |   17.593056 |    43 |    37 |    28 |     4 | TS01102 |
| Juglans     |               26 |  19.0710312 |   19.744944 |    18.77568 |   17.565624 |    43 |    21 |    23 |     3 | ST58766 |
| Juglans     |               24 |  18.7698888 |   18.266664 |   18.031968 |   13.341096 |    67 |    20 |    17 |     1 | HF6393  |
| Juglans     | 23.6220472440945 |  18.7448952 |      19.431 |   18.473928 |   16.133064 |    41 |    23 |    28 |     1 | AS02748 |
| Juglans     |               33 |   18.681192 |    19.08048 |     18.2118 |   17.123664 |   127 |    24 |    16 |     2 | ST72469 |
| Juglans     |               24 |  18.5528712 |   18.803112 |   18.857976 |   16.190976 |    65 |    18 |    27 |     4 | ST80092 |
| Juglans     |               21 |  18.4364376 |    18.62328 |   18.321528 |   16.495776 |    21 |    18 |    16 |     5 | HF5145  |
| Juglans     |               33 |  18.2980584 |   18.495264 |   17.900904 |   15.252192 |    33 |    21 |    19 |     3 | ST42187 |
| Juglans     | 29.5275590551181 |  18.2828184 |    17.86128 |    17.89176 |   12.368784 |   119 |    13 |    14 |     2 | AS02834 |
| Juglans     |               26 |  18.0767736 |   18.202656 |     18.0594 |   16.873728 |    46 |    50 |    23 |     4 | SS03257 |
| Juglans     |               25 |  17.3120304 |   17.788128 |   17.041368 |   15.090648 |    22 |    29 |    22 |     2 | ST20199 |
| Juglans     |               27 |  17.3068488 |    17.26692 |   16.635984 |   14.420088 |    38 |    37 |    27 |     1 | ST20200 |
| Juglans     |               23 |  17.2492416 |   17.727168 |   16.925544 |   13.764768 |    50 |    47 |    14 |     5 | ST45769 |
| Juglans     |               25 |   17.163288 |   17.138904 |   17.050512 |   13.673328 |    95 |    26 |    19 |     2 | ST42003 |
| Juglans     | 21.6535433070866 |  17.1428664 |   16.468344 |   16.892016 |   13.962888 |    41 |    20 |    19 |     1 | AS02514 |
| Juglans     | 25.5905511811024 |  17.0072304 |   16.998696 |   16.739616 |   15.157704 |    32 |    33 |    25 |     2 | AS02373 |
| Juglans     |               35 |  16.9755312 |   17.666208 |   16.727424 |    8.491728 |    57 |    16 |    19 |     1 | HF1599  |
| Juglans     |               27 |  16.7002968 |   16.660368 |   16.834104 |   13.417296 |    38 |    59 |    32 |     3 | ST72289 |
| Juglans     |               26 |  16.6807896 |     16.3068 |   17.065752 |   16.157448 |    37 |    21 |    23 |     4 | ST53791 |
| Juglans     |               26 |  16.2757104 |   16.925544 |   16.651224 |    13.12164 |    54 |    42 |    24 |     2 | ST04466 |
| Juglans     |               25 |   16.204692 |   15.459456 |   16.401288 |   11.448288 |    74 |    17 |    55 |     2 | ST88626 |
| Picea       |               11 |   25.830276 |   25.773888 |   25.795224 |   22.698456 |   194 |    44 |    18 |     4 | ST33216 |
| Picea       |               21 |  23.3577384 |     23.4696 |    22.52472 |   20.153376 |    69 |    84 |    38 |     5 | SS01247 |
| Picea       |               23 |  21.8946984 |    21.80844 |   21.265896 |   19.086576 |    50 |    71 |    22 |     2 | ST08014 |
| Picea       | 13.7795275590551 |   21.403056 |   20.964144 |   20.979384 |   18.534888 |    43 |    25 |    21 |     3 | AS04292 |
| Picea       | 25.5905511811024 |  21.3295992 |   21.323808 |   20.561808 |   17.574768 |    39 |    19 |    25 |     3 | AS02894 |
| Picea       | 27.5590551181102 |  21.1122768 |   21.378672 |   20.461224 |    15.97152 |    43 |    71 |    21 |     1 | AS01482 |
| Picea       |               21 |  20.7532224 |   21.262848 |   20.317968 |   18.717768 |    50 |    59 |    26 |     7 | SS01239 |
| Picea       |  28.740157480315 |  20.5782672 |   20.622768 |   19.738848 |   17.794224 |   347 |    29 |    28 |     5 | AS04950 |
| Picea       |               28 |  20.2167744 |   20.226528 |   20.122896 |   19.763232 |   109 |    33 |    22 |    10 | SS00367 |
| Picea       |               28 |  19.9010016 |    20.07108 |   19.760184 |   16.197072 |    18 |    17 |    14 |     3 | HF1376  |
| Picea       |               16 |  19.4712336 |   19.510248 |   18.510504 |   15.724632 |    63 |    19 |    13 |     4 | SS03349 |
| Picea       |               18 |  19.1356488 |   18.970752 |   18.233136 |   16.895064 |   108 |    39 |    28 |     5 | SS03330 |
| Picea       |               11 |  19.0158624 |    18.37944 |    18.34896 |    13.19784 |    80 |    26 |    22 |     2 | HF2818  |
| Picea       |               12 |  18.9747144 |    18.54708 |   18.434304 |   18.035016 |    85 |    25 |    24 |     4 | HF1960  |
| Picea       |               18 |  18.9503304 |   19.031712 |   18.065496 |   16.934688 |    44 |    69 |    33 |     2 | SS02816 |
| Picea       |               23 |  18.3724296 |   18.355056 |    17.40408 |   16.757904 |    50 |    50 |    32 |     4 | HF5574  |
| Picea       |               22 |  18.3389016 |   18.245328 |   17.721072 |   16.053816 |    59 |    72 |    28 |     3 | ST86209 |
| Picea       |               51 |  18.2267352 |    17.58696 |   17.443704 |     8.51916 |    52 |    58 |    32 |     3 | HF3080  |
| Picea       |               16 |  18.2212488 |   18.062448 |   18.099024 |   13.420344 |     9 |     5 |    11 |     1 | ST53516 |
| Picea       |               18 |  18.0965856 |   17.654016 |   17.468088 |   14.825472 |    24 |    34 |    26 |     4 | HF3669  |
| Picea       |               13 |  17.8042824 |    18.48612 |   17.775936 |    16.01724 |    49 |    80 |    24 |     5 | ST42334 |
| Picea       |               15 |  17.6436528 |   17.797272 |    17.12976 |   17.364456 |    45 |    60 |    33 |     3 | ST42581 |
| Picea       |               13 |  17.1684696 |   16.709136 |    17.28216 |   16.828008 |   108 |    28 |    31 |     6 | TS01479 |
| Picea       |               14 |  17.1651168 |   17.108424 |   16.270224 |   10.229088 |    39 |    27 |    16 |     2 | HF6497  |
| Picea       |               11 |  17.1218352 |   16.952976 |    16.58112 |     10.9728 |   104 |    19 |    15 |     2 | HF4037  |
| Picea       | 16.1417322834646 |  17.1193968 |   16.904208 |   16.852392 |   17.279112 |    27 |    16 |    18 |     3 | AS04294 |
| Picea       |               16 |  17.0758104 |   17.288256 |   16.739616 |     7.55904 |   109 |    14 |    21 |     3 | HF5966  |
| Picea       |               14 |   16.843248 |   16.645128 |   16.602456 |   16.568928 |    88 |    18 |    21 |     3 | ST86121 |
| Picea       |               18 |  16.6768272 |   16.532352 |   15.736824 |   12.996672 |    36 |    30 |    36 |     3 | ST53483 |
| Picea       | 14.9606299212598 |  16.4598096 |   16.684752 |   15.761208 |   10.533888 |    49 |    24 |    26 |     1 | AS04443 |
| Picea       |               12 |  16.4534088 |   16.803624 |    16.03248 |   15.489936 |    52 |    21 |    11 |     1 | HF723   |
| Picea       | 17.3228346456693 |   16.361664 |   16.401288 |   15.898368 |   11.981688 |    42 |    28 |    12 |     1 | AS04903 |
| Picea       | 13.7795275590551 |  16.2650424 |   15.432024 |    15.65148 |   14.395704 |    46 |    22 |    20 |     3 | AS05024 |
| Picea       |               17 |  16.2150552 |   16.069056 |   15.541752 |    14.08176 |   108 |    59 |    39 |     6 | ST69992 |
| Picea       |               12 |  16.1915856 |    16.59636 |   16.386048 |   14.819376 |   104 |    33 |    22 |     2 | HF2076  |
| Picea       |               49 |  16.1629344 |   15.776448 |   15.252192 |   12.777216 |    51 |    70 |    35 |     6 | HF7273  |
| Picea       | 13.7795275590551 |  16.1108136 |    15.74292 |   15.115032 |    13.06068 |    40 |    31 |    15 |     2 | AS01056 |
| Picea       |               14 |    16.09344 |   15.459456 |    15.19428 |    11.84148 |   162 |    18 |    24 |     3 | HF6314  |
| Picea       |               15 |  16.0474152 |   16.157448 |   16.392144 |    7.607808 |    44 |    26 |     9 |     1 | HF2784  |
| Picea       | 18.8976377952756 |  15.7587696 |   15.617952 |    14.84376 |   12.856464 |    44 |    70 |    28 |     7 | AS04682 |
| Pinus       |               22 |   23.108412 |   22.914864 |   22.229064 |   19.824192 |    47 |   101 |    33 |     3 | ST12429 |
| Pinus       |               22 |   21.652992 |   22.183344 |    21.70176 |   20.546568 |    50 |    62 |    13 |     4 | HF4707  |
| Pinus       |               27 |  21.4073232 |   21.296376 |   20.912328 |   18.144744 |    47 |    31 |    13 |     2 | HF4666  |
| Pinus       |               32 |  20.0229216 |    20.08632 |   19.251168 |    8.196072 |    47 |    46 |    30 |     3 | HF4665  |
| Pinus       |               25 |  19.0365888 |   18.720816 |   18.635472 |   16.364712 |   114 |    38 |    33 |     2 | ST52803 |
| Pinus       |               23 |  18.2063136 |   18.184368 |   17.501616 |   16.861536 |   105 |    67 |    33 |     3 | SS01851 |
| Pinus       |               21 |  14.8111464 |   15.017496 |   15.639288 |     9.09828 |   140 |    37 |    33 |     3 | TS01345 |
| Pinus       |               30 |  13.9257024 |    14.90472 |   14.353032 |   14.106144 |    44 |    38 |    16 |     2 | ST14177 |
| Pinus       |               27 |  13.6647936 |   12.749784 |   13.310616 |   10.610088 |    45 |    32 |    34 |     2 | HF1060  |
| Pinus       |               21 |  13.5767064 |    13.51788 |   12.743688 |   10.131552 |    52 |    61 |    38 |     2 | ST38981 |
| Pinus       |               21 |  11.7695472 |   11.484864 |   11.241024 |   11.076432 |    48 |    29 |    18 |     4 | HF6019  |
| Platanus    |               37 |  26.9424912 |   27.130248 |    26.15184 |   22.893528 |    97 |    53 |    16 |     6 | ST22430 |
| Platanus    |               31 |  22.1373192 |   22.183344 |   21.866352 |   18.278856 |   137 |    25 |    21 |     4 | HF3658  |
| Platanus    |               24 |  22.0382592 |   22.427184 |   21.546312 |    14.26464 |    89 |    14 |    26 |     2 | SS01004 |
| Platanus    |               26 |  21.4920576 |   21.019008 |    20.52828 |   17.096232 |   123 |    23 |    25 |     5 | ST76851 |
| Platanus    |               25 |  19.5507864 |   20.046696 |   19.641312 |   19.635216 |   109 |    51 |    29 |     7 | SS00996 |
| Platanus    |               34 |  19.4197224 |   18.861024 |   19.168872 |   18.361152 |    40 |    30 |    17 |     4 | ST37620 |
| Platanus    |               30 |  19.3176144 |   19.345656 |     18.5166 |   16.547592 |    98 |    25 |    29 |     3 | ST63222 |
| Platanus    |               23 |   19.267932 |    19.84248 |   19.028664 |    5.590032 |    45 |    32 |    20 |     1 | ST48754 |
| Platanus    |               25 |    18.28038 |   17.446752 |   17.547336 |   15.368016 |   151 |    42 |    12 |     5 | ST19544 |
| Platanus    | 27.5590551181102 |   17.269968 |   17.187672 |   16.952976 |    7.775448 |   104 |    29 |    25 |     4 | AS05393 |
| Populus     |               22 |    31.85922 |   32.320992 |   31.376112 |   29.193744 |    54 |    15 |    16 |     3 | TS00737 |
| Populus     |               49 |  30.5004216 |   30.376368 |   30.367224 |   23.213568 |    25 |    20 |    31 |     2 | TS00733 |
| Populus     |               44 |  29.7518328 |   29.742384 |   29.492448 |   23.420832 |    47 |    39 |    27 |     1 | TS00748 |
| Populus     |               30 |   28.908756 |   28.571952 |   27.925776 |    27.38628 |    92 |    26 |    24 |     3 | TS00808 |
| Populus     |               30 |  28.2263088 |    27.63012 |   28.120848 |   26.249376 |    96 |    51 |    28 |     6 | ST54418 |
| Populus     |               49 |  27.9160224 |   27.163776 |   27.651456 |    27.95016 |    60 |    57 |    43 |     4 | TP00205 |
| Populus     |               44 |  27.3881088 |   27.227784 |   27.575256 |   25.676352 |    91 |    22 |    28 |     3 | SS00337 |
| Populus     |               27 |  26.2399272 |   26.956512 |   26.828496 |    26.07564 |    34 |    47 |    29 |     3 | TS00728 |
| Populus     |               28 |  26.0143752 |    26.73096 |   26.130504 |   27.300936 |    31 |    32 |    25 |     7 | HF3782  |
| Populus     | 31.1023622047244 |  25.7668776 |   24.792432 |   25.392888 |   25.203912 |    45 |    24 |    28 |     3 | AS00416 |
| Populus     |               26 |  25.5961896 |   25.645872 |   25.886664 |   21.393912 |    79 |    40 |    20 |     4 | ST72301 |
| Populus     |               29 |  25.5120648 |   25.947624 |   25.213056 |   24.545544 |    50 |    29 |    23 |     3 | ST86107 |
| Populus     |               34 |  25.0143264 |   25.264872 |    25.77084 |     24.4602 |    46 |    31 |    28 |     5 | HF269   |
| Populus     |               48 |  24.9640344 |    25.05456 |   24.207216 |    21.54936 |   104 |    26 |    21 |     4 | HF398   |
| Populus     |               52 |  24.9390408 |    25.03932 |   24.438864 |   23.969472 |    38 |    20 |    28 |     3 | ST27721 |
| Populus     |               43 |  24.9000264 |   24.926544 |   24.249888 |   23.433024 |    50 |    57 |    33 |     3 | ST65438 |
| Populus     |               74 |  24.8613168 |    24.03348 |   24.990552 |   25.566624 |    44 |    26 |    31 |     4 | HF4135  |
| Populus     |               40 |   24.638508 |   24.496776 |   24.121872 |   24.390096 |   109 |    27 |    17 |     6 | SS03345 |
| Populus     |               35 |  24.6113808 |     24.5364 |   23.984712 |   23.692104 |    42 |    40 |    30 |     3 | ST72805 |
| Populus     |               31 |  24.3452904 |    24.74976 |   24.451056 |   23.963376 |   112 |    25 |    30 |     4 | ST32217 |
| Populus     | 33.4645669291339 |  23.9106456 |   23.594568 |   23.228808 |   22.878288 |    44 |    16 |    29 |     4 | AS00412 |
| Populus     |               39 |  23.8134144 |   23.228808 |    22.89048 |   20.826984 |    84 |    26 |    23 |     5 | HF1998  |
| Populus     | 40.1574803149606 |  23.7512352 |   23.582376 |   23.481792 |   23.259288 |   146 |    46 |    32 |     4 | AS04580 |
| Populus     |               26 |  23.7177072 |   23.143464 |   22.960584 |   21.659088 |    56 |    15 |    15 |     2 | ST13873 |
| Populus     | 27.9527559055118 |  23.3677968 |   23.579328 |   23.064216 |   22.299168 |    42 |    35 |    24 |     4 | AS04568 |
| Populus     | 43.7007874015748 |  23.3281728 |    22.66188 |   23.457408 |   23.219664 |    63 |    13 |    27 |     2 | AS04633 |
| Populus     | 33.0708661417323 |  23.2937304 |   23.234904 |   22.430232 |    22.03704 |    40 |    29 |    26 |     5 | AS00390 |
| Populus     |               36 |   23.152608 |   23.369016 |   22.954488 |   23.207472 |    86 |    23 |    26 |     2 | ST13168 |
| Populus     |               44 |  23.0837232 |   22.664928 |   22.381464 |   21.360384 |    97 |    37 |    34 |     2 | ST08548 |
| Populus     | 35.8267716535433 |  23.0757984 |   22.686264 |   22.079712 |    20.33016 |    36 |    53 |    30 |     6 | AS00321 |
| Populus     | 36.6141732283465 |  22.9694232 |   23.161752 |   23.140416 |    22.57044 |    33 |    25 |    22 |     5 | AS00307 |
| Populus     |               41 |  22.7627688 |   22.795992 |    23.63724 |   18.095976 |    70 |    21 |    25 |     3 | TS00811 |
| Populus     | 56.2992125984252 |  22.7374704 |   22.213824 |    22.35708 |   21.695664 |    46 |    15 |    33 |     5 | AS00388 |
| Populus     | 50.3937007874016 |   22.614636 |   23.579328 |    22.81428 |   23.381208 |    43 |    49 |    12 |     3 | AS05498 |
| Populus     | 29.9212598425197 |  22.3747584 |   22.643592 |   21.866352 |   21.195792 |   154 |    24 |    21 |     2 | AS00293 |
| Populus     | 32.2834645669291 |  22.3421448 |   22.393656 |   22.597872 |   22.872192 |   100 |    31 |    23 |     3 | AS00252 |
| Populus     |               36 |  22.2281496 |   22.149816 |    21.27504 |   21.314664 |   234 |    29 |    25 |     2 | ST74168 |
| Populus     | 28.3464566929134 |    22.11324 |   21.829776 |   21.756624 |     18.4404 |    52 |    27 |    33 |     3 | AS01542 |
| Populus     |               21 |  22.0181424 |   21.101304 |   21.055584 |    21.00072 |    38 |    28 |    22 |     5 | TP00341 |
| Populus     | 39.7637795275591 |  21.9718128 |   22.073616 |   22.338792 |   21.771864 |    79 |    26 |    29 |     3 | AS00286 |
| Quercus     |               37 |  30.4367184 |   29.556456 |   30.348936 |    29.47416 |    41 |    31 |    25 |     4 | SS01670 |
| Quercus     |               36 |  29.8472352 |   29.876496 |    29.76372 |   20.141184 |    41 |    21 |    24 |     3 | SS01691 |
| Quercus     |               38 |  29.0529264 |   29.099256 |   29.059632 |   28.632912 |   153 |    21 |    17 |     2 | SS01672 |
| Quercus     |               22 |  28.6079184 |   28.069032 |   28.065984 |   27.819096 |    81 |    28 |    10 |     1 | ST27011 |
| Quercus     |               35 |  28.5862776 |   28.989528 |   29.117544 |   29.074872 |    43 |    24 |    15 |     3 | SS01697 |
| Quercus     |               42 |  28.4768544 |   28.181808 |   28.678632 |   27.374088 |   101 |    41 |    26 |     5 | ST27505 |
| Quercus     |               23 |  28.3427424 |   28.325064 |   28.014168 |   26.386536 |    32 |    27 |    14 |     2 | SS01669 |
| Quercus     |               41 |   28.250388 |   28.398216 |   28.264104 |       26.67 |   181 |    18 |    25 |     3 | SS01683 |
| Quercus     |               29 |   28.189428 |    27.38628 |    27.76728 |   27.794712 |    31 |    25 |     6 |     3 | SS01647 |
| Quercus     |               35 |  27.4143216 |   26.423112 |   27.236928 |   25.152096 |   190 |    31 |    21 |     3 | SS01678 |
| Quercus     |               43 |   26.093928 |   25.673304 |   25.447752 |   26.371296 |    15 |    10 |    14 |     4 | SS01663 |
| Quercus     |               28 |  25.9470144 |   26.118312 |   25.624536 |   25.173432 |   149 |    25 |    21 |     4 | SS01784 |
| Quercus     |               23 |  25.9390896 |    25.48128 |   25.901904 |     26.0604 |     8 |    11 |    16 |     6 | SS02122 |
| Quercus     |               31 |  25.8857496 |    25.63368 |   25.886664 |     25.2984 |    72 |    34 |    24 |     3 | ST27506 |
| Quercus     |               23 |   25.728168 |   25.761696 |    25.16124 |   22.530816 |    43 |    22 |    23 |     3 | SS00675 |
| Quercus     |               28 |   25.476708 |   25.456896 |   24.911304 |   24.222456 |    92 |    56 |    24 |     4 | ST27411 |
| Quercus     |               37 |  25.4215392 |   25.667208 |      25.146 |   25.127712 |   119 |    25 |    31 |     5 | ST63185 |
| Quercus     |               32 |  25.1466096 |   25.536144 |    25.84704 |   25.213056 |   131 |    31 |    26 |     4 | SS00335 |
| Quercus     |               34 |  24.7784112 |   24.624792 |   24.822912 |   23.414736 |   102 |    28 |    21 |     5 | ST65806 |
| Quercus     |               26 |  24.6528336 |    24.49068 |   23.871936 |   24.432768 |    38 |    19 |    22 |     4 | SS02128 |
| Quercus     |               23 |  24.5629176 |   23.945088 |   23.826216 |    23.66772 |   229 |    30 |    27 |     4 | SS01705 |
| Quercus     |               25 |  24.5184168 |   24.496776 |   23.920704 |   21.253704 |    44 |    29 |    21 |     3 | SS01946 |
| Quercus     | 55.1181102362205 |  24.5025672 |   24.335232 |   24.606504 |   22.899624 |   110 |    29 |    21 |     3 | AS05417 |
| Quercus     |               29 |    24.48306 |     23.7744 |    23.91156 |   23.640288 |    30 |    15 |    20 |     3 | SS01131 |
| Quercus     |               27 |  24.3705888 |   24.365712 |   23.734776 |   22.671024 |    36 |    30 |    23 |     2 | SS01132 |
| Quercus     |               26 |     24.0411 |   23.387304 |   23.183088 |   20.601432 |    39 |    30 |    20 |     2 | SS01226 |
| Quercus     |               30 |  23.9517936 |   23.908512 |   23.746968 |   23.173944 |    45 |    40 |    10 |     5 | SS01094 |
| Quercus     |               33 |  23.8085376 |    23.91156 |     23.9268 |   23.295864 |   104 |    24 |    28 |     4 | ST63198 |
| Quercus     |               29 |  23.8036608 |   23.369016 |   23.420832 |     23.4696 |    54 |    15 |    23 |     5 | ST63137 |
| Quercus     |               27 |  23.7006384 |   23.341584 |   23.262336 |   22.899624 |    31 |    18 |    21 |     5 | HF850   |
| Quercus     |               29 |  23.6713776 |   23.594568 |   23.039832 |    21.67128 |    49 |    31 |    39 |     4 | ST51714 |
| Quercus     |               23 |  23.6530896 |   23.643336 |   23.061168 |   21.622512 |    84 |    24 |    23 |     4 | SS01777 |
| Quercus     |               30 |  23.4110784 |   23.990808 |   24.252936 |   24.222456 |   109 |    45 |    18 |     6 | ST26917 |
| Quercus     |               25 |   23.391876 |   23.554944 |   22.988016 |   21.918168 |    79 |    21 |    23 |     3 | ST32838 |
| Quercus     |               29 |  23.2483152 |   22.664928 |   22.917912 |   21.409152 |    40 |    26 |    25 |     1 | SS02228 |
| Quercus     |               40 |  23.1849168 |    22.81428 |   22.472904 |   20.613624 |   117 |    29 |    18 |     3 | HF5540  |
| Quercus     |               26 |  23.1620568 |   23.326344 |   22.329648 |   21.820632 |    39 |    25 |    24 |     3 | HF4164  |
| Quercus     |               25 |  23.1538272 |    23.50008 |   22.911816 |   19.516344 |    88 |    45 |    38 |     4 | ST48697 |
| Quercus     |               31 |   23.099268 |    23.14956 |   23.128224 |   23.219664 |    88 |    17 |    14 |     5 | ST32466 |
| Quercus     |               27 |  23.0666544 |   22.485096 |   22.369272 |   21.744432 |    39 |    23 |    22 |     2 | ST33101 |
| Robinia     |               23 |  26.4054336 |   26.740104 |   26.615136 |   24.697944 |    74 |    17 |    18 |     4 | HF4196  |
| Robinia     |               25 |  25.2660912 |   25.667208 |   24.813768 |    21.74748 |    89 |    23 |    28 |     2 | SS00424 |
| Robinia     |               22 |  23.8454184 |   24.725376 |   24.161496 |   23.061168 |   116 |    26 |    23 |     6 | SS00417 |
| Robinia     |               35 |  23.0751888 |   22.856952 |   22.317456 |   17.291304 |   123 |    30 |    33 |     2 | HF2443  |
| Robinia     |               33 |  21.7803984 |   21.616416 |    22.44852 |   19.702272 |    95 |    23 |    22 |     4 | SS00419 |
| Robinia     |               25 |   20.869656 |   21.223224 |    21.42744 |   21.116544 |   104 |    26 |    22 |     4 | HF2193  |
| Robinia     |               31 |  20.4136752 |   20.540472 |   20.080224 |   16.279368 |    42 |    60 |    15 |     4 | ST63779 |
| Robinia     |               22 |  18.0432456 |    18.18132 |   17.269968 |    16.03248 |    37 |    47 |    23 |     3 | TS01198 |
| Robinia     |               28 |  17.9548536 |   17.867376 |   17.087088 |   15.867888 |    50 |    32 |     5 |     4 | HF6070  |
| Robinia     |               38 |  17.6119536 |   18.284952 |    17.72412 |   16.568928 |    49 |    28 |    55 |     3 | ST52517 |
| Robinia     |               24 |   15.364968 |   15.197328 |   15.502128 |    9.534144 |    44 |    59 |    20 |     1 | ST21993 |
| Salix       |               57 |  22.4244408 |   22.140672 |   21.637752 |     21.1074 |    40 |    38 |    26 |     5 | ST52429 |
| Salix       |               38 |  17.2141896 |   17.964912 |   17.407128 |   12.697968 |    51 |    17 |    23 |     2 | HF2538  |
| Tilia       |               23 |   24.987504 |   24.832056 |     24.4602 |   23.460456 |    39 |    42 |    11 |     8 | ST31545 |
| Tilia       |               26 |  23.7841536 |   24.036528 |   23.948136 |   23.170896 |    51 |    50 |    10 |     6 | ST32102 |
| Tilia       |               23 |  23.6619288 |    24.14016 |   24.609552 |   24.451056 |    40 |    35 |    27 |     5 | SS00783 |
| Tilia       |               22 |  23.3053128 |   23.259288 |   23.183088 |   22.710648 |   143 |    25 |    13 |     8 | SS02096 |
| Tilia       |               26 |  22.7886768 |   23.265384 |   23.036784 |   21.790152 |   157 |    53 |    33 |     4 | ST32171 |
| Tilia       |               23 |  22.7359464 |   22.924008 |   22.375368 |    21.83892 |    32 |    30 |    16 |     5 | SS00768 |
| Tilia       |               23 |  22.5442272 |   22.521672 |   22.488144 |    22.06752 |   118 |    32 |    19 |     4 | ST13511 |
| Tilia       |               24 |  22.3503744 |   22.634448 |   22.414992 |    22.92096 |    47 |    46 |    12 |     5 | ST31571 |
| Tilia       |               50 |   22.290024 |    22.49424 |     21.6408 |   16.194024 |    29 |    23 |    19 |     5 | HF4120  |
| Tilia       |               24 |  21.7621104 |   21.988272 |   21.022056 |   17.187672 |    49 |    70 |    29 |     5 | ST12276 |
| Tilia       |               26 |  21.2604096 |     20.8788 |   20.567904 |   19.196304 |   170 |    23 |    21 |     3 | ST33941 |
| Tilia       |               22 |  21.2031072 |   21.421344 |    21.24456 |    20.77212 |    32 |    22 |    24 |     6 | ST31776 |
| Tilia       |               22 |   21.195792 |   21.515832 |   21.180552 |    18.39468 |    30 |    27 |    18 |     2 | ST31811 |
| Tilia       |               38 |  20.9638392 |   21.415248 |   20.839176 |   20.473416 |   129 |    55 |    22 |     6 | ST11027 |
| Tilia       |               26 |  20.9074512 |   21.043392 |   20.321016 |   19.485864 |    39 |    55 |     6 |     4 | ST72751 |
| Tilia       |               34 |   20.700492 |   20.698968 |   19.854672 |   19.229832 |    47 |    28 |    12 |     2 | ST31628 |
| Tilia       |               29 |   20.676108 |   20.205192 |   19.702272 |   20.564856 |    48 |    58 |    12 |     5 | ST72910 |
| Tilia       |               23 |  20.6724504 |   20.958048 |    20.43684 |    11.26236 |    48 |    22 |    15 |     2 | ST09196 |
| Tilia       |               22 |  20.6657448 |   20.409408 |   19.839432 |   19.196304 |   104 |    32 |     8 |     4 | ST10619 |
| Tilia       |               34 |  20.4920088 |   20.750784 |      20.193 |    20.14728 |    28 |    23 |    13 |     5 | ST35978 |
| Tilia       |              121 |  20.3670408 |   20.854416 |   20.845272 |   18.193512 |    31 |    24 |    21 |     8 | HF4127  |
| Tilia       |               26 |  20.3231496 |   20.064984 |   20.098512 |    19.44624 |    50 |     6 |    23 |     4 | ST07731 |
| Tilia       |               30 |  20.2871832 |     20.0406 |   19.348704 |    9.195816 |   252 |    41 |    11 |     2 | ST69814 |
| Tilia       |               28 |  20.2749912 |   20.064984 |   19.452336 |   18.388584 |    46 |    44 |    23 |     3 | ST73073 |
| Tilia       |               29 |  20.2442064 |   20.424648 |   19.458432 |   17.410176 |    51 |    68 |    26 |     3 | ST13064 |
| Tilia       |               38 |   20.194524 |   20.260056 |   21.022056 |   21.165312 |   274 |    29 |    27 |     5 | ST32487 |
| Tilia       |               23 |  20.1216768 |     20.2692 |   19.653504 |   19.235928 |    45 |    46 |    19 |     2 | ST63469 |
| Tilia       |               22 |  20.0165208 |   20.403312 |   19.607784 |   19.062192 |    43 |    53 |    22 |     5 | SS02283 |
| Tilia       |               22 |    19.98726 |   19.671792 |   19.077432 |   15.230856 |   101 |    21 |    14 |     3 | ST80723 |
| Tilia       |               24 |  19.9214232 |   19.854672 |   18.937224 |   18.672048 |   107 |    41 |    13 |     5 | ST70327 |
| Tilia       |               35 |   19.876008 |    19.85772 |   19.123152 |   18.839688 |    34 |    44 |    11 |     3 | ST63658 |
| Tilia       |               22 |  19.8113904 |   20.000976 |   19.031712 |   15.873984 |    50 |    95 |    63 |     3 | ST28139 |
| Tilia       |               27 |   19.702272 |   19.577304 |    18.92808 |   16.968216 |    51 |    92 |    35 |     6 | ST88320 |
| Tilia       |               30 |  19.5538344 |   19.577304 |   18.824448 |   17.836896 |    44 |    24 |     9 |     3 | ST24723 |
| Tilia       |               39 |  19.5334128 |   19.641312 |   19.083528 |   16.425672 |    45 |    46 |    32 |     2 | ST70139 |
| Tilia       |               21 |  19.4687952 |   19.982688 |    20.31492 |    18.88236 |    41 |    46 |    13 |     5 | ST38412 |
| Tilia       |               22 |  19.4273424 |   19.205448 |   18.464784 |   17.858232 |    48 |    39 |    20 |     4 | ST29966 |
| Tilia       |               42 |  19.4245992 |   20.037552 |    19.97964 |   18.336768 |   102 |    30 |    11 |     1 | ST10620 |
| Tilia       |               29 |  19.1984376 |    19.23288 |   19.242024 |    17.48028 |    54 |    27 |    23 |     7 | ST16699 |
| Tilia       |               22 |  19.1152272 |   19.016472 |   18.370296 |   17.522952 |   114 |    41 |    10 |     5 | ST69739 |
| Ulmus       |               26 |  24.3785136 |   23.487888 |   23.433024 |   19.763232 |   109 |    48 |    24 |     7 | SS02680 |
| Ulmus       |               32 |   23.323296 |   23.308056 |   23.070312 |    21.99132 |   116 |    33 |    24 |     4 | ST18253 |
| Ulmus       |               25 |   23.189184 |   23.228808 |    22.92096 |   21.936456 |   128 |    38 |    21 |     4 | SS02999 |
| Ulmus       |               21 |  23.0959152 |   23.295864 |   22.588728 |     22.0218 |    67 |    28 |     9 |     3 | ST48949 |
| Ulmus       |               34 |  22.9307136 |   23.158704 |    23.34768 |   22.530816 |   100 |    62 |    20 |     5 | ST35378 |
| Ulmus       |               41 |  22.6658424 |   22.506432 |   22.122384 |   20.540472 |    45 |    41 |    16 |     2 | ST38524 |
| Ulmus       |               45 |  22.5661728 |   21.985224 |   22.719792 |   22.232112 |    43 |    42 |    14 |     6 | ST33223 |
| Ulmus       |               21 |   22.172676 |   22.064472 |   21.421344 |   19.915632 |    39 |    33 |     9 |     2 | ST31031 |
| Ulmus       |               21 |   21.901404 |    21.77796 |   21.028152 |   18.708624 |   112 |    23 |    19 |     3 | SS01776 |
| Ulmus       |               26 |  21.3311232 |   20.805648 |   21.189696 |   18.641568 |    72 |    16 |    22 |     2 | ST23560 |
| Ulmus       |               35 |  21.3201504 |   21.348192 |   20.409408 |   20.278344 |    89 |    45 |    30 |     4 | ST50747 |
| Ulmus       |               40 |   21.316188 |   21.537168 |   21.354288 |      21.336 |    36 |    31 |    37 |     4 | ST59825 |
| Ulmus       |               39 |   21.151596 |   21.235416 |   21.143976 |   19.540728 |    50 |    85 |    37 |     6 | ST87494 |
| Ulmus       |               28 |  20.9300064 |   20.747736 |   20.631912 |   19.488912 |    75 |    33 |    24 |     4 | ST25867 |
| Ulmus       |               38 |  20.9263488 |    20.90928 |   20.366736 |   19.802856 |    98 |    33 |    31 |     4 | ST57946 |
| Ulmus       |               45 |   20.906232 |   21.073872 |   20.598384 |    19.99488 |   121 |    30 |    29 |     3 | ST08052 |
| Ulmus       |               36 |  20.5956408 |   20.683728 |   20.077176 |    19.32432 |    49 |    33 |    15 |     4 | SS02884 |
| Ulmus       |               34 |  20.4508608 |   20.415504 |   20.244816 |   20.110704 |   119 |    44 |    26 |     2 | ST67878 |
| Ulmus       |               38 |  20.4496416 |   20.705064 |   20.479512 |   19.193256 |    96 |    37 |    28 |     2 | ST35199 |
| Ulmus       |               31 |   20.415504 |   20.290536 |   20.049744 |   19.296888 |   121 |    17 |    19 |     4 | ST38201 |
| Ulmus       |               38 |  20.0860152 |   20.019264 |   20.183856 |   20.506944 |    47 |    10 |    12 |     3 | ST35249 |
| Ulmus       | 25.1968503937008 |  19.8497952 |   19.946112 |   19.129248 |   17.958816 |    81 |    43 |     8 |     3 | AS03174 |
| Ulmus       |               36 |  19.8229728 |   19.424904 |   19.223736 |   18.339816 |    81 |    28 |    25 |     4 | ST35200 |
| Ulmus       |               39 |  19.5321936 |   19.586448 |    18.94332 |   19.366992 |    47 |    33 |    28 |     4 | ST68878 |
| Ulmus       |               21 |  19.5111624 |   19.409664 |   19.104864 |   18.446496 |    47 |    34 |    27 |     6 | ST50224 |
| Ulmus       |               39 |    19.46148 |    19.64436 |   20.445984 |   19.412712 |    92 |    34 |    17 |     3 | ST67662 |
| Ulmus       |               22 |    19.44624 |   19.351752 |   18.946368 |   17.468088 |    93 |    18 |     7 |     3 | HF1876  |
| Ulmus       |               24 |  19.4428872 |    19.52244 |    20.28444 |   20.080224 |   102 |    24 |    31 |     2 | ST52295 |
| Ulmus       |               44 |    19.30908 |   19.379184 |   18.483072 |   17.888712 |   147 |    31 |    38 |     5 | TS01344 |
| Ulmus       |               38 |  19.1606424 |   19.574256 |    18.83664 |   19.696176 |    47 |    50 |    25 |     3 | ST69606 |
| Ulmus       |               38 |  19.1286384 |   19.226784 |    18.47088 |    18.71472 |    46 |    23 |    25 |     2 | ST37025 |
| Ulmus       |               26 |   19.068288 |   18.839688 |     18.5928 |   18.230088 |    44 |    14 |    10 |     5 | ST25260 |
| Ulmus       |               38 |  19.0503048 |    18.86712 |    18.50136 |   18.153888 |    43 |    27 |    29 |     2 | ST36960 |
| Ulmus       |               34 |  19.0030608 |    19.29384 |   18.434304 |   20.281392 |   122 |    58 |    18 |     6 | ST11894 |
| Ulmus       |               34 |  18.9820296 |   18.998184 |   18.955512 |   15.663672 |    46 |    51 |    15 |     3 | ST74592 |
| Ulmus       |               29 |  18.9780672 |    19.09572 |    18.92808 |   18.062448 |   125 |    39 |    27 |     2 | ST08579 |
| Ulmus       |               31 |  18.9442344 |   18.891504 |   19.178016 |    18.37944 |   107 |    34 |    25 |     4 | ST67931 |
| Ulmus       |               31 |  18.8951616 |    19.14144 |   18.617184 |   19.251168 |   109 |    43 |    15 |     2 | ST39299 |
| Ulmus       |               33 |  18.8741304 |   18.845784 |     18.4404 |   16.983456 |   135 |    16 |    14 |     4 | ST48838 |
| Ulmus       |               24 |   18.809208 |   18.665952 |   19.223736 |    18.92808 |    46 |    24 |    28 |     4 | ST24951 |
#+END_SRC

**** revised extraction using just the trees identified as not growing above

#+begin_src R
no.grow.uid <- hg$uid
#+end_src

#+RESULTS:

#+begin_src R
    library(raster)
    library(dplyr)
    library(stringr)
    library(foreach)
    library(doParallel)

    b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
    b@data <- select(b@data, UID)


                                            #uids <- c("ST14603", "ST14604", "ST14599", "ST14547")

    fs2017 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2017_normlas/", full.names = F)
    fs2016 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2016_normlas/", full.names = F)
    fs2009 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_normlas/", full.names = F)
    fs2005 <- list.files("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2005_normlas/", full.names = F)

                                            #make sure there is only one of each trees
    uids2017 <- str_extract(fs2017, "^[A-Za-z0-9]+")
    head(sort(table(uids2017), decreasing = T))

    uids2016 <- str_extract(fs2016, "^[A-Za-z0-9]+")
    head(sort(table(uids2016), decreasing = T))

    uids2009 <- str_extract(fs2009, "^[A-Za-z0-9]+")
                                            #head(sort(table(uids2009), decreasing = T), 1800)
    head(sort(table(uids2009), decreasing = T))

    uids2005 <- str_extract(fs2005, "^[A-Za-z0-9]+")
    head(sort(table(uids2005), decreasing = T))

                                            # put all the uids and las paths for ecah year in a dataframe to loop through

    uids2017 <- data.frame(str_match(fs2017, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2017) <- c("path2017", "uid")

    uids2016 <- data.frame(str_match(fs2016, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2016) <- c("path2016", "uid")

    uids2009 <- data.frame(str_match(fs2009, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2009) <- c("path2009", "uid")
                                            # remove duplicates for 2009
    uids2009 <- uids2009 %>% group_by(uid) %>% summarize(path2009 = path2009[1])


    uids2005 <- data.frame(str_match(fs2005, "([A-Za-z0-9]+)_.*"), stringsAsFactors = F)
    colnames(uids2005) <- c("path2005", "uid")


    uids_df <- left_join(uids2017, uids2016)
    uids_df <- left_join(uids_df, uids2009)
    uids_df <- left_join(uids_df, uids2005)


    uids_df <- uids_df[complete.cases(uids_df),]

  ###################### filter the uids to the ones identified above
  uids_df <- filter(uids_df, uid %in% no.grow.uid)



    treelasdir <- "/home/erker/hgt_data/madison_tree_inventories/hgt/"
    reps <- 1000

    cl <- makeCluster(6)
    registerDoParallel(cl)

    out <- foreach(i = (1:nrow(uids_df)), .packages = c("stringr","lidR", "rgeos"), .combine = "rbind") %dopar% {  

        path2017 <- paste0(treelasdir, "trees_2017_normlas/", uids_df$path2017[i])
        path2016 <- paste0(treelasdir, "trees_2016_normlas/", uids_df$path2016[i])
        path2009 <- paste0(treelasdir, "trees_2009_normlas/", uids_df$path2009[i])
        path2005 <- paste0(treelasdir, "trees_2005_normlas/", uids_df$path2005[i])

        l2017 <- readLAS(path2017, select = "")
        l2017@data$Z <-     l2017@data$Z  * .3048  # convert to meters
     
        l2016 <- readLAS(path2016, select = "")
        l2016@data$Z <-     l2016@data$Z  * .3048  # convert to meters
     
        l2009 <- readLAS(path2009, select = "")
        l2009@data$Z <-     l2009@data$Z  * .3048  # convert to meters
     
        l2005 <- readLAS(path2005, select = "")
        l2005@data$Z <-     l2005@data$Z  * .3048  # convert to meters
     

        Z <- c(l2017@data$Z, l2016@data$Z, l2009@data$Z, l2005@data$Z)
        mZ <- max(Z)

        n <- 1:length(Z)
        bias <- sapply(n, function(n) {replicate(reps, mZ - max(sample(Z, n, replace = T)))})

      
        mean_bias <- apply(bias, 2, mean)
        sd_bias <- apply(bias, 2, sd)


        res <- data.frame(uid = uids_df[i,"uid"],
                          maxZ = mZ,
                          sample_size = n,
                          mean_bias = mean_bias,
                          sd_bias = sd_bias,
                          stringsAsFactors = F)

        saveRDS(res, paste0("/home/erker/hgt_data/madison_tree_inventories/hgt/nogrow_extracted_heights_bias/", uids_df[i,"uid"], ".rds"))
        return(res)

    }
    closeAllConnections()

  saveRDS(out, "/home/erker/hgt_data/madison_tree_inventories/hgt/nogrow_extracted_heights_bias.rds")

#+end_src

**** plotting
#+begin_src R
        trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")

      ngh <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/nogrow_extracted_heights_bias.rds")
      ngh <- left_join(ngh, select(unique(trees@data), UID, Genus), by = c("uid" = "UID")) # use unique because for some reason there are duplicate trees

    # make the bias negative
    ngh$mean_bias <- -1 * ngh$mean_bias 

  # convert n points to point density
  ngh$pulse_density <- ngh$sample_size / ((8 * .3048)^2 * pi)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/ng_bias_n.png :width 1200 :bg transparent :res 120 :height 600
nghg <- filter(ngh, Genus %in% c("Acer", "Fraxinus", "Gleditsia", "Pinus", "Quercus", "Populus", "Tilia", "Ulmus"))
  ggplot(nghg, aes(x = pulse_density, y = mean_bias, group = uid, color = Genus, ymin = mean_bias - sd_bias, ymax = mean_bias + sd_bias)) + 
      geom_line() + 
      facet_wrap(~Genus, ncol = 4) +
      coord_cartesian(y = c(-5, 0), x = c(0,2)) +
      scale_color_brewer(palette = "Dark2") +
      theme_tufte(base_size = 16) +
      theme(legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          axis.ticks = element_line(size = .3), 
          panel.grid.major = element_line(color = "#839496", size = .1),
          panel.grid.minor = element_line(color = "#839496", size = .05)) +
    scale_x_continuous(name = "Pulse Density (pulses / m^2)") +
    scale_y_continuous(name = "Height Bias (m)")


#+end_src

#+RESULTS:
[[file:figs/ng_bias_n.png]]

[[file:figs/ng_bias.png]]

#+begin_src R :exports results :results graphics :file figs/ng_bias_focus1.png :width 1000 :bg transparent :res 100 :height 800

  ggplot(ngh, aes(x = pulse_density, y = mean_bias, group = uid, color = Genus, ymin = mean_bias - sd_bias, ymax = mean_bias + sd_bias)) + 
      #geom_ribbon(color = base1) + 
      geom_line() + 
      facet_wrap(~Genus) +
      coord_cartesian(y = c(-2, 0), x = c(0,2)) +
      terk

#+end_src

#+RESULTS:
[[file:figs/ng_bias_focus1.png]]

#+begin_src R :exports results :results graphics :file figs/ng_bias_focus1_commonGenera.png :width 1000 :bg transparent :res 120 :height 800
  dp <- filter(ngh, Genus %in% c("Acer", "Gleditsia", "Fraxinus"))
    ggplot(dp, aes(x = pulse_density, y = mean_bias, group = uid, color = Genus, ymin = mean_bias - sd_bias, ymax = mean_bias + sd_bias)) + 
#        geom_ribbon(color = base1) + 
        geom_line() + 
  #      facet_wrap(~Genus) +
        coord_cartesian(y = c(-2, 0), x = c(0,2)) +
        scale_color_solarized() +
        terk 

#+end_src

#+RESULTS:
[[file:figs/ng_bias_focus1_commonGenera.png]]

#+begin_src R :exports results :results graphics :file figs/ng_bias_focus1_otherGenera1.png :width 1000 :bg transparent :res 120 :height 800
  dp <- filter(ngh, Genus %in% c("Acer", "Gymnocladus"))
    ggplot(dp, aes(x = pulse_density, y = mean_bias, group = uid, color = Genus, ymin = mean_bias - sd_bias, ymax = mean_bias + sd_bias)) + 
#        geom_ribbon(color = base1) + 
        geom_line() + 
  #      facet_wrap(~Genus) +
        coord_cartesian(y = c(-2, 0), x = c(0,2)) +
        scale_color_solarized() +
        terk 

#+end_src

#+RESULTS:
[[file:figs/ng_bias_focus1_otherGenera1.png]]

[[file:figs/ng_bias_focus1_otherGenera1.png]]

#+begin_src R
  nghs <-   ngh %>% group_by(sample_size, Genus) %>%
      summarize(mean_mean_bias = mean(mean_bias),
                se_mean_bias = sd(mean_bias) / (n() - 1),
                mean_sd_bias = sqrt(mean(sd_bias^2))) %>%
    mutate(point_density = sample_size / ((8 * .3048)^2 * pi))


#+end_src

#+RESULTS:


#+begin_src R :exports results :results graphics :file figs/avg_bias_focus1_otherGenera2_n.png :bg transparent :width 1000 :res 120

                                          #pd <-  filter(nghs, Genus %in% c("Fraxinus", "Acer", "Gleditsia", "Ginkgo", "Gymnocladus", "Picea", "Pinus", "Quercus", "Platanus", "Populus", "Juglans"))
  pd <- filter(nghs, Genus %in% c("Acer", "Fraxinus", "Gleditsia", "Pinus", "Quercus", "Populus", "Tilia", "Ulmus"))
                                          #  pd2 <-  filter(nghs, !Genus %in% c("Carya", "Salix", "Thuja"), point_density < 1.1, point_density > .9)

  p <-     ggplot(pd, aes(x = point_density, y = mean_mean_bias, ymax = mean_mean_bias + 1*se_mean_bias, ymin = mean_mean_bias - 1*se_mean_bias, color = Genus, fill = Genus)) +
      geom_ribbon(alpha = .2, color = NA) +
      geom_line() +
      coord_cartesian(y = c(0, -3), x = c(0,1)) +
      scale_color_brewer(palette = "Dark2") +
      scale_fill_brewer(palette = "Dark2") +
      theme_tufte(base_size = 16) +
      theme(legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          legend.position = c(.875, .4),
          axis.ticks = element_line(size = .3), 
          panel.grid.major = element_line(color = "#839496", size = .1),
          panel.grid.minor = element_line(color = "#839496", size = .05)) +
    scale_x_continuous(name = "Pulse Density (pulses / m^2)") +
    scale_y_continuous(name = "Mean Height Bias (m)")


  p

#+end_src

#+RESULTS:
[[file:figs/avg_bias_focus1_otherGenera2_n.png]]



[[file:figs/avg_bias_focus1_otherGenera2_.png]]
#+begin_src R :exports results :results graphics :file figs/avg_bias_focus1_otherGenera1.pngvg_.png :bg transparent :width 1000 :res 120


p <-     ggplot(nghs, aes(x = point_density, y = mean_mean_bias, ymax = mean_mean_bias + 2*se_mean_bias, ymin = mean_mean_bias - 2*se_mean_bias, color = Genus, fill = Genus)) +
      geom_line() +
          coord_cartesian(y = c(0, -5), x = c(0,3)) +
          terk 

p

#+end_src

#+RESULTS:
[[file:figs/avg_bias_focus1_otherGenera1.pngvg_.png]]

#+begin_src R
library(plotly)
ggplotly(p)
#+end_src

#+RESULTS:

**** save new correction

Calculate the mean bias for each Genus.  This is the correction that
I will apply to the data
#+begin_src R
  nghg <-   ngh %>% 
        group_by(Genus, sample_size, pulse_density) %>%
        summarize(bias = mean(mean_bias),
                  sd_bias = mean(sd_bias))

  saveRDS(nghg, "/home/erker/hgt_data/madison_tree_inventories/hgt/no_growth_bias.rds")
#+end_src

#+RESULTS:
**** apply new correction
Apply the species specific correction derived from large not growing
trees to the data.

Reading back in the extracted heights
#+begin_src R
    trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")
    h <-   readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias.rds")
    h <- left_join(h, select(unique(trees@data), UID, Genus), by = c("uid" = "UID")) # use unique because for some reason there are duplicate trees

  bias <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/no_growth_bias.rds")

  hy <- h %>%
    select(emp_max2017, emp_max2016, emp_max2009, emp_max2005, Genus, uid) %>%
    gather(year, emp_height, -Genus, -uid) %>%
        mutate(year = as.numeric(str_extract(year, "[0-9]{4}")))

  hn <- h %>%
        select(n2017, n2016, n2009, n2005, Genus, uid) %>%
    gather(year, sample_size, -Genus, -uid) %>%
        mutate(year = as.numeric(str_extract(year, "[0-9]{4}")))

  hg <- left_join(hy, hn)

  d <- left_join(hg, bias)

  d <- d %>%
      mutate(cor_height = emp_height - bias)

#+end_src

#+RESULTS:
: 
: Joining, by = c("Genus", "uid", "year")
: 
: Joining, by = c("Genus", "sample_size")

#+begin_src R
saveRDS(d, "/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_longform.rds")
#+end_src

#+RESULTS:

#+begin_src R
  library(ggthemes)
      terk <- list(theme_solarized_2(base_size = 16) +
                   theme(legend.title = element_text(size = 10),
                         legend.text = element_text(size = 8),
                         axis.ticks = element_line(size = .3),
                         rect = element_rect(fill = "transparent"),
                         panel.background = element_rect(fill = "transparent"),
                         panel.grid.major = element_line(color = "#839496", size = .1),
                         panel.grid.minor = element_line(color = "#839496", size = .05)))

  base1 <- "#93a1a1"
  blue <- scale_color_solarized("blue")

  red <- solarized_pal("red")(1)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/correction_nogrowth_40_n.png :width 1300 :height 800 :bg transparent :res 100

  n <- 40
  set.seed(6)
  uids <- sample(unique(h$uid), n)
  df <- filter(d, uid %in% uids)

    ggplot(data = df) + 
        geom_line(aes(y = emp_height, x = year, group = uid), color = base1) +
        geom_line(aes(y = cor_height, x = year, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sd_bias, ymin = cor_height - 1.96 *sd_bias, x = year), color = red) + 
        facet_wrap(~uid, ncol = 8) +
        terk +
        scale_x_continuous(breaks = c(2005,2009, 2017)) +
        theme(axis.text.x = element_text(angle = 60, hjust = 1))


#+end_src

#+RESULTS:
[[file:figs/correction_nogrowth_40_n.png]]





**** compare the two corrections
| [[file:figs/correction_nogrowth_40.png]] | [[file:figs/correction_oldway.png]] |

**** Fitting many weighted regressions and getting estimates
#+begin_src R
  d <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_longform.rds")
    d$year <- d$year - 2005

    # filter the trees out that aren't in the spceies that we ahve corrections for 
    d <- d[complete.cases(d),]

            lms <- list()
            uids <- unique(d$uid)
          for(i in 1:length(uids)) {
                lms[[i]] <- lm(cor_height ~ year, weights = 1/ sd_bias^2, data = subset(d, uid == uids[i]))
            }
      names(lms) <- uids
        saveRDS(lms, "/home/erker/hgt_data/madison_tree_inventories/hgt/ng_growth_rates_lms.rds")
#+end_src

#+begin_src R
  lms <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/ng_growth_rates_lms.rds")
  growth.rates <- sapply(lms, function(lm) coef(lm)[2])
  growth.rates.se <- sapply(lms, function(lm) summary(lm)$coefficients[2,2])
  est.hgt.at2005 <- sapply(lms, function(lm) coef(lm)[1])
  growth.rates <- data.frame(uid = names(lms), 
                             growth.rate = growth.rates, 
                             growth.rate.se = growth.rates.se, 
                             est.hgt.at2005 = est.hgt.at2005, stringsAsFactors = F)
#+end_src

#+RESULTS:

***** fit non weighed regression on original heigthts to see the magnitude of the difference.
#+begin_src R :eval no
  d <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_longform.rds")
    d$year <- d$year - 2005

    # filter the trees out that aren't in the spceies that we ahve corrections for 
    d <- d[complete.cases(d),]

            lms <- list()
            uids <- unique(d$uid)
          for(i in 1:length(uids)) {
                lms[[i]] <- lm(emp_height ~ year, data = subset(d, uid == uids[i]))
            }
      names(lms) <- uids
        saveRDS(lms, "/home/erker/hgt_data/madison_tree_inventories/hgt/ng_growth_rates_lms_emp_noweight.rds")
#+end_src

#+begin_src R :eval no
  lms <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/ng_growth_rates_lms_emp_noweight.rds")
  growth.rates <- sapply(lms, function(lm) coef(lm)[2])
  growth.rates.se <- sapply(lms, function(lm) summary(lm)$coefficients[2,2])
  est.hgt.at2005 <- sapply(lms, function(lm) coef(lm)[1])
  growth.rates <- data.frame(uid = names(lms), 
                             growth.rate = growth.rates, 
                             growth.rate.se = growth.rates.se, 
                             est.hgt.at2005 = est.hgt.at2005, stringsAsFactors = F)
#+end_src

#+RESULTS:
: 
: Warning messages:
: 1: In summary.lm(lm) : essentially perfect fit: summary may be unreliable
: 2: In summary.lm(lm) : essentially perfect fit: summary may be unreliable

**** dropping trees with impossible growth or removal and replacements
#+begin_src R
    d <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_longform.rds")
    d <- d[complete.cases(d),]
      d$year <- d$year - 2005
      ds <- d %>% select(uid, year, emp_height) %>% pivot_wider(names_from = year, values_from = emp_height)

      bad_uids <- ds %>%
          mutate(dif1716_big = abs(`12` - `11`) > 1.5,
                 dif1609_big = abs(`11` - `4`) > 10,
                 dif1609_vryneg = `11` - `4` <  -2,
                 dif0905_vryneg = `4` - `0` <  -2) %>%
          filter(dif1716_big == T | dif1609_big == T | dif1609_vryneg | dif0905_vryneg) %>%
          pull(uid)

  growth.rates.f <- filter(growth.rates, ! uid %in% bad_uids)

  d <- filter(d, ! uid %in% bad_uids)

#+end_src

#+RESULTS:

**** replotting height by year for some trees with weighted ols line
#+begin_src R
library(ggplot2)
    library(ggthemes)
        terk <- list(theme_solarized_2(base_size = 16) +
                     theme(legend.title = element_text(size = 10),
                           legend.text = element_text(size = 8),
                           axis.ticks = element_line(size = .3),
                           rect = element_rect(fill = "transparent"),
                           panel.background = element_rect(fill = "transparent"),
                           panel.grid.major = element_line(color = "#839496", size = .1),
                           panel.grid.minor = element_line(color = "#839496", size = .05)))

    base1 <- "#93a1a1"
  base01 <- "#586e75"
    blue <- scale_color_solarized("blue")
    red <- solarized_pal("red")(1)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/correction_nogrowth_40_m.png :width 1300 :height 800 :bg transparent :res 100

  n <- 40
  set.seed(2)
  uids <- sample(unique(d$uid), n)
  df <- filter(d, uid %in% uids)

    ggplot(data = df) + 
        geom_line(aes(y = emp_height, x = year + 2005, group = uid), color = "darkgray") +
        geom_line(aes(y = cor_height, x = year + 2005, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sd_bias, ymin = cor_height - 1.96 *sd_bias, x = year + 2005), color = red) + 
        facet_wrap(~uid, ncol = 8) +
      theme_tufte(base_size = 16) +
      theme(legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          axis.ticks = element_line(size = .3), 
          panel.grid.major = element_line(color = "#839496", size = .1),
          panel.grid.minor = element_line(color = "#839496", size = .05),
          axis.text.x = element_text(angle = 60, hjust = 1)) +
        scale_x_continuous(name = "year", breaks = c(2005,2009, 2017)) +
        scale_y_continuous(name = "height (m)") 




#+end_src

#+RESULTS:
[[file:figs/correction_nogrowth_40_m.png]]


#+begin_src R :exports results :results graphics :file figs/correction_nogrowth_40_m_smooth_lm.png :width 1300 :height 800 :bg transparent :res 100

  n <- 40
  set.seed(7)  # 7 is a good seed for visualizing a range of situations.  y axis is nice scale too.
  uids <- sample(unique(d$uid), n)
  df <- filter(d, uid %in% uids)

  base01 <- "#586e75"

    ggplot(data = df) + 
      stat_smooth(method = "lm", aes(y = emp_height, x = year + 2005, group = uid), color = base01, size = .5, se = F) +
      stat_smooth(method = "lm", aes(y = cor_height, x = year + 2005, weight = (1 / sd_bias^2), group = uid), fill = "red", alpha = .2, color = red, size = .5, se = T) +
        geom_point(aes(y = emp_height, x = year + 2005, group = uid), color = base01) +
        geom_point(aes(y = cor_height, x = year + 2005, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sd_bias, ymin = cor_height - 1.96 *sd_bias, x = year + 2005), color = red) + 
        facet_wrap(~uid, ncol = 8) +
        scale_x_continuous(name = "year",breaks = c(2005,2009, 2017)) +
        scale_y_continuous(name = "height (m)") +
      theme_tufte(base_size = 16) +
      theme(legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          axis.ticks = element_line(size = .3), 
          panel.grid.major = element_line(color = "#839496", size = .1),
          panel.grid.minor = element_line(color = "#839496", size = .05),
          axis.text.x = element_text(angle = 60, hjust = 1)) 




#+end_src

#+RESULTS:
[[file:figs/correction_nogrowth_40_m_smooth_lm.png]]

[[file:figs/correction_nogrowth_40_m_smooth_lm.png]]

there are many possible conditions. assume linear growth over 12 year
period, it would be difficult to identify a nonlinear relationship
with only 4 observations per tree.
#+begin_src R :exports results :results graphics :file figs/correction_nogrowth_m_smooth_lm_specificsample.png :width 1000 :height 260 :bg transparent :res 100

      uids <- c("ST03542",  # possible overcorrection
                "ST20636", # over corrected 2005, but weighted regression gives realistic growth line
                "ST05216",   # little change, but does make the slope slightly negative.
                "ST89566",   # 2005 very low, correction looks nice, 
                "ST20161")  # 2005 empirical height looks very biased low, correction and weighted regression makes more realistic plot
      df <- filter(d, uid %in% uids)

      base01 <- "#586e75"

    dfp <- select(df, uid, year, cor_height, emp_height) %>%
        gather(type, height, -uid, -year)

        ggplot(data = df) + 
          stat_smooth(method = "lm", aes(y = emp_height, x = year + 2005, group = uid), color = base01, size = .5, se = F) +
          stat_smooth(method = "lm", aes(y = cor_height, x = year + 2005, weight = (1 / sd_bias^2), group = uid), fill = "red", alpha = .2, color = red, size = .5, se = T) +
            geom_linerange(aes(ymax = cor_height + 1.96 * sd_bias, ymin = cor_height - 1.96 *sd_bias, x = year + 2005), color = red) + 
            geom_point(data = dfp, aes(y = height, x = year + 2005, group = uid, color = type), alpha = .8) +
            facet_wrap(~uid, ncol = 10) +
            scale_x_continuous(name = "year",breaks = c(2005,2009, 2017)) +
            scale_y_continuous(name = "height (m)") +
            scale_color_manual(values = c(red, base01), labels = c("bias corrected", "empirical"), name = "") +
  #        annotate("text", label = "bias corrected", color = red, x = 2008, y = 20) +
          theme_tufte(base_size = 16) +
          theme(legend.title = element_blank(),
              legend.text = element_text(size = 14),
              axis.ticks = element_line(size = .3), 
              panel.grid.major = element_line(color = "#839496", size = .1),
              panel.grid.minor = element_line(color = "#839496", size = .05),
              axis.text.x = element_text(angle = 60, hjust = 1)) 




#+end_src

#+RESULTS:
[[file:figs/correction_nogrowth_m_smooth_lm_specificsample.png]]


#+begin_src R :exports results :results graphics :file figs/correction_nogrowth_80_m_smooth_lm.png :width 1500 :height 1500 :bg transparent :res 100

  n <- 80
  set.seed(8)  # 7 is a good seed for visualizing a range of situations.  y axis is nice scale too.
  uids <- sample(unique(d$uid), n)
  df <- filter(d, uid %in% uids)

  base01 <- "#586e75"

    ggplot(data = df) + 
      stat_smooth(method = "lm", aes(y = emp_height, x = year + 2005, group = uid), color = base01, size = .5, se = F) +
      stat_smooth(method = "lm", aes(y = cor_height, x = year + 2005, weight = (1 / sd_bias^2), group = uid), fill = "red", alpha = .2, color = red, size = .5, se = T) +
        geom_point(aes(y = emp_height, x = year + 2005, group = uid), color = base01) +
        geom_point(aes(y = cor_height, x = year + 2005, group = uid), color = red) +
        geom_linerange(aes(ymax = cor_height + 1.96 * sd_bias, ymin = cor_height - 1.96 *sd_bias, x = year + 2005), color = red) + 
        facet_wrap(~uid, ncol = 10) +
        scale_x_continuous(name = "year",breaks = c(2005,2009, 2017)) +
        scale_y_continuous(name = "height (m)") +
      theme_tufte(base_size = 16) +
      theme(legend.title = element_text(size = 15),
          legend.text = element_text(size = 12),
          axis.ticks = element_line(size = .3), 
          panel.grid.major = element_line(color = "#839496", size = .1),
          panel.grid.minor = element_line(color = "#839496", size = .05),
          axis.text.x = element_text(angle = 60, hjust = 1)) 




#+end_src

#+RESULTS:
[[file:figs/correction_nogrowth_80_m_smooth_lm.png]]

**** plots of growth rates

***** histogram
#+begin_src R :exports results :results graphics :file figs/ng_growthrates_lm_clip_n.png :width 1000 :res 120 :bg transparent
  ggplot(growth.rates.f, aes(x = 100 * growth.rate)) + geom_histogram(binwidth = 2, color = base1) +
    terk +
    scale_x_continuous("growth rate (cm/year)", lim = c(-100,100), breaks = c(-100,-50,0, round(mean(growth.rates$growth.rate * 100),1), 50, 100)) +
    geom_vline(data = growth.rates, aes(xintercept = mean(growth.rate)*100), color = red)
#+end_src

#+RESULTS:
[[file:figs/ng_growthrates_lm_clip_n.png]]



[[file:figs/ng_growthrates_lm_clip_n_emphgt_noweight.png]]


[[file:figs/ng_growthrates_lm_clip.png]]

***** plot suspect growth rates
#+begin_src R :exports results :results graphics :file figs/correction_nogrowth_suspect_high.png :width 1300 :height 800 :bg transparent :res 100
  d <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/extracted_heights_bias_longform.rds")
    dn <- left_join(d, growth.rates.f)

  dn <- dn[complete.cases(dn),]

      df <- dn[dn$growth.rate < -.4,]

        ggplot(data = df) + 
            geom_line(aes(y = emp_height, x = year, group = uid), color = base1) +
            geom_line(aes(y = cor_height, x = year, group = uid), color = red) +
            geom_linerange(aes(ymax = cor_height + 1.96 * sd_bias, ymin = cor_height - 1.96 *sd_bias, x = year), color = red) + 
            facet_wrap(~uid, ncol = 8) +
            scale_x_continuous(breaks = c(2005,2009, 2017)) +
            theme_minimal() +
              theme(axis.text.x = element_text(angle = 60, hjust = 1))


#+end_src

#+RESULTS:
[[file:figs/correction_nogrowth_suspect_high.png]]

***** growth by height 
#+begin_src R :exports results :results graphics :file figs/ng_rate_by_int.png :bg transparent :width 1000 :res 100
  hn <- left_join(h, growth.rates.f)

    ggplot(hn, aes(x = emp_max2005, y = growth.rate)) + geom_point(size = .5, alpha = .5) + 
      geom_smooth() #+
#      facet_wrap(~abs(growth.rate.se / growth.rate) < .1, ncol = 2)
#+end_src

#+RESULTS:
[[file:figs/ng_rate_by_int.png]]


#+begin_src R
saveRDS(hn, "/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds")
#+end_src

#+RESULTS:

***** growth in space
join growth rates to trees

#+begin_src R
    library(raster)
    trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")

  trees <- spTransform(trees, "+init=epsg:7599")

    hn <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds")

    trees@data <- left_join(trees@data, hn, by = c("UID" = "uid"))

    shapefile(trees, "/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_Withlidarextractedheights_growthrates_corrFromNoGrowth.rds", overwrite = T)

#+end_src

#+RESULTS:
: 
: Warning message:
: In rgdal::writeOGR(x, filename, layer, driver = "ESRI Shapefile",  :
:   Field names abbreviated for ESRI Shapefile driver

#+begin_src R
  tdf <- data.frame(trees) %>%
    filter(!is.na(growth.rate))
#+end_src

#+RESULTS:

#+begin_src R
  library(ggthemes)
      terk <- list(theme_solarized_2(base_size = 16) +
                   theme(legend.title = element_text(size = 10),
                         legend.text = element_text(size = 8),
                         axis.ticks = element_line(size = .3),
                         rect = element_rect(fill = "transparent"),
                         panel.background = element_rect(fill = "transparent"),
                         panel.grid.major = element_line(color = "#839496", size = .1),
                         panel.grid.minor = element_line(color = "#839496", size = .05)))

      terklight <- list(theme_minimal(base_size = 16) +
                   theme(legend.title = element_text(size = 10),
                         legend.text = element_text(size = 8),
                         axis.ticks = element_line(size = .3),
                         rect = element_rect(fill = "transparent"),
                         panel.background = element_rect(fill = "transparent"),
                         panel.grid.major = element_line(color = "#839496", size = .2),
                         panel.grid.minor = element_line(color = "#839496", size = .1)))


  base1 <- "#93a1a1"
#  blue <- scale_color_solarized("blue")
  green <- solarized_pal("green")(1)
  red <- solarized_pal("red")(1)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/trees_growth.png :width 1000 :height 800 :bg transparent
  p <-   ggplot(tdf, aes(x = coords.x1, y = coords.x2, color = growth.rate)) + geom_point(size = .8, alpha = .8) +
      coord_equal() +
      terklight +
      scale_color_distiller(limits = c(-.3, .3), direction = 1, palette = "RdYlGn")
  p
#+end_src

#+RESULTS:
[[file:figs/trees_growth.png]]
#+begin_src R
ggplotly(p)
#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/trees_growth_bin.png :width 1000 :height 800 :bg transparent :res 100
  tdf <- tdf %>%
    mutate(growth = ifelse(growth.rate > median(growth.rate), "high", ifelse(growth.rate < 0, "no", "low")))

    p <-   ggplot(tdf, aes(x = coords.x1, y = coords.x2, color = growth)) + geom_point(size = .4, alpha = .8) +
        coord_equal() +
        terk +
        scale_color_brewer(palette = "RdYlGn", direction = -1)
    p
#+end_src

#+RESULTS:
[[file:figs/trees_growth_bin.png]]

***** growth by species
#+begin_src R
    hn <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds")

hn <- hn[complete.cases(hn),]

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/growth_species.png :bg transparent :width 1000
  ggplot(hn, aes(y = growth.rate, x = Genus)) + geom_boxplot() +
    stat_summary(fun.y = "mean", geom = "point", color = red) +
  terklight
#+end_src

#+RESULTS:
[[file:figs/growth_species.png]]

#+begin_src R :exports results :results graphics :file figs/growth_species_mean.png :bg transparent :width 1000 :res 120
  library(Hmisc)
  library(forcats)

  hns <- hn %>%
    group_by(Genus) %>%
      dplyr::summarize(mgr = mean(growth.rate),
                n = n(),
                se = sd(growth.rate) / sqrt(n)) %>%
    mutate(Genus = fct_reorder(Genus, mgr))


      ggplot(hns, aes(x = Genus, y = mgr, ymin = mgr - 1.96 * se, ymax = mgr + 1.96 * se)) +  geom_pointrange() +
        terklight +
        coord_flip()
#+end_src

#+RESULTS:
[[file:figs/growth_species_mean.png]]


#+begin_src R :exports results :results graphics :file figs/growth_species_mean_sizeclass.png :bg transparent :width 1000 :res 120
  library(Hmisc)
  library(forcats)

  hns <- hn %>%
    mutate(size_class = ifelse(emp_max2005 < 10, "small", ifelse(emp_max2005 > 20, "large", "medium"))) %>%
    group_by(Genus, size_class) %>%
      dplyr::summarize(mgr = mean(growth.rate),
                n = n(),
                se = sd(growth.rate) / sqrt(n)) %>%
    ungroup() %>%
    mutate(Genus = fct_reorder(Genus, mgr))


      ggplot(hns, aes(x = Genus, y = mgr, ymin = mgr - 1.96 * se, ymax = mgr + 1.96 * se)) +  geom_pointrange() +
        terklight +
        coord_flip() + 
        facet_wrap(~ size_class, ncol = 3)
#+end_src

#+RESULTS:
[[file:figs/growth_species_mean_sizeclass.png]]

#+begin_src R :exports results :results graphics :file figs/growth_species_mean_sizeclass2.png :width 1000 :res 120 :bg transparent

  ggplot(hns, aes(x = Genus, y = mgr, ymin = mgr - 1.96 * se, ymax = mgr + 1.96 * se, color = size_class)) +  geom_pointrange() +
    terklight +
    coord_flip()

#+end_src

#+RESULTS:
[[file:figs/growth_species_mean_sizeclass2.png]]

***** make a model and plot species effect controling for height  I SHOULD JOIN ALL THE DATA (hyperspectral etc first before I do modelling).

#+begin_src R

#+end_src

** example trees for visualization
*** crop lidar to the tenney oak for visualization of bias situation.

I could make a 2d plot of the points (z on y axis and 


My resampling strategy doesn't work becuase while the larger foot
print might underestimate height according to roussel (see his paper),
it also means that the points don't penetrate as deeply.  So when I
resample from the 2017 which has a smaller footprint and deeper
penetration into the canopy, I can potentially sample points lower
than I would ever get from 2005 lidar.  But maybe this doesn't matter
since I'm not interested in the mean, but rather the maximum.


#+begin_src R
  library(lidR)
  library(dplyr)
    l2017 <- readLAS("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/0823_esri_normalized.las", select = "r")
    l2016 <- readLAS("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar/102_normalized.las", select = "r")
    l2009 <- readLAS("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/lc2t70912f_normalized.las", select = "r")
    l2005 <- readLAS("/home/erker/hgt_data/madison_lidar_2005_heights/normalized/tile014_ground_normalized.las", select = "r")


    tenney_oak <- shapefile("/home/erker/hgt_data/example_trees/tenney_oak.shp")

    o2017 <- lasclip(l2017, tenney_oak)
    o2016 <- lasclip(l2016, tenney_oak)
    o2009 <- lasclip(l2009, tenney_oak)
    o2005 <- lasclip(l2005, tenney_oak)

  #  plot(o2017)
   # plot(o2009)
    #plot(o2005)

    # I should make neat gifs...
plot(o2017, bg = "white", colorPalette = "black")

    d2017 <- o2017@data %>% mutate(year = 2017)
    d2016 <- o2016@data %>% mutate(year = 2016)
    d2009 <- o2009@data %>% mutate(year = 2009)
    d2005 <- o2005@data %>% mutate(year = 2005)

  d <- rbind(d2017, d2016, d2009, d2005) 
d <- mutate(d, Z = Z * .3048, Y = Y * .3048, X = X * .3048, year = factor(year))


#+end_src

#+RESULTS:
#+begin_example
Loading required package: raster
Loading required package: sp
lidR 2.2.0 using 4 threads. Help on <gis.stackexchange.com>. Bug report on <github.com/Jean-Romain/lidR>.

Attaching package: ‘dplyr’

The following objects are masked from ‘package:raster’:

    intersect, select, union

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union
#+end_example

#+begin_src R
      library(ggplot2)
      library(ggthemes)
      library(tidyr)
                                              #  terk <- list(theme_solarized_2(base_size = 16) +
      terk <- theme_tufte(base_size = 16) +
        theme(legend.title = element_text(size = 15),
              legend.text = element_text(size = 12),
              axis.ticks = element_line(size = .3), 
              panel.grid.major = element_line(color = "#839496", size = .1),
              panel.grid.minor = element_line(color = "#839496", size = .05),
              axis.title.x = element_blank(),
              axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              legend.position = "none")


      blue <- scale_color_solarized("blue")

      red <- solarized_pal("red")(1)
      base1 <- "#93a1a1"

#+end_src

#+RESULTS:
: 
: Attaching package: ‘tidyr’
: 
: The following object is masked from ‘package:raster’:
: 
:     extract

#+begin_src R :exports results :results graphics :file figs/tenney_oak1.png :width 1200 :height 300 :res 100 :bg transparent

  ggplot(d, aes(x = X, y = Z, color = year)) +
      geom_point(size = .5) +
      coord_equal() +
      facet_wrap(~year, ncol = 4) +
    terk +
  scale_y_continuous("height (m)") +
    scale_color_brewer(palette = "Dark2")

#+end_src

#+RESULTS:
[[file:figs/tenney_oak1.png]]
the pulses penetrate deep into the canopy when there aren't leaves.
#+begin_src R :exports results :results graphics :file figs/tenney_oak1_firstreturns.png :width 1200 :height 250 :res 100 :bg transparent

  ggplot(filter(d, ReturnNumber ==1), aes(x = X, y = Z, color = year)) +
      geom_point(size = .5) +
      coord_equal() +
      facet_wrap(~year, ncol = 4) +
    terk +
  scale_y_continuous("height (m)") +
    scale_color_brewer(palette = "Dark2")

#+end_src

#+RESULTS:
[[file:figs/tenney_oak1_firstreturns.png]]

#+begin_src R :exports results :results graphics :file figs/tenney_oak_crosssection.png :width 1200 :height 250 :res 100 :bg transparent

#    xc <- 825410

    dc <- filter(d, abs(X - mean(X)) < 8 * .3048)
    ggplot(dc, aes(x = Y, y = Z, color = year)) +
        geom_point(size = .5) +
        coord_equal() +
        facet_wrap(~year, ncol = 4) +
    terk +
  scale_y_continuous("height (m)") +
    scale_color_brewer(palette = "Dark2")


  #+end_src

  #+RESULTS:
  [[file:figs/tenney_oak_crosssection.png]]

#+begin_src R :exports results :results graphics :file figs/tenney_oak_crosssection_vline.png :width 1200 :height 250 :res 100 :bg transparent
    dc <- filter(d, abs(X - mean(X)) < 8 * .3048)
    ggplot(dc, aes(x = Y, y = Z, color = year)) +
       geom_vline(xintercept = mean(d$Y) + 8 * .3048) +
       geom_vline(xintercept = mean(d$Y) - 8 * .3048) +
        geom_point(size = .5) +
        coord_equal() +
        facet_wrap(~year, ncol = 4) +
    terk +
  scale_y_continuous("height (m)") +
    scale_color_brewer(palette = "Dark2")

  #+end_src

  #+RESULTS:
  [[file:figs/tenney_oak_crosssection_vline.png]]
#+begin_src R :exports results :results graphics :file figs/tenney_oak_crosssection_vline_centercolumn.png :width 1200 :height 250 :res 100 :bg transparent
    dc <- filter(d, abs(X - mean(X)) < 8 * .3048)
    dcc <- filter(dc, abs(Y - mean(Y)) < 8 * .3048)
    ggplot(dc, aes(x = Y, y = Z, color = year)) +
       geom_vline(xintercept = mean(d$Y) + 8 * .3048) +
       geom_vline(xintercept = mean(d$Y) - 8 * .3048) +
        geom_point(size = .5, alpha = .01) +
        geom_point(data = dcc, size = .5) +
        coord_equal() +
        facet_wrap(~year, ncol = 4) +
    terk +
  scale_y_continuous("height (m)") +
    scale_color_brewer(palette = "Dark2")

  #+end_src

  #+RESULTS:
  [[file:figs/tenney_oak_crosssection_vline_centercolumn.png]]


#+begin_src R :exports results :results graphics :file figs/tenney_oak_centerpoints.png :width 350 :height 350 :res 100 :bg transparent
#    yc <- 489580
    ggplot(dcc, aes(x = Y, y = Z, color = year)) +
        geom_point(size = 1) +
        coord_equal() +
        facet_wrap(~year, ncol = 4) +
    terk +
  scale_y_continuous("height (m)") +
    scale_color_brewer(palette = "Dark2")



#+end_src

#+RESULTS:
[[file:figs/tenney_oak_centerpoints.png]]

Maybe it does work well?
I'm not sure this resampling makes sense.  It's not not bad for this
tree, within distribution of bias for sure (bias is about 1.9m with sd
1.4), the observed difference between 2017 and 2005 is 1.9.

How to deal with the fact that the 2016 and 2009 have higher heights
than the 2017?


#+begin_src R

d2017f <- filter(d2017, ReturnNumber ==1)
d2005f <- filter(d2005, ReturnNumber ==1)
n2005 <- nrow(d2005f)

reps <- 100
replicate(reps, max(sample(d2017$Z, n2005)))

max2017 <- max(d2017f$Z)
max_height_resampled <- replicate(reps, max(sample(d2017$Z, n2005)))
mean(max_height_resampled)

sd(max_height_resampled)

max2017 - mean(max_height_resampled)
max2005 <- max(d2005f$Z)

max2017 - max2005


#+end_src

#+RESULTS:
#+begin_example

  [1] 59.665 60.274 60.181 60.304 59.897 61.327 59.567 58.432 56.079 59.085
 [11] 55.762 58.990 59.884 59.567 55.199 58.226 59.085 59.567 60.169 57.934
 [21] 60.304 60.304 55.220 60.169 58.118 59.567 55.583 59.909 57.655 60.052
 [31] 60.432 60.651 58.226 60.393 56.372 58.899 58.478 61.030 61.030 58.478
 [41] 58.653 61.779 55.237 60.280 58.145 58.145 58.480 55.393 61.030 54.738
 [51] 56.588 54.676 55.614 59.930 55.762 57.185 60.647 60.274 60.647 57.611
 [61] 58.145 55.237 59.322 59.398 53.656 57.541 56.079 61.030 58.653 57.611
 [71] 60.052 59.558 60.784 61.601 59.910 58.136 58.193 58.949 61.779 56.830
 [81] 60.393 56.352 59.404 59.567 55.382 60.432 59.240 59.910 54.658 59.240
 [91] 58.455 59.567 61.601 59.240 59.930 58.317 55.131 55.137 58.949 57.434

[1] 58.86473

[1] 2.104214

[1] 3.30627

[1] 1.451
#+end_example

*** crop lidar to a fast growing tree for visualization of bias situation. ST42874

ST42874


#+begin_src R

  l2017 <- readLAS("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/0676_esri_normalized.las", select = "r")
    l2016 <- readLAS("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar/54_normalized.las", select = "r")
    l2009 <- readLAS("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/lc2t81028f_ground_normalized.las", select = "r")
    l2005 <- readLAS("/home/erker/hgt_data/madison_lidar_2005_heights/normalized/tile007_ground_normalized.las", select = "r")


  p <- shapefile("/home/erker/hgt_data/ST42874.shp")

    o2017 <- lasclip(l2017, p)
    o2016 <- lasclip(l2016, p)
    o2009 <- lasclip(l2009, p)
    o2005 <- lasclip(l2005, p)

  #  plot(o2017)
   # plot(o2009)
    #plot(o2005)

    # I should make neat gifs...


    d2017 <- o2017@data %>% mutate(year = 2017)
    d2016 <- o2016@data %>% mutate(year = 2016)
    d2009 <- o2009@data %>% mutate(year = 2009)
    d2005 <- o2005@data %>% mutate(year = 2005)

#+end_src

#+begin_src R
  library(ggthemes)

    terk <- list(theme_solarized_2(base_size = 16) +
                 theme(legend.title = element_text(size = 10),
                       legend.text = element_text(size = 8),
                       axis.ticks = element_line(size = .3),
                       rect = element_rect(fill = "transparent"),
                       panel.background = element_rect(fill = "transparent"),
                       panel.grid.major = element_line(color = "#839496", size = .3),
                       panel.grid.minor = element_line(color = "#839496", size = .1)),
blue <- scale_color_solarized("blue"))

red <- solarized_pal("red")(1)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/ST42874.png :width 1200 :height 300 :res 100 :bg transparent

        d <- rbind(d2017, d2016, d2009, d2005) %>%
          mutate(year = factor(year),
                 height = Z * .3048,
                 X = X * .3048,
                 Y = Y * .3048)


        ggplot(d, aes(x = X, y = height, color = year)) +
            geom_point(size = .5) +
            geom_rug(sides = "l") +
            coord_equal() +
            facet_wrap(~year, ncol = 4) +
          terk +
          theme(axis.text.x = element_blank())

#+end_src

#+RESULTS:
[[file:figs/ST42874.png]]

*** ST78492 
78492

ST78492 - smaller honey locust, single street tree.

#+begin_src R

  l2017 <- readLAS("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/0777_esri_normalized.las", select = "r")
    l2016 <- readLAS("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar/85_normalized.las", select = "r")
    l2009 <- readLAS("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/lc2t81034f_normalized.las", select = "r")
    l2005 <- readLAS("/home/erker/hgt_data/madison_lidar_2005_heights/normalized/tile015_ground_normalized.las", select = "r")


  p <- shapefile("/home/erker/hgt_data/ST78492.shp")

    o2017 <- lasclip(l2017, p)
    o2016 <- lasclip(l2016, p)
    o2009 <- lasclip(l2009, p)
    o2005 <- lasclip(l2005, p)

  #  plot(o2017)
   # plot(o2009)
    #plot(o2005)

    # I should make neat gifs...


    d2017 <- o2017@data %>% mutate(year = 2017)
    d2016 <- o2016@data %>% mutate(year = 2016)
    d2009 <- o2009@data %>% mutate(year = 2009)
    d2005 <- o2005@data %>% mutate(year = 2005)

#+end_src

#+begin_src R
  library(ggthemes)

    terk <- list(theme_solarized_2(base_size = 16) +
                 theme(legend.title = element_text(size = 10),
                       legend.text = element_text(size = 8),
                       axis.ticks = element_line(size = .3),
                       rect = element_rect(fill = "transparent"),
                       panel.background = element_rect(fill = "transparent"),
                       panel.grid.major = element_line(color = "#839496", size = .3),
                       panel.grid.minor = element_line(color = "#839496", size = .1)),
blue <- scale_color_solarized("blue"))

red <- solarized_pal("red")(1)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/ST78492.png :width 1200 :height 300 :res 100 :bg transparent

        d <- rbind(d2017, d2016, d2009, d2005) %>%
          mutate(year = factor(year),
                 height = Z * .3048,
                 X = X * .3048,
                 Y = Y * .3048)


        ggplot(d, aes(x = X, y = height, color = year)) +
            geom_point(size = .5) +
            geom_rug(sides = "l") +
            coord_equal() +
            facet_wrap(~year, ncol = 4) +
          terk +
          theme(axis.text.x = element_blank())

#+end_src

#+RESULTS:
[[file:figs/ST78492.png]]

#+begin_src R :exports results :results graphics :file figs/ST78492_slice.png :width 1200 :height 300 :res 100 :bg transparent

  d <- rbind(d2017, d2016, d2009, d2005) %>%
      mutate(height = Z * .3048,
             X = X * .3048,
             Y = Y * .3048) %>%
  filter(abs(X - 257088) < (8 * .3048)) %>%
      mutate(year = factor(year))


  ggplot(d, aes(x = Y, y = height, color = year)) +
      geom_point(size = .5) +
      geom_rug(sides = "l") +
      coord_equal() +
  facet_wrap(~year, ncol = 4) +
      terk +
      theme(axis.text.x = element_blank())

#+end_src

#+RESULTS:
[[file:figs/ST78492_slice.png]]

*** ST69002 tree with powerline hole                               :ATTACH:
:PROPERTIES:
:Attachments: IMG_20191018_173331.jpg
:ID:       9346cc96-17cc-42eb-b67f-10e39b107aa1
:END:
#+begin_src R

  l2017 <- readLAS("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/0824_esri_normalized.las", select = "r")
    l2016 <- readLAS("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar/103_normalized.las", select = "r")
    l2009 <- readLAS("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/lc2t71007f_normalized.las", select = "r")
    l2005 <- readLAS("/home/erker/hgt_data/madison_lidar_2005_heights/normalized/tile014_ground_normalized.las", select = "r")


  p <- shapefile("/home/erker/hgt_data/ST69002.shp")

    o2017 <- lasclip(l2017, p)
    o2016 <- lasclip(l2016, p)
    o2009 <- lasclip(l2009, p)
    o2005 <- lasclip(l2005, p)

    plot(o2016)
   # plot(o2009)
    #plot(o2005)

    # I should make neat gifs...


    d2017 <- o2017@data %>% mutate(year = 2017)
    d2016 <- o2016@data %>% mutate(year = 2016)
    d2009 <- o2009@data %>% mutate(year = 2009)
    d2005 <- o2005@data %>% mutate(year = 2005)

#+end_src
#+begin_src R :exports results :results graphics :file figs/ST69002.png :width 1200 :height 300 :res 100 :bg transparent

        d <- rbind(d2017, d2016, d2009, d2005) %>%
          mutate(year = factor(year),
                 height = Z * .3048,
                 X = X * .3048,
                 Y = Y * .3048)


        ggplot(d, aes(x = X, y = height, color = year)) +
            geom_point(size = .5) +
            geom_rug(sides = "l") +
            coord_equal() +
            facet_wrap(~year, ncol = 4) +
          terk +
          theme(axis.text.x = element_blank())

#+end_src

#+RESULTS:
[[file:figs/ST69002.png]]

*** HF6591
:PROPERTIES:
:Attachments: IMG_20191018_173331.jpg
:ID:       9346cc96-17cc-42eb-b67f-10e39b107aa1
:END:

Why 2009 the way it is?
#+begin_src R

  l2017 <- readLAS("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/0917_esri_normalized.las", select = "r")
    l2016 <- readLAS("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar/117_normalized.las", select = "r")
    l2009 <- readLAS("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/lc2t70919f_normalized.las", select = "r")
    l2005 <- readLAS("/home/erker/hgt_data/madison_lidar_2005_heights/normalized/tile020_ground_normalized.las", select = "r")


  p <- shapefile("/home/erker/hgt_data/HF6591.shp")

    o2017 <- lasclip(l2017, p)
    o2016 <- lasclip(l2016, p)
    o2009 <- lasclip(l2009, p)
    o2005 <- lasclip(l2005, p)

    plot(o2016)
    plot(o2009)
    #plot(o2005)

    # I should make neat gifs...


    d2017 <- o2017@data %>% mutate(year = 2017)
    d2016 <- o2016@data %>% mutate(year = 2016)
    d2009 <- o2009@data %>% mutate(year = 2009)
    d2005 <- o2005@data %>% mutate(year = 2005)

#+end_src

#+begin_src R :exports results :results graphics :file figs/HF6591.png :width 1200 :height 300 :res 100 :bg transparent

        d <- rbind(d2017, d2016, d2009, d2005) %>%
          mutate(year = factor(year),
                 height = Z * .3048,
                 X = X * .3048,
                 Y = Y * .3048)


        ggplot(d, aes(x = X, y = height, color = year)) +
            geom_point(size = .5) +
            geom_rug(sides = "l") +
            coord_equal() +
            facet_wrap(~year, ncol = 4) +
          terk +
          theme(axis.text.x = element_blank())

#+end_src

#+RESULTS:
[[file:figs/HF6591.png]]

*** ST45429
#+begin_src R
  library(lidR)

  l2017 <- readLAS("/home/erker/hgt_data/madison_lidar_2017_heights/normalized/1019_esri_normalized.las", select = "r")
    l2016 <- readLAS("/home/erker/hgt_data/madison_lidar_2016_heights/normalized_lidar/162_normalized.las", select = "r")
    l2009 <- readLAS("/home/erker/hgt_data/madison_lidar_2009_heights/normalized/lc2t70933f_normalized.las", select = "r", filter = "-drop_z_below 0")
    l2005 <- readLAS("/home/erker/hgt_data/madison_lidar_2005_heights/normalized/tile020_ground_normalized.las", select = "r")


  p <- shapefile("/home/erker/hgt_data/ST45429.shp")
  p2 <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_buf_excludeNearNeigh.shp")
  p2 <- p2[p2@data$UID == "ST45429",]

    o2017 <- lasclip(l2017, p)
    o2016 <- lasclip(l2016, p)
    o2009 <- lasclip(l2009, p)
    o2005 <- lasclip(l2005, p)

    plot(o2016)
    plot(o2009)
    #plot(o2005)

    # I should make neat gifs...


    d2017 <- o2017@data %>% mutate(year = 2017)
    d2016 <- o2016@data %>% mutate(year = 2016)
    d2009 <- o2009@data %>% mutate(year = 2009)
    d2005 <- o2005@data %>% mutate(year = 2005)

#+end_src

#+begin_src R
to2009<-readLAS("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_2009_las/ST45429_lc2t70933.las")
plot(to2009)
#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/ST45429_new.png :width 1200 :height 300 :res 100 :bg transparent

        d <- rbind(d2017, d2016, d2009, d2005) %>%
          mutate(year = factor(year),
                 height = Z * .3048,
                 X = X * .3048,
                 Y = Y * .3048)


        ggplot(d, aes(x = X, y = height, color = year)) +
            geom_point(size = .5) +
            geom_rug(sides = "l") +
            coord_equal() +
            facet_wrap(~year, ncol = 4) +
          terk +
          theme(axis.text.x = element_blank())

#+end_src

#+RESULTS:
[[file:figs/ST45429_new.png]]



[[file:figs/ST45429.png]]

** other covariates
- position in topography
- % impervious within 20m
- % impervious within 100m
- mean height of first returns within 20m of tree
- traits from hyperspectral imagery
- distance to road?

*** foliar traits from imaging spectroscopy

**** load 2016 tree chm to create tree mask

***** scale up to 15 ft pixels

#+BEGIN_SRC sh
cd /home/erker/hgt_data/madison_lidar_2016_heights/
gdal_edit.py -a_nodata -3.4e+38 tree_height_norm_2016_cpy.tif

#+END_SRC

#+RESULTS:

Convert less than 0 to 0 for averaging
#+BEGIN_SRC sh :session a
cd /home/erker/hgt_data/madison_lidar_2016_heights/
gdal_calc.py -A tree_height_norm_2016.tif --outfile=tree_height_norm_2016_zeros.tif --type=Byte --calc="A*(A>0)"
#+END_SRC

#+RESULTS:
: 0 .. 10 .. 20 .. 30 .. 40 .. 50 .. 60 .. 70 .. 80 .. 90 .. 100 - Done

Scale up with average height
#+BEGIN_SRC sh :results verbatim
cd /home/erker/hgt_data/madison_lidar_2016_heights/
gdalwarp -srcnodata -inf -tr 15 15 -r average -t_srs epsg:7599 -tap tree_height_norm_2016_zeros.tif tree_height_norm_2016_15ft.tif
#+END_SRC

#+RESULTS:
: Creating output file that is 5334P x 4334L.
: Processing input file tree_height_norm_2016_zeros.tif.
: Copying nodata values from source tree_height_norm_2016_zeros.tif to destination tree_height_norm_2016_15ft.tif.
: 0...10...20...30...40...50...60...70...80...90...100 - done.

Make Mask
#+BEGIN_SRC sh
cd /home/erker/hgt_data/madison_lidar_2016_heights/
gdal_calc.py -A tree_height_norm_2016_15ft.tif --outfile=tree_height_norm_2016_mask.tif --type=Byte --calc="0*(A<=30)" --calc="1*(A>30)" 
#+END_SRC

#+RESULTS:
: 0 .. 10 .. 20 .. 30 .. 40 .. 50 .. 60 .. 70 .. 80 .. 90 .. 100 - Done

**** reproject foliar traits
#+begin_src sh
cd /home/erker/hgt_data/madison_aviris/
gdalwarp -tap -tr 15 15 -r cubicspline -t_srs epsg:7599 N_merged.tif N_merged_7599.tif
#+end_src

#+RESULTS:
| Creating                                             | output   | file   | that         | is     | 9764P       | x   | 7409L.      |                  |
| Processing                                           | input    | file   | N_merged.tif. |        |             |     |             |                  |
| Using                                                | internal | nodata | values       | (e.g.  | 0)          | for | image       | N_merged.tif.     |
| Copying                                              | nodata   | values | from         | source | N_merged.tif | to  | destination | N_merged_7599.tif. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0        | done.  |              |        |             |     |             |                  |

#+begin_src sh
cd /home/erker/hgt_data/madison_aviris/
gdalwarp -tap -tr 15 15 -r cubicspline -t_srs epsg:7599 LMA_merged.tif LMA_merged_7599.tif
#+end_src

#+RESULTS:
| Creating                                             | output   | file   | that           | is     | 9764P         | x   | 7409L.      |                    |
| Processing                                           | input    | file   | LMA_merged.tif. |        |               |     |             |                    |
| Using                                                | internal | nodata | values         | (e.g.  | 0)            | for | image       | LMA_merged.tif.     |
| Copying                                              | nodata   | values | from           | source | LMA_merged.tif | to  | destination | LMA_merged_7599.tif. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0        | done.  |                |        |               |     |             |                    |

#+begin_src sh
cd /home/erker/hgt_data/madison_aviris/
gdalwarp -tap -tr 15 15 -r cubicspline -t_srs epsg:7599 lignin_merged.tif lignin_merged_7599.tif
#+end_src

#+RESULTS:
| Creating                                             | output   | file   | that              | is     | 9764P            | x   | 7409L.      |                       |
| Processing                                           | input    | file   | lignin_merged.tif. |        |                  |     |             |                       |
| Using                                                | internal | nodata | values            | (e.g.  | 0)               | for | image       | lignin_merged.tif.     |
| Copying                                              | nodata   | values | from              | source | lignin_merged.tif | to  | destination | lignin_merged_7599.tif. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0        | done.  |                   |        |                  |     |             |                       |

#+begin_src sh
cd /home/erker/hgt_data/madison_aviris/
gdalwarp -tap -tr 15 15 -r cubicspline -t_srs epsg:7599 chl_merged.tif chl_merged_7599.tif
#+end_src

#+RESULTS:
| Creating                                             | output   | file   | that           | is     | 9764P         | x   | 7409L.      |                    |
| Processing                                           | input    | file   | chl_merged.tif. |        |               |     |             |                    |
| Using                                                | internal | nodata | values         | (e.g.  | 0)            | for | image       | chl_merged.tif.     |
| Copying                                              | nodata   | values | from           | source | chl_merged.tif | to  | destination | chl_merged_7599.tif. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0        | done.  |                |        |               |     |             |                    |

#+begin_src sh
cd /home/erker/hgt_data/madison_aviris/
gdalwarp -tap -tr 15 15 -r cubicspline -t_srs epsg:7599 Sugar_merged.tif Sugar_merged_7599.tif
#+end_src

#+RESULTS:
| Creating                                             | output   | file   | that             | is     | 9764P           | x   | 7409L.      |                      |
| Processing                                           | input    | file   | Sugar_merged.tif. |        |                 |     |             |                      |
| Using                                                | internal | nodata | values           | (e.g.  | 0)              | for | image       | Sugar_merged.tif.     |
| Copying                                              | nodata   | values | from             | source | Sugar_merged.tif | to  | destination | Sugar_merged_7599.tif. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0        | done.  |                  |        |                 |     |             |                      |

#+begin_src sh
cd /home/erker/hgt_data/madison_aviris/
gdalwarp -tap -tr 15 15 -r cubicspline -t_srs epsg:7599 TotPhen_merged.tif TotPhen_merged_7599.tif
#+end_src

#+RESULTS:
| Creating                                             | output   | file   | that               | is     | 9764P             | x   | 7409L.      |                        |
| Processing                                           | input    | file   | TotPhen_merged.tif. |        |                   |     |             |                        |
| Using                                                | internal | nodata | values             | (e.g.  | 0)                | for | image       | TotPhen_merged.tif.     |
| Copying                                              | nodata   | values | from               | source | TotPhen_merged.tif | to  | destination | TotPhen_merged_7599.tif. |
| 0...10...20...30...40...50...60...70...80...90...100 | 0        | done.  |                    |        |                   |     |             |                        |

**** mask the foliar traits

#+begin_src sh :session a
cd /home/erker/hgt_data/madison_aviris/
gdal_merge.py -separate -o lignin_merged_7599_masked_int.tif lignin_merged_7599.tif /home/erker/hgt_data/madison_lidar_2016_heights/tree_height_norm_2016_mask.tif
gdal_calc.py -A lignin_merged_7599_masked_int.tif -B lignin_merged_7599_masked_int.tif --A_band=1 --B_band=3 --outfile=lignin_merged_7599_masked.tif --calc="A*B"

gdal_merge.py -separate -o N_merged_7599_masked_int.tif N_merged_7599.tif /home/erker/hgt_data/madison_lidar_2016_heights/tree_height_norm_2016_mask.tif
gdal_calc.py -A N_merged_7599_masked_int.tif -B N_merged_7599_masked_int.tif --A_band=1 --B_band=3 --outfile=N_merged_7599_masked.tif --calc="A*B"

gdal_merge.py -separate -o LMA_merged_7599_masked_int.tif LMA_merged_7599.tif /home/erker/hgt_data/madison_lidar_2016_heights/tree_height_norm_2016_mask.tif
gdal_calc.py -A LMA_merged_7599_masked_int.tif -B LMA_merged_7599_masked_int.tif --A_band=1 --B_band=3 --outfile=LMA_merged_7599_masked.tif --calc="A*B"

gdal_merge.py -separate -o chl_merged_7599_masked_int.tif chl_merged_7599.tif /home/erker/hgt_data/madison_lidar_2016_heights/tree_height_norm_2016_mask.tif
gdal_calc.py -A chl_merged_7599_masked_int.tif -B chl_merged_7599_masked_int.tif --A_band=1 --B_band=3 --outfile=chl_merged_7599_masked.tif --calc="A*B"

gdal_merge.py -separate -o Sugar_merged_7599_masked_int.tif Sugar_merged_7599.tif /home/erker/hgt_data/madison_lidar_2016_heights/tree_height_norm_2016_mask.tif
gdal_calc.py -A Sugar_merged_7599_masked_int.tif -B Sugar_merged_7599_masked_int.tif --A_band=1 --B_band=3 --outfile=Sugar_merged_7599_masked.tif --calc="A*B"

gdal_merge.py -separate -o TotPhen_merged_7599_masked_int.tif TotPhen_merged_7599.tif /home/erker/hgt_data/madison_lidar_2016_heights/tree_height_norm_2016_mask.tif
gdal_calc.py -A TotPhen_merged_7599_masked_int.tif -B TotPhen_merged_7599_masked_int.tif --A_band=1 --B_band=3 --outfile=TotPhen_merged_7599_masked.tif --calc="A*B"


#+end_src

#+RESULTS:
|                                                      |                                                      |       |       |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
| 0...10...20...30...40...50...60...70...80...90...100 |                                                    0 | done. |       |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
|                                                    0 |                                                   .. |    10 | ..    | 20 | .. | 30 | .. | 40 | .. | 50 | .. | 60 | .. | 70 | .. | 80 | .. | 90 | .. | 100 | 0 | Done |
|                                                    $ | 0...10...20...30...40...50...60...70...80...90...100 |     0 | done. |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
|                                                    0 |                                                   .. |    10 | ..    | 20 | .. | 30 | .. | 40 | .. | 50 | .. | 60 | .. | 70 | .. | 80 | .. | 90 | .. | 100 | 0 | Done |
|                                                    $ | 0...10...20...30...40...50...60...70...80...90...100 |     0 | done. |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
|                                                    0 |                                                   .. |    10 | ..    | 20 | .. | 30 | .. | 40 | .. | 50 | .. | 60 | .. | 70 | .. | 80 | .. | 90 | .. | 100 | 0 | Done |
|                                                    $ | 0...10...20...30...40...50...60...70...80...90...100 |     0 | done. |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
|                                                    0 |                                                   .. |    10 | ..    | 20 | .. | 30 | .. | 40 | .. | 50 | .. | 60 | .. | 70 | .. | 80 | .. | 90 | .. | 100 | 0 | Done |
|                                                    $ | 0...10...20...30...40...50...60...70...80...90...100 |     0 | done. |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
|                                                    0 |                                                   .. |    10 | ..    | 20 | .. | 30 | .. | 40 | .. | 50 | .. | 60 | .. | 70 | .. | 80 | .. | 90 | .. | 100 | 0 | Done |
|                                                    $ | 0...10...20...30...40...50...60...70...80...90...100 |     0 | done. |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |    |     |   |      |
|                                                    0 |                                                   .. |    10 | ..    | 20 | .. | 30 | .. | 40 | .. | 50 | .. | 60 | .. | 70 | .. | 80 | .. | 90 | .. | 100 | 0 | Done |

**** extract foliar traits at trees
#+begin_src R
  library(raster)
  library(dplyr)
      h <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds")
      uids <- h$uid


      trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")
      trees@data <-   select(trees@data, UID, DBH, Genus, Species)
      trees <- trees[trees@data$UID %in% uids,]
    trees <- spTransform(trees, "+init=epsg:7599")

#+end_src

#+RESULTS:
#+begin_example
Loading required package: sp

Attaching package: ‘dplyr’

The following objects are masked from ‘package:raster’:

    intersect, select, union

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union
#+end_example

#+begin_src R

        traitsdir <- "/home/erker/hgt_data/madison_aviris/"
          traits <- c("TotPhen", "N", "Sugar", "LMA", "lignin", "chl")
          tp <- paste0(traitsdir, traits, "_merged_7599_masked.tif")

          e <- lapply(tp, function(p) {

              r <- raster(p)
              ex <- extract(r, trees)
              ex
          })

      names(e) <- traits

    df <- cbind(trees@data, e)

  df[df == 0] <- NA # 0's are really missings

    saveRDS(df, "/home/erker/hgt_data/canopy_foliar_traits.rds")

#+end_src

#+RESULTS:

standardize foliar traits
#+begin_src R
    tr <- readRDS("/home/erker/hgt_data/canopy_foliar_traits.rds") %>% unique()

  trs <-   tr %>%
      mutate(TotPhen = c(scale(TotPhen)),
             N = c(scale(N)),
             lignin = c(scale(lignin)),
             Sugar = c(scale(Sugar)),
             LMA = c(scale(LMA)),
             chl = c(scale(chl)))

saveRDS(trs, "/home/erker/hgt_data/canopy_foliar_traits_scaled.rds")

#+end_src

#+RESULTS:

*** mean height of first returns within 20m of tree (includes other trees and buildings etc)

**** make 20m buffers
#+begin_src R
  library(rgeos)

    h <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds")
    uids <- h$uid

    # make 20m buffer

    trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")
    trees <- spTransform(trees, crs("+init=epsg:7599"))

    trees <- trees[trees@data$UID %in% uids,]

    trees@data <-   select(trees@data, UID, DBH, Genus, Species)

  p <- gBuffer(trees, width = 20 / .3048, byid = T)
     
  shapefile(p, "/home/erker/hgt_data/madison_tree_inventories/hgt/trees_20m_buf.shp", overwrite = T)
#+end_src

#+RESULTS:

**** Use the chm instead of the lidar clouds clipped to each tree. I'm only going to use 2016 here.  It's good quality lidar and it's closest to the aviris

#+begin_src R
      library(raster)
      library(velox)
      library(dplyr)

       b <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_20m_buf.shp")
         b <- spTransform(b, crs("+init=epsg:7599"))
         b@data <- select(b@data, UID)

      fs <- list.files("/home/erker/hgt_data/madison_lidar_2016_heights/all_chm", full.names = T)

      o <- sapply(fs, function(f) {
          v <- velox(f)
          m <- v$extract(sp = b, fun = function(x) mean(x, na.rm = TRUE))
          m
      })

      # then average across the images because some trees may go across tiles.
      o2 <- apply(o, 1, function(x) mean(x, na.rm = T))

                                              # I LEFT OFF HERE [2019-11-18 Mon]

      # these heights are in feet.  Convert to meters

    o2 <- o2 * .3048

  d <- data.frame(UID = b@data$UID, mean_height_wn20m = o2, stringsAsFactors = F)

  saveRDS(d, "~/hgt_data/mean_height_within20m_2016.rds")
#+end_src

*** topographic position and terrain

**** TODO elevation slope aspect and topographic position index at 2 scales SLOPE ASPECT Transformation?:https://rdrr.io/github/raff-k/GeoMorphTB/man/saTransformation.html

#+begin_src R :session *R2*
    library(raster)
  library(dplyr)
                                          #  library(dynatopmodel)  I'm not going to get the topographic wetness index.  I think 2 scale apporach with terrain works fine
    library(rgeos)

      h <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds") %>%
        filter(!duplicated(.))

      uids <- h$uid


      trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")
      trees@data <-   select(trees@data, UID, DBH, Genus, Species)
      trees <- trees[trees@data$UID %in% uids,]
    trees <- spTransform(trees, "+init=epsg:7599")

    dem <- raster("/home/erker/hgt_data/dane_dem/dane_dem.tif")
    crs(dem) <- "+init=epsg:7599"

    dem <- crop(dem, trees)

    ter_5ft <- terrain(dem, neighbors = 8, opt = c("slope", "aspect", "TPI"))
    writeRaster(ter_5ft, "~/hgt_data/dane_dem/madison_5ft_terrain.tif", overwrite = T)

    dema <- raster::aggregate(dem, fact = 40)

    ter_200ft <- terrain(dema, neighbors = 8, opt = c("slope", "aspect", "TPI"))
    writeRaster(ter_200ft, "~/hgt_data/dane_dem/madison_200ft_terrain.tif", overwrite = T)
#+end_src

#+begin_src R :session *R2*

  trees_ter_5ft  <- raster::extract(ter_5ft, trees, sp = T)

  trees_ter_5ft@data <- trees_ter_5ft@data %>%
      rename(tpi_5ft = tpi, slope_5ft = slope, aspect_5ft = aspect)

  trees_ter_200ft  <- raster::extract(ter_200ft, trees_ter_5ft, sp = T)

  trees_ter_200ft@data <- trees_ter_200ft@data %>%
      rename(tpi_200ft = tpi, slope_200ft = slope, aspect_200ft = aspect)

  trees_ter_welv <- raster::extract(dem, trees_ter_200ft, sp = T)

  trees_ter_welv@data <- trees_ter_welv@data %>%
      rename(elev = dane_dem) %>%
      mutate(elev = elev * .3048)


  #categorize aspect
  dterr <- trees_ter_welv@data

  dterr <- dterr %>%
      mutate(


  saveRDS(dterr, "~/hgt_data/terrain_at_trees.rds")

#+end_src



*** TODO distance to road?  need to get centerlines file

#+begin_src R

#+end_src
*** TODO pct impervious etc
**** tile landcover so velox can fit it in memory
#+begin_src R
  library(raster)
  landcover <- raster("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea.tif")
  trees20m <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_20m_buf.shp")
  trees20m <- trees20m[!duplicated(trees20m@data),]
  trees20m <- spTransform(trees20m, crs(landcover))
  crop(landcover, trees20m, filename = "/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea_treecropped.tif")  

#+end_src


#+BEGIN_SRC python
import os, gdal
 
in_path = '/home/erker/hgt_data/share_madison_utc/'
input_filename = '3_ClassifiedUrbanArea_treecropped.tif'
 
out_path = '/home/erker/hgt_data/share_madison_utc/'
output_filename = 'tile_'
 
tile_size_x = 5000
tile_size_y = 5000
 
ds = gdal.Open(in_path + input_filename)
band = ds.GetRasterBand(1)
xsize = band.XSize
ysize = band.YSize
 
for i in range(0, xsize, tile_size_x):
    for j in range(0, ysize, tile_size_y):
        com_string = "gdal_translate -of GTIFF -srcwin " + str(i)+ ", " + str(j) + ", " + str(tile_size_x) + ", " + str(tile_size_y) + " " + str(in_path) + str(input_filename) + " " + str(out_path) + str(output_filename) + str(i) + "_" + str(j) + ".tif"
        os.system(com_string)

#+END_SRC

#+RESULTS:
: None
**** 20m
#+begin_src R
       library(raster)
       library(velox)
    library(stringr)
         landcover <- raster("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea.tif")
         trees20m <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_20m_buf.shp")
         trees20m <- trees20m[!duplicated(trees20m@data),]
         trees20m <- spTransform(trees20m, crs(landcover))
       rm(landcover)

     fs <- list.files("/home/erker/hgt_data/share_madison_utc/", pattern = "tile_.*", full.names = T)

  o <-      lapply(fs, function(f) {
           app <- str_extract(f, "[0-9]+_[0-9]+")
           landcover <- velox(f)
           imp <- landcover$extract(sp = trees20m, fun = function(x) sum(x == 7))
           saveRDS(imp, paste0("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea_treecropped_extracted",app,".rds"))
           imp
       })

  n <-      lapply(fs, function(f) {
           app <- str_extract(f, "[0-9]+_[0-9]+")
           landcover <- velox(f)
           imp <- landcover$extract(sp = trees20m, fun = function(x) length(x))
           saveRDS(imp, paste0("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea_treecropped_extracted",app,"_n.rds"))
           imp
       })

#+end_src

#+RESULTS:

#+begin_src R
d <- do.call("cbind",o)
d <- apply(d, 1, function(x) sum(x, na.rm = T))

dn <- do.call("cbind",n)
dn <- apply(dn, 1, function(x) sum(x, na.rm = T))

pct_imp <- d / dn

pct_imp_df <- data.frame(UID = trees20m@data$UID, pct_imp_20m = pct_imp)
saveRDS(pct_imp_df, "/home/erker/hgt_data/pct_imp_20m.rds")
#+end_src

#+RESULTS:
**** 100 m
#+begin_src R
         library(raster)
         library(velox)
      library(stringr)
  library(rgeos)

           landcover <- raster("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea.tif")
           trees20m <- shapefile("/home/erker/hgt_data/madison_tree_inventories/hgt/trees_20m_buf.shp")
           trees20m <- trees20m[!duplicated(trees20m@data),]
           trees20m <- spTransform(trees20m, crs(landcover))
  trees100m <- gBuffer(trees20m, width = 80, byid = T)

         rm(landcover)

       fs <- list.files("/home/erker/hgt_data/share_madison_utc/", pattern = "tile_.*", full.names = T)

    o <-      lapply(fs, function(f) {
             app <- str_extract(f, "[0-9]+_[0-9]+")
             landcover <- velox(f)
             imp <- landcover$extract(sp = trees100m, fun = function(x) sum(x == 7))
             saveRDS(imp, paste0("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea_treecropped_extracted",app,"_100m_.rds"))
             imp
         })

    n <-      lapply(fs, function(f) {
             app <- str_extract(f, "[0-9]+_[0-9]+")
             landcover <- velox(f)
             imp <- landcover$extract(sp = trees100m, fun = function(x) length(x))
             saveRDS(imp, paste0("/home/erker/hgt_data/share_madison_utc/3_ClassifiedUrbanArea_treecropped_extracted",app,"_100m_n.rds"))
             imp
         })

#+end_src

#+RESULTS:

#+begin_src R
d <- do.call("cbind",o)
d <- apply(d, 1, function(x) sum(x, na.rm = T))

dn <- do.call("cbind",n)
dn <- apply(dn, 1, function(x) sum(x, na.rm = T))

pct_imp <- d / dn

pct_imp_df <- data.frame(UID = trees20m@data$UID, pct_imp_100m = pct_imp)
saveRDS(pct_imp_df, "/home/erker/hgt_data/pct_imp_100m.rds")
#+end_src

#+RESULTS:

*** TODO sewers?

** combine data

#+begin_src R
              library(raster)
      library(plyr)
              library(dplyr)

                  traits <- readRDS("/home/erker/hgt_data/canopy_foliar_traits_scaled.rds") %>% unique()
                  hgt_wn20m <- readRDS("/home/erker/hgt_data/mean_height_within20m_2016.rds") %>% unique()
                  terr <- readRDS("/home/erker/hgt_data/terrain_at_trees.rds") %>% unique()
                  imp20 <- readRDS("/home/erker/hgt_data/pct_imp_20m.rds")
                  imp100 <- readRDS("/home/erker/hgt_data/pct_imp_100m.rds")
              h <- readRDS("/home/erker/hgt_data/madison_tree_inventories/hgt/lidarextractedheights_growthrates_corrFromNoGrowth.rds") %>%
                  rename(UID = uid) %>%
                  filter(!is.na(growth.rate)) %>%
                  mutate(cor_max2005 = emp_max2005 + mean_bias05,
                         cor_max2009 = emp_max2009 + mean_bias09,
                         height2005_2 = cor_max2005^2,
                         height2005_3 = cor_max2005^3,
                         height2005_4 = cor_max2005^4,
                         height2009_2 = cor_max2009^2,
                         height2009_3 = cor_max2009^3,
                         height2009_4 = cor_max2009^4,
                         growth.rate = growth.rate * 100)  # convert to cm


            uids <- h$UID

                  trees <- shapefile("/home/erker/hgt_data/madison_tree_inventories/MadisonTrees_WithAttributes.shp")
                  trees <- trees[!(duplicated(trees@data)),]
                  trees@data <-   select(trees@data, UID, DBH, Genus, Species)
                  trees <- trees[trees@data$UID %in% uids,]
                  trees <- spTransform(trees, "+init=epsg:7599")



              coords <- coordinates(trees)
              dimnames(coords)[[2]] <- c("x", "y")
              td <- cbind(trees@data, coords)

              d <- left_join(h, td)

              d <- left_join(d, terr) %>%
                mutate(aspect_trans_5ft = (sin(aspect_5ft+ 45*180/pi) + 1),
                       aspect_trans_200ft = (sin(aspect_200ft+ 45*180/pi) + 1),
                       elev = elev / 100)

              d <- left_join(d, hgt_wn20m)

              d <- left_join(d, traits)

              d <- left_join(d, imp20)

              d <- left_join(d, imp100)


                                              # separate out street trees, no powerline, street tree powerline, and the other trees
      d <- d %>%
          mutate(street = grepl("S[ST][0-9]+",UID))

      # get powerlines
      stt <- read.csv("/home/erker/hgt_data/madison_tree_inventories/STTREES.csv", stringsAsFactors = F) %>%
          select(UID, UTILPRES) %>%
          mutate(overhead_utilities = UTILPRES %in% c(2,3,4))

    sst <-  read.csv("/home/erker/hgt_data/madison_tree_inventories/shorewoodhills_strees.csv", stringsAsFactors = F) %>%
          select(UID, UTILPRES) %>%
          mutate(overhead_utilities = UTILPRES %in% c(2,3,4))

    overutils <- rbind(stt, sst)

    d <- left_join(d, overutils) %>%
          mutate(st_po = case_when(street == F ~ "neighborhood",
                                   street == T & overhead_utilities == F ~ "st no util",
                                   street == T & overhead_utilities == T ~ "st w util"))

    d <- select(d, -overhead_utilities, -street, -UTILPRES)  


    d <- d %>% mutate(conifer = Genus %in% c("Abies", "Pinus", "Picea"))


            saveRDS(d, "/home/erker/hgt_data/merged_data.rds")
#+end_src

#+RESULTS:
#+begin_example

Joining, by = c("UID", "Genus")

Joining, by = c("UID", "Genus", "DBH", "Species")

Joining, by = "UID"

Joining, by = c("UID", "Genus", "DBH", "Species")

Joining, by = "UID"
Warning message:
Column `UID` joining character vector and factor, coercing into character vector

Joining, by = "UID"
Warning message:
Column `UID` joining character vector and factor, coercing into character vector

Joining, by = "UID"
#+end_example

** read back in data

#+Begin_src R
library(dplyr)
library(ggplot2)

d <-   readRDS("/home/erker/hgt_data/merged_data.rds")
dc <- filter(d, complete.cases(d))
#+end_src

#+RESULTS:

** plot data
*** define theme
#+begin_src R

  library(ggplot2)
  library(ggthemes)
  library(tidyr)
                                          #  terk <- list(theme_solarized_2(base_size = 16) +
  terk <- theme_tufte(base_size = 16) +
    theme(legend.title = element_text(size = 15),
          legend.text = element_text(size = 13),
          axis.ticks = element_line(size = .3), 
          panel.grid.major = element_line(color = "#839496", size = .1),
          panel.grid.minor = element_line(color = "#839496", size = .05))


  blue <- scale_color_solarized("blue")

  red <- solarized_pal("red")(1)
  base1 <- "#93a1a1"

  d <-  readRDS("/home/erker/hgt_data/merged_data.rds")



#+end_src

#+RESULTS:

*** growth rates

#+begin_src R :exports results :results graphics :file figs/growthrate_histogram_w.png :width 1200 :res 150 :bg transparent
  ggplot(dc, aes(x = growth.rate)) + geom_histogram(binwidth = 2) +
    terk +
    scale_x_continuous("growth rate (cm/year)", lim = c(-50,100), breaks = c(-100,-50,0, round(mean(d$growth.rate),1), 50, 100)) +
    geom_vline(data = d, aes(xintercept = mean(growth.rate)), color = red)
#+end_src

#+RESULTS:
[[file:figs/growthrate_histogram_w.png]]


[[file:figs/growthrate_histogram.png]]

How many trees
#+begin_src R
sum(complete.cases(d$growth.rate))
sum(complete.cases(dc$growth.rate))
#+end_src

#+RESULTS:
: [1] 41949
: 
: [1] 21247

*** height 
**** 2005
#+begin_src R :exports results :results graphics :file figs/corheight2005_growth.png :width 1000
ggplot(d, aes(x = cor_max2005, y = growth.rate)) + geom_point(alpha = .3) + terk + geom_smooth()
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth.png]]
#+begin_src R :exports results :results graphics :file figs/corheight2005_growth_bygenus.png :width 1300
    ggplot(d, aes(x = cor_max2005, y = growth.rate, color = Genus)) + 
        #geom_point(alpha = .3) + 
        terk + geom_smooth(se = F, method = "lm")
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth_bygenus.png]]

#+begin_src R :exports results :results graphics :file figs/corheight2005_growth_bygenus_facet_keyGenera.png :width 1200 :res 100
  ggplot(filter(dc, Genus %in% c("Acer", "Fraxinus", "Gleditsia", "Quercus", "Pinus", "Picea", "Tilia")), aes(x = cor_max2005, y = growth.rate, color = st_po)) +
      geom_point(alpha = .05) + 
      terk + 
      geom_smooth(method = "lm") +
    facet_grid(~Genus)
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth_bygenus_facet_keyGenera.png]]
#+begin_src R :exports results :results graphics :file figs/corheight2005_growth_bygenus_facet_keyGenera_nopoints.png :width 1200 :res 100
  ggplot(filter(dc, Genus %in% c("Acer", "Fraxinus", "Gleditsia", "Quercus", "Pinus", "Picea", "Tilia")), aes(x = cor_max2005, y = growth.rate, color = st_po)) +
#      geom_point(alpha = .05) + 
      terk + 
      geom_smooth() +
    facet_grid(~Genus)
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth_bygenus_facet_keyGenera_nopoints.png]]
#+begin_src R :exports results :results graphics :file figs/corheight2005_growth_bygenus_facet_TiliaAcer.png :width 1200 :res 100
  ggplot(filter(dc, Genus %in% c("Acer", "Tilia")), aes(x = cor_max2005, y = growth.rate, color = st_po)) +
      geom_point(alpha = .3) + 
      terk + 
      geom_smooth(method = "lm") +
    facet_grid(~Genus)
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth_bygenus_facet_TiliaAcer.png]]



poly 4
#+begin_src R :exports results :results graphics :file figs/corheight2005_growth_poly4smooth.png :width 1000
ggplot(d, aes(x = cor_max2005, y = growth.rate)) + geom_point(alpha = .3) + terk + geom_smooth(method = "lm", formula = y ~ poly(x,4))
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth_poly4smooth.png]]

#+begin_src R :exports results :results graphics :file figs/corheight2005_growth_color_N_poly4smooth.png :width 1000
dc <- dc %>% mutate(Nbin = cut(N, 3))
ggplot(dc, aes(x = cor_max2005, y = growth.rate, color = Nbin)) + geom_point(alpha = .3) + terk + geom_smooth(method = "lm", formula = y ~ poly(x,4))
#+end_src

#+RESULTS:
[[file:figs/corheight2005_growth_color_N_poly4smooth.png]]


**** 2009
#+begin_src R :exports results :results graphics :file figs/corheight2009_growth.png :width 1000
ggplot(d, aes(x = cor_max2009, y = growth.rate)) + geom_point(alpha = .3) + terk + geom_smooth()
#+end_src

#+RESULTS:
[[file:figs/corheight2009_growth.png]]

*** Genera
#+begin_src R
sort(table(dc$Genus))
#+end_src

#+RESULTS:
: 
:       Salix Gymnocladus    Platanus       Abies      Ginkgo     Catalpa 
:           4           7          23          28          63          74 
:       Carya       Thuja     Populus     Robinia      Betula     Juglans 
:          79         116         122         123         209         222 
:       Pinus       Ulmus       Picea      Celtis     Quercus       Tilia 
:         265         407         420         421        1002        1523 
:   Gleditsia    Fraxinus        Acer 
:        3439        5936        6764

*** Space
*** traits

how many trees are there with full traits?

#+begin_src R
  d %>% select(TotPhen, N, Sugar, LMA, lignin, chl) %>%
    filter(complete.cases(.)) %>%
      nrow
#+end_src

#+RESULTS:
: 
: [1] 21457

#+begin_src R

  dt <- d %>%
    select(UID, growth.rate, TotPhen, N, Sugar, LMA, lignin, chl) %>%
    gather(trait, value, -growth.rate, -UID)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/traits_N_growth.png :bg transparent :width 1000 :height 800 :res 100

  ggplot(dt, aes(x = value, y = growth.rate)) + geom_point(alpha = .3) + geom_smooth() + terk +
    facet_wrap(~trait, scales = "free")

#+end_src

#+RESULTS:
[[file:figs/traits_N_growth.png]]

#+begin_src R :exports results :results graphics :file figs/traits_N_growth_methodlm.png :bg transparent

  ggplot(dt, aes(x = value, y = growth.rate)) + geom_point() + geom_smooth(method = "lm") + terk +
    facet_wrap(~trait, scales = "free")

#+end_src

#+RESULTS:
[[file:figs/traits_N_growth_methodlm.png]]
 #+begin_src R :exports results :results graphics :file figs/N_heightBinned.png :width 1000 :bg transparent

   dc <- mutate(dc, heightbin = cut(cor_max2005, 5))
     ggplot(dc, aes(x = N, y = growth.rate, color = heightbin)) + geom_point(alpha = .3) + 
         geom_smooth(method = "lm", color = "black") + terk +
       facet_wrap(~heightbin) +
      scale_color_brewer(palette = "Dark2")



#+end_src

#+RESULTS:
[[file:figs/N_heightBinned.png]]

#+begin_src R :exports results :results graphics :file figs/TotPhen_heightBinned.png :width 1000 :bg transparent

    dc <- mutate(dc, heightbin = cut(cor_max2005, 5))
      ggplot(dc, aes(x = TotPhen, y = growth.rate, color = heightbin)) + geom_point(alpha = .3) + 
          geom_smooth(method = "lm", color = "black") + terk +
        facet_wrap(~heightbin) +
      scale_color_brewer(palette = "Dark2")



#+end_src

#+RESULTS:
[[file:figs/TotPhen_heightBinned.png]]

#+begin_src R :exports results :results graphics :file figs/Sugar_heightBinned.png :width 1000 :bg transparent

    dc <- mutate(dc, heightbin = cut(cor_max2005, 5))
      ggplot(dc, aes(x = Sugar, y = growth.rate, color = heightbin)) + geom_point(alpha = .3) + 
          geom_smooth(method = "lm", color = "black") + terk +
        facet_wrap(~heightbin) +
      scale_color_brewer(palette = "Dark2")



#+end_src

#+RESULTS:
[[file:figs/Sugar_heightBinned.png]]

*** mean height within 20m

#+begin_src R :exports results :results graphics :file figs/meanheight20m_v_growthrate.png
  ggplot(d, aes(x = mean_height_wn20m, y = growth.rate)) + 
      geom_point(alpha = .1) +
      geom_smooth()
#+end_src

#+RESULTS:
[[file:figs/meanheight20m_v_growthrate.png]]

#+begin_src R :exports results :results graphics :file figs/meanheight20m_v_growthrate_lm.png
  ggplot(d, aes(x = mean_height_wn20m, y = growth.rate)) + 
      geom_point(alpha = .1) +
      geom_smooth(method = "lm")
#+end_src

#+RESULTS:
[[file:figs/meanheight20m_v_growthrate_lm.png]]
*** terrain large scale
#+begin_src R

  dt <- d %>%
      dplyr::select(UID, growth.rate, tpi_200ft, slope_200ft, aspect_200ft, aspect_trans_200ft) %>%
    gather(terr, value, -growth.rate, -UID)


#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/terrain200_growth.png :bg transparent :width 1000 :height 500 :res 100
  ggplot(dt, aes(x = value, y = growth.rate)) + geom_point(alpha = .1) + terk + geom_smooth() +
    facet_wrap(~terr, scales = "free_x", ncol = 4)

#+end_src

#+RESULTS:
[[file:figs/terrain200_growth.png]]
#+begin_src R :exports results :results graphics :file figs/terrain200_growth_lm.png :bg transparent :width 1000 :height 500 :res 100
  ggplot(dt, aes(x = value, y = growth.rate)) + geom_point(alpha = .1) + terk + geom_smooth(method = "lm") +
    facet_wrap(~terr, scales = "free_x", ncol = 4)

#+end_src

#+RESULTS:
[[file:figs/terrain200_growth_lm.png]]

*** terrain small scale
#+begin_src R

  dt <- d %>%
      dplyr::select(UID, growth.rate, tpi_5ft, slope_5ft, aspect_5ft, aspect_trans_5ft) %>%
    gather(terr, value, -growth.rate, -UID)


#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/terrain5_growth.png :bg transparent :width 1000 :height 500 :res 100

  ggplot(dt, aes(x = value, y = growth.rate)) + geom_point(alpha = .1) + terk + geom_smooth() +
    facet_wrap(~terr, scales = "free", ncol = 4)

#+end_src

#+RESULTS:
[[file:figs/terrain5_growth.png]]
#+begin_src R :exports results :results graphics :file figs/terrain5_growth_lm.png :bg transparent :width 1000 :height 500 :res 100

  ggplot(dt, aes(x = value, y = growth.rate)) + geom_point(alpha = .1) + terk + geom_smooth(method = "lm") +
    facet_wrap(~terr, scales = "free", ncol = 4)

#+end_src

#+RESULTS:
[[file:figs/terrain5_growth_lm.png]]
To see if the trend is driven by exteme points
#+begin_src R :exports results :results graphics :file figs/terrain5_growth_tpi_noextreme.png :bg transparent :width 1000 :height 500 :res 100

  ggplot(filter(dt, terr == "tpi_5ft"), aes(x = value, y = growth.rate)) + geom_point(alpha = .1) + terk + geom_smooth() +
    facet_wrap(~terr, scales = "free") +
    scale_x_continuous(limits = c(-1,1))

#+end_src

#+RESULTS:
[[file:figs/terrain5_growth_tpi_noextreme.png]]

*** elevation
#+begin_src R :exports results :results graphics :file figs/elv_growth.png :width 1000 :height 800 :bg transparent
  ggplot(d, aes(x = elev, y = growth.rate)) + geom_point(alpha = .1) +
    geom_smooth(method = "lm") + terk
#+end_src

#+RESULTS:
[[file:figs/elv_growth.png]]

*** impervious
#+begin_src R :exports results :results graphics :file figs/growth.rate_pctimp20m.png
  ggplot(d, aes(x = pct_imp_20m, y = growth.rate)) + geom_point(alpha = .1) + 
      terk +
      geom_smooth()
#+end_src

#+RESULTS:
[[file:figs/growth.rate_pctimp20m.png]]

#+begin_src R :exports results :results graphics :file figs/growth.rate_pctimp100m.png
  ggplot(d, aes(x = pct_imp_100m, y = growth.rate)) + geom_point(alpha = .1) + 
      terk +
      geom_smooth()
#+end_src

#+RESULTS:
[[file:figs/growth.rate_pctimp100m.png]]

#+begin_src R
mimp <- lm(growth.rate ~ pct_imp_20m + pct_imp_100m, data = d)
summary(mimp)
mimpint  <- lm(growth.rate ~ pct_imp_20m * pct_imp_100m, data = d)
summary(mimpint)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ pct_imp_20m + pct_imp_100m, data = d)

Residuals:
    Min      1Q  Median      3Q     Max 
-83.462  -9.955  -2.014   7.626 110.848 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept)   15.9767     0.1774  90.040  < 2e-16 ***
pct_imp_20m   -2.6797     0.4843  -5.534 3.16e-08 ***
pct_imp_100m  -5.8914     0.5802 -10.155  < 2e-16 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 15.1 on 41946 degrees of freedom
Multiple R-squared:  0.009092,	Adjusted R-squared:  0.009045 
F-statistic: 192.4 on 2 and 41946 DF,  p-value: < 2.2e-16

Call:
lm(formula = growth.rate ~ pct_imp_20m * pct_imp_100m, data = d)

Residuals:
    Min      1Q  Median      3Q     Max 
-83.390  -9.980  -2.001   7.671 114.607 

Coefficients:
                         Estimate Std. Error t value Pr(>|t|)    
(Intercept)               13.2302     0.3391  39.017  < 2e-16 ***
pct_imp_20m                3.6773     0.8256   4.454 8.46e-06 ***
pct_imp_100m               2.2153     1.0315   2.148   0.0317 *  
pct_imp_20m:pct_imp_100m -16.1802     1.7030  -9.501  < 2e-16 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 15.08 on 41945 degrees of freedom
Multiple R-squared:  0.01122,	Adjusted R-squared:  0.01115 
F-statistic: 158.7 on 3 and 41945 DF,  p-value: < 2.2e-16
#+end_example

#+begin_src R :exports results :results graphics :file figs/interactionplot_imp.png :bg transparent :width 1000

      dimp <- d %>%
        select(growth.rate, pct_imp_20m, pct_imp_100m) %>%
        mutate(local_imp = case_when(pct_imp_20m >= .45 ~ "high",
                                     pct_imp_20m < .45 & pct_imp_20m > .2 ~ "medium",
                                     pct_imp_20m <= .2 ~ "low"))

  ggplot(dimp, aes(x = pct_imp_100m, y = growth.rate, color = local_imp)) + geom_point(alpha = .1) + geom_smooth(method = "lm") + terk +
    facet_wrap(~local_imp)


#+end_src

#+RESULTS:
[[file:figs/interactionplot_imp.png]]
#+begin_src R :exports results :results graphics :file figs/interactionplot2_imp.png :bg transparent :width 1000

      dimp <- d %>%
        select(growth.rate, pct_imp_20m, pct_imp_100m) %>%
        mutate(medium_imp = case_when(pct_imp_100m >= .45 ~ "high",
                                     pct_imp_100m < .45 & pct_imp_100m > .25 ~ "medium",
                                     pct_imp_100m <= .25 ~ "low"))

  ggplot(dimp, aes(x = pct_imp_20m, y = growth.rate, color = medium_imp)) + geom_point(alpha = .1) + geom_smooth(method = "lm") + terk +
    facet_wrap(~medium_imp)


#+end_src

#+RESULTS:
[[file:figs/interactionplot2_imp.png]]
#+begin_src R :exports results :results graphics :file figs/interactionplot3_imp.png :bg transparent :width 1000

      dimp <- d %>%
        select(growth.rate, pct_imp_20m, pct_imp_100m) %>%
        mutate(medium_imp = case_when(pct_imp_100m >= .45 ~ "high",
                                     pct_imp_100m < .45 & pct_imp_100m > .25 ~ "medium",
                                     pct_imp_100m <= .25 ~ "low"))

  ggplot(dimp, aes(x = pct_imp_20m, y = growth.rate, color = medium_imp)) + 
      #geom_point(alpha = .1) + 
      geom_smooth(method = "lm") +
    terk 



#+end_src

#+RESULTS:
[[file:figs/interactionplot3_imp.png]]

** modeling
*** random forest
:PROPERTIES:
:header-args:R: :cache no :results output :exports both :comments link :session *R:hgt2* :eval yes
:END:

#+begin_src R 
    library(randomForest)
    library(dplyr)
  library(randomForestExplainer)
library(pdp)
#+end_src

#+RESULTS:
#+begin_example
randomForest 4.6-14
Type rfNews() to see new features/changes/bug fixes.

Attaching package: ‘dplyr’

The following object is masked from ‘package:randomForest’:

    combine

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

Registered S3 method overwritten by 'GGally':
  method from   
  +.gg   ggplot2
#+end_example

#+begin_src R


    d <-   readRDS("/home/erker/hgt_data/merged_data.rds")

          dc <- d %>%
              filter(complete.cases(.)) %>%
              mutate(Genus = factor(Genus),
                     st_po = factor(st_po))

#+end_src

#+RESULTS:

#+begin_src R

    mrf <- randomForest(formula = growth.rate ~ st_po +
                                                Genus + 
                                                cor_max2005 + 
                                                tpi_5ft +
                                                slope_5ft +
                                                aspect_5ft +
                                                tpi_200ft +
                                                slope_200ft +
                                                aspect_200ft +
                                                elev +
                                                mean_height_wn20m +
                                                pct_imp_20m +
                                                pct_imp_100m +
                                                TotPhen +
                                                N +
                                                Sugar +
                                                LMA +
                                                lignin +
                                                chl, 
             data = dc,
             localImp=T)

#+end_src

#+begin_src R
saveRDS(mrf, paste0("/home/erker/hgt_data/randomForest", date(), ".rds"))
mrf
#+end_src

#+RESULTS:
: 
: Call:
:  randomForest(formula = growth.rate ~ street + Genus + cor_max2005 +      tpi_5ft + slope_5ft + aspect_5ft + tpi_200ft + slope_200ft +      aspect_200ft + elev + mean_height_wn20m + pct_imp_20m + pct_imp_100m +      TotPhen + N + Sugar + LMA + lignin + chl, data = dc, localImp = T) 
:                Type of random forest: regression
:                      Number of trees: 500
: of variables tried at each split: 6
: 
:           Mean of squared residuals: 0.0140445
:                     % Var explained: 46.91

#+begin_src R :eval no
mrf <- readRDS(...)
#+end_src

#+RESULTS:

#+begin_src R :results org
  library(orgutils)
  importance(mrf)[order(-importance(mrf)[,1]),] %>%
    data.frame() %>%
  toOrg()
#+end_src

#+RESULTS:
#+BEGIN_SRC org

| row.names         |         X.IncMSE |    IncNodePurity |
|-------------------+------------------+------------------|
| Genus             | 118.785152771169 | 49.5209282927706 |
| cor_max2005       | 110.818868169204 | 47.0229824774494 |
| pct_imp_100m      |  57.257590238097 | 21.7707507137905 |
| mean_height_wn20m | 55.5075208030704 | 20.5887831209259 |
| lignin            | 49.3529971204131 | 20.0915789416627 |
| chl               | 45.3199010896456 | 18.4584232615527 |
| pct_imp_20m       | 43.0891182727796 | 19.3398405252383 |
| N                 | 42.0204554631309 | 20.0761271493273 |
| Sugar             | 41.0438653436023 | 18.4322023085719 |
| st_po             | 38.8799523337292 | 7.39339464891131 |
| TotPhen           | 38.8384225183786 | 19.3626308729807 |
| elev              | 37.8961913243256 |  19.531826800254 |
| slope_200ft       | 37.3681380133922 | 18.2239963072014 |
| LMA               | 33.4296811301435 | 18.6944159760163 |
| tpi_200ft         | 23.6174553951024 | 18.4751264869306 |
| aspect_200ft      | 18.2692112986164 | 17.7270256727321 |
| slope_5ft         | 15.3775662742339 | 17.7137969972392 |
| tpi_5ft           | 5.88916966498362 |  17.032539262487 |
| aspect_5ft        | 4.67594147258568 | 16.8197950545812 |
#+END_SRC


https://cran.r-project.org/web/packages/randomForestExplainer/vignettes/randomForestExplainer.htlm
#+begin_src R
  library(randomForestExplainer)
  importanceframe <- measure_importance(mrf)
  saveRDS(importanceframe, "/home/erker/hgt_data/importanceframe.rds")
#+end_src

#+begin_src R 
importanceframe
#+end_src

#+RESULTS:
#+begin_example
            variable mean_min_depth no_of_nodes mse_increase
1       aspect_200ft          4.332      199839 2.620552e-04
2         aspect_5ft          4.706      206149 6.158746e-05
3                chl          3.766      200190 1.615095e-03
4        cor_max2005          1.428      225476 5.378788e-03
5               elev          3.468      207434 1.325130e-03
6              Genus          1.154       74804 5.581159e-03
7             lignin          3.502      204360 2.135660e-03
8                LMA          3.726      204384 6.827571e-04
9  mean_height_wn20m          3.826      210119 1.794897e-03
10                 N          3.298      203857 1.418491e-03
11      pct_imp_100m          3.036      208848 1.558699e-03
12       pct_imp_20m          3.158      203817 1.388984e-03
13       slope_200ft          4.196      199613 6.619894e-04
14         slope_5ft          4.518      207392 2.107691e-04
15             st_po          1.986       29449 1.237459e-03
16             Sugar          3.790      201213 1.209765e-03
17           TotPhen          2.922      201089 1.899255e-03
18         tpi_200ft          4.098      201467 3.449302e-04
19           tpi_5ft          4.364      207342 7.483900e-05
   node_purity_increase no_of_trees times_a_root       p_value
1             17.727026         500            0 1.634482e-134
2             16.819795         500            0  0.000000e+00
3             18.458423         500            1 2.153653e-143
4             47.022982         500          115  0.000000e+00
5             19.531827         500           25  0.000000e+00
6             49.520928         500          138  1.000000e+00
7             20.091579         500            0 2.161882e-270
8             18.694416         500           16 3.089577e-271
9             20.588783         500            0  0.000000e+00
10            20.076127         500            1 5.554209e-253
11            21.770751         500           16  0.000000e+00
12            19.339841         500           19 1.272365e-251
13            18.223996         500            2 6.044587e-129
14            17.713797         500            0  0.000000e+00
15             7.393395         500           98  1.000000e+00
16            18.432202         500            2 6.937120e-171
17            19.362631         500           65 1.999967e-167
18            18.475126         500            0 4.410544e-178
19            17.032539         500            2  0.000000e+00
#+end_example

importance rankings

#+begin_src R :exports results :results graphics :file figs/cor_impor.png
plot_importance_ggpairs(importanceframe, measures = c("node_purity_increase", "mse_increase", "mean_min_depth", "p_value"))
#+end_src

#+RESULTS:
[[file:figs/cor_impor.png]]

#+begin_src R :exports results :results graphics :file figs/rf_imp_frame1.png

plot_multi_way_importance(importanceframe, x_measure = "mean_min_depth", y_measure = "node_purity_increase", size_measure = "p_value", no_of_labels = 5)

#+end_src

#+RESULTS:
[[file:figs/rf_imp_frame1.png]]


#+begin_src R
interactions_frame <- min_depth_interactions(mrf, c("cor_max2005", "Genus", "mean_height_wn20m", "pct_imp_20m", "pct_imp_100m", "lignin", "N","chl"))
#+end_src

#+begin_src R
saveRDS(interactions_frame, paste0("/home/erker/hgt_data/interactionsframe", date(), ".rds"))
#+end_src

#+RESULTS:
: Error in saveRDS(interactions_frame, paste0("/home/erker/hgt_data/interactionsframe",  : 
:   object 'interactions_frame' not found

#+begin_src R :exports results :results graphics :file figs/rf_int_frame.png :width 1000
plot_min_depth_interactions(interactions_frame)
#+end_src

#+RESULTS:
[[file:figs/rf_int_frame.png]]

#+begin_src R :exports results :results graphics :file figs/interactions_min_depth.png :width 1200
  library(forcats)
  ggplot(interactions_frame, aes(x = fct_reorder(interaction, mean_min_depth), y = mean_min_depth)) + geom_col()  +
              theme(axis.text.x = element_text(angle = 60, hjust = 1))
#+end_src

#+RESULTS:
[[file:figs/interactions_min_depth.png]]


#+begin_src R :exports results :results graphics :file figs/pred_int_meanheight20m_cormax2005.png
plot_predict_interaction(mrf, dc, "mean_height_wn20m", "cor_max2005")
#+end_src

#+RESULTS:
[[file:figs/pred_int_meanheight20m_cormax2005.png]]
#+begin_src R :exports results :results graphics :file figs/pred_int_pct_imp.png
plot_predict_interaction(mrf, dc, "pct_imp_20m", "pct_imp_100m")
#+end_src

#+RESULTS:
[[file:figs/pred_int_pct_imp.png]]


#+begin_src R :exports results :results graphics :file figs/pred_int_2.png
plot_predict_interaction(mrf, dc, "cor_max2005", "N")
#+end_src

#+RESULTS:
[[file:figs/pred_int_2.png]]

#+begin_src R :exports results :results graphics :file figs/partialGenus.png :width 1000 :res 120
  #pp <- partialPlot(x=mrf, pred.data=dc, x.var=Genus, which.class="Acer", las = 2)
  dp <- data.frame(pp)
  ggplot(dp, aes(x = x, y = y)) + geom_point() +
      theme(axis.text.x = element_text(angle = 60, hjust = 1))
#+end_src

#+RESULTS:
[[file:figs/partialGenus.png]]

#+begin_src R
library(pdp)
#+end_src

#+RESULTS:

#+begin_src R
genus_by_2005height <- partial(mrf, pred.data = dc, pred.var = c("Genus", "cor_max2005"))
#+end_src

#+begin_src R :exports results :results graphics :file figs/partialGenusheight.png :width 1500
plot(genus_by_2005height)
#+end_src

#+RESULTS:
[[file:figs/partialGenusheight.png]]

#+begin_src R :exports results :results graphics :file figs/partial_genus_height2.png :width 1500 :bg transparent :res 120
  ggplot(genus_by_2005height, aes(x = cor_max2005, y = yhat, color = Genus)) + geom_line() + 
      coord_cartesian(xlim = c(5,20)) +
    terk
#+end_src

#+RESULTS:
[[file:figs/partial_genus_height2.png]]
There doesn't appear to be super strong genus x height interactions to me.

#+begin_src R :exports results :results graphics :file figs/partialGenusheight.png :width 1500
#N_by_2005height <- partial(mrf, pred.data = dc, pred.var = c("N", "cor_max2005"))
plot(N_by_2005height)
#+end_src

#+RESULTS:
[[file:figs/partialGenusheight.png]]

*** multiple linear model
**** all variables first go
All in.  This will remove the observations where we have missing
data.  Instead of the 40k, it's about 20k where we ahve aviris.

#+begin_src R
  m1 <- lm(growth.rate ~ st_po + Genus + cor_max2005 + tpi_5ft + slope_5ft + aspect_trans_5ft + tpi_200ft + slope_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     d)
summary(m1)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + cor_max2005 + tpi_5ft + 
    slope_5ft + aspect_trans_5ft + tpi_200ft + slope_200ft + 
    aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * 
    pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
    data = d)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74268 -0.07954 -0.01492  0.05980  0.96226 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               3.016e-01  3.103e-02   9.718  < 2e-16 ***
st_post no util          -4.633e-02  2.996e-03 -15.463  < 2e-16 ***
st_post w util           -5.068e-02  3.710e-03 -13.661  < 2e-16 ***
GenusAcer                -6.661e-02  2.416e-02  -2.757 0.005830 ** 
GenusBetula              -7.300e-02  2.541e-02  -2.873 0.004070 ** 
GenusCarya               -4.834e-02  2.711e-02  -1.783 0.074576 .  
GenusCatalpa             -1.927e-02  2.815e-02  -0.684 0.493812    
GenusCeltis              -7.995e-02  2.489e-02  -3.212 0.001319 ** 
GenusFraxinus            -3.328e-02  2.415e-02  -1.378 0.168165    
GenusGinkgo              -1.145e-02  2.893e-02  -0.396 0.692316    
GenusGleditsia           -1.868e-02  2.420e-02  -0.772 0.440251    
GenusGymnocladus          4.411e-02  5.366e-02   0.822 0.411006    
GenusJuglans             -6.677e-02  2.551e-02  -2.617 0.008879 ** 
GenusPicea                6.475e-02  2.469e-02   2.622 0.008738 ** 
GenusPinus                1.237e-01  2.523e-02   4.902 9.55e-07 ***
GenusPlatanus            -3.761e-02  3.577e-02  -1.051 0.293053    
GenusPopulus             -5.364e-02  2.668e-02  -2.010 0.044420 *  
GenusQuercus             -7.785e-02  2.439e-02  -3.192 0.001414 ** 
GenusRobinia             -1.822e-02  2.671e-02  -0.682 0.495088    
GenusSalix               -7.777e-02  5.711e-02  -1.362 0.173315    
GenusThuja               -2.036e-02  2.672e-02  -0.762 0.446093    
GenusTilia                2.433e-02  2.433e-02   1.000 0.317262    
GenusUlmus                2.785e-02  2.486e-02   1.120 0.262563    
cor_max2005              -1.362e-02  3.365e-04 -40.488  < 2e-16 ***
tpi_5ft                  -1.194e-02  3.852e-03  -3.099 0.001943 ** 
slope_5ft                -4.072e-02  1.663e-02  -2.449 0.014335 *  
aspect_trans_5ft          4.377e-03  1.275e-03   3.433 0.000597 ***
tpi_200ft                -1.691e-03  3.019e-04  -5.602 2.15e-08 ***
slope_200ft              -4.995e-02  4.002e-02  -1.248 0.211953    
aspect_trans_200ft       -3.548e-03  1.252e-03  -2.833 0.004612 ** 
elev                      3.526e-05  5.120e-05   0.689 0.491000    
mean_height_wn20m         9.003e-03  6.013e-04  14.972  < 2e-16 ***
pct_imp_20m               2.377e-02  1.340e-02   1.774 0.076129 .  
pct_imp_100m              7.394e-03  1.364e-02   0.542 0.587753    
TotPhen                  -6.768e-03  2.206e-03  -3.067 0.002162 ** 
N                        -3.104e-02  1.720e-03 -18.044  < 2e-16 ***
Sugar                    -1.060e-02  2.038e-03  -5.198 2.03e-07 ***
LMA                      -3.620e-03  1.334e-03  -2.714 0.006645 ** 
lignin                   -1.706e-02  2.233e-03  -7.639 2.27e-14 ***
chl                       2.377e-02  2.061e-03  11.532  < 2e-16 ***
pct_imp_20m:pct_imp_100m -1.267e-01  2.461e-02  -5.149 2.64e-07 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1269 on 21415 degrees of freedom
  (20493 observations deleted due to missingness)
Multiple R-squared:  0.2011,	Adjusted R-squared:  0.1996 
F-statistic: 134.7 on 40 and 21415 DF,  p-value: < 2.2e-16
#+end_example

**** No Genus
#+begin_src R
  m_noGenus <- lm(growth.rate ~ st_po + cor_max2005 + tpi_5ft + slope_5ft + aspect_trans_5ft + tpi_200ft + slope_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     d)
summary(m_noGenus)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + cor_max2005 + tpi_5ft + slope_5ft + 
    aspect_trans_5ft + tpi_200ft + slope_200ft + aspect_trans_200ft + 
    elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + 
    N + Sugar + LMA + lignin + chl, data = d)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74673 -0.08337 -0.01631  0.06325  0.96211 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               2.420e-01  2.007e-02  12.054  < 2e-16 ***
st_post no util          -5.145e-02  2.890e-03 -17.802  < 2e-16 ***
st_post w util           -5.616e-02  3.668e-03 -15.311  < 2e-16 ***
cor_max2005              -1.458e-02  3.371e-04 -43.250  < 2e-16 ***
tpi_5ft                  -1.724e-02  3.977e-03  -4.335 1.46e-05 ***
slope_5ft                -4.421e-02  1.707e-02  -2.590 0.009609 ** 
aspect_trans_5ft          4.796e-03  1.317e-03   3.641 0.000272 ***
tpi_200ft                -1.922e-03  3.114e-04  -6.171 6.91e-10 ***
slope_200ft              -4.760e-02  4.105e-02  -1.160 0.246255    
aspect_trans_200ft       -1.675e-03  1.292e-03  -1.296 0.194915    
elev                      1.511e-04  5.262e-05   2.872 0.004081 ** 
mean_height_wn20m         9.450e-03  6.165e-04  15.329  < 2e-16 ***
pct_imp_20m               1.867e-02  1.372e-02   1.361 0.173544    
pct_imp_100m              2.117e-02  1.394e-02   1.518 0.128912    
TotPhen                  -3.002e-02  1.763e-03 -17.032  < 2e-16 ***
N                        -3.076e-02  1.727e-03 -17.807  < 2e-16 ***
Sugar                    -1.463e-03  1.953e-03  -0.749 0.453768    
LMA                      -1.235e-03  1.303e-03  -0.948 0.343128    
lignin                   -3.166e-02  2.108e-03 -15.020  < 2e-16 ***
chl                       2.736e-02  1.943e-03  14.079  < 2e-16 ***
pct_imp_20m:pct_imp_100m -1.268e-01  2.512e-02  -5.048 4.49e-07 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1312 on 21435 degrees of freedom
  (20493 observations deleted due to missingness)
Multiple R-squared:  0.1443,	Adjusted R-squared:  0.1435 
F-statistic: 180.7 on 20 and 21435 DF,  p-value: < 2.2e-16
#+end_example

**** quadratic 2005 height
#+begin_src R
  m2 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + slope_5ft + aspect_trans_5ft + tpi_200ft + slope_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     d)
summary(m2)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + poly(cor_max2005, 
    4) + tpi_5ft + slope_5ft + aspect_trans_5ft + tpi_200ft + 
    slope_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = d)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74061 -0.07927 -0.01470  0.05934  0.96097 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.437e-01  3.077e-02   4.671 3.02e-06 ***
st_post no util          -4.553e-02  2.993e-03 -15.213  < 2e-16 ***
st_post w util           -5.013e-02  3.700e-03 -13.545  < 2e-16 ***
GenusAcer                -6.677e-02  2.409e-02  -2.771 0.005586 ** 
GenusBetula              -7.130e-02  2.534e-02  -2.813 0.004908 ** 
GenusCarya               -5.249e-02  2.704e-02  -1.941 0.052262 .  
GenusCatalpa             -2.223e-02  2.808e-02  -0.792 0.428517    
GenusCeltis              -7.995e-02  2.482e-02  -3.221 0.001280 ** 
GenusFraxinus            -3.201e-02  2.409e-02  -1.329 0.183986    
GenusGinkgo              -6.934e-03  2.886e-02  -0.240 0.810139    
GenusGleditsia           -1.983e-02  2.414e-02  -0.822 0.411329    
GenusGymnocladus          4.038e-02  5.352e-02   0.754 0.450557    
GenusJuglans             -6.914e-02  2.545e-02  -2.716 0.006603 ** 
GenusPicea                6.447e-02  2.463e-02   2.618 0.008857 ** 
GenusPinus                1.216e-01  2.516e-02   4.834 1.35e-06 ***
GenusPlatanus            -4.425e-02  3.569e-02  -1.240 0.215008    
GenusPopulus             -7.056e-02  2.672e-02  -2.640 0.008289 ** 
GenusQuercus             -8.276e-02  2.433e-02  -3.402 0.000671 ***
GenusRobinia             -2.107e-02  2.664e-02  -0.791 0.429039    
GenusSalix               -7.978e-02  5.696e-02  -1.400 0.161387    
GenusThuja               -2.118e-02  2.666e-02  -0.795 0.426836    
GenusTilia                2.442e-02  2.427e-02   1.006 0.314299    
GenusUlmus                2.450e-02  2.480e-02   0.988 0.323312    
poly(cor_max2005, 4)1    -1.308e+01  3.364e-01 -38.892  < 2e-16 ***
poly(cor_max2005, 4)2     3.083e+00  2.918e-01  10.567  < 2e-16 ***
poly(cor_max2005, 4)3    -1.328e+00  2.469e-01  -5.380 7.53e-08 ***
poly(cor_max2005, 4)4     6.974e-01  1.941e-01   3.592 0.000328 ***
tpi_5ft                  -1.181e-02  3.842e-03  -3.073 0.002121 ** 
slope_5ft                -4.207e-02  1.659e-02  -2.537 0.011203 *  
aspect_trans_5ft          4.326e-03  1.272e-03   3.401 0.000672 ***
tpi_200ft                -1.541e-03  3.016e-04  -5.110 3.25e-07 ***
slope_200ft              -6.395e-02  3.997e-02  -1.600 0.109661    
aspect_trans_200ft       -3.484e-03  1.249e-03  -2.789 0.005288 ** 
elev                      1.263e-05  5.123e-05   0.246 0.805358    
mean_height_wn20m         8.280e-03  6.037e-04  13.716  < 2e-16 ***
pct_imp_20m               2.078e-02  1.337e-02   1.554 0.120094    
pct_imp_100m              7.851e-03  1.362e-02   0.576 0.564421    
TotPhen                  -6.573e-03  2.201e-03  -2.986 0.002827 ** 
N                        -2.982e-02  1.722e-03 -17.316  < 2e-16 ***
Sugar                    -1.067e-02  2.033e-03  -5.246 1.57e-07 ***
LMA                      -2.646e-03  1.333e-03  -1.984 0.047268 *  
lignin                   -1.657e-02  2.228e-03  -7.438 1.06e-13 ***
chl                       2.230e-02  2.063e-03  10.807  < 2e-16 ***
pct_imp_20m:pct_imp_100m -1.263e-01  2.460e-02  -5.137 2.82e-07 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1265 on 21412 degrees of freedom
  (20493 observations deleted due to missingness)
Multiple R-squared:  0.2054,	Adjusted R-squared:  0.2038 
F-statistic: 128.7 on 43 and 21412 DF,  p-value: < 2.2e-16
#+end_example

#+begin_src R
AIC(m1, m2)
#+end_src

#+RESULTS:
:    df       AIC
: m1 42 -27670.09
: m2 45 -27780.65

**** quadratic 2005 height do a little variable selection and use AIC
***** the observations with traits n = 21244
#+begin_src R
dc <- dplyr::filter(d, complete.cases(d))
  m4 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + slope_5ft + aspect_trans_5ft + tpi_200ft + slope_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     dc)
  m5 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     dc)
  m6 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     dc)
  m7 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, dc)
  m8 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, dc)

AIC(m4,m5,m6,m7, m8)

#+end_src

#+RESULTS:
: 
:    df       AIC
: m4 45 -27624.22
: m5 43 -27615.17
: m6 41 -27605.70
: m7 37 -27196.03
: m8 36 -27191.68

***** all observations, but no traits, n = 41936
#+begin_src R

    m4 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + slope_5ft + aspect_trans_5ft + tpi_200ft + slope_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, 
       d)
    m5 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, 
       d)
    m6 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, 
       d)
    m7 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, 
             d)

  AIC(m4,m5,m6,m7)

#+end_src

#+RESULTS:
: 
:    df       AIC
: m4 39 -46569.99
: m5 37 -46563.51
: m6 35 -46562.88
: m7 37 -46563.51

Do coeffieicnets change when observations are dropped because we don't
have traits
#+begin_src R
  m_traits <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     dc)

  m_notraits <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, 
           d)

#+end_src

#+RESULTS:

#+begin_src R
summary(m_notraits)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + poly(cor_max2005, 
    4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + 
    elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m, data = d)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.86398 -0.08492 -0.01520  0.06610  1.07524 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.306e-01  2.293e-02   5.695 1.24e-08 ***
st_post no util          -4.657e-02  2.711e-03 -17.178  < 2e-16 ***
st_post w util           -6.422e-02  3.214e-03 -19.982  < 2e-16 ***
GenusAcer                -1.262e-01  1.868e-02  -6.756 1.44e-11 ***
GenusBetula              -1.455e-01  1.956e-02  -7.436 1.06e-13 ***
GenusCarya               -1.069e-01  2.211e-02  -4.837 1.32e-06 ***
GenusCatalpa             -6.733e-02  2.380e-02  -2.829 0.004667 ** 
GenusCeltis              -1.311e-01  1.934e-02  -6.780 1.22e-11 ***
GenusFraxinus            -6.712e-02  1.870e-02  -3.588 0.000333 ***
GenusGinkgo              -4.231e-02  2.204e-02  -1.920 0.054923 .  
GenusGleditsia           -5.708e-02  1.873e-02  -3.048 0.002306 ** 
GenusGymnocladus         -5.392e-02  4.582e-02  -1.177 0.239274    
GenusJuglans             -1.125e-01  2.022e-02  -5.565 2.63e-08 ***
GenusPicea                1.093e-02  1.917e-02   0.570 0.568657    
GenusPinus                4.469e-02  1.974e-02   2.264 0.023589 *  
GenusPlatanus            -9.143e-02  3.258e-02  -2.806 0.005018 ** 
GenusPopulus             -1.170e-01  2.199e-02  -5.321 1.04e-07 ***
GenusQuercus             -1.257e-01  1.903e-02  -6.606 4.01e-11 ***
GenusRobinia             -7.271e-02  2.187e-02  -3.325 0.000885 ***
GenusSalix               -5.226e-02  4.276e-02  -1.222 0.221563    
GenusThuja               -9.660e-02  2.024e-02  -4.772 1.83e-06 ***
GenusTilia               -1.911e-02  1.879e-02  -1.017 0.309078    
GenusUlmus                7.034e-04  1.934e-02   0.036 0.970986    
poly(cor_max2005, 4)1    -9.587e+00  2.010e-01 -47.701  < 2e-16 ***
poly(cor_max2005, 4)2     5.217e-01  1.473e-01   3.542 0.000398 ***
poly(cor_max2005, 4)3     3.727e-01  1.409e-01   2.645 0.008168 ** 
poly(cor_max2005, 4)4    -2.848e-01  1.397e-01  -2.038 0.041511 *  
tpi_5ft                  -1.040e-02  3.119e-03  -3.334 0.000857 ***
aspect_trans_5ft          2.102e-03  9.863e-04   2.131 0.033060 *  
tpi_200ft                -1.180e-03  2.448e-04  -4.821 1.44e-06 ***
aspect_trans_200ft       -8.856e-04  9.633e-04  -0.919 0.357964    
elev                      1.156e-04  3.581e-05   3.227 0.001251 ** 
mean_height_wn20m         9.231e-03  4.653e-04  19.837  < 2e-16 ***
pct_imp_20m               5.170e-02  9.470e-03   5.459 4.81e-08 ***
pct_imp_100m              2.992e-02  1.021e-02   2.931 0.003382 ** 
pct_imp_20m:pct_imp_100m -2.153e-01  1.691e-02 -12.732  < 2e-16 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1388 on 41902 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.1632,	Adjusted R-squared:  0.1625 
F-statistic: 233.5 on 35 and 41902 DF,  p-value: < 2.2e-16
#+end_example

#+begin_src R
cbind(traits = coef(summary(m_notraits))[1:35,3], notraits = coef(summary(m_traits))[1:35,3])
#+end_src

#+RESULTS:
#+begin_example
                            traits     notraits
(Intercept)             5.69470812   3.61150162
st_post no util       -17.17833083 -15.59895057
st_post w util        -19.98188600 -14.10143877
GenusAcer              -6.75573826  -2.75949953
GenusBetula            -7.43621677  -2.87759004
GenusCarya             -4.83719711  -2.26124257
GenusCatalpa           -2.82933326  -0.94887531
GenusCeltis            -6.78029150  -3.28277647
GenusFraxinus          -3.58819344  -1.30873328
GenusGinkgo            -1.91954132  -0.23894344
GenusGleditsia         -3.04784707  -0.81960531
GenusGymnocladus       -1.17681939   0.74181339
GenusJuglans           -5.56520175  -2.76350954
GenusPicea              0.57003530   2.93050109
GenusPinus              2.26384275   4.83220205
GenusPlatanus          -2.80601114  -1.24210557
GenusPopulus           -5.32099509  -2.57710158
GenusQuercus           -6.60559014  -3.44568664
GenusRobinia           -3.32487786  -0.95259702
GenusSalix             -1.22240073  -1.34837367
GenusThuja             -4.77225644  -0.82746970
GenusTilia             -1.01717115   1.03762705
GenusUlmus              0.03637182   0.92069440
poly(cor_max2005, 4)1 -47.70115586 -39.42373152
poly(cor_max2005, 4)2   3.54151689   9.24986620
poly(cor_max2005, 4)3   2.64517277  -3.90387164
poly(cor_max2005, 4)4  -2.03845390   3.63309384
tpi_5ft                -3.33408036  -3.11528009
aspect_trans_5ft        2.13142442   3.30156307
tpi_200ft              -4.82070658  -5.41688044
aspect_trans_200ft     -0.91926137  -2.55373632
elev                    3.22719527   0.06102249
mean_height_wn20m      19.83686139  13.37919853
pct_imp_20m             5.45925911   1.70098934
pct_imp_100m            2.93086164   1.30348778
#+end_example

Yes.  Definitely for the species.  

**** a good mlr model
#+begin_src R
  m5 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
     dc)
summary(m5)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + poly(cor_max2005, 
    4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + 
    elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + 
    N + Sugar + LMA + lignin + chl, data = dc)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74030 -0.07899 -0.01479  0.05957  0.96273 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.106e-01  3.064e-02   3.612 0.000305 ***
st_post no util          -4.758e-02  3.050e-03 -15.599  < 2e-16 ***
st_post w util           -5.242e-02  3.717e-03 -14.101  < 2e-16 ***
GenusAcer                -6.633e-02  2.404e-02  -2.759 0.005794 ** 
GenusBetula              -7.319e-02  2.544e-02  -2.878 0.004011 ** 
GenusCarya               -6.308e-02  2.789e-02  -2.261 0.023754 *  
GenusCatalpa             -2.668e-02  2.812e-02  -0.949 0.342695    
GenusCeltis              -8.129e-02  2.476e-02  -3.283 0.001030 ** 
GenusFraxinus            -3.146e-02  2.404e-02  -1.309 0.190639    
GenusGinkgo              -6.880e-03  2.879e-02  -0.239 0.811152    
GenusGleditsia           -1.974e-02  2.408e-02  -0.820 0.412450    
GenusGymnocladus          3.960e-02  5.339e-02   0.742 0.458209    
GenusJuglans             -7.017e-02  2.539e-02  -2.764 0.005723 ** 
GenusPicea                7.227e-02  2.466e-02   2.931 0.003388 ** 
GenusPinus                1.213e-01  2.510e-02   4.832 1.36e-06 ***
GenusPlatanus            -4.421e-02  3.560e-02  -1.242 0.214211    
GenusPopulus             -6.876e-02  2.668e-02  -2.577 0.009970 ** 
GenusQuercus             -8.364e-02  2.428e-02  -3.446 0.000571 ***
GenusRobinia             -2.529e-02  2.655e-02  -0.953 0.340805    
GenusSalix               -9.106e-02  6.753e-02  -1.348 0.177553    
GenusThuja               -2.200e-02  2.659e-02  -0.827 0.407980    
GenusTilia                2.513e-02  2.421e-02   1.038 0.299456    
GenusUlmus                2.279e-02  2.475e-02   0.921 0.357220    
poly(cor_max2005, 4)1    -6.916e+00  1.754e-01 -39.424  < 2e-16 ***
poly(cor_max2005, 4)2     1.238e+00  1.338e-01   9.250  < 2e-16 ***
poly(cor_max2005, 4)3    -5.026e-01  1.287e-01  -3.904 9.50e-05 ***
poly(cor_max2005, 4)4     4.623e-01  1.272e-01   3.633 0.000281 ***
tpi_5ft                  -1.199e-02  3.849e-03  -3.115 0.001840 ** 
aspect_trans_5ft          4.207e-03  1.274e-03   3.302 0.000963 ***
tpi_200ft                -1.630e-03  3.010e-04  -5.417 6.13e-08 ***
aspect_trans_200ft       -3.195e-03  1.251e-03  -2.554 0.010664 *  
elev                      3.114e-06  5.104e-05   0.061 0.951342    
mean_height_wn20m         8.100e-03  6.054e-04  13.379  < 2e-16 ***
pct_imp_20m               2.270e-02  1.334e-02   1.701 0.088960 .  
pct_imp_100m              1.726e-02  1.324e-02   1.303 0.192422    
TotPhen                  -6.776e-03  2.204e-03  -3.074 0.002114 ** 
N                        -2.968e-02  1.723e-03 -17.222  < 2e-16 ***
Sugar                    -1.086e-02  2.035e-03  -5.337 9.53e-08 ***
LMA                      -2.876e-03  1.334e-03  -2.156 0.031096 *  
lignin                   -1.664e-02  2.230e-03  -7.460 9.01e-14 ***
chl                       2.159e-02  2.068e-03  10.439  < 2e-16 ***
pct_imp_20m:pct_imp_100m -1.364e-01  2.430e-02  -5.614 2.01e-08 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1262 on 21205 degrees of freedom
Multiple R-squared:  0.2063,	Adjusted R-squared:  0.2048 
F-statistic: 134.4 on 41 and 21205 DF,  p-value: < 2.2e-16
#+end_example

*** MLR, differences conifer and not

**** conifer interaction
#+begin_src R
    m.coniferint <- lm(growth.rate ~ conifer * (st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl), 
       dc)
  summary(m.coniferint)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ conifer * (st_po + poly(cor_max2005, 
    4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl), data = dc)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.75302 -0.08159 -0.01560  0.06313  0.95931 

Coefficients:
                                       Estimate Std. Error t value Pr(>|t|)    
(Intercept)                           2.946e-02  1.969e-02   1.497 0.134476    
coniferTRUE                           2.899e-01  1.304e-01   2.223 0.026240 *  
st_post no util                      -3.779e-02  3.081e-03 -12.268  < 2e-16 ***
st_post w util                       -4.333e-02  3.769e-03 -11.497  < 2e-16 ***
poly(cor_max2005, 4)1                -7.352e+00  1.780e-01 -41.300  < 2e-16 ***
poly(cor_max2005, 4)2                 9.559e-01  1.347e-01   7.097 1.32e-12 ***
poly(cor_max2005, 4)3                -6.479e-01  1.315e-01  -4.926 8.45e-07 ***
poly(cor_max2005, 4)4                 7.284e-01  1.312e-01   5.552 2.86e-08 ***
tpi_5ft                              -1.480e-02  3.959e-03  -3.737 0.000187 ***
tpi_200ft                            -1.729e-03  3.130e-04  -5.524 3.35e-08 ***
aspect_trans_200ft                    2.702e-04  1.227e-03   0.220 0.825763    
elev                                  4.245e-05  5.250e-05   0.809 0.418743    
mean_height_wn20m                     9.096e-03  6.313e-04  14.408  < 2e-16 ***
pct_imp_20m                           3.069e-02  1.378e-02   2.227 0.025942 *  
pct_imp_100m                          4.558e-02  1.350e-02   3.377 0.000734 ***
TotPhen                              -2.287e-02  1.780e-03 -12.844  < 2e-16 ***
N                                    -2.184e-02  1.769e-03 -12.347  < 2e-16 ***
Sugar                                -3.573e-03  1.950e-03  -1.832 0.066946 .  
LMA                                  -3.900e-03  1.319e-03  -2.957 0.003113 ** 
lignin                               -2.609e-02  2.135e-03 -12.221  < 2e-16 ***
chl                                   1.564e-02  2.004e-03   7.804 6.26e-15 ***
pct_imp_20m:pct_imp_100m             -1.492e-01  2.475e-02  -6.027 1.70e-09 ***
coniferTRUE:st_post no util          -4.505e-04  1.325e-02  -0.034 0.972883    
coniferTRUE:st_post w util            2.376e-02  2.434e-02   0.976 0.328987    
coniferTRUE:poly(cor_max2005, 4)1    -5.282e-01  9.258e-01  -0.571 0.568277    
coniferTRUE:poly(cor_max2005, 4)2     8.851e-01  1.404e+00   0.631 0.528308    
coniferTRUE:poly(cor_max2005, 4)3     1.051e+00  2.101e+00   0.500 0.616793    
coniferTRUE:poly(cor_max2005, 4)4    -1.642e+00  1.724e+00  -0.952 0.341020    
coniferTRUE:tpi_5ft                   3.236e-03  3.003e-02   0.108 0.914189    
coniferTRUE:tpi_200ft                -2.885e-03  1.548e-03  -1.863 0.062479 .  
coniferTRUE:aspect_trans_200ft        3.724e-03  7.159e-03   0.520 0.602921    
coniferTRUE:elev                     -4.790e-04  3.883e-04  -1.234 0.217345    
coniferTRUE:mean_height_wn20m        -5.909e-03  2.930e-03  -2.016 0.043762 *  
coniferTRUE:pct_imp_20m               4.337e-02  8.282e-02   0.524 0.600518    
coniferTRUE:pct_imp_100m              6.139e-02  8.922e-02   0.688 0.491398    
coniferTRUE:TotPhen                  -3.007e-02  1.179e-02  -2.551 0.010746 *  
coniferTRUE:N                        -2.275e-02  9.257e-03  -2.458 0.013990 *  
coniferTRUE:Sugar                     1.471e-02  1.166e-02   1.261 0.207223    
coniferTRUE:LMA                      -5.057e-03  7.358e-03  -0.687 0.491960    
coniferTRUE:lignin                   -1.522e-02  1.138e-02  -1.338 0.181030    
coniferTRUE:chl                       1.263e-02  1.142e-02   1.106 0.268736    
coniferTRUE:pct_imp_20m:pct_imp_100m -2.755e-01  1.975e-01  -1.395 0.163020    
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1289 on 21205 degrees of freedom
Multiple R-squared:  0.1725,	Adjusted R-squared:  0.1709 
F-statistic: 107.8 on 41 and 21205 DF,  p-value: < 2.2e-16
#+end_example

**** rmove conifers and fit, see if traits change.  or add conifer dummy variable. and interact with traits.
#+begin_src R
    m.noconifer <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$conifer == F)
  summary(m.noconifer)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + poly(cor_max2005, 
    4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$conifer == F)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74445 -0.07748 -0.01450  0.05844  0.96471 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               3.759e-02  1.894e-02   1.985 0.047177 *  
st_post no util          -4.801e-02  3.094e-03 -15.518  < 2e-16 ***
st_post w util           -5.294e-02  3.723e-03 -14.218  < 2e-16 ***
GenusBetula              -3.516e-03  9.028e-03  -0.389 0.696938    
GenusCarya                3.311e-03  1.405e-02   0.236 0.813673    
GenusCatalpa              4.323e-02  1.461e-02   2.958 0.003099 ** 
GenusCeltis              -1.196e-02  6.683e-03  -1.790 0.073475 .  
GenusFraxinus             3.690e-02  2.772e-03  13.313  < 2e-16 ***
GenusGinkgo               6.554e-02  1.582e-02   4.142 3.45e-05 ***
GenusGleditsia            4.856e-02  3.274e-03  14.834  < 2e-16 ***
GenusGymnocladus          1.080e-01  4.658e-02   2.319 0.020422 *  
GenusJuglans             -2.655e-03  8.620e-03  -0.308 0.758097    
GenusPlatanus             2.518e-02  2.583e-02   0.975 0.329647    
GenusPopulus              2.697e-03  1.219e-02   0.221 0.824886    
GenusQuercus             -1.601e-02  4.676e-03  -3.425 0.000617 ***
GenusRobinia              4.022e-02  1.136e-02   3.540 0.000401 ***
GenusSalix               -2.276e-02  6.160e-02  -0.370 0.711730    
GenusThuja                4.795e-02  1.177e-02   4.073 4.65e-05 ***
GenusTilia                9.294e-02  3.766e-03  24.682  < 2e-16 ***
GenusUlmus                9.152e-02  6.556e-03  13.960  < 2e-16 ***
poly(cor_max2005, 4)1    -6.892e+00  1.763e-01 -39.098  < 2e-16 ***
poly(cor_max2005, 4)2     1.235e+00  1.327e-01   9.310  < 2e-16 ***
poly(cor_max2005, 4)3    -5.529e-01  1.270e-01  -4.353 1.35e-05 ***
poly(cor_max2005, 4)4     4.926e-01  1.256e-01   3.921 8.85e-05 ***
tpi_5ft                  -1.213e-02  3.786e-03  -3.202 0.001365 ** 
tpi_200ft                -1.440e-03  2.999e-04  -4.800 1.59e-06 ***
aspect_trans_200ft       -1.765e-03  1.176e-03  -1.501 0.133336    
elev                      6.303e-06  5.031e-05   0.125 0.900297    
mean_height_wn20m         8.565e-03  6.069e-04  14.113  < 2e-16 ***
pct_imp_20m               2.878e-02  1.331e-02   2.163 0.030564 *  
pct_imp_100m              1.911e-02  1.309e-02   1.460 0.144404    
TotPhen                  -3.445e-03  2.203e-03  -1.564 0.117865    
N                        -2.790e-02  1.722e-03 -16.206  < 2e-16 ***
Sugar                    -1.167e-02  2.018e-03  -5.781 7.52e-09 ***
LMA                      -3.308e-03  1.329e-03  -2.489 0.012827 *  
lignin                   -1.532e-02  2.230e-03  -6.869 6.65e-12 ***
chl                       2.023e-02  2.061e-03   9.819  < 2e-16 ***
pct_imp_20m:pct_imp_100m -1.391e-01  2.404e-02  -5.786 7.31e-09 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.123 on 20496 degrees of freedom
Multiple R-squared:  0.1671,	Adjusted R-squared:  0.1656 
F-statistic: 111.1 on 37 and 20496 DF,  p-value: < 2.2e-16
#+end_example

#+begin_src R
    m.conifer <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$conifer == T)
  summary(m.conifer)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + poly(cor_max2005, 
    4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$conifer == T)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.45956 -0.13136 -0.03374  0.10400  0.74917 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               0.2607969  0.1983237   1.315  0.18894    
st_post no util          -0.0404688  0.0194898  -2.076  0.03823 *  
st_post w util           -0.0177256  0.0363589  -0.488  0.62605    
GenusPicea                0.0551074  0.0390878   1.410  0.15904    
GenusPinus                0.1152770  0.0398731   2.891  0.00396 ** 
poly(cor_max2005, 4)1    -7.2955123  1.3790298  -5.290 1.64e-07 ***
poly(cor_max2005, 4)2     2.3846940  2.1218356   1.124  0.26145    
poly(cor_max2005, 4)3     2.0748171  3.1976811   0.649  0.51665    
poly(cor_max2005, 4)4     0.3589448  2.6144033   0.137  0.89084    
tpi_5ft                  -0.0117626  0.0449725  -0.262  0.79375    
tpi_200ft                -0.0041603  0.0022941  -1.813  0.07020 .  
aspect_trans_200ft        0.0002321  0.0107179   0.022  0.98273    
elev                     -0.0004414  0.0005811  -0.760  0.44771    
mean_height_wn20m         0.0020468  0.0043307   0.473  0.63663    
pct_imp_20m               0.0901510  0.1233958   0.731  0.46528    
pct_imp_100m              0.1275931  0.1333787   0.957  0.33909    
TotPhen                  -0.0440554  0.0177200  -2.486  0.01315 *  
N                        -0.0440619  0.0137318  -3.209  0.00139 ** 
Sugar                     0.0077543  0.0173948   0.446  0.65589    
LMA                      -0.0081450  0.0109438  -0.744  0.45697    
lignin                   -0.0317563  0.0170391  -1.864  0.06278 .  
chl                       0.0322431  0.0170798   1.888  0.05947 .  
pct_imp_20m:pct_imp_100m -0.5144442  0.2967429  -1.734  0.08343 .  
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1946 on 690 degrees of freedom
Multiple R-squared:  0.177,	Adjusted R-squared:  0.1507 
F-statistic: 6.744 on 22 and 690 DF,  p-value: < 2.2e-16
#+end_example



***** traits by conifer not
#+begin_src R
  library(broom)
    traits <- c("N", "chl", "TotPhen", "lignin", "Sugar", "LMA")

    mnocon <-   tidy(m.noconifer) %>%
          filter(term %in% traits) %>%
          mutate(model = "broadleaf")

    mcon <-   tidy(m.conifer) %>%
          filter(term %in% traits) %>%
          mutate(model = "conifer")

    mc <- bind_rows(mnocon, mcon)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/conifer_trait_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/conifer_trait_coef_plots.png]]

*** MLR, street versus not, also powerlines subset to street trees / powerlines

**** fit model with interactions I fit the separate models below
#+begin_src R :results org
  library(orgutils)
        m.street_powerline_neighborhood_int <- lm(growth.rate ~ Genus + st_po * (poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl), 
           dc)
    tidy(m.street_powerline_neighborhood_int) %>%
      mutate(pless.01 = p.value < .01) %>%
      toOrg() %>% print(digits = 3)

#+end_src

#+RESULTS:
#+BEGIN_SRC org

| term                                     |              estimate |            std.error |          statistic |              p.value | pless.01 |
|------------------------------------------+-----------------------+----------------------+--------------------+----------------------+----------|
| (Intercept)                              |     0.125413111588887 |   0.0695698930765384 |   1.80269231477633 |   0.0714507658247099 |    FALSE |
| GenusAcer                                |   -0.0635150786410785 |   0.0240778794155344 |  -2.63790168332267 |  0.00834817585058683 |     TRUE |
| GenusBetula                              |   -0.0749359571864098 |   0.0255002489301267 |  -2.93863630083541 |  0.00330015392112987 |     TRUE |
| GenusCarya                               |   -0.0620712024319257 |   0.0279475558881259 |  -2.22098857876505 |   0.0263622751061351 |    FALSE |
| GenusCatalpa                             |   -0.0241908720839883 |   0.0282130480516592 | -0.857435610632848 |    0.391213892261713 |    FALSE |
| GenusCeltis                              |   -0.0813528232019033 |   0.0248205876159735 |  -3.27763485944015 |   0.0010484933403912 |     TRUE |
| GenusFraxinus                            |   -0.0290767464397189 |   0.0240771594744052 |  -1.20764853805236 |    0.227195972078355 |    FALSE |
| GenusGinkgo                              |  -0.00386072995449304 |   0.0288225795915174 | -0.133948106283633 |    0.893444882969815 |    FALSE |
| GenusGleditsia                           |    -0.017004527860407 |   0.0241172859102727 | -0.705076347465949 |    0.480770482153773 |    FALSE |
| GenusGymnocladus                         |    0.0375926272809279 |   0.0533860532882607 |  0.704165694323659 |    0.481337337808942 |    FALSE |
| GenusJuglans                             |   -0.0659629827437877 |   0.0254661457317722 |  -2.59022246391571 |  0.00959796430878469 |     TRUE |
| GenusPicea                               |    0.0652514512081634 |   0.0247273466262777 |   2.63883756693979 |  0.00832517344601414 |     TRUE |
| GenusPinus                               |     0.117867150982004 |   0.0251188099089279 |   4.69238596133133 |  2.7172530851067e-06 |     TRUE |
| GenusPlatanus                            |   -0.0391583235640195 |   0.0356903310282246 |  -1.09716896525987 |    0.272580016560077 |    FALSE |
| GenusPopulus                             |   -0.0590429561369444 |   0.0269464126159146 |  -2.19112491813004 |   0.0284536137966914 |    FALSE |
| GenusQuercus                             |   -0.0820410823232791 |   0.0243123266354272 |  -3.37446446625686 | 0.000740921760264397 |     TRUE |
| GenusRobinia                             |   -0.0242502269179823 |   0.0265971808927633 | -0.911759295684619 |    0.361905824058224 |    FALSE |
| GenusSalix                               |    -0.088027052568377 |   0.0674846131860623 |   -1.3044018245415 |    0.192110794086502 |    FALSE |
| GenusThuja                               |   -0.0214727278840251 |   0.0265935707885819 | -0.807440567298491 |    0.419421774495195 |    FALSE |
| GenusTilia                               |    0.0272222173267263 |   0.0242520892636817 |   1.12246895641657 |    0.261675829734237 |    FALSE |
| GenusUlmus                               |    0.0250754782678581 |   0.0247920553017744 |   1.01143200765866 |    0.311821267829848 |    FALSE |
| st_post no util                          |   -0.0702628733794296 |   0.0680790712196768 |   -1.0320774376123 |    0.302047632741331 |    FALSE |
| st_post w util                           |    0.0106634791196946 |   0.0933100255324672 |  0.114280100759207 |    0.909016840182018 |    FALSE |
| poly(cor_max2005, 4)1                    |     -7.14422445848784 |    0.412096294191819 |  -17.3362987223622 | 7.25313578190772e-67 |     TRUE |
| poly(cor_max2005, 4)2                    |      1.10407116611484 |    0.332345754385015 |   3.32205587568841 | 0.000895080923924872 |     TRUE |
| poly(cor_max2005, 4)3                    |    -0.415492974286652 |    0.283657517959333 |  -1.46476982974313 |    0.142998575647538 |    FALSE |
| poly(cor_max2005, 4)4                    |     0.319440011029624 |    0.230474265487458 |   1.38601162413513 |    0.165757952650665 |    FALSE |
| tpi_5ft                                  |   -0.0380103291041909 |   0.0113569683817007 |  -3.34687284728523 | 0.000818709404196838 |     TRUE |
| tpi_200ft                                | -0.000395473393586122 | 0.000841551244978244 | -0.469933822742245 |    0.638407139254879 |    FALSE |
| aspect_trans_200ft                       |   0.00652033346429893 |  0.00342365753366056 |    1.9044934839985 |   0.0568594851219327 |    FALSE |
| elev                                     | -8.87698277276761e-05 | 0.000200706376157225 | -0.442287033562589 |     0.65828603095053 |    FALSE |
| mean_height_wn20m                        |   0.00689270236257055 |  0.00143581122832731 |   4.80056307304437 | 1.59300088505133e-06 |     TRUE |
| pct_imp_20m                              |    0.0898783672253345 |   0.0405934018514197 |   2.21411271601006 |   0.0268316402004602 |    FALSE |
| pct_imp_100m                             |    0.0415810472624403 |   0.0300932560385629 |   1.38173972298499 |    0.167066213469749 |    FALSE |
| TotPhen                                  |   0.00326976774000875 |  0.00480636007801702 |  0.680300203674663 |    0.496321835138486 |    FALSE |
| N                                        |     -0.03924194575561 |  0.00498339760149783 |  -7.87453638935317 | 3.58384391337937e-15 |     TRUE |
| Sugar                                    |   -0.0129595954715734 |  0.00549494099371806 |  -2.35845944231051 |   0.0183600021844495 |    FALSE |
| LMA                                      |   0.00331323321325364 |  0.00365043106056742 |  0.907627937161654 |    0.364085160210285 |    FALSE |
| lignin                                   |   -0.0177070278076154 |   0.0055881434566753 |  -3.16867810300459 |   0.0015335162973291 |     TRUE |
| chl                                      |    0.0368773679593096 |   0.0049282291201439 |   7.48288422885516 | 7.55454502011765e-14 |     TRUE |
| pct_imp_20m:pct_imp_100m                 |    -0.263162056017299 |   0.0846253440183075 |  -3.10973100399294 |  0.00187506289420689 |     TRUE |
| st_post no util:poly(cor_max2005, 4)1    |     0.380487027269644 |    0.460961582789989 |  0.825420255125668 |    0.409142340391742 |    FALSE |
| st_post w util:poly(cor_max2005, 4)1     |    0.0643451573054692 |    0.608280915014973 |  0.105781976250045 |    0.915756339652614 |    FALSE |
| st_post no util:poly(cor_max2005, 4)2    |     0.313130048697767 |    0.369396250461197 |  0.847680636462387 |    0.396625436408881 |    FALSE |
| st_post w util:poly(cor_max2005, 4)2     |    -0.142843140521238 |    0.540354137461671 | -0.264350970258593 |    0.791512061422794 |    FALSE |
| st_post no util:poly(cor_max2005, 4)3    |   -0.0427298611891889 |    0.341910667197669 | -0.124973758611881 |    0.900545511662419 |    FALSE |
| st_post w util:poly(cor_max2005, 4)3     |     0.725192005555191 |    0.596757844270777 |   1.21521989617306 |    0.224295786416368 |    FALSE |
| st_post no util:poly(cor_max2005, 4)4    |     0.361266335002783 |    0.313834676668823 |   1.15113581085883 |    0.249689368551497 |    FALSE |
| st_post w util:poly(cor_max2005, 4)4     |     0.068369791631576 |    0.621896914647516 |  0.109937499320651 |    0.912459984686935 |    FALSE |
| st_post no util:tpi_5ft                  |    0.0326390554604263 |   0.0121916165068487 |   2.67717209133762 |  0.00743037205364151 |     TRUE |
| st_post w util:tpi_5ft                   |    0.0145789922931408 |   0.0154856670438716 |  0.941450713865783 |    0.346484677659593 |    FALSE |
| st_post no util:tpi_200ft                |  -0.00139284682727204 | 0.000912201746119889 |   -1.5269065567969 |     0.12679918833929 |    FALSE |
| st_post w util:tpi_200ft                 |  -0.00149116586209385 |  0.00115068003542532 |  -1.29589965601748 |    0.195024186018998 |    FALSE |
| st_post no util:aspect_trans_200ft       |   -0.0079602938958521 |    0.003693025477394 |  -2.15549390183718 |   0.0311344404414266 |    FALSE |
| st_post w util:aspect_trans_200ft        |   -0.0171268184648019 |   0.0046588288770397 |  -3.67620681437961 | 0.000237312533095706 |     TRUE |
| st_post no util:elev                     |  8.87189019204192e-05 |  0.00020809952708812 |  0.426329185663412 |    0.669872328645296 |    FALSE |
| st_post w util:elev                      |  4.45017049004103e-05 | 0.000282608664798908 |  0.157467588377291 |    0.874877851680472 |    FALSE |
| st_post no util:mean_height_wn20m        |   0.00179062383129482 |   0.0016090123466165 |   1.11287140528177 |    0.265776298820462 |    FALSE |
| st_post w util:mean_height_wn20m         | -0.000445158296233769 |    0.002253394996657 | -0.197550050876202 |    0.843399014762884 |    FALSE |
| st_post no util:pct_imp_20m              |   -0.0618526376634833 |    0.043471913667654 |  -1.42281837731716 |    0.154803547515224 |    FALSE |
| st_post w util:pct_imp_20m               |     -0.12009714821127 |   0.0564557951783024 |  -2.12727759536414 |   0.0334085517006263 |    FALSE |
| st_post no util:pct_imp_100m             |   -0.0242550468949891 |   0.0342450791923221 | -0.708278312302084 |    0.478780240663768 |    FALSE |
| st_post w util:pct_imp_100m              |   -0.0970706343511522 |   0.0463324821203971 |  -2.09508815217172 |   0.0361750084016856 |    FALSE |
| st_post no util:TotPhen                  |   -0.0132196620878079 |  0.00514275195092567 |  -2.57054242824766 |   0.0101607098213296 |    FALSE |
| st_post w util:TotPhen                   |  -0.00178626237398228 |  0.00703142901488156 | -0.254039736474872 |    0.799467326760718 |    FALSE |
| st_post no util:N                        |     0.012029004286149 |  0.00533581690507033 |   2.25438850323341 |   0.0241819163055106 |    FALSE |
| st_post w util:N                         |   0.00635929963852236 |  0.00672819358763757 |  0.945171918092098 |    0.344581900803853 |    FALSE |
| st_post no util:Sugar                    |   0.00415254832193844 |   0.0058742904024728 |  0.706902117094928 |    0.479635088814833 |    FALSE |
| st_post w util:Sugar                     |  -0.00492121900728742 |  0.00777148506336408 | -0.633240489708559 |    0.526583448984657 |    FALSE |
| st_post no util:LMA                      |  -0.00770036586616846 |  0.00390774240204608 |   -1.9705408069213 |   0.0487894322691541 |    FALSE |
| st_post w util:LMA                       |  -0.00532725504905199 |  0.00509489242873672 |  -1.04560697278017 |    0.295754467071411 |    FALSE |
| st_post no util:lignin                   |   0.00170875684147431 |  0.00605743661344043 |  0.282092401542077 |    0.777875416965772 |    FALSE |
| st_post w util:lignin                    |  0.000700859228777265 |  0.00849048123312172 | 0.0825464669827175 |    0.934212949489463 |    FALSE |
| st_post no util:chl                      |   -0.0201573174488263 |  0.00534871792287561 |  -3.76862600336739 |  0.00016459387974819 |     TRUE |
| st_post w util:chl                       |  -0.00784997534465241 |  0.00742791394646414 |  -1.05682098651522 |    0.290605353810642 |    FALSE |
| st_post no util:pct_imp_20m:pct_imp_100m |      0.12438171187446 |   0.0893118493409619 |   1.39266752163662 |    0.163734979988007 |    FALSE |
| st_post w util:pct_imp_20m:pct_imp_100m  |     0.221658677391555 |    0.106947985743457 |   2.07258393742227 |   0.0382230903645626 |    FALSE |
#+END_SRC

**** street trees w powerlines
#+begin_src R
    m.street_powerline <- lm(growth.rate ~ Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$st_po == "st w util")
  summary(m.street_powerline)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ Genus + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$st_po == "st w util")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.38219 -0.07300 -0.01201  0.05342  0.73504 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               6.252e-02  6.464e-02   0.967 0.333534    
GenusBetula               8.312e-02  5.397e-02   1.540 0.123620    
GenusCarya                3.324e-02  2.960e-02   1.123 0.261556    
GenusCatalpa              7.418e-02  2.925e-02   2.536 0.011258 *  
GenusCeltis              -3.518e-02  1.944e-02  -1.810 0.070395 .  
GenusFraxinus             3.946e-02  7.446e-03   5.300 1.25e-07 ***
GenusGinkgo              -7.754e-04  3.227e-02  -0.024 0.980834    
GenusGleditsia            4.949e-02  9.088e-03   5.445 5.62e-08 ***
GenusGymnocladus         -4.857e-02  1.200e-01  -0.405 0.685628    
GenusJuglans             -8.719e-03  2.645e-02  -0.330 0.741714    
GenusPicea                1.776e-01  2.573e-02   6.902 6.31e-12 ***
GenusPinus                1.493e-01  3.694e-02   4.043 5.42e-05 ***
GenusPlatanus             2.365e-02  4.642e-02   0.510 0.610431    
GenusPopulus              9.901e-02  6.222e-02   1.591 0.111635    
GenusQuercus             -2.227e-02  1.220e-02  -1.825 0.068172 .  
GenusRobinia              1.029e-01  3.859e-02   2.666 0.007712 ** 
GenusThuja               -1.010e-01  4.613e-02  -2.189 0.028652 *  
GenusTilia                8.899e-02  1.102e-02   8.078 9.65e-16 ***
GenusUlmus                5.252e-02  1.794e-02   2.928 0.003434 ** 
poly(cor_max2005, 4)1    -7.073e+00  4.379e-01 -16.153  < 2e-16 ***
poly(cor_max2005, 4)2     8.598e-01  4.168e-01   2.063 0.039230 *  
poly(cor_max2005, 4)3     8.007e-02  5.104e-01   0.157 0.875351    
poly(cor_max2005, 4)4     1.588e-01  5.548e-01   0.286 0.774664    
tpi_5ft                  -2.546e-02  1.005e-02  -2.535 0.011310 *  
tpi_200ft                -1.818e-03  7.518e-04  -2.419 0.015634 *  
aspect_trans_200ft       -1.020e-02  3.004e-03  -3.395 0.000695 ***
elev                     -9.538e-07  1.914e-04  -0.005 0.996025    
mean_height_wn20m         6.237e-03  1.682e-03   3.709 0.000212 ***
pct_imp_20m              -3.360e-02  3.776e-02  -0.890 0.373660    
pct_imp_100m             -5.763e-02  3.456e-02  -1.667 0.095542 .  
TotPhen                   1.519e-03  6.478e-03   0.234 0.814687    
N                        -3.204e-02  4.391e-03  -7.297 3.81e-13 ***
Sugar                    -1.611e-02  5.641e-03  -2.857 0.004312 ** 
LMA                      -2.500e-03  3.572e-03  -0.700 0.484012    
lignin                   -1.768e-02  6.757e-03  -2.617 0.008928 ** 
chl                       2.994e-02  5.821e-03   5.144 2.88e-07 ***
pct_imp_20m:pct_imp_100m -3.507e-02  6.376e-02  -0.550 0.582405    
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1196 on 2828 degrees of freedom
Multiple R-squared:  0.1898,	Adjusted R-squared:  0.1795 
F-statistic:  18.4 on 36 and 2828 DF,  p-value: < 2.2e-16
#+end_example

**** street trees no powerlines
#+begin_src R
    m.street_no_powerline <- lm(growth.rate ~ Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$st_po == "st no util")
  summary(m.street_no_powerline)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ Genus + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$st_po == "st no util")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.73630 -0.07626 -0.01403  0.05743  0.96820 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               6.256e-02  4.611e-02   1.357  0.17485    
GenusAcer                -7.371e-02  4.094e-02  -1.801  0.07177 .  
GenusBetula              -5.676e-02  4.529e-02  -1.253  0.21017    
GenusCarya               -7.811e-02  4.449e-02  -1.755  0.07920 .  
GenusCatalpa             -3.853e-02  4.557e-02  -0.845  0.39789    
GenusCeltis              -8.940e-02  4.158e-02  -2.150  0.03157 *  
GenusFraxinus            -3.454e-02  4.091e-02  -0.844  0.39850    
GenusGinkgo               1.334e-02  4.483e-02   0.298  0.76606    
GenusGleditsia           -2.054e-02  4.097e-02  -0.501  0.61618    
GenusGymnocladus          1.307e-01  7.358e-02   1.776  0.07574 .  
GenusJuglans             -9.394e-02  4.282e-02  -2.194  0.02826 *  
GenusPicea                6.580e-02  4.245e-02   1.550  0.12114    
GenusPinus                1.172e-01  4.278e-02   2.740  0.00615 ** 
GenusPlatanus            -1.014e-01  5.771e-02  -1.757  0.07893 .  
GenusPopulus             -5.349e-02  4.497e-02  -1.189  0.23428    
GenusQuercus             -8.540e-02  4.121e-02  -2.072  0.03824 *  
GenusRobinia             -3.969e-02  4.334e-02  -0.916  0.35986    
GenusSalix               -9.290e-02  7.354e-02  -1.263  0.20655    
GenusThuja               -3.946e-02  4.588e-02  -0.860  0.38982    
GenusTilia                2.190e-02  4.102e-02   0.534  0.59349    
GenusUlmus                4.586e-02  4.151e-02   1.105  0.26923    
poly(cor_max2005, 4)1    -6.746e+00  2.115e-01 -31.891  < 2e-16 ***
poly(cor_max2005, 4)2     1.384e+00  1.627e-01   8.508  < 2e-16 ***
poly(cor_max2005, 4)3    -4.475e-01  1.862e-01  -2.404  0.01624 *  
poly(cor_max2005, 4)4     6.556e-01  2.072e-01   3.164  0.00156 ** 
tpi_5ft                  -5.362e-03  4.312e-03  -1.243  0.21372    
tpi_200ft                -1.764e-03  3.437e-04  -5.133 2.88e-07 ***
aspect_trans_200ft       -1.601e-03  1.346e-03  -1.189  0.23429    
elev                     -1.469e-06  5.412e-05  -0.027  0.97834    
mean_height_wn20m         8.574e-03  7.083e-04  12.104  < 2e-16 ***
pct_imp_20m               3.166e-02  1.523e-02   2.078  0.03769 *  
pct_imp_100m              1.816e-02  1.622e-02   1.120  0.26291    
TotPhen                  -6.387e-03  2.549e-03  -2.506  0.01224 *  
N                        -2.738e-02  1.956e-03 -13.994  < 2e-16 ***
Sugar                    -9.946e-03  2.301e-03  -4.323 1.55e-05 ***
LMA                      -4.715e-03  1.508e-03  -3.128  0.00177 ** 
lignin                   -1.360e-02  2.548e-03  -5.337 9.58e-08 ***
chl                       1.677e-02  2.368e-03   7.081 1.49e-12 ***
pct_imp_20m:pct_imp_100m -1.459e-01  2.836e-02  -5.146 2.70e-07 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1223 on 15517 degrees of freedom
Multiple R-squared:  0.1869,	Adjusted R-squared:  0.1849 
F-statistic: 93.88 on 38 and 15517 DF,  p-value: < 2.2e-16
#+end_example

**** neighborhood trees
#+begin_src R
    m.neigh <- lm(growth.rate ~ Genus + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$st_po == "neighborhood")
  summary(m.neigh)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ Genus + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$st_po == "neighborhood")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.40641 -0.09651 -0.01960  0.07758  0.90873 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.181e-01  8.631e-02   1.368 0.171445    
GenusAcer                -3.595e-02  3.505e-02  -1.026 0.305136    
GenusBetula              -8.434e-02  3.634e-02  -2.321 0.020378 *  
GenusCarya               -5.955e-02  5.458e-02  -1.091 0.275368    
GenusCatalpa             -3.690e-02  4.965e-02  -0.743 0.457447    
GenusCeltis              -5.746e-02  3.791e-02  -1.516 0.129689    
GenusFraxinus            -3.810e-02  3.614e-02  -1.054 0.291967    
GenusGinkgo               1.759e-03  8.230e-02   0.021 0.982955    
GenusGleditsia           -2.923e-02  3.541e-02  -0.825 0.409207    
GenusGymnocladus         -7.926e-02  1.112e-01  -0.713 0.475966    
GenusJuglans             -4.016e-02  3.756e-02  -1.069 0.285113    
GenusPicea                5.733e-02  3.560e-02   1.610 0.107451    
GenusPinus                1.176e-01  3.631e-02   3.238 0.001216 ** 
GenusPlatanus             3.538e-02  6.642e-02   0.533 0.594333    
GenusPopulus             -7.135e-02  3.970e-02  -1.798 0.072362 .  
GenusQuercus             -7.872e-02  3.560e-02  -2.211 0.027089 *  
GenusRobinia             -1.783e-02  4.209e-02  -0.424 0.671910    
GenusThuja               -1.905e-03  3.839e-02  -0.050 0.960432    
GenusTilia                7.088e-03  4.133e-02   0.172 0.863842    
GenusUlmus               -3.988e-02  3.864e-02  -1.032 0.302034    
poly(cor_max2005, 4)1    -7.276e+00  4.963e-01 -14.660  < 2e-16 ***
poly(cor_max2005, 4)2     1.056e+00  3.998e-01   2.641 0.008323 ** 
poly(cor_max2005, 4)3    -3.377e-01  3.387e-01  -0.997 0.318733    
poly(cor_max2005, 4)4     3.076e-01  2.735e-01   1.125 0.260875    
tpi_5ft                  -3.836e-02  1.349e-02  -2.844 0.004483 ** 
tpi_200ft                -4.105e-04  1.003e-03  -0.409 0.682235    
aspect_trans_200ft        6.448e-03  4.073e-03   1.583 0.113521    
elev                     -7.867e-05  2.426e-04  -0.324 0.745793    
mean_height_wn20m         7.170e-03  1.716e-03   4.179 3.02e-05 ***
pct_imp_20m               9.108e-02  4.835e-02   1.884 0.059681 .  
pct_imp_100m              3.167e-02  3.620e-02   0.875 0.381704    
TotPhen                  -8.507e-03  6.311e-03  -1.348 0.177789    
N                        -3.334e-02  6.137e-03  -5.434 6.00e-08 ***
Sugar                    -1.009e-02  6.752e-03  -1.494 0.135305    
LMA                       7.755e-03  4.540e-03   1.708 0.087747 .  
lignin                   -2.322e-02  6.780e-03  -3.424 0.000625 ***
chl                       3.137e-02  6.300e-03   4.979 6.77e-07 ***
pct_imp_20m:pct_imp_100m -2.596e-01  1.009e-01  -2.573 0.010126 *  
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1492 on 2788 degrees of freedom
Multiple R-squared:  0.2472,	Adjusted R-squared:  0.2372 
F-statistic: 24.75 on 37 and 2788 DF,  p-value: < 2.2e-16
#+end_example

**** plot the coefficients of all these subset models to see where the coefficients change.  where thsre might be interactions.
***** traits by street powerlines
#+begin_src R
  library(broom)
    traits <- c("N", "chl", "TotPhen", "lignin", "Sugar", "LMA")

    mstpo <-   tidy(m.street_powerline) %>%
          filter(term %in% traits) %>%
          mutate(model = "street powerline")

    mstnopo <-   tidy(m.street_no_powerline) %>%
          filter(term %in% traits) %>%
          mutate(model = "street no powerline")

    mneigh <- tidy(m.neigh) %>%
          filter(term %in% traits) %>%
          mutate(model = "neighborhood")

    mc <- bind_rows(mstpo, mstnopo, mneigh)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/street_powerline_neighborhood_trait_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/street_powerline_neighborhood_trait_coef_plots.png]]

***** topo by street neighborhood powerline
#+begin_src R
  topo <- c("aspect_trans_200ft", "elev", "tpi_5ft", "tpi_200ft")


    mstpo <-   tidy(m.street_powerline) %>%
          filter(term %in% topo) %>%
          mutate(model = "street powerline")

    mstnopo <-   tidy(m.street_no_powerline) %>%
          filter(term %in% topo) %>%
          mutate(model = "street no powerline")

    mneigh <- tidy(m.neigh) %>%
          filter(term %in% topo) %>%
          mutate(model = "neighborhood")

    mc <- bind_rows(mstpo, mstnopo, mneigh)


#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/street_powerline_neighborhood_topo_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/street_powerline_neighborhood_topo_coef_plots.png]]
#+begin_src R :exports results :results graphics :file figs/street_powerline_neighborhood_topo_coef_plots_facet.png :width 1200 :height 400 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = model)) + geom_pointrange(position = position_dodge(width = .3)) +
    geom_hline(yintercept = 0) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2") +
    facet_wrap(~term, scales = "free_x", ncol = 4) 



#+end_src

#+RESULTS:
[[file:figs/street_powerline_neighborhood_topo_coef_plots_facet.png]]

***** height 2005 and height within 20m by street powerline neighborhood
#+begin_src R
  terms <- c("poly(cor_max2005, 4)1", "poly(cor_max2005, 4)2", "poly(cor_max2005, 4)3", "poly(cor_max2005, 4)4", "mean_height_wn20m")


    mstpo <-   tidy(m.street_powerline) %>%
          filter(term %in% terms) %>%
          mutate(model = "street powerline")

    mstnopo <-   tidy(m.street_no_powerline) %>%
          filter(term %in% terms) %>%
          mutate(model = "street no powerline")

    mneigh <- tidy(m.neigh) %>%
          filter(term %in% terms) %>%
          mutate(model = "neighborhood")

    mc <- bind_rows(mstpo, mstnopo, mneigh)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/street_powerline_neighborhood_height_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/street_powerline_neighborhood_height_coef_plots.png]]
#+begin_src R :exports results :results graphics :file figs/street_powerline_neighborhood_height_coef_plots_facet.png :width 1200 :height 400 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = model)) + geom_pointrange(position = position_dodge(width = .3)) +
    geom_hline(yintercept = 0) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2") +
    facet_wrap(~term, scales = "free_x", ncol = 5)

#+end_src

#+RESULTS:
[[file:figs/street_powerline_neighborhood_height_coef_plots_facet.png]]

***** impervious at 2 scales

#+begin_src R
  terms <- c("pct_imp_20m", "pct_imp_100m", "pct_imp_20m:pct_imp_100m")


    mstpo <-   tidy(m.street_powerline) %>%
          filter(term %in% terms) %>%
          mutate(model = "street powerline")

    mstnopo <-   tidy(m.street_no_powerline) %>%
          filter(term %in% terms) %>%
          mutate(model = "street no powerline")

    mneigh <- tidy(m.neigh) %>%
          filter(term %in% terms) %>%
          mutate(model = "neighborhood")

    mc <- bind_rows(mstpo, mstnopo, mneigh)


#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/street_powerline_neighborhood_imp_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/street_powerline_neighborhood_imp_coef_plots.png]]

#+begin_src R
  nd <- select(dc, pct_imp_20m, pct_imp_100m, st_po) %>%
      mutate(pct_imp_20m = round(pct_imp_20m, digits = 1),
             pct_imp_100m = round(pct_imp_100m, digits = 1)) %>%
      unique()

        mediand <- dc %>% summarize_all(median) %>%
                 select(-pct_imp_20m, -pct_imp_100m, -st_po)

          nd_neigh <- cbind(nd, mediand) %>%
            mutate(Genus = "Fraxinus", 
                   st_po = "neighborhood")

          nd_street_no_powerline <- cbind(nd, mediand) %>%
            mutate(Genus = "Fraxinus", 
                   st_po = "street no powerline")

        gr <- predict(m.neigh, nd_neigh)
        dpn <- cbind(nd_neigh, predicted_growthrate = gr)

      gr <- predict(m.street_no_powerline, nd_street_no_powerline)
      dpsnp <- cbind(nd_street_no_powerline, predicted_growthrate = gr)

    dp <- rbind(dpn, dpsnp)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/impervious_street_neighborhood.png :width 1000
  ggplot(data = dp, aes(x = pct_imp_100m, y = predicted_growthrate, color = pct_imp_20m, group = pct_imp_20m)) + 
    geom_line() +
      facet_wrap(~st_po) +
    terk 
    
#+end_src

#+RESULTS:
[[file:figs/impervious_street_neighborhood.png]]

**** plot
*** MLR by Generafit for a few Genera individually. look for genera differences
**** gleditsia
#+begin_src R
    m.gleditsia <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Gleditsia")
  summary(m.gleditsia)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Gleditsia")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.34603 -0.07516 -0.01395  0.05752  0.55618 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               0.0881858  0.0444186   1.985 0.047187 *  
st_post no util          -0.0139666  0.0068766  -2.031 0.042330 *  
st_post w util           -0.0172465  0.0083320  -2.070 0.038535 *  
poly(cor_max2005, 4)1    -6.8590817  0.9749522  -7.035 2.39e-12 ***
poly(cor_max2005, 4)2    -2.0288466  1.7890323  -1.134 0.256854    
poly(cor_max2005, 4)3    -4.0969992  2.1073572  -1.944 0.051960 .  
poly(cor_max2005, 4)4    -2.0964902  1.2700876  -1.651 0.098899 .  
tpi_5ft                  -0.0051544  0.0088761  -0.581 0.561473    
tpi_200ft                -0.0010179  0.0007918  -1.286 0.198688    
aspect_trans_200ft       -0.0033619  0.0028351  -1.186 0.235776    
elev                      0.0001970  0.0001176   1.675 0.093928 .  
mean_height_wn20m         0.0058709  0.0014822   3.961 7.61e-05 ***
pct_imp_20m              -0.0836453  0.0308800  -2.709 0.006788 ** 
pct_imp_100m             -0.0742751  0.0282837  -2.626 0.008676 ** 
TotPhen                   0.0233183  0.0059335   3.930 8.67e-05 ***
N                        -0.0187859  0.0048715  -3.856 0.000117 ***
Sugar                    -0.0187370  0.0057083  -3.282 0.001040 ** 
LMA                      -0.0002679  0.0032397  -0.083 0.934105    
lignin                   -0.0063009  0.0057246  -1.101 0.271118    
chl                       0.0218092  0.0055009   3.965 7.50e-05 ***
pct_imp_20m:pct_imp_100m  0.0221961  0.0511605   0.434 0.664423    
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.115 on 3418 degrees of freedom
Multiple R-squared:  0.1458,	Adjusted R-squared:  0.1408 
F-statistic: 29.17 on 20 and 3418 DF,  p-value: < 2.2e-16
#+end_example

**** fraxinus
#+begin_src R
    m.fraxinus <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Fraxinus")
  summary(m.fraxinus)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Fraxinus")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.42039 -0.06560 -0.00952  0.05074  0.96170 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.476e-01  3.118e-02   4.734 2.25e-06 ***
st_post no util          -2.714e-02  8.060e-03  -3.367 0.000764 ***
st_post w util           -3.153e-02  8.647e-03  -3.647 0.000268 ***
poly(cor_max2005, 4)1    -7.379e+00  4.019e-01 -18.360  < 2e-16 ***
poly(cor_max2005, 4)2     6.863e-02  6.028e-01   0.114 0.909364    
poly(cor_max2005, 4)3    -6.874e-01  7.202e-01  -0.954 0.339898    
poly(cor_max2005, 4)4    -4.106e-01  6.754e-01  -0.608 0.543277    
tpi_5ft                  -9.114e-03  6.329e-03  -1.440 0.149923    
tpi_200ft                -1.363e-03  5.136e-04  -2.654 0.007976 ** 
aspect_trans_200ft       -4.322e-04  1.892e-03  -0.228 0.819378    
elev                     -2.026e-04  7.937e-05  -2.553 0.010707 *  
mean_height_wn20m         6.870e-03  1.107e-03   6.207 5.76e-10 ***
pct_imp_20m               4.831e-03  2.231e-02   0.217 0.828545    
pct_imp_100m             -1.809e-02  2.188e-02  -0.827 0.408203    
TotPhen                   5.079e-03  4.255e-03   1.194 0.232695    
N                        -2.153e-02  3.037e-03  -7.089 1.51e-12 ***
Sugar                    -2.532e-03  4.001e-03  -0.633 0.526868    
LMA                      -1.712e-03  2.244e-03  -0.763 0.445431    
lignin                   -2.286e-02  4.493e-03  -5.089 3.71e-07 ***
chl                       3.316e-02  3.610e-03   9.186  < 2e-16 ***
pct_imp_20m:pct_imp_100m -7.497e-02  3.940e-02  -1.903 0.057138 .  
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.108 on 5915 degrees of freedom
Multiple R-squared:  0.1334,	Adjusted R-squared:  0.1304 
F-statistic: 45.52 on 20 and 5915 DF,  p-value: < 2.2e-16
#+end_example

**** acer
#+begin_src R
    m.acer <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Acer")
  summary(m.acer)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Acer")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.72625 -0.07892 -0.01919  0.05773  0.95893 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               6.663e-02  3.575e-02   1.864   0.0624 .  
st_post no util          -6.160e-02  5.533e-03 -11.132  < 2e-16 ***
st_post w util           -6.510e-02  6.828e-03  -9.533  < 2e-16 ***
poly(cor_max2005, 4)1    -5.500e+00  3.059e-01 -17.980  < 2e-16 ***
poly(cor_max2005, 4)2     4.296e-01  3.171e-01   1.355   0.1755    
poly(cor_max2005, 4)3    -9.084e-01  4.434e-01  -2.049   0.0405 *  
poly(cor_max2005, 4)4     1.065e+00  4.285e-01   2.485   0.0130 *  
tpi_5ft                  -1.774e-02  6.929e-03  -2.561   0.0105 *  
tpi_200ft                -8.358e-04  5.895e-04  -1.418   0.1563    
aspect_trans_200ft       -1.029e-03  2.124e-03  -0.485   0.6280    
elev                     -4.515e-05  9.507e-05  -0.475   0.6348    
mean_height_wn20m         9.591e-03  1.076e-03   8.910  < 2e-16 ***
pct_imp_20m               7.109e-03  2.697e-02   0.264   0.7921    
pct_imp_100m             -9.368e-03  2.752e-02  -0.340   0.7336    
TotPhen                  -1.866e-02  3.656e-03  -5.103 3.43e-07 ***
N                        -2.661e-02  2.985e-03  -8.916  < 2e-16 ***
Sugar                    -7.094e-03  3.521e-03  -2.015   0.0440 *  
LMA                       2.585e-03  2.409e-03   1.073   0.2833    
lignin                   -2.236e-02  3.884e-03  -5.758 8.90e-09 ***
chl                       1.665e-02  3.652e-03   4.558 5.24e-06 ***
pct_imp_20m:pct_imp_100m -4.999e-02  5.634e-02  -0.887   0.3749    
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1274 on 6743 degrees of freedom
Multiple R-squared:  0.1026,	Adjusted R-squared:  0.09998 
F-statistic: 38.56 on 20 and 6743 DF,  p-value: < 2.2e-16
#+end_example

**** quercus
#+begin_src R
    m.quercus <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Quercus")
  summary(m.quercus)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Quercus")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.40502 -0.08168 -0.01518  0.05997  0.62246 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)              -3.295e-02  9.932e-02  -0.332 0.740133    
st_post no util          -4.859e-02  1.015e-02  -4.789 1.94e-06 ***
st_post w util           -5.405e-02  1.330e-02  -4.066 5.17e-05 ***
poly(cor_max2005, 4)1    -1.054e+01  9.950e-01 -10.589  < 2e-16 ***
poly(cor_max2005, 4)2     3.716e+00  7.491e-01   4.961 8.26e-07 ***
poly(cor_max2005, 4)3    -9.128e-01  5.709e-01  -1.599 0.110129    
poly(cor_max2005, 4)4    -5.880e-01  6.235e-01  -0.943 0.345833    
tpi_5ft                   1.655e-02  1.669e-02   0.991 0.321828    
tpi_200ft                -2.144e-03  9.094e-04  -2.358 0.018589 *  
aspect_trans_200ft       -4.786e-03  5.580e-03  -0.858 0.391325    
elev                      1.817e-04  3.173e-04   0.573 0.567051    
mean_height_wn20m         9.202e-03  2.616e-03   3.518 0.000455 ***
pct_imp_20m               1.168e-01  7.138e-02   1.636 0.102093    
pct_imp_100m              8.355e-03  5.730e-02   0.146 0.884092    
TotPhen                  -5.875e-03  1.168e-02  -0.503 0.615176    
N                        -1.959e-02  1.021e-02  -1.918 0.055343 .  
Sugar                    -1.246e-03  9.634e-03  -0.129 0.897128    
LMA                      -5.793e-03  6.709e-03  -0.863 0.388079    
lignin                   -2.479e-02  1.249e-02  -1.985 0.047402 *  
chl                       1.374e-02  9.976e-03   1.377 0.168756    
pct_imp_20m:pct_imp_100m -1.623e-01  1.801e-01  -0.901 0.367872    
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1275 on 981 degrees of freedom
Multiple R-squared:  0.1402,	Adjusted R-squared:  0.1226 
F-statistic: 7.996 on 20 and 981 DF,  p-value: < 2.2e-16
#+end_example

oak pine honey acer picea pinus tilia 

**** tilia
#+begin_src R
    m.tilia <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Tilia")
  summary(m.tilia)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Tilia")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.40020 -0.07309 -0.01066  0.06267  0.61940 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.471e-01  6.891e-02   2.134 0.032964 *  
st_post no util          -4.985e-02  1.915e-02  -2.603 0.009337 ** 
st_post w util           -4.100e-02  2.119e-02  -1.935 0.053155 .  
poly(cor_max2005, 4)1    -1.079e+01  7.790e-01 -13.850  < 2e-16 ***
poly(cor_max2005, 4)2     9.100e-01  1.117e+00   0.815 0.415394    
poly(cor_max2005, 4)3    -3.484e+00  1.620e+00  -2.151 0.031613 *  
poly(cor_max2005, 4)4    -2.584e+00  1.304e+00  -1.981 0.047801 *  
tpi_5ft                  -1.504e-02  1.414e-02  -1.064 0.287416    
tpi_200ft                 5.138e-04  1.102e-03   0.466 0.641200    
aspect_trans_200ft       -3.822e-03  4.299e-03  -0.889 0.374081    
elev                     -1.443e-04  1.723e-04  -0.837 0.402642    
mean_height_wn20m         8.907e-03  2.344e-03   3.800 0.000150 ***
pct_imp_20m               1.186e-01  4.754e-02   2.495 0.012699 *  
pct_imp_100m              6.379e-02  5.486e-02   1.163 0.245099    
TotPhen                  -4.125e-03  8.800e-03  -0.469 0.639336    
N                        -2.000e-02  5.480e-03  -3.650 0.000271 ***
Sugar                    -1.091e-02  5.962e-03  -1.830 0.067443 .  
LMA                      -1.368e-02  5.206e-03  -2.628 0.008675 ** 
lignin                   -2.407e-04  6.833e-03  -0.035 0.971898    
chl                      -9.092e-03  7.352e-03  -1.237 0.216424    
pct_imp_20m:pct_imp_100m -2.930e-01  9.234e-02  -3.173 0.001537 ** 
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.122 on 1502 degrees of freedom
Multiple R-squared:  0.259,	Adjusted R-squared:  0.2492 
F-statistic: 26.26 on 20 and 1502 DF,  p-value: < 2.2e-16
#+end_example

**** pinus
#+begin_src R
    m.pinus <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Pinus")
  summary(m.pinus)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Pinus")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.42526 -0.14430 -0.02899  0.13269  0.72627 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)   
(Intercept)               0.7299891  0.3276734   2.228  0.02681 * 
st_post no util          -0.0744534  0.0354235  -2.102  0.03660 * 
st_post w util           -0.1514689  0.0737932  -2.053  0.04118 * 
poly(cor_max2005, 4)1    -7.8696574  2.6182408  -3.006  0.00293 **
poly(cor_max2005, 4)2     4.2171446  4.8178888   0.875  0.38227   
poly(cor_max2005, 4)3    -0.8886896  6.7522073  -0.132  0.89540   
poly(cor_max2005, 4)4     2.9386072  6.3028201   0.466  0.64146   
tpi_5ft                   0.1133702  0.0793564   1.429  0.15439   
tpi_200ft                -0.0057617  0.0041410  -1.391  0.16538   
aspect_trans_200ft        0.0006967  0.0192789   0.036  0.97120   
elev                     -0.0013415  0.0009943  -1.349  0.17852   
mean_height_wn20m        -0.0011188  0.0074954  -0.149  0.88147   
pct_imp_20m               0.0961583  0.2047567   0.470  0.63904   
pct_imp_100m              0.0548570  0.2424088   0.226  0.82116   
TotPhen                  -0.0743155  0.0321673  -2.310  0.02171 * 
N                        -0.0298122  0.0263299  -1.132  0.25864   
Sugar                    -0.0082193  0.0314540  -0.261  0.79407   
LMA                      -0.0034328  0.0219073  -0.157  0.87561   
lignin                   -0.0042971  0.0330741  -0.130  0.89673   
chl                      -0.0200579  0.0335147  -0.598  0.55007   
pct_imp_20m:pct_imp_100m -0.6466105  0.5004866  -1.292  0.19759   
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.2079 on 244 degrees of freedom
Multiple R-squared:  0.218,	Adjusted R-squared:  0.154 
F-statistic: 3.402 on 20 and 244 DF,  p-value: 3.274e-06
#+end_example

**** picea
#+begin_src R
    m.picea <- lm(growth.rate ~ st_po + poly(cor_max2005,4) + tpi_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, 
       dc,
       subset = dc$Genus == "Picea")
  summary(m.picea)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + poly(cor_max2005, 4) + tpi_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + 
    lignin + chl, data = dc, subset = dc$Genus == "Picea")

Residuals:
     Min       1Q   Median       3Q      Max 
-0.40901 -0.12532 -0.03409  0.08944  0.73355 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)              -0.0104331  0.2549785  -0.041 0.967382    
st_post no util          -0.0274950  0.0250364  -1.098 0.272779    
st_post w util            0.0298451  0.0429861   0.694 0.487901    
poly(cor_max2005, 4)1    -6.7664124  1.9776557  -3.421 0.000687 ***
poly(cor_max2005, 4)2     2.9596090  3.0762566   0.962 0.336591    
poly(cor_max2005, 4)3     6.9655975  4.5356849   1.536 0.125397    
poly(cor_max2005, 4)4     2.5612910  3.3226132   0.771 0.441242    
tpi_5ft                  -0.0877768  0.0606707  -1.447 0.148745    
tpi_200ft                -0.0027998  0.0028941  -0.967 0.333911    
aspect_trans_200ft        0.0008699  0.0135293   0.064 0.948764    
elev                      0.0002749  0.0007647   0.359 0.719468    
mean_height_wn20m         0.0090888  0.0056538   1.608 0.108723    
pct_imp_20m               0.0746143  0.1611992   0.463 0.643710    
pct_imp_100m              0.1992676  0.1659490   1.201 0.230550    
TotPhen                  -0.0293729  0.0223309  -1.315 0.189148    
N                        -0.0415437  0.0169978  -2.444 0.014955 *  
Sugar                     0.0264909  0.0218717   1.211 0.226537    
LMA                      -0.0134700  0.0130857  -1.029 0.303930    
lignin                   -0.0434391  0.0211460  -2.054 0.040603 *  
chl                       0.0582813  0.0206763   2.819 0.005061 ** 
pct_imp_20m:pct_imp_100m -0.3658552  0.3856255  -0.949 0.343331    
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1876 on 399 degrees of freedom
Multiple R-squared:  0.1657,	Adjusted R-squared:  0.1239 
F-statistic: 3.962 on 20 and 399 DF,  p-value: 4.197e-08
#+end_example



**** plot the coefficients of all these subset models to see where the coefficients change.  where thsre might be interactions.
***** traits by genera
#+begin_src R
  traits <- c("N", "chl", "TotPhen", "lignin", "Sugar", "LMA")
  mq <-   tidy(m.quercus) %>%
        filter(term %in% traits) %>%
        mutate(model = "quercus")


  ma <-   tidy(m.acer) %>%
        filter(term %in% traits) %>%
        mutate(model = "acer")


  mg <-   tidy(m.gleditsia) %>%
        filter(term %in% traits) %>%
        mutate(model = "gleditsia")


  mpin <-   tidy(m.pinus) %>%
        filter(term %in% traits) %>%
        mutate(model = "pinus")

  mpic <-   tidy(m.picea) %>%
        filter(term %in% traits) %>%
        mutate(model = "picea")


  mt <-   tidy(m.tilia) %>%
        filter(term %in% traits) %>%
        mutate(model = "tilia")

  mf <-   tidy(m.fraxinus) %>%
        filter(term %in% traits) %>%
        mutate(model = "fraxinus")



  mc <- bind_rows(mq, ma, mg, mpin, mpic, mt, mf)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/genus_trait_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/genus_trait_coef_plots.png]]

***** topo by genera
#+begin_src R
  topo <- c("aspect_trans_200ft", "elev", "tpi_5ft", "tpi_200ft")
  mq <-   tidy(m.quercus) %>%
        filter(term %in% topo) %>%
        mutate(model = "quercus")


  ma <-   tidy(m.acer) %>%
        filter(term %in% topo) %>%
        mutate(model = "acer")


  mg <-   tidy(m.gleditsia) %>%
        filter(term %in% topo) %>%
        mutate(model = "gleditsia")


  mpin <-   tidy(m.pinus) %>%
        filter(term %in% topo) %>%
        mutate(model = "pinus")

  mpic <-   tidy(m.picea) %>%
        filter(term %in% topo) %>%
        mutate(model = "picea")


  mt <-   tidy(m.tilia) %>%
        filter(term %in% topo) %>%
        mutate(model = "tilia")

  mf <-   tidy(m.fraxinus) %>%
        filter(term %in% topo) %>%
        mutate(model = "fraxinus")



  mc <- bind_rows(mq, ma, mg, mpin, mpic, mt, mf)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/genus_topo_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/genus_topo_coef_plots.png]]
#+begin_src R :exports results :results graphics :file figs/genus_topo_coef_plots_facet.png :width 1200 :height 400 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = model)) + geom_pointrange(position = position_dodge(width = .3)) +
    geom_hline(yintercept = 0) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2") +
    facet_wrap(~term, scales = "free_x", ncol = 4)



#+end_src

#+RESULTS:
[[file:figs/genus_topo_coef_plots_facet.png]]

***** height 2005 and height within 20m by genera
#+begin_src R
  terms <- c("poly(cor_max2005, 4)1", "poly(cor_max2005, 4)2", "poly(cor_max2005, 4)3", "poly(cor_max2005, 4)4", "mean_height_wn20m")
  mq <-   tidy(m.quercus) %>%
        filter(term %in% terms) %>%
        mutate(model = "quercus")


  ma <-   tidy(m.acer) %>%
        filter(term %in% terms) %>%
        mutate(model = "acer")


  mg <-   tidy(m.gleditsia) %>%
        filter(term %in% terms) %>%
        mutate(model = "gleditsia")


  mpin <-   tidy(m.pinus) %>%
        filter(term %in% terms) %>%
        mutate(model = "pinus")

  mpic <-   tidy(m.picea) %>%
        filter(term %in% terms) %>%
        mutate(model = "picea")


  mt <-   tidy(m.tilia) %>%
        filter(term %in% terms) %>%
        mutate(model = "tilia")

  mf <-   tidy(m.fraxinus) %>%
        filter(term %in% terms) %>%
        mutate(model = "fraxinus")



  mc <- bind_rows(mq, ma, mg, mpin, mpic, mt, mf)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/genus_height_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/genus_height_coef_plots.png]]
#+begin_src R :exports results :results graphics :file figs/genus_height_coef_plots_facet.png :width 1200 :height 400 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = model)) + geom_pointrange(position = position_dodge(width = .3)) +
    geom_hline(yintercept = 0) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2") +
    facet_wrap(~term, scales = "free_x", ncol = 5)

#+end_src

#+RESULTS:
[[file:figs/genus_height_coef_plots_facet.png]]

****** TODO Plot the predicted lines like I do for impervious 
#+begin_src R

#+end_src


***** impervious at 2 scales

#+begin_src R
  terms <- c("pct_imp_20m", "pct_imp_100m", "pct_imp_20m:pct_imp_100m")
  mq <-   tidy(m.quercus) %>%
        filter(term %in% terms) %>%
        mutate(model = "quercus")


  ma <-   tidy(m.acer) %>%
        filter(term %in% terms) %>%
        mutate(model = "acer")


  mg <-   tidy(m.gleditsia) %>%
        filter(term %in% terms) %>%
        mutate(model = "gleditsia")


  mpin <-   tidy(m.pinus) %>%
        filter(term %in% terms) %>%
        mutate(model = "pinus")

  mpic <-   tidy(m.picea) %>%
        filter(term %in% terms) %>%
        mutate(model = "picea")


  mt <-   tidy(m.tilia) %>%
        filter(term %in% terms) %>%
        mutate(model = "tilia")

  mf <-   tidy(m.fraxinus) %>%
        filter(term %in% terms) %>%
        mutate(model = "fraxinus")



  mc <- bind_rows(mq, ma, mg, mpin, mpic, mt, mf)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/genus_imp_coef_plots.png :width 1000 :height 600 :res 100 :bg transparent
  ggplot(mc, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, color = model, x = term)) + geom_pointrange(position = position_dodge(width = .3)) +
    coord_flip() +
   terk +
    scale_color_brewer(type = "qual", palette = "Dark2")


#+end_src

#+RESULTS:
[[file:figs/genus_imp_coef_plots.png]]

#+begin_src R
    nd <- data.frame(pct_imp_20m = seq(0, 1, .1),
                     pct_imp_100m = seq(0, 1, .1))


                 
#+end_src

*** TODO ? MLR interaction traits and height
#+begin_src R
  m.NintHeight <- lm(growth.rate ~ st_po + Genus + N*poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + Sugar + LMA + lignin + chl, 
     dc)
summary(m.NintHeight)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + N * poly(cor_max2005, 
    4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + 
    elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + 
    Sugar + LMA + lignin + chl, data = dc)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74136 -0.07857 -0.01466  0.05987  0.96399 

Coefficients:
                           Estimate Std. Error t value Pr(>|t|)    
(Intercept)               1.088e-01  3.060e-02   3.557 0.000377 ***
st_post no util          -4.769e-02  3.047e-03 -15.653  < 2e-16 ***
st_post w util           -5.240e-02  3.716e-03 -14.100  < 2e-16 ***
GenusAcer                -6.518e-02  2.401e-02  -2.714 0.006645 ** 
GenusBetula              -7.191e-02  2.541e-02  -2.830 0.004656 ** 
GenusCarya               -6.218e-02  2.787e-02  -2.231 0.025665 *  
GenusCatalpa             -2.565e-02  2.811e-02  -0.913 0.361476    
GenusCeltis              -8.083e-02  2.474e-02  -3.268 0.001086 ** 
GenusFraxinus            -3.080e-02  2.401e-02  -1.283 0.199585    
GenusGinkgo              -6.555e-03  2.876e-02  -0.228 0.819719    
GenusGleditsia           -1.898e-02  2.405e-02  -0.789 0.430132    
GenusGymnocladus          3.897e-02  5.333e-02   0.731 0.464995    
GenusJuglans             -6.838e-02  2.536e-02  -2.696 0.007022 ** 
GenusPicea                7.377e-02  2.463e-02   2.995 0.002752 ** 
GenusPinus                1.231e-01  2.508e-02   4.911 9.13e-07 ***
GenusPlatanus            -4.356e-02  3.556e-02  -1.225 0.220678    
GenusPopulus             -6.871e-02  2.667e-02  -2.576 0.009990 ** 
GenusQuercus             -8.294e-02  2.425e-02  -3.420 0.000627 ***
GenusRobinia             -2.452e-02  2.653e-02  -0.924 0.355360    
GenusSalix               -8.987e-02  6.746e-02  -1.332 0.182822    
GenusThuja               -2.002e-02  2.656e-02  -0.754 0.451022    
GenusTilia                2.597e-02  2.419e-02   1.074 0.283007    
GenusUlmus                2.189e-02  2.472e-02   0.885 0.376029    
N                        -2.988e-02  1.733e-03 -17.247  < 2e-16 ***
poly(cor_max2005, 4)1    -6.809e+00  1.812e-01 -37.584  < 2e-16 ***
poly(cor_max2005, 4)2     1.100e+00  1.407e-01   7.820 5.53e-15 ***
poly(cor_max2005, 4)3    -3.599e-01  1.306e-01  -2.757 0.005840 ** 
poly(cor_max2005, 4)4     3.229e-01  1.323e-01   2.441 0.014654 *  
tpi_5ft                  -1.189e-02  3.845e-03  -3.091 0.001997 ** 
aspect_trans_5ft          4.204e-03  1.273e-03   3.303 0.000958 ***
tpi_200ft                -1.628e-03  3.007e-04  -5.415 6.20e-08 ***
aspect_trans_200ft       -3.196e-03  1.250e-03  -2.557 0.010562 *  
elev                      2.147e-06  5.098e-05   0.042 0.966413    
mean_height_wn20m         8.182e-03  6.052e-04  13.520  < 2e-16 ***
pct_imp_20m               2.273e-02  1.333e-02   1.705 0.088254 .  
pct_imp_100m              1.727e-02  1.323e-02   1.306 0.191730    
TotPhen                  -6.843e-03  2.202e-03  -3.108 0.001887 ** 
Sugar                    -1.074e-02  2.034e-03  -5.278 1.32e-07 ***
LMA                      -2.550e-03  1.335e-03  -1.909 0.056231 .  
lignin                   -1.679e-02  2.229e-03  -7.535 5.06e-14 ***
chl                       2.173e-02  2.066e-03  10.518  < 2e-16 ***
N:poly(cor_max2005, 4)1  -1.977e-01  1.578e-01  -1.253 0.210211    
N:poly(cor_max2005, 4)2   6.235e-01  2.089e-01   2.985 0.002842 ** 
N:poly(cor_max2005, 4)3  -2.935e-01  2.727e-01  -1.076 0.281902    
N:poly(cor_max2005, 4)4   4.110e-01  2.343e-01   1.754 0.079450 .  
pct_imp_20m:pct_imp_100m -1.365e-01  2.428e-02  -5.620 1.94e-08 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1261 on 21201 degrees of freedom
Multiple R-squared:  0.2083,	Adjusted R-squared:  0.2066 
F-statistic: 123.9 on 45 and 21201 DF,  p-value: < 2.2e-16
#+end_example

#+begin_src R
  m.chlintHeight <- lm(growth.rate ~ st_po + Genus + TotPhen + Sugar + LMA + lignin + N + chl*poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m,
     dc)
summary(m.chlintHeight)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + TotPhen + Sugar + 
    LMA + lignin + N + chl * poly(cor_max2005, 4) + tpi_5ft + 
    aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + 
    mean_height_wn20m + pct_imp_20m * pct_imp_100m, data = dc)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.73795 -0.07874 -0.01455  0.05951  0.96687 

Coefficients:
                            Estimate Std. Error t value Pr(>|t|)    
(Intercept)                1.043e-01  3.061e-02   3.409 0.000654 ***
st_post no util           -4.775e-02  3.044e-03 -15.683  < 2e-16 ***
st_post w util            -5.197e-02  3.711e-03 -14.003  < 2e-16 ***
GenusAcer                 -6.555e-02  2.399e-02  -2.732 0.006300 ** 
GenusBetula               -7.277e-02  2.539e-02  -2.866 0.004157 ** 
GenusCarya                -6.180e-02  2.784e-02  -2.220 0.026462 *  
GenusCatalpa              -2.483e-02  2.807e-02  -0.884 0.376518    
GenusCeltis               -8.062e-02  2.472e-02  -3.261 0.001112 ** 
GenusFraxinus             -3.047e-02  2.399e-02  -1.270 0.204083    
GenusGinkgo               -4.589e-03  2.874e-02  -0.160 0.873174    
GenusGleditsia            -1.758e-02  2.404e-02  -0.731 0.464586    
GenusGymnocladus           4.095e-02  5.329e-02   0.768 0.442249    
GenusJuglans              -6.845e-02  2.534e-02  -2.701 0.006926 ** 
GenusPicea                 7.331e-02  2.462e-02   2.978 0.002907 ** 
GenusPinus                 1.209e-01  2.506e-02   4.826 1.41e-06 ***
GenusPlatanus             -4.543e-02  3.553e-02  -1.279 0.201005    
GenusPopulus              -6.104e-02  2.681e-02  -2.277 0.022819 *  
GenusQuercus              -8.335e-02  2.424e-02  -3.439 0.000585 ***
GenusRobinia              -2.346e-02  2.651e-02  -0.885 0.376107    
GenusSalix                -8.775e-02  6.741e-02  -1.302 0.193001    
GenusThuja                -2.077e-02  2.654e-02  -0.782 0.434047    
GenusTilia                 2.594e-02  2.417e-02   1.073 0.283204    
GenusUlmus                 2.197e-02  2.471e-02   0.889 0.373932    
TotPhen                   -6.550e-03  2.201e-03  -2.977 0.002918 ** 
Sugar                     -1.005e-02  2.036e-03  -4.939 7.91e-07 ***
LMA                       -2.656e-03  1.333e-03  -1.993 0.046281 *  
lignin                    -1.681e-02  2.227e-03  -7.547 4.65e-14 ***
N                         -3.002e-02  1.724e-03 -17.413  < 2e-16 ***
chl                        2.193e-02  2.066e-03  10.614  < 2e-16 ***
poly(cor_max2005, 4)1     -6.781e+00  1.771e-01 -38.284  < 2e-16 ***
poly(cor_max2005, 4)2      9.838e-01  1.372e-01   7.172 7.63e-13 ***
poly(cor_max2005, 4)3     -2.827e-01  1.309e-01  -2.160 0.030783 *  
poly(cor_max2005, 4)4      2.794e-01  1.322e-01   2.114 0.034541 *  
tpi_5ft                   -1.217e-02  3.842e-03  -3.169 0.001534 ** 
aspect_trans_5ft           4.247e-03  1.272e-03   3.339 0.000841 ***
tpi_200ft                 -1.617e-03  3.005e-04  -5.380 7.55e-08 ***
aspect_trans_200ft        -3.114e-03  1.249e-03  -2.493 0.012667 *  
elev                       1.508e-05  5.101e-05   0.296 0.767557    
mean_height_wn20m          8.085e-03  6.052e-04  13.359  < 2e-16 ***
pct_imp_20m                2.546e-02  1.333e-02   1.910 0.056159 .  
pct_imp_100m               1.970e-02  1.323e-02   1.488 0.136701    
chl:poly(cor_max2005, 4)1 -7.902e-01  1.437e-01  -5.499 3.86e-08 ***
chl:poly(cor_max2005, 4)2  5.312e-01  1.523e-01   3.488 0.000487 ***
chl:poly(cor_max2005, 4)3 -4.280e-01  1.832e-01  -2.335 0.019527 *  
chl:poly(cor_max2005, 4)4  3.791e-01  1.793e-01   2.114 0.034509 *  
pct_imp_20m:pct_imp_100m  -1.435e-01  2.432e-02  -5.900 3.69e-09 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.126 on 21201 degrees of freedom
Multiple R-squared:  0.2095,	Adjusted R-squared:  0.2079 
F-statistic: 124.9 on 45 and 21201 DF,  p-value: < 2.2e-16
#+end_example

#+begin_src R
  m.intHeight <- lm(growth.rate ~ st_po + Genus + Sugar + lignin + N + chl + TotPhen + LMA*poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m,
     dc)
summary(m.intHeight)
#+end_src

#+RESULTS:
#+begin_example

Call:
lm(formula = growth.rate ~ st_po + Genus + Sugar + lignin + N + 
    chl + TotPhen + LMA * poly(cor_max2005, 4) + tpi_5ft + aspect_trans_5ft + 
    tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + 
    pct_imp_20m * pct_imp_100m, data = dc)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.74128 -0.07864 -0.01515  0.05948  0.96368 

Coefficients:
                            Estimate Std. Error t value Pr(>|t|)    
(Intercept)                1.097e-01  3.061e-02   3.584 0.000339 ***
st_post no util           -4.777e-02  3.050e-03 -15.663  < 2e-16 ***
st_post w util            -5.247e-02  3.717e-03 -14.117  < 2e-16 ***
GenusAcer                 -6.518e-02  2.402e-02  -2.713 0.006666 ** 
GenusBetula               -7.277e-02  2.542e-02  -2.863 0.004200 ** 
GenusCarya                -6.266e-02  2.788e-02  -2.248 0.024590 *  
GenusCatalpa              -2.529e-02  2.811e-02  -0.900 0.368284    
GenusCeltis               -7.985e-02  2.475e-02  -3.226 0.001257 ** 
GenusFraxinus             -3.043e-02  2.403e-02  -1.266 0.205378    
GenusGinkgo               -5.077e-03  2.878e-02  -0.176 0.859958    
GenusGleditsia            -1.917e-02  2.407e-02  -0.796 0.425840    
GenusGymnocladus           3.907e-02  5.335e-02   0.732 0.463951    
GenusJuglans              -6.791e-02  2.538e-02  -2.676 0.007450 ** 
GenusPicea                 7.371e-02  2.465e-02   2.990 0.002789 ** 
GenusPinus                 1.233e-01  2.509e-02   4.915 8.94e-07 ***
GenusPlatanus             -4.018e-02  3.561e-02  -1.128 0.259255    
GenusPopulus              -6.417e-02  2.674e-02  -2.400 0.016424 *  
GenusQuercus              -8.214e-02  2.427e-02  -3.384 0.000715 ***
GenusRobinia              -2.629e-02  2.655e-02  -0.990 0.322211    
GenusSalix                -8.875e-02  6.749e-02  -1.315 0.188494    
GenusThuja                -2.079e-02  2.657e-02  -0.782 0.434070    
GenusTilia                 2.633e-02  2.420e-02   1.088 0.276607    
GenusUlmus                 2.312e-02  2.474e-02   0.934 0.350082    
Sugar                     -1.100e-02  2.034e-03  -5.410 6.37e-08 ***
lignin                    -1.658e-02  2.229e-03  -7.440 1.05e-13 ***
N                         -2.984e-02  1.727e-03 -17.277  < 2e-16 ***
chl                        2.147e-02  2.067e-03  10.387  < 2e-16 ***
TotPhen                   -6.885e-03  2.203e-03  -3.126 0.001776 ** 
LMA                       -2.523e-03  1.340e-03  -1.883 0.059754 .  
poly(cor_max2005, 4)1     -6.888e+00  1.754e-01 -39.277  < 2e-16 ***
poly(cor_max2005, 4)2      1.172e+00  1.345e-01   8.712  < 2e-16 ***
poly(cor_max2005, 4)3     -4.389e-01  1.304e-01  -3.365 0.000766 ***
poly(cor_max2005, 4)4      4.245e-01  1.291e-01   3.288 0.001009 ** 
tpi_5ft                   -1.181e-02  3.847e-03  -3.071 0.002139 ** 
aspect_trans_5ft           4.191e-03  1.274e-03   3.291 0.001002 ** 
tpi_200ft                 -1.608e-03  3.009e-04  -5.344 9.20e-08 ***
aspect_trans_200ft        -3.197e-03  1.250e-03  -2.557 0.010570 *  
elev                       7.112e-07  5.101e-05   0.014 0.988875    
mean_height_wn20m          8.175e-03  6.054e-04  13.503  < 2e-16 ***
pct_imp_20m                2.131e-02  1.334e-02   1.598 0.110115    
pct_imp_100m               1.672e-02  1.324e-02   1.263 0.206588    
LMA:poly(cor_max2005, 4)1  3.765e-02  1.360e-01   0.277 0.781990    
LMA:poly(cor_max2005, 4)2 -6.124e-01  1.612e-01  -3.799 0.000145 ***
LMA:poly(cor_max2005, 4)3  2.624e-01  2.165e-01   1.212 0.225463    
LMA:poly(cor_max2005, 4)4 -1.129e-01  1.935e-01  -0.584 0.559475    
pct_imp_20m:pct_imp_100m  -1.349e-01  2.430e-02  -5.551 2.88e-08 ***
---
codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.1261 on 21201 degrees of freedom
Multiple R-squared:  0.2076,	Adjusted R-squared:  0.206 
F-statistic: 123.5 on 45 and 21201 DF,  p-value: < 2.2e-16
#+end_example

*** MLR various interactions with AIC selection
**** fit all models
m0 - no interactions
m1 - add poly height and impervious interactions
m15 - add polynomial term for mean height within 20m.  - not sig.
m2 - m1 plus genus by height, heightwithin20m and impervious
interactions
m3 - m2 plus genus by trait interactions
m4 - m3 plus genus by street/neighborhood power by height interaction
m5 - m3 plus street/neighborhood power by height interaction (not
interacted with genus)
m6 - like m5 but no st_po by genus interaction

m7 - model with no genus, but all the interactions between other
covariates that seem to make sense.

#+begin_src R
    # not very strong evidence for various topography interactions  m00 <- lm(growth.rate ~ st_po + Genus + cor_max2005 + tpi_5ft * tpi_200ft + aspect_trans_5ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m + pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, dc)
  dc <- mutate(dc, st_po = factor(st_po))
      m00 <- lm(growth.rate ~ st_po + Genus + cor_max2005 + slope_5ft + tpi_5ft + aspect_trans_5ft + slope_200ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m + pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, dc)
      m0 <- lm(growth.rate ~ st_po + Genus + cor_max2005 + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m + pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, dc)
      m1 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, dc)
  #    m15 <- lm(growth.rate ~ st_po + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + poly(mean_height_wn20m,2) + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl, dc)
      m2 <- lm(growth.rate ~ Genus * (st_po + poly(cor_max2005,4) + mean_height_wn20m + pct_imp_20m * pct_imp_100m) + TotPhen + N + Sugar + LMA + lignin + chl + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev, dc)
      m3 <- lm(growth.rate ~ Genus * (st_po + poly(cor_max2005,4) + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev, dc)
      m4 <- lm(growth.rate ~ Genus * (st_po * poly(cor_max2005,4) + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev, dc)
      m5 <- lm(growth.rate ~ st_po:cor_max2005 + Genus * (st_po + poly(cor_max2005,4) + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft, dc)
      m6 <- lm(growth.rate ~ st_po + st_po:poly(cor_max2005,4) + Genus * (poly(cor_max2005,4) + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev, dc)
      m60 <- lm(growth.rate ~ st_po + st_po:poly(cor_max2005,4) + Genus * (poly(cor_max2005,4) + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft, dc)

  m7 <- lm(growth.rate ~ st_po * poly(cor_max2005,4)[,1] + poly(cor_max2005,4)[,2:4] + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft, dc)

#+end_src
#+RESULTS:

#+begin_src R
#(AIC(m00,m0,m1, m2, m3, m4, m5, m6, m60, m7, m50,m8))
AIC(m0,m1, m2, m3, m4, m5, m6, m7)
#+end_src

#+RESULTS:
#+begin_example

    df      AIC
m0  39 168215.1
m1  43 168076.9
m2 231 167505.3
m3 339 167389.0
m4 483 167402.8
m5 343 167381.0
m6 312 167401.3
m7  27 169504.6
#+end_example

#+begin_src R
  
  m_nogenus <- lm(growth.rate ~ st_po * cor_max2005 + height2005_2 + height2005_3 + height2005_4 + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft, dc)
  m_genus <- lm(growth.rate ~ st_po:cor_max2005 + Genus + Genus : (st_po + cor_max2005 + height2005_2 + height2005_3 + height2005_4 + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft, dc)
  AIC(m_nogenus, m_genus)

#+end_src

#+RESULTS:
: 
:            df      AIC
: m_nogenus  27 169504.6
: m_genus   342 167381.3



    df       AIC
m0  39 -27477.04
m1  43 -27615.17
m2 231 -28186.80
m3 339 -28303.08
m4 483 -28289.34
m5 343 -28311.12
m6 312 -28290.80
m7  27 -26187.47
#+end_example

:     df       AIC
: m0  39 -27477.04
: m1  43 -27615.17
: m2 231 -28186.80
: m3 339 -28303.08
: m4 483 -28289.34
: m5 341 -28308.11
: m6 312 -28290.80
: m7  45 -27617.36


:     df       AIC
: m0  39 -27477.04
: m1  43 -27615.17
: m2 231 -28186.80
: m3 339 -28303.08
: m4 483 -28289.34
: m5 347 -28307.93
: m6 312 -28290.80
: m7  45 -27617.36
*** Fit the two models
**** fit models
#+begin_src R
  m_nogenus <- lm(growth.rate ~ st_po * cor_max2005 + height2005_2 + height2005_3 + height2005_4 + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft - 1, dc)
  m_genus <- lm(growth.rate ~ st_po:cor_max2005 + Genus + Genus : (st_po + cor_max2005 + height2005_2 + height2005_3 + height2005_4 + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft - 1, dc)
  AIC(m_nogenus, m_genus)

#+end_src

#+RESULTS:
: 
:            df      AIC
: m_nogenus  27 169504.6
: m_genus   342 167381.3

**** emmeans for genus doing the model with the interactions has very different results than model without interactions
***** model with interactions
#+begin_src R
  library(emmeans)

  m_genus_sub <- lm(growth.rate ~ st_po:cor_max2005 + Genus + Genus: (st_po + cor_max2005 + height2005_2 + height2005_3 + height2005_4 + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + slope_5ft + slope_200ft - 1,
                                      data = filter(dc, ! Genus %in% c("Salix", "Gymnocladus", "Platanus", "Abies")))

  em <- emmeans(m_genus_sub, pairwise ~ Genus)
#+end_src

#+RESULTS:
: 
: NOTE: Results may be misleading due to involvement in interactions




#+begin_src R :exports results :results graphics :file figs/genus_comparisons_full model.png :width 800 :height 500 :res 120
    plot(em, comparison = T) +
        terk +
        scale_x_continuous("Estimated Marginal Mean Growth Rate (cm / yr)")
#+end_src

#+RESULTS:
[[file:figs/genus_comparisons_full model.png]]

#+begin_src R :exports results :results graphics :file figs/genus_pairwise_pvalue_plot.png
  pwpp(em$emmeans) 
#+end_src

#+RESULTS:
[[file:figs/genus_pairwise_pvalue_plot.png]]

**** print summary output of first model 
#+begin_src R
library(broom)
        library(orgutils)
        tidy(summary(m_nogenus)) %>% data.frame %>% 
            mutate(estimate = round(estimate, 2), 
                   std.error = round(std.error, 2), 
                   statistic = round(statistic, 3),
                   p.value = round(p.value, 3)) %>% toOrg
#+end_src

#+RESULTS:
#+begin_example

| term                        | estimate | std.error | statistic | p.value |
|-----------------------------+----------+-----------+-----------+---------|
| st_poneighborhood           |    77.51 |      6.13 |    12.639 |       0 |
| st_post no util             |     66.5 |      6.07 |    10.951 |       0 |
| st_post w util              |    66.82 |      6.15 |    10.871 |       0 |
| cor_max2005                 |   -12.21 |      1.43 |    -8.566 |       0 |
| height2005_2                |     0.82 |      0.13 |     6.482 |       0 |
| height2005_3                |    -0.03 |         0 |    -5.714 |       0 |
| height2005_4                |        0 |         0 |     5.118 |       0 |
| mean_height_wn20m           |     0.85 |      0.06 |    13.645 |       0 |
| pct_imp_20m                 |     1.41 |      1.37 |     1.022 |   0.307 |
| pct_imp_100m                |     2.16 |       1.4 |     1.545 |   0.122 |
| TotPhen                     |    -2.96 |      0.18 |   -16.818 |       0 |
| N                           |    -2.92 |      0.17 |   -16.872 |       0 |
| Sugar                       |    -0.17 |       0.2 |    -0.849 |   0.396 |
| LMA                         |    -0.08 |      0.13 |    -0.642 |   0.521 |
| lignin                      |    -3.07 |      0.21 |   -14.574 |       0 |
| chl                         |     2.54 |       0.2 |    12.977 |       0 |
| tpi_5ft                     |    -1.72 |       0.4 |    -4.335 |       0 |
| aspect_trans_5ft            |     0.45 |      0.13 |     3.424 |   0.001 |
| tpi_200ft                   |    -0.18 |      0.03 |    -5.701 |       0 |
| aspect_trans_200ft          |    -0.11 |      0.13 |    -0.882 |   0.378 |
| elev                        |      1.4 |      0.53 |     2.643 |   0.008 |
| slope_5ft                   |    -4.95 |      1.71 |    -2.887 |   0.004 |
| slope_200ft                 |    -6.06 |      4.11 |    -1.475 |    0.14 |
| st_post no util:cor_max2005 |     0.37 |      0.07 |     4.999 |       0 |
| st_post w util:cor_max2005  |     0.31 |       0.1 |     3.192 |   0.001 |
| pct_imp_20m:pct_imp_100m    |   -12.37 |      2.52 |    -4.916 |       0 |
#+end_example

**** print summary output second model with genus interactions
#+begin_src R
        library(orgutils)
        tidy(summary(m_genus)) %>% data.frame %>% 
            mutate(estimate = round(estimate, 2), 
                   std.error = round(std.error, 2), 
                   statistic = round(statistic, 3),
                   p.value = round(p.value, 3)) %>% toOrg
#+end_src

#+RESULTS:
#+begin_example

| term                                    | estimate | std.error | statistic | p.value |
|-----------------------------------------+----------+-----------+-----------+---------|
| GenusAbies                              |   118.49 |    798.77 |     0.148 |   0.882 |
| GenusAcer                               |     85.7 |     13.03 |     6.579 |       0 |
| GenusBetula                             |   127.83 |    130.81 |     0.977 |   0.328 |
| GenusCarya                              |  -237.72 |      89.3 |    -2.662 |   0.008 |
| GenusCatalpa                            |  -422.58 |    194.26 |    -2.175 |    0.03 |
| GenusCeltis                             |    70.96 |     75.83 |     0.936 |   0.349 |
| GenusFraxinus                           |    30.55 |     22.97 |      1.33 |   0.183 |
| GenusGinkgo                             |   451.76 |   1416.13 |     0.319 |    0.75 |
| GenusGleditsia                          |    19.13 |     25.17 |      0.76 |   0.447 |
| GenusGymnocladus                        |  9572.94 |   4417.96 |     2.167 |    0.03 |
| GenusJuglans                            |   -75.26 |     44.23 |    -1.701 |   0.089 |
| GenusPicea                              |    17.57 |     48.95 |     0.359 |    0.72 |
| GenusPinus                              |    213.3 |     98.61 |     2.163 |   0.031 |
| GenusPlatanus                           | -1889.55 |    1318.1 |    -1.434 |   0.152 |
| GenusPopulus                            |   226.35 |     85.96 |     2.633 |   0.008 |
| GenusQuercus                            |    55.06 |      33.6 |     1.639 |   0.101 |
| GenusRobinia                            |   116.28 |     113.3 |     1.026 |   0.305 |
| GenusSalix                              | 15930.38 |   7129.33 |     2.234 |   0.025 |
| GenusThuja                              |   -26.34 |     90.07 |    -0.292 |    0.77 |
| GenusTilia                              |    20.75 |     31.57 |     0.657 |   0.511 |
| GenusUlmus                              |    51.33 |     28.42 |     1.806 |   0.071 |
| tpi_5ft                                 |    -1.13 |      0.38 |    -2.992 |   0.003 |
| aspect_trans_5ft                        |     0.36 |      0.13 |     2.849 |   0.004 |
| tpi_200ft                               |    -0.13 |      0.03 |    -4.256 |       0 |
| aspect_trans_200ft                      |    -0.26 |      0.12 |    -2.071 |   0.038 |
| elev                                    |    -0.26 |      0.52 |    -0.498 |   0.619 |
| slope_5ft                               |    -2.64 |      1.67 |    -1.581 |   0.114 |
| slope_200ft                             |    -5.97 |      4.02 |    -1.485 |   0.137 |
| st_poneighborhood:cor_max2005           |     4.68 |    200.05 |     0.023 |   0.981 |
| st_post no util:cor_max2005             |      4.9 |    200.05 |     0.024 |    0.98 |
| st_post w util:cor_max2005              |     4.76 |    200.05 |     0.024 |   0.981 |
| st_post no util:GenusAcer               |    -9.81 |      1.51 |    -6.504 |       0 |
| st_post w util:GenusAcer                |    -8.01 |      1.85 |    -4.331 |       0 |
| st_post no util:GenusBetula             |    -6.05 |      2.67 |    -2.271 |   0.023 |
| st_post w util:GenusBetula              |     2.73 |      6.03 |     0.454 |    0.65 |
| st_post no util:GenusCarya              |    -5.01 |      5.24 |    -0.955 |    0.34 |
| st_post w util:GenusCarya               |    -2.05 |      5.87 |     -0.35 |   0.726 |
| st_post no util:GenusCatalpa            |    -1.99 |      4.97 |    -0.401 |   0.689 |
| st_post w util:GenusCatalpa             |     0.43 |      5.32 |     0.081 |   0.936 |
| st_post no util:GenusCeltis             |    -7.57 |      2.41 |    -3.137 |   0.002 |
| st_post w util:GenusCeltis              |    -8.22 |      3.08 |    -2.666 |   0.008 |
| st_post no util:GenusFraxinus           |    -6.19 |      1.62 |    -3.831 |       0 |
| st_post w util:GenusFraxinus            |    -4.34 |      1.95 |     -2.23 |   0.026 |
| st_post no util:GenusGinkgo             |     -2.6 |       7.6 |    -0.342 |   0.732 |
| st_post w util:GenusGinkgo              |   -12.75 |      9.02 |    -1.413 |   0.158 |
| st_post no util:GenusGleditsia          |    -4.69 |      1.49 |    -3.152 |   0.002 |
| st_post w util:GenusGleditsia           |    -3.18 |      1.87 |    -1.699 |   0.089 |
| st_post no util:GenusGymnocladus        |     21.8 |      11.7 |     1.863 |   0.063 |
| st_post w util:GenusGymnocladus         |    16.59 |     16.63 |     0.998 |   0.318 |
| st_post no util:GenusJuglans            |    -8.73 |      2.67 |    -3.273 |   0.001 |
| st_post w util:GenusJuglans             |    -7.07 |      3.81 |    -1.858 |   0.063 |
| st_post no util:GenusPicea              |    -6.12 |      2.09 |    -2.925 |   0.003 |
| st_post w util:GenusPicea               |     0.99 |      3.32 |     0.299 |   0.765 |
| st_post no util:GenusPinus              |    -9.93 |      2.44 |    -4.064 |       0 |
| st_post w util:GenusPinus               |   -13.02 |       4.6 |    -2.832 |   0.005 |
| st_post no util:GenusPlatanus           |   -26.26 |      14.5 |    -1.811 |    0.07 |
| st_post w util:GenusPlatanus            |   -25.73 |     17.28 |    -1.489 |   0.136 |
| st_post no util:GenusPopulus            |   -10.77 |      3.29 |    -3.276 |   0.001 |
| st_post w util:GenusPopulus             |    -4.96 |      7.46 |    -0.664 |   0.506 |
| st_post no util:GenusQuercus            |    -8.74 |      1.89 |    -4.622 |       0 |
| st_post w util:GenusQuercus             |    -6.86 |      2.41 |     -2.85 |   0.004 |
| st_post no util:GenusRobinia            |   -10.39 |      3.69 |    -2.818 |   0.005 |
| st_post w util:GenusRobinia             |    -1.01 |      5.51 |    -0.183 |   0.855 |
| st_post no util:GenusThuja              |   -12.16 |      3.45 |    -3.525 |       0 |
| st_post w util:GenusThuja               |    -20.4 |      5.82 |    -3.504 |       0 |
| st_post no util:GenusTilia              |    -8.53 |      2.38 |     -3.59 |       0 |
| st_post w util:GenusTilia               |    -5.29 |      2.76 |    -1.918 |   0.055 |
| st_post no util:GenusUlmus              |    -2.53 |      2.34 |    -1.081 |    0.28 |
| st_post w util:GenusUlmus               |    -1.43 |      3.02 |    -0.471 |   0.637 |
| cor_max2005:GenusAcer                   |   -20.13 |    200.08 |    -0.101 |    0.92 |
| cor_max2005:GenusBetula                 |   -32.16 |    203.22 |    -0.158 |   0.874 |
| cor_max2005:GenusCarya                  |    83.11 |    201.75 |     0.412 |    0.68 |
| cor_max2005:GenusCatalpa                |   102.65 |     205.3 |       0.5 |   0.617 |
| cor_max2005:GenusCeltis                 |   -18.25 |    200.82 |    -0.091 |   0.928 |
| cor_max2005:GenusFraxinus               |     -4.5 |    200.15 |    -0.022 |   0.982 |
| cor_max2005:GenusGinkgo                 |   -82.33 |    427.71 |    -0.192 |   0.847 |
| cor_max2005:GenusGleditsia              |     2.23 |     200.2 |     0.011 |   0.991 |
| cor_max2005:GenusGymnocladus            | -2383.91 |   1113.12 |    -2.142 |   0.032 |
| cor_max2005:GenusJuglans                |    21.36 |    200.47 |     0.107 |   0.915 |
| cor_max2005:GenusPicea                  |    -8.64 |    200.55 |    -0.043 |   0.966 |
| cor_max2005:GenusPinus                  |   -41.76 |    201.92 |    -0.207 |   0.836 |
| cor_max2005:GenusPlatanus               |   357.82 |     381.3 |     0.938 |   0.348 |
| cor_max2005:GenusPopulus                |   -42.78 |    200.87 |    -0.213 |   0.831 |
| cor_max2005:GenusQuercus                |     -6.9 |    200.21 |    -0.034 |   0.972 |
| cor_max2005:GenusRobinia                |   -19.88 |    201.79 |    -0.099 |   0.922 |
| cor_max2005:GenusSalix                  | -2525.71 |   1171.77 |    -2.155 |   0.031 |
| cor_max2005:GenusThuja                  |     1.72 |    201.75 |     0.009 |   0.993 |
| cor_max2005:GenusTilia                  |     4.98 |    200.26 |     0.025 |    0.98 |
| cor_max2005:GenusUlmus                  |     3.24 |    200.24 |     0.016 |   0.987 |
| GenusAbies:height2005_2                 |    -1.47 |     17.96 |    -0.082 |   0.935 |
| GenusAcer:height2005_2                  |     1.17 |      0.33 |      3.55 |       0 |
| GenusBetula:height2005_2                |     2.49 |      3.57 |     0.699 |   0.485 |
| GenusCarya:height2005_2                 |    -8.95 |      2.62 |    -3.412 |   0.001 |
| GenusCatalpa:height2005_2               |    -9.59 |      3.95 |    -2.426 |   0.015 |
| GenusCeltis:height2005_2                |     1.18 |      1.47 |     0.802 |   0.423 |
| GenusFraxinus:height2005_2              |    -0.26 |       0.6 |    -0.427 |    0.67 |
| GenusGinkgo:height2005_2                |     3.47 |     37.28 |     0.093 |   0.926 |
| GenusGleditsia:height2005_2             |    -1.14 |      0.84 |    -1.359 |   0.174 |
| GenusGymnocladus:height2005_2           |   213.81 |     98.71 |     2.166 |    0.03 |
| GenusJuglans:height2005_2               |    -2.86 |      1.34 |    -2.127 |   0.033 |
| GenusPicea:height2005_2                 |     0.83 |      1.49 |     0.559 |   0.576 |
| GenusPinus:height2005_2                 |     2.87 |      2.75 |     1.043 |   0.297 |
| GenusPlatanus:height2005_2              |   -26.46 |     28.99 |    -0.913 |   0.361 |
| GenusPopulus:height2005_2               |     2.24 |      1.33 |     1.684 |   0.092 |
| GenusQuercus:height2005_2               |    -0.34 |      0.65 |    -0.519 |   0.604 |
| GenusRobinia:height2005_2               |     0.67 |      2.22 |     0.302 |   0.763 |
| GenusSalix:height2005_2                 |   131.61 |     61.68 |     2.134 |   0.033 |
| GenusThuja:height2005_2                 |    -0.54 |       2.7 |    -0.198 |   0.843 |
| GenusTilia:height2005_2                 |    -1.58 |      0.93 |    -1.699 |   0.089 |
| GenusUlmus:height2005_2                 |    -1.57 |      0.91 |    -1.732 |   0.083 |
| GenusAbies:height2005_3                 |     0.08 |       0.7 |     0.111 |   0.912 |
| GenusAcer:height2005_3                  |    -0.04 |      0.01 |    -2.941 |   0.003 |
| GenusBetula:height2005_3                |    -0.11 |      0.15 |    -0.689 |   0.491 |
| GenusCarya:height2005_3                 |     0.36 |      0.11 |     3.316 |   0.001 |
| GenusCatalpa:height2005_3               |     0.36 |      0.14 |     2.479 |   0.013 |
| GenusCeltis:height2005_3                |    -0.05 |      0.05 |    -0.886 |   0.376 |
| GenusFraxinus:height2005_3              |     0.01 |      0.03 |     0.534 |   0.594 |
| GenusGinkgo:height2005_3                |     0.02 |      1.61 |     0.015 |   0.988 |
| GenusGleditsia:height2005_3             |     0.06 |      0.04 |      1.53 |   0.126 |
| GenusGymnocladus:height2005_3           |    -8.27 |      3.84 |    -2.152 |   0.031 |
| GenusJuglans:height2005_3               |     0.12 |      0.06 |     2.039 |   0.042 |
| GenusPicea:height2005_3                 |    -0.06 |      0.07 |    -0.887 |   0.375 |
| GenusPinus:height2005_3                 |     -0.1 |      0.12 |    -0.845 |   0.398 |
| GenusPlatanus:height2005_3              |     0.81 |      1.13 |     0.718 |   0.472 |
| GenusPopulus:height2005_3               |    -0.06 |      0.04 |    -1.448 |   0.148 |
| GenusQuercus:height2005_3               |     0.02 |      0.02 |     0.943 |   0.346 |
| GenusRobinia:height2005_3               |    -0.01 |      0.08 |    -0.131 |   0.896 |
| GenusSalix:height2005_3                 |    -2.27 |      1.09 |    -2.085 |   0.037 |
| GenusThuja:height2005_3                 |     0.01 |      0.12 |     0.107 |   0.915 |
| GenusTilia:height2005_3                 |     0.08 |      0.04 |     1.912 |   0.056 |
| GenusUlmus:height2005_3                 |     0.07 |      0.04 |     1.814 |    0.07 |
| GenusAbies:height2005_4                 |        0 |      0.01 |    -0.118 |   0.906 |
| GenusAcer:height2005_4                  |        0 |         0 |     2.375 |   0.018 |
| GenusBetula:height2005_4                |        0 |         0 |      0.69 |    0.49 |
| GenusCarya:height2005_4                 |    -0.01 |         0 |    -3.147 |   0.002 |
| GenusCatalpa:height2005_4               |        0 |         0 |    -2.522 |   0.012 |
| GenusCeltis:height2005_4                |        0 |         0 |      0.97 |   0.332 |
| GenusFraxinus:height2005_4              |        0 |         0 |    -0.603 |   0.546 |
| GenusGinkgo:height2005_4                |        0 |      0.03 |    -0.123 |   0.902 |
| GenusGleditsia:height2005_4             |        0 |         0 |    -1.614 |   0.106 |
| GenusGymnocladus:height2005_4           |     0.12 |      0.05 |     2.135 |   0.033 |
| GenusJuglans:height2005_4               |        0 |         0 |    -1.885 |   0.059 |
| GenusPicea:height2005_4                 |        0 |         0 |     1.153 |   0.249 |
| GenusPinus:height2005_4                 |        0 |         0 |     0.699 |   0.485 |
| GenusPlatanus:height2005_4              |    -0.01 |      0.02 |    -0.548 |   0.584 |
| GenusPopulus:height2005_4               |        0 |         0 |     1.296 |   0.195 |
| GenusQuercus:height2005_4               |        0 |         0 |    -1.193 |   0.233 |
| GenusRobinia:height2005_4               |        0 |         0 |     0.015 |   0.988 |
| GenusThuja:height2005_4                 |        0 |         0 |    -0.028 |   0.977 |
| GenusTilia:height2005_4                 |        0 |         0 |    -1.988 |   0.047 |
| GenusUlmus:height2005_4                 |        0 |         0 |    -1.679 |   0.093 |
| GenusAbies:mean_height_wn20m            |    -1.61 |      1.49 |    -1.079 |    0.28 |
| GenusAcer:mean_height_wn20m             |     0.96 |       0.1 |     9.302 |       0 |
| GenusBetula:mean_height_wn20m           |     1.23 |      0.58 |     2.134 |   0.033 |
| GenusCarya:mean_height_wn20m            |     -1.4 |      1.06 |     -1.32 |   0.187 |
| GenusCatalpa:mean_height_wn20m          |     1.01 |      0.78 |     1.302 |   0.193 |
| GenusCeltis:mean_height_wn20m           |     0.44 |      0.44 |     1.016 |    0.31 |
| GenusFraxinus:mean_height_wn20m         |      0.7 |      0.13 |     5.585 |       0 |
| GenusGinkgo:mean_height_wn20m           |     2.13 |      1.58 |     1.353 |   0.176 |
| GenusGleditsia:mean_height_wn20m        |     0.53 |      0.16 |     3.353 |   0.001 |
| GenusJuglans:mean_height_wn20m          |     1.48 |      0.52 |     2.828 |   0.005 |
| GenusPicea:mean_height_wn20m            |     0.94 |      0.37 |     2.562 |    0.01 |
| GenusPinus:mean_height_wn20m            |    -0.08 |      0.44 |    -0.189 |    0.85 |
| GenusPlatanus:mean_height_wn20m         |    12.11 |      5.06 |     2.393 |   0.017 |
| GenusPopulus:mean_height_wn20m          |     1.59 |      0.64 |     2.479 |   0.013 |
| GenusQuercus:mean_height_wn20m          |      0.9 |      0.25 |     3.617 |       0 |
| GenusRobinia:mean_height_wn20m          |     0.71 |       0.7 |     1.008 |   0.314 |
| GenusThuja:mean_height_wn20m            |      1.6 |      0.73 |     2.186 |   0.029 |
| GenusTilia:mean_height_wn20m            |      0.9 |      0.23 |     3.881 |       0 |
| GenusUlmus:mean_height_wn20m            |     0.49 |      0.39 |     1.279 |   0.201 |
| GenusAbies:pct_imp_20m                  |   -55.67 |    158.88 |     -0.35 |   0.726 |
| GenusAcer:pct_imp_20m                   |     0.49 |      2.61 |     0.187 |   0.852 |
| GenusBetula:pct_imp_20m                 |   -17.82 |     18.25 |    -0.977 |   0.329 |
| GenusCarya:pct_imp_20m                  |   -28.11 |     26.06 |    -1.079 |   0.281 |
| GenusCatalpa:pct_imp_20m                |     36.4 |     20.26 |     1.796 |   0.072 |
| GenusCeltis:pct_imp_20m                 |     7.19 |       9.8 |     0.734 |   0.463 |
| GenusFraxinus:pct_imp_20m               |     0.98 |      2.52 |     0.388 |   0.698 |
| GenusGinkgo:pct_imp_20m                 |     9.84 |     35.27 |     0.279 |    0.78 |
| GenusGleditsia:pct_imp_20m              |    -9.25 |      3.29 |    -2.812 |   0.005 |
| GenusJuglans:pct_imp_20m                |    -9.41 |     13.93 |    -0.675 |   0.499 |
| GenusPicea:pct_imp_20m                  |     8.59 |     10.51 |     0.817 |   0.414 |
| GenusPinus:pct_imp_20m                  |    10.97 |     12.03 |     0.912 |   0.362 |
| GenusPlatanus:pct_imp_20m               |    74.61 |    105.59 |     0.707 |    0.48 |
| GenusPopulus:pct_imp_20m                |    35.05 |     19.82 |     1.768 |   0.077 |
| GenusQuercus:pct_imp_20m                |    12.23 |      6.73 |     1.817 |   0.069 |
| GenusRobinia:pct_imp_20m                |     2.18 |     16.93 |     0.129 |   0.898 |
| GenusThuja:pct_imp_20m                  |    45.52 |     19.74 |     2.306 |   0.021 |
| GenusTilia:pct_imp_20m                  |    11.84 |      4.79 |      2.47 |   0.014 |
| GenusUlmus:pct_imp_20m                  |     3.45 |      8.76 |     0.394 |   0.693 |
| GenusAbies:pct_imp_100m                 |   -43.58 |    146.34 |    -0.298 |   0.766 |
| GenusAcer:pct_imp_100m                  |    -1.51 |      2.63 |    -0.576 |   0.565 |
| GenusBetula:pct_imp_100m                |     7.87 |     19.93 |     0.395 |   0.693 |
| GenusCarya:pct_imp_100m                 |    41.16 |     23.94 |     1.719 |   0.086 |
| GenusCatalpa:pct_imp_100m               |    17.69 |     21.07 |      0.84 |   0.401 |
| GenusCeltis:pct_imp_100m                |     6.33 |      7.91 |     0.799 |   0.424 |
| GenusFraxinus:pct_imp_100m              |     -1.1 |      2.46 |    -0.448 |   0.654 |
| GenusGinkgo:pct_imp_100m                |     33.1 |     35.04 |     0.945 |   0.345 |
| GenusGleditsia:pct_imp_100m             |    -8.78 |      2.98 |    -2.946 |   0.003 |
| GenusJuglans:pct_imp_100m               |    20.01 |      9.98 |     2.005 |   0.045 |
| GenusPicea:pct_imp_100m                 |    19.69 |     10.77 |     1.828 |   0.067 |
| GenusPinus:pct_imp_100m                 |     9.02 |     13.93 |     0.647 |   0.518 |
| GenusPlatanus:pct_imp_100m              |    89.87 |    151.92 |     0.592 |   0.554 |
| GenusPopulus:pct_imp_100m               |       36 |     16.09 |     2.237 |   0.025 |
| GenusQuercus:pct_imp_100m               |      0.4 |      5.49 |     0.073 |   0.942 |
| GenusRobinia:pct_imp_100m               |      7.1 |     19.77 |     0.359 |   0.719 |
| GenusThuja:pct_imp_100m                 |    42.94 |      22.6 |       1.9 |   0.057 |
| GenusTilia:pct_imp_100m                 |     6.32 |      5.46 |     1.159 |   0.247 |
| GenusUlmus:pct_imp_100m                 |      2.2 |      7.97 |     0.276 |   0.782 |
| GenusAbies:TotPhen                      |    16.06 |      9.06 |     1.773 |   0.076 |
| GenusAcer:TotPhen                       |    -1.86 |      0.35 |    -5.258 |       0 |
| GenusBetula:TotPhen                     |    -1.96 |      2.12 |    -0.924 |   0.355 |
| GenusCarya:TotPhen                      |      4.2 |      4.78 |      0.88 |   0.379 |
| GenusCatalpa:TotPhen                    |     0.73 |      4.03 |      0.18 |   0.857 |
| GenusCeltis:TotPhen                     |      4.7 |      1.54 |     3.056 |   0.002 |
| GenusFraxinus:TotPhen                   |     0.47 |      0.49 |     0.974 |    0.33 |
| GenusGinkgo:TotPhen                     |     9.64 |      4.54 |     2.122 |   0.034 |
| GenusGleditsia:TotPhen                  |     2.41 |      0.63 |     3.794 |       0 |
| GenusJuglans:TotPhen                    |    -1.69 |      2.35 |    -0.718 |   0.473 |
| GenusPicea:TotPhen                      |    -3.48 |      1.43 |     -2.43 |   0.015 |
| GenusPinus:TotPhen                      |    -7.98 |       1.9 |    -4.195 |       0 |
| GenusPlatanus:TotPhen                   |     6.16 |     12.58 |      0.49 |   0.624 |
| GenusPopulus:TotPhen                    |     1.41 |      2.65 |      0.53 |   0.596 |
| GenusQuercus:TotPhen                    |    -0.51 |      1.12 |    -0.452 |   0.651 |
| GenusRobinia:TotPhen                    |    -1.79 |       3.9 |    -0.457 |   0.647 |
| GenusThuja:TotPhen                      |     1.53 |      3.08 |     0.497 |   0.619 |
| GenusTilia:TotPhen                      |    -0.52 |      0.89 |    -0.591 |   0.555 |
| GenusUlmus:TotPhen                      |    -3.04 |      1.53 |    -1.982 |   0.047 |
| GenusAbies:N                            |     7.29 |      8.31 |     0.877 |    0.38 |
| GenusAcer:N                             |    -2.65 |      0.29 |    -9.184 |       0 |
| GenusBetula:N                           |    -7.09 |      1.91 |    -3.714 |       0 |
| GenusCarya:N                            |    -5.94 |       4.4 |     -1.35 |   0.177 |
| GenusCatalpa:N                          |     -6.4 |      2.84 |    -2.256 |   0.024 |
| GenusCeltis:N                           |    -3.37 |      1.41 |     -2.39 |   0.017 |
| GenusFraxinus:N                         |    -2.28 |      0.34 |    -6.676 |       0 |
| GenusGinkgo:N                           |     2.22 |      3.91 |     0.567 |   0.571 |
| GenusGleditsia:N                        |    -1.81 |      0.52 |    -3.483 |       0 |
| GenusJuglans:N                          |    -2.94 |      1.97 |    -1.489 |   0.136 |
| GenusPicea:N                            |    -3.79 |      1.11 |     -3.43 |   0.001 |
| GenusPinus:N                            |    -3.03 |      1.56 |    -1.942 |   0.052 |
| GenusPlatanus:N                         |    -8.46 |     16.78 |    -0.504 |   0.614 |
| GenusPopulus:N                          |     1.04 |      3.02 |     0.344 |   0.731 |
| GenusQuercus:N                          |    -1.78 |      0.98 |     -1.82 |   0.069 |
| GenusRobinia:N                          |    -7.23 |      2.77 |    -2.611 |   0.009 |
| GenusThuja:N                            |     1.97 |      2.28 |     0.861 |   0.389 |
| GenusTilia:N                            |    -2.03 |      0.55 |     -3.69 |       0 |
| GenusUlmus:N                            |    -2.14 |      1.32 |    -1.617 |   0.106 |
| GenusAbies:Sugar                        |   -14.56 |     10.95 |     -1.33 |   0.184 |
| GenusAcer:Sugar                         |    -0.71 |      0.34 |    -2.092 |   0.036 |
| GenusBetula:Sugar                       |    -3.19 |      2.37 |    -1.347 |   0.178 |
| GenusCarya:Sugar                        |    -1.65 |         5 |    -0.331 |   0.741 |
| GenusCatalpa:Sugar                      |     4.83 |      4.57 |     1.059 |    0.29 |
| GenusCeltis:Sugar                       |     -2.6 |      1.32 |    -1.968 |   0.049 |
| GenusFraxinus:Sugar                     |    -0.14 |      0.45 |    -0.312 |   0.755 |
| GenusGinkgo:Sugar                       |     2.62 |      5.41 |     0.485 |   0.628 |
| GenusGleditsia:Sugar                    |    -2.01 |      0.61 |    -3.298 |   0.001 |
| GenusJuglans:Sugar                      |    -2.92 |      2.19 |     -1.33 |   0.183 |
| GenusPicea:Sugar                        |     3.06 |      1.41 |     2.169 |    0.03 |
| GenusPinus:Sugar                        |     0.37 |      1.81 |     0.206 |   0.837 |
| GenusPlatanus:Sugar                     |   -36.29 |     16.57 |     -2.19 |   0.029 |
| GenusPopulus:Sugar                      |     0.97 |      2.46 |     0.393 |   0.694 |
| GenusQuercus:Sugar                      |    -0.13 |      0.93 |    -0.137 |   0.891 |
| GenusRobinia:Sugar                      |    -4.07 |      3.63 |    -1.122 |   0.262 |
| GenusThuja:Sugar                        |     1.03 |      3.26 |     0.315 |   0.752 |
| GenusTilia:Sugar                        |    -1.14 |       0.6 |      -1.9 |   0.057 |
| GenusUlmus:Sugar                        |     2.56 |      1.42 |       1.8 |   0.072 |
| GenusAbies:LMA                          |     9.71 |      6.73 |     1.443 |   0.149 |
| GenusAcer:LMA                           |     0.25 |      0.23 |     1.072 |   0.284 |
| GenusBetula:LMA                         |    -0.72 |      1.56 |    -0.461 |   0.645 |
| GenusCarya:LMA                          |    -1.65 |       3.9 |    -0.424 |   0.671 |
| GenusCatalpa:LMA                        |     0.17 |      2.47 |     0.069 |   0.945 |
| GenusCeltis:LMA                         |    -0.52 |      0.92 |    -0.566 |   0.572 |
| GenusFraxinus:LMA                       |    -0.23 |      0.26 |    -0.918 |   0.359 |
| GenusGinkgo:LMA                         |    -3.51 |      2.99 |    -1.174 |    0.24 |
| GenusGleditsia:LMA                      |    -0.09 |      0.35 |    -0.272 |   0.786 |
| GenusJuglans:LMA                        |     1.06 |      1.44 |     0.736 |   0.462 |
| GenusPicea:LMA                          |    -1.38 |      0.86 |    -1.607 |   0.108 |
| GenusPinus:LMA                          |    -0.68 |      1.28 |    -0.531 |   0.596 |
| GenusPlatanus:LMA                       |    12.57 |      13.7 |     0.917 |   0.359 |
| GenusPopulus:LMA                        |     1.92 |      2.13 |     0.899 |   0.369 |
| GenusQuercus:LMA                        |    -0.57 |      0.65 |    -0.879 |   0.379 |
| GenusRobinia:LMA                        |     0.53 |      2.22 |      0.24 |   0.811 |
| GenusThuja:LMA                          |     2.57 |      1.84 |     1.399 |   0.162 |
| GenusTilia:LMA                          |    -1.26 |      0.52 |    -2.393 |   0.017 |
| GenusUlmus:LMA                          |    -2.11 |      0.93 |    -2.264 |   0.024 |
| GenusAbies:lignin                       |    15.65 |      8.61 |     1.817 |   0.069 |
| GenusAcer:lignin                        |    -2.22 |      0.38 |    -5.906 |       0 |
| GenusBetula:lignin                      |    -1.45 |      2.36 |    -0.615 |   0.539 |
| GenusCarya:lignin                       |    -1.88 |      4.72 |    -0.399 |    0.69 |
| GenusCatalpa:lignin                     |    -8.14 |      5.42 |    -1.502 |   0.133 |
| GenusCeltis:lignin                      |     1.74 |      1.62 |     1.075 |   0.283 |
| GenusFraxinus:lignin                    |    -2.41 |      0.51 |    -4.711 |       0 |
| GenusGinkgo:lignin                      |     1.51 |      5.78 |     0.262 |   0.793 |
| GenusGleditsia:lignin                   |    -0.58 |      0.61 |    -0.954 |    0.34 |
| GenusJuglans:lignin                     |    -3.18 |      2.49 |    -1.278 |   0.201 |
| GenusPicea:lignin                       |     -4.9 |      1.35 |     -3.62 |       0 |
| GenusPinus:lignin                       |    -0.78 |      1.95 |    -0.398 |   0.691 |
| GenusPlatanus:lignin                    |    16.84 |      10.3 |     1.635 |   0.102 |
| GenusPopulus:lignin                     |    -2.73 |      2.52 |    -1.082 |   0.279 |
| GenusQuercus:lignin                     |    -2.49 |      1.19 |    -2.091 |   0.037 |
| GenusRobinia:lignin                     |    -6.57 |      3.67 |    -1.791 |   0.073 |
| GenusThuja:lignin                       |    -0.05 |       3.9 |    -0.013 |    0.99 |
| GenusTilia:lignin                       |    -0.16 |      0.68 |    -0.228 |    0.82 |
| GenusUlmus:lignin                       |    -3.43 |       1.5 |    -2.282 |   0.023 |
| GenusAbies:chl                          |    -4.01 |      7.88 |    -0.509 |   0.611 |
| GenusAcer:chl                           |     1.69 |      0.35 |      4.79 |       0 |
| GenusBetula:chl                         |     3.83 |      2.06 |     1.858 |   0.063 |
| GenusCarya:chl                          |     4.13 |      4.81 |     0.858 |   0.391 |
| GenusCatalpa:chl                        |     12.4 |      3.89 |     3.188 |   0.001 |
| GenusCeltis:chl                         |     3.76 |      1.53 |     2.457 |   0.014 |
| GenusFraxinus:chl                       |     3.56 |       0.4 |     8.887 |       0 |
| GenusGinkgo:chl                         |     2.74 |      4.46 |     0.615 |   0.538 |
| GenusGleditsia:chl                      |     2.02 |      0.58 |     3.468 |   0.001 |
| GenusJuglans:chl                        |     2.28 |      2.35 |      0.97 |   0.332 |
| GenusPicea:chl                          |     5.66 |      1.35 |     4.197 |       0 |
| GenusPinus:chl                          |     -1.8 |      1.98 |    -0.912 |   0.362 |
| GenusPlatanus:chl                       |    -3.16 |     13.73 |     -0.23 |   0.818 |
| GenusPopulus:chl                        |    -2.63 |      2.98 |    -0.882 |   0.378 |
| GenusQuercus:chl                        |     1.44 |      0.96 |     1.497 |   0.134 |
| GenusRobinia:chl                        |      4.4 |      3.54 |     1.244 |   0.213 |
| GenusThuja:chl                          |     1.39 |      2.78 |     0.501 |   0.616 |
| GenusTilia:chl                          |    -0.84 |      0.73 |    -1.139 |   0.255 |
| GenusUlmus:chl                          |     3.82 |      1.52 |      2.52 |   0.012 |
| GenusAbies:pct_imp_20m:pct_imp_100m     |    39.27 |    483.61 |     0.081 |   0.935 |
| GenusAcer:pct_imp_20m:pct_imp_100m      |    -4.49 |      5.46 |    -0.822 |   0.411 |
| GenusBetula:pct_imp_20m:pct_imp_100m    |   -10.96 |     50.72 |    -0.216 |   0.829 |
| GenusCarya:pct_imp_20m:pct_imp_100m     |   -17.49 |     54.84 |    -0.319 |    0.75 |
| GenusCatalpa:pct_imp_20m:pct_imp_100m   |    -49.1 |     37.64 |    -1.304 |   0.192 |
| GenusCeltis:pct_imp_20m:pct_imp_100m    |   -17.12 |     18.92 |    -0.905 |   0.365 |
| GenusFraxinus:pct_imp_20m:pct_imp_100m  |    -8.06 |      4.47 |    -1.801 |   0.072 |
| GenusGinkgo:pct_imp_20m:pct_imp_100m    |   -23.78 |     68.64 |    -0.346 |   0.729 |
| GenusGleditsia:pct_imp_20m:pct_imp_100m |     3.65 |      5.46 |     0.669 |   0.503 |
| GenusJuglans:pct_imp_20m:pct_imp_100m   |     5.38 |      27.7 |     0.194 |   0.846 |
| GenusPicea:pct_imp_20m:pct_imp_100m     |   -39.91 |     25.17 |    -1.586 |   0.113 |
| GenusPinus:pct_imp_20m:pct_imp_100m     |   -57.46 |      29.1 |    -1.975 |   0.048 |
| GenusPlatanus:pct_imp_20m:pct_imp_100m  |  -125.31 |    290.56 |    -0.431 |   0.666 |
| GenusPopulus:pct_imp_20m:pct_imp_100m   |   -63.87 |      39.5 |    -1.617 |   0.106 |
| GenusQuercus:pct_imp_20m:pct_imp_100m   |   -18.75 |     17.11 |    -1.095 |   0.273 |
| GenusRobinia:pct_imp_20m:pct_imp_100m   |     8.25 |     38.25 |     0.216 |   0.829 |
| GenusThuja:pct_imp_20m:pct_imp_100m     |  -119.12 |     54.88 |    -2.171 |    0.03 |
| GenusTilia:pct_imp_20m:pct_imp_100m     |   -28.85 |      9.33 |    -3.093 |   0.002 |
| GenusUlmus:pct_imp_20m:pct_imp_100m     |    -4.58 |     15.12 |    -0.303 |   0.762 |
#+end_example

*** Plots of two models
**** height by neighborhood/street/utilities
#+begin_src R
        nd <- dc %>%
            select(mean_height_wn20m , pct_imp_20m, pct_imp_100m , TotPhen , N , Sugar , LMA , lignin , chl , tpi_5ft , aspect_trans_5ft , tpi_200ft , aspect_trans_200ft , elev, slope_5ft, slope_200ft) %>%
            summarize_all(median)

    eg <- expand.grid(cor_max2005 = seq(8,24, 1), Genus = "Fraxinus", st_po = c("neighborhood", "st no util", "st w util")) %>%
        mutate(height2005_2 = cor_max2005^2,
               height2005_3 = cor_max2005^3,
               height2005_4 = cor_max2005^4)
           

    nd <- cbind(nd, eg)

  p <- predict(m_nogenus, newdata = nd, interval = "confidence")

  nd <- cbind(nd, p)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/first_model_predict_height_by_stpo_int.png :width 1000 :height 400 :bg transparent :res 120
  ggplot(nd, aes(x = cor_max2005, y = fit, ymax = upr, ymin = lwr, group = st_po)) +
      geom_line(aes(color = st_po)) + geom_ribbon(alpha = .1) +
      scale_color_brewer("tree type", labels = c("neighborhood tree","street tree with no overhead utilites", "street tree with overhead utilites"), palette = "Dark2") +
      scale_y_continuous("growth rate (m / yr)") +
      scale_x_continuous("bias corrected height in 2005 (m)") +
      theme_tufte(base_size = 16) +
      theme(legend.title = element_blank(),
            legend.text = element_text(size = 13),
            legend.position = c(.75, .75),
            axis.ticks = element_line(size = .3), 
            panel.grid.major = element_line(color = "#839496", size = .1),
            panel.grid.minor = element_line(color = "#839496", size = .05))


#+end_src

#+RESULTS:
[[file:figs/first_model_predict_height_by_stpo_int.png]]

**** impervious cover interaction
#+begin_src R
  nd <- select(dc, pct_imp_20m, pct_imp_100m) %>%
      mutate(pct_imp_20m = round(pct_imp_20m, digits = 1),
             pct_imp_100m = round(pct_imp_100m, digits = 1)) %>%
      unique()

        ndm <- dc %>%
            select(cor_max2005, height2005_2, height2005_3, height2005_4,mean_height_wn20m, TotPhen , N , Sugar , LMA , lignin , chl , tpi_5ft , aspect_trans_5ft , tpi_200ft , aspect_trans_200ft , elev, slope_5ft, slope_200ft) %>%
            summarize_all(median)

  ndm$st_po <- "neighborhood"
  ndm$st_po <- "st no util"

  nd <- cbind(nd, ndm)

      
  p <- predict(m_nogenus, nd, interval = "confidence")

p <- cbind(nd, p)

#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/impervious_street_neighborhood.png :width 1000 :res 120
        ggplot(data = p, aes(x = pct_imp_100m * 100, y = fit, ymin = lwr, ymax = upr, color = pct_imp_20m * 100, group = pct_imp_20m * 100)) + 
          geom_line(aes(color = pct_imp_20m)) +
#          geom_ribbon(alpha = .1) +
          scale_color_distiller("percent impervious\nwithin 20 m", palette = "RdYlGn") +
          scale_y_continuous("growth rate (cm / yr)") +
          scale_x_continuous("percent impervious within 100 m") +
        theme_tufte(base_size = 16) +
          theme(legend.title = element_text(size = 15, ),
                legend.text = element_text(size = 13),
                legend.position = c(.18, .45),
                legend.direction = "horizontal",
                axis.ticks = element_line(size = .3), 
                panel.grid.major = element_line(color = "#839496", size = .1),
                panel.grid.minor = element_line(color = "#839496", size = .05)) +
            guides(colour = guide_colourbar(title.position="top", title.hjust = 0.2))




#+end_src

#+RESULTS:
[[file:figs/impervious_street_neighborhood.png]]
#+begin_src R :exports results :results graphics :file figs/impervious_street_neighborhood_ribbon.png :width 1000 :res 120
          ggplot(data = p, aes(x = pct_imp_100m * 100, y = fit, ymin = lwr, ymax = upr, fill = pct_imp_20m * 100, group = pct_imp_20m * 100)) + 
            geom_ribbon(alpha = .1) +
            geom_line(aes(color = pct_imp_20m * 100), size = .8) +
            scale_color_distiller("percent impervious\nwithin 20 m", palette = "RdYlGn") +
            scale_fill_distiller("percent impervious\nwithin 20 m", palette = "RdYlGn") +
            scale_y_continuous("growth rate (cm / yr)") +
            scale_x_continuous("percent impervious within 100 m") +
          theme_tufte(base_size = 16) +
            theme(legend.title = element_text(size = 15, ),
                  legend.text = element_text(size = 13),
                  legend.position = c(.18, .45),
                  legend.direction = "horizontal",
                  axis.ticks = element_line(size = .3), 
                  panel.grid.major = element_line(color = "#839496", size = .1),
                  panel.grid.minor = element_line(color = "#839496", size = .05)) +
              guides(colour = guide_colourbar(title.position="top", title.hjust = 0.2),
                     fill = F)




#+end_src

#+RESULTS:
[[file:figs/impervious_street_neighborhood_ribbon.png]]



***** topography
#+begin_src R
      library(stringr)
        topo <- c("aspect_trans_200ft", "aspect_trans_5ft", "elev", "tpi_5ft", "tpi_200ft", "slope_5ft", "slope_200ft")

          mt <-   tidy(m_nogenus) %>%
                filter(term %in% topo) 

    mt$term[mt$term == "elev"] <- "elev_5ft"



    mt <- mt %>%
              mutate(scale = str_extract(term, "5ft|200ft"),
                     scale = plyr::mapvalues(scale, c("5ft", "200ft"), c("1.5 m", "61 m")),
                     topo_term = str_extract(term, "tpi|slope|aspect_trans|elev"),
                     topo_term = case_when(topo_term == "tpi" ~ "topographic position index",
                                           topo_term == "slope" ~ "slope",
                                           topo_term == "aspect_trans" ~ "transformed aspect",
                                           topo_term == "elev" ~ "elevation (100s m)"))
                                         


#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/first_model_topo_coef_plots.png :width 1150 :height 300 :res 120 :bg transparent

        ggplot(mt, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, x = scale)) + geom_pointrange(position = position_dodge(width = .3)) +
          coord_flip() +
          geom_hline(aes(yintercept = 0), color = red) +
          facet_wrap(~topo_term, ncol = 4, scales = "free_x") +
            theme_tufte(base_size = 16) +
            theme(legend.title = element_text(size = 10),
                legend.text = element_text(size = 8),
                axis.ticks = element_line(size = .3), 
                panel.grid.major = element_line(color = "#839496", size = .1),
                panel.grid.minor = element_line(color = "#839496", size = .05),
                panel.background = element_rect(size = .2)) +
          scale_color_brewer(type = "qual", palette = "Dark2") 
#+end_src

#+RESULTS:
[[file:figs/first_model_topo_coef_plots.png]]

**** height by genus 

#+begin_src R
            nd <- dc %>%
                select(mean_height_wn20m , pct_imp_20m, pct_imp_100m , TotPhen , N , Sugar , LMA , lignin , chl , tpi_5ft , aspect_trans_5ft , tpi_200ft , aspect_trans_200ft , elev, slope_5ft, slope_200ft) %>%
                summarize_all(median)

        eg <- expand.grid(cor_max2005 = seq(8,22, 1), 
                          Genus = c("Acer", "Fraxinus", "Gleditsia", "Tilia", "Quercus", "Celtis",  "Picea", "Ulmus", "Pinus", "Juglans", "Robinia", "Populus"), 
                          st_po = c("neighborhood", "st no util", "st w util")) %>%
            mutate(height2005_2 = cor_max2005^2,
                   height2005_3 = cor_max2005^3,
                   height2005_4 = cor_max2005^4)
           

        nd <- cbind(nd, eg)

      p <- predict(m_genus, newdata = nd, interval = "confidence")

      nd <- cbind(nd, p)

nd <- nd %>% mutate(st_po = plyr::mapvalues(st_po, c("neighborhood", "st no util", "st w util"), c("neighborhood tree","street tree with no overhead utilites", "street tree with overhead utilites")))

#+end_src

#+RESULTS:
: 
: Warning message:
: In predict.lm(m_genus, newdata = nd, interval = "confidence") :
:   prediction from a rank-deficient fit may be misleading

#+begin_src R :exports results :results graphics :file figs/height_genus_int_stpoNeighborhood.png :width 1300 :height 800 :res 120 
tpal <- c(brewer.pal(n = 8, name = "Dark2"), brewer.pal(n = 8, name = "Accent")[c(1,6, 7, 5)])

  ggplot(filter(nd, st_po == "neighborhood tree"), aes(x = cor_max2005, y = fit, ymax = upr, ymin = lwr, group = Genus)) +
    geom_ribbon(aes(fill = Genus), alpha = .1) +
    geom_line(aes(color = Genus)) +
    facet_wrap(~Genus) +
    scale_color_manual(values = tpal) +
    scale_fill_manual(values = tpal) +
    scale_y_continuous("predicted growth rate (cm / yr)") +
    scale_x_continuous("height in 2005 (m)") +
    terk

#+end_src

#+RESULTS:
[[file:figs/height_genus_int_stpoNeighborhood.png]]

The negative impact of being a street tree appears to be greater for
Acer than for Fraxinus and Gleditsia.

#+begin_src R :exports results :results graphics :file figs/height_genus_int_stpo_genussub1.png :width 1300 :res 120
    ggplot(filter(nd, Genus %in% c("Acer", "Fraxinus", "Gleditsia")), aes(x = cor_max2005, y = fit, ymax = upr, ymin = lwr, group = Genus)) +
      geom_ribbon(aes(fill = Genus), alpha = .1) +
      geom_line(aes(color = Genus)) +
      facet_wrap(~st_po, ncol = 3) +
  terk +
    scale_color_brewer(palette = "Dark2") +
    scale_y_continuous("predicted growth rate (cm / yr)") +
    scale_x_continuous("height in 2005 (m)") +
    scale_fill_brewer(palette = "Dark2") 


#+end_src

#+RESULTS:
[[file:figs/height_genus_int_stpo_genussub1.png]]

#+begin_src R :exports results :results graphics :file figs/height_genus_int_stpo_genussub2.png :width 1300 :res 120
    ggplot(filter(nd, Genus %in% c("Acer", "Fraxinus", "Gleditsia")), aes(x = cor_max2005, y = fit, ymax = upr, ymin = lwr, group = st_po)) +
      geom_ribbon(aes(fill = st_po), alpha = .1) +
      geom_line(aes(color = st_po)) +
      facet_wrap(~Genus, ncol = 4) +
  terk +
    scale_color_solarized("red") +
    scale_fill_solarized("red")
#+end_src

#+RESULTS:
[[file:figs/height_genus_int_stpo_genussub2.png]]


#+begin_src R :exports results :results graphics :file figs/height_genus_int_stpolines.png :width 1300 :height 800 :res 120 
tpal <- c(brewer.pal(n = 8, name = "Dark2"), brewer.pal(n = 8, name = "Accent")[c(1,6, 7, 5)])
  ggplot(nd, aes(x = cor_max2005, y = fit, ymax = upr, ymin = lwr, group = st_po)) +
    geom_ribbon(aes(fill = st_po), alpha = .1) +
    geom_line(aes(color = st_po)) +
    facet_wrap(~Genus) +
    scale_color_manual(values = tpal) +
    scale_fill_manual(values = tpal) +
    scale_y_continuous("predicted growth rate (cm / yr)") +
    scale_x_continuous("height in 2005 (m)") +
    terk

#+end_src

#+RESULTS:
[[file:figs/height_genus_int_stpolines.png]]

#+begin_src R :exports results :results graphics :file figs/height_genus_int_stpolines_scalesfree.png :width 1300 :height 800 :res 120 
tpal <- c(brewer.pal(n = 8, name = "Dark2"), brewer.pal(n = 8, name = "Accent")[c(1,6, 7, 5)])
  ggplot(nd, aes(x = cor_max2005, y = fit, ymax = upr, ymin = lwr, group = st_po)) +
    geom_ribbon(aes(fill = st_po), alpha = .1) +
    geom_line(aes(color = st_po)) +
    facet_wrap(~Genus, scales = "free") +
    scale_color_manual(values = tpal) +
    scale_fill_manual(values = tpal) +
    scale_y_continuous("predicted growth rate (cm / yr)") +
    scale_x_continuous("height in 2005 (m)") +
    terk

#+end_src

#+RESULTS:
[[file:figs/height_genus_int_stpolines_scalesfree.png]]

**** mean height within 20 m
#+begin_src R
      mtng <- tidy(m_nogenus) %>% data.frame %>%
        filter(grepl("mean_height", term)) %>%
        mutate(Genus = "overall")

      mtg <- tidy(m_genus) %>% data.frame %>%
        filter(grepl("mean_height", term)) %>%
        mutate(Genus = str_match(term, "Genus([A-Z][a-z]+)")[,2])


  mt <- bind_rows(mtg, mtng) %>%
    mutate(Genus = factor(Genus, levels = c("overall", c(mtg$Genus))))




#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/mean_height_20m_coefs.png :width 800 :height 475 :bg transparent :res 120
    mtp <- filter(mt, Genus != "Platanus")

              ggplot(mtp, aes(y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error, x = Genus)) + 
                  geom_pointrange(position = position_dodge(width = .3)) +
                coord_flip() +
                geom_hline(aes(yintercept = 0), color = red) +
                  theme_tufte(base_size = 16) +
                  theme(legend.title = element_text(size = 10),
                      legend.text = element_text(size = 8),
                      axis.ticks = element_line(size = .3), 
                      panel.grid.major = element_line(color = "#839496", size = .1),
                      panel.grid.minor = element_line(color = "#839496", size = .05),
                      panel.background = element_rect(size = .2),
                      plot.subtitle = element_text(hjust = 0.5)) +
                labs(subtitle = "coefficients for mean height within 20 m")

#+end_src

#+RESULTS:
[[file:figs/mean_height_20m_coefs.png]]


**** traits
#+begin_src R
      mtng <- tidy(m_nogenus) %>% data.frame %>%
          filter(grepl("N|TotPhen|chl|Sugar|LMA", term)) %>%
        mutate(Genus = "overall",
               trait = str_match(term, "(N|TotPhen|chl|Sugar|LMA)")[,2])

      mtg <- tidy(m_genus) %>% data.frame %>%
        filter(grepl("N|TotPhen|chl|Sugar|LMA", term)) %>%
          mutate(Genus = str_match(term, "Genus([A-Z][a-z]+)")[,2],
                 trait = str_match(term, "(N|TotPhen|chl|Sugar|LMA)")[,2])


  mt <- bind_rows(mtg, mtng) %>%
    mutate(Genus = factor(Genus, levels = c("overall", unique(c(mtg$Genus)))))


#+end_src

#+RESULTS:

#+begin_src R :exports results :results graphics :file figs/traits_coef_comparison.png :width 1000 :height 800 :bg transparent :res 120
  tpal <- c(brewer.pal(n = 8, name = "Dark2"), brewer.pal(n = 8, name = "Accent")[c(1,6, 7, 5)])

  mtg <- mtg %>% filter(Genus %in% c("Acer", "Fraxinus", "Gleditsia", "Tilia", "Quercus", "Celtis",  "Picea", "Ulmus", "Pinus", "Juglans", "Robinia", "Populus"))

    ggplot(data = mtng, aes(x = trait, y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error)) + 
        geom_pointrange(data = mtg, aes(color = Genus), position = position_dodge2(width = .6, reverse = TRUE)) +
        geom_pointrange() +
        coord_flip() +
      terk +
      scale_color_manual(values = tpal) +
      scale_y_continuous(limits = c(-12, 12)) +
       geom_hline(yintercept = 0, size = .2)

#+end_src

#+RESULTS:
[[file:figs/traits_coef_comparison.png]]

#+begin_src R :exports results :results graphics :file figs/traits_coef_comparison_nogenus.png :width 1000 :height 600 :bg transparent :res 120
    tpal <- c(brewer.pal(n = 8, name = "Dark2"), brewer.pal(n = 8, name = "Accent")[c(1,6, 7, 5)])

    mtg <- mtg %>% filter(Genus %in% c("Acer", "Fraxinus", "Gleditsia", "Tilia", "Quercus", "Celtis",  "Picea", "Ulmus", "Pinus", "Juglans", "Robinia", "Populus"))

      ggplot(data = mtng, aes(x = trait, y = estimate, ymax = estimate + 1.96 * std.error, ymin = estimate - 1.96 * std.error)) + 
  #        geom_pointrange(data = mtg, aes(color = Genus), position = position_dodge2(width = .6, reverse = TRUE)) +
          geom_pointrange() +
          coord_flip() +
        terk +
        scale_color_manual(values = tpal) +
        scale_y_continuous(limits = c(-12, 12)) +
       geom_hline(yintercept = 0, size = .2)

#+end_src

#+RESULTS:
[[file:figs/traits_coef_comparison_nogenus.png]]


*** TODO I need to look at semivariogram...


#+begin_src R
    library(sp)
    library(gstat)

    dc$resid <- resid(m_genus)

    coordinates(dc) = ~ x + y

  vg.gr <-   variogram(growth.rate ~ 1, dc, cutoff = 2000, width = 20)
  vg.rd <-   variogram(resid ~ 1, dc, cutoff = 2000, width = 20)

#+end_src

#+RESULTS:
: 
: Registered S3 method overwritten by 'xts':
:   method     from
:   as.zoo.xts zoo

#+begin_src R :exports results :results graphics :file figs/growthrate_variogram.png
plot(vg.gr)
#+end_src

#+RESULTS:
[[file:figs/growthrate_variogram.png]]

#+begin_src R :exports results :results graphics :file figs/residual_variogram.png
plot(vg.rd)
#+end_src

#+RESULTS:
[[file:figs/residual_variogram.png]]
#+begin_src R

  vg <- variogram(growth.rate ~ street + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl,
                  dc,
                  cutoff = 1000,
                  width = 20)

  plot(vg)


  vge <- fit.variogram(vg, model = vgm("Mat"))
#+end_src

*** with spatial errors?
#+begin_src R

#+end_src


R crashes for lack of memory
#+begin_src R :eval no
      library(nlme)
library(spaMM)
    dc$dummy <- 1 # necessary for lme to work

      sm <- lme(fixed = growth.rate ~ street + Genus + poly(cor_max2005,4) + tpi_5ft + aspect_trans_5ft + tpi_200ft + aspect_trans_200ft + elev + mean_height_wn20m + pct_imp_20m * pct_imp_100m + TotPhen + N + Sugar + LMA + lignin + chl,
                data = dc,
                random = ~ 1 | dummy,
                correlation = corMatern(form = ~ x+y  | dummy), 
                method = "ML")


#+end_src

#+RESULTS:
#+begin_example

Attaching package: ‘nlme’

The following object is masked from ‘package:dplyr’:

    collapse

The following object is masked from ‘package:raster’:

    getData

Error in corMatern(form = ~x + y | dummy) : 
  could not find function "corMatern"
#+end_example

** TODO map predicted growth rate
- plotting
- plot residual in space

what i would need everything at trait map resolution
- trait maps
- impervious cover smoothed 20m and 100m
- topography
- height 2005, corrected.
- mean height within 20m?
- 




- make map -
  - as inputs
    - trait map
    - topography
    - impervious
    - street lines and powerlines for street tree and utilities.
    - 


- show predicted versus observed

* Introduction

Urban trees grow differently than their more rural counterparts
because of the challenges they face surviving amongst urban
infrastructure and because they are largely cultivated by humans (but
not for their wood).  For example, street trees are subject to damage
from vehicles, pedestrians, and poor soil conditions; urban trees tend
to be more open grown than rural trees; urban trees are pruned to
accomodate powerlines or for aesthetics, many urban trees are
irrigated and fertilized; the species composition in a city is often
different than its rural surrounding.  Urban conditions are not only
unique, but they are also more heterogeneous, which creates
variability in the growth of the urban forest at small spatial scales.

Urban forests are also critical components of the "green
infrastructure" meant to make cities more livable.  With over half the
human population living in urban areas, planting trees to provide
ecosystem services is seen as a way to make cities more livable.
These ecosystem services include habitat for wildlife, stormwater
runoff reduction, air quality improvement, and carbon sequestration.  

All these services are a function of growth, either directy such as
carbon sequestration, or indirectly such as stormwater runoff
reduction which is a function of tree size.  Therefore, understanding
urban tree growth is essential to estimating and projecting ecosystem
services into the future.  

Remote sensing technology provides an efficient way to collect
sufficient data on urban tree growth for detecting effect sizes that
may be small relative to the variability induced by the urban
environment.  Here we use two technologies that have only recently
become more available, repeat lidar and imaging spectroscopy.  Lidar
uses the reflection of lazer pulses to create 3 dimensional point
clouds of objects.  Using multiple years of lidar data we are able to
calculate growth in the the height of thousands of trees.  Imaging
spectroscopy 

to measure height
growth, to create indicies of canopy foliar
traits.  



Objectives:
- Evaluate the effectiveness of terrain optimaized leaf-off lidar with
  variable pulse densities to estimate urban tree height growth
- Evaluate whether canopy foliar traits estimated from imaging
  spectroscopy can explain tree height growth.
- Evaluate how urban tree height growth is altered by environmental
  factors common to all trees (e.g. aspect) as well as environmental
  factors specific to the urban environment (impervious cover and
  powerlines).
- 
Use repeat lidar in an urban environ


cite:marinelli_e_2019 note the challenge of mulitemporal lidar
analyses of forest parameters since as forest changes in time pulse density
has increased in time.  Especially true for individual trees.  They
cite: cite:paris_bruzzone_2015 and cite:zhao_e_2018.  But I don't
think they performed a correction for tree height.


Existing methods for estimating ecosystem services are lacking.
cite:erker_townsend_2019 address building energy use
effects. cite:boukili_e_2017 address C sequestration from growth and
find itree and UTD both over estimate.  
When we have limited resources, we need to make sure we allocate them
efficiently.  We don't want to spend loads of money on trees if the
benefits of trees will be less than the benefits that could be
achieved by allocating those resources elsewhere.  At best it's a
waste of resources, at worst it lulls us into a feeling of complancey-
that we're doing something when we're really not.  
- think all those science papers
- elon musk planting million trees
- mr beast?
- vice and timberland avertisement for planting trees.




** COMMENT comments







Understanding how trees grow in urban environments can help cities
better estimate and project 

- Why important
  - Urban environments are unique
  - Trees there provide services, one of which is carbon sequestration
    via growth
- Context
  - there is incredible variability in urban tree growth across a city
    due to variability in environment, and species
  - Remote sensing technology, specifically repeat lidar and imaging
    spectroscopy, allow for measurements of growth (from repeat lidar)
    for thousands of trees, which then can be combined with indicies
    of foliar traits (from imaging spectroscopy) to create large data
    for understanding urban tree growth
- Questions
  - What is the distribution of rates of urban tree height growth for different
    species in Madison?
    - this is the variability that I would seek to explain with
      environmental and trait data.
  - Do foliar trait indicies derived from imaging spectroscopy explain
    any of the variability in tree growth rates?
  - Do environmental factors (proximity to road, age of road?, percent
    impervious within 100m, topographic location.
- We hypothesize that we'll see effects expected from other studies
  - trees grow faster
* Methods
** Overview
In our study city, Madison, WI, we combined several outputs of remote
sensing technologies and several geographic information system (GIS)
layers to explore the potential for environmental factors and canopy
foliar traits to explain urban tree height growth.  Using four years
of lidar data (2005, 2009, 2016, and 2017) and an new height bias
correction method, we estimated the height growth of trees over a 12
year period.  We used two street tree inventories (one from the city
of Madison and one from the village of Shorewood, which is within the
city) and two complete inventories of the trees Madison's Atwood and
Hill Farms neighborhoods to get taxonomic infomation of trees.  In
June 2015, NASA's Airborne Visible / Infrared Imaging Spectometer -
Next Generation (AVIRIS-NG) imaged the majority of Madison.  Using
predictive equations developed following cite:singh_e_2015, we
predicted canopy foliar traits: Nitrogen (% mass), N; leaf mass per
area (g/m^2), LMA; lignin (% mass), chlophyll, and total phenolics.  I
should change these units to an index. CHECK I HAVE ALL THESE.  In
addition to foliar traits, we calculated other environmental factors
such as percent impervious cover at two scales (within 20m and within
100m), topographic

see table [[tab:covariates]] for all covariates

proximity to road and topographic
position.  Total number of trees used in the study was approximately 21
thousand.

We performed exploratory data analysis by plotting 

separate models for street trees and trees from the neighborhood inventories.

We then built a regression models to estimate the relationship of
environmental factors and foliar traits with growth, with separate
models for different species and tree contexts (street trees versus
neighborhood trees).

#+name: tab:covariates
| short name                      |                                          | source                          | explanation                                                                                                                    |
|---------------------------------+------------------------------------------+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------|
| height 2005                     | Bias corrected height in 2005            | lidar                           |                                                                                                                                |
| height within 20m               | Mean Height within 20 m                  | lidar                           |                                                                                                                                |
| Genus                           | Genus                                    | tree inventories                |                                                                                                                                |
| neighborhood street utilities   | neighborhood, street, powerlines         | tree inventories                | indicator variable for whether tree is a neighborhood or street tree and if street trees whether it is under powerlines or not |
| slope 1.5 m                     | slope 1.5 m (5 ft)                       | Digital Elevation Model (DEM)   |                                                                                                                                |
| aspect 1.5 m                    | transformed aspect 1.5 m (5 ft)          | DEM                             |                                                                                                                                |
| TPI 1.5 m                       | topographic position index 1.5m (5 ft)   | DEM                             |                                                                                                                                |
| slope 61 m                      | slope 61 m (200 ft)                      | DEM                             |                                                                                                                                |
| aspect 61 m                     | transformed aspect 61 m (200 ft)         | DEM                             |                                                                                                                                |
| TPI 61 m                        | topographic position index 61 m (200 ft) | DEM                             |                                                                                                                                |
| elevation                       | elevation                                | DEM                             |                                                                                                                                |
| Sugar                           | Sugar                                    |                                 |                                                                                                                                |
| lignin                          | lignin                                   |                                 |                                                                                                                                |
| chlorophyll                     | chlorophyll                              |                                 |                                                                                                                                |
| leaf mass per area              | leaf mass per area                       |                                 |                                                                                                                                |
| total phenolics                 | total phenolics                          |                                 |                                                                                                                                |
| nitrogen                        | nitrogen                                 |                                 |                                                                                                                                |
| percent impervious 20 m         | percent impervious within 20 m           | landcover map cite:erker_e_2019 |                                                                                                                                |
| percent impervious 100 m        | percent impervious within 100 m          | landcover map cite:erker_e_2019 |                                                                                                                                |
|                                 |                                          |                                 |                                                                                                                                |

** Madison, WI: population and forests
Madison is a city of about 260,000 persons ([[https://www.census.gov/quickfacts/fact/table/madisoncitywisconsin/LND110210][USCensus]]), located in south
central Wisconsin.  Its climate is .... and the dominant forest type
is broadleaf deciduous.  Pre-european settlement forests were
dominated by oaks (Quercus), maples (Acer), and basswood (Tilia).
Now the most common street tree genera are Fraxinus, Acer, Gleditsia,
and Tilia, making up over 70% of all street trees.  Other common
genera in neighborhoods include: Picea, Thuja, Betula, and Pinus.


** Data
*** Tree inventories
The species of a tree encodes a suite of genetic factors that affect
growth rates and is therefore important to know when modeling tree
grwoth.  We used four tree inventories for species information.  The
first is the city of Madison's street tree inventory from 2011; the second is the
2012?  inventory of the Atwood neighborhood located on Madison's east
side and the north side of lake Monona, the third is the 2015-2016
inventory of the [[http://www.hillfarms.org/documents/UHFP_Tree_Report_2016.pdf][HillFarms neighborhood]] on Madison's west side FIGURE
HERE SHOWING INVENTORIES!!  the fourth is the village of shorewood's
2015 street tree inventory.  give species breakdowns too.  These
inventories also provide information on DBH and tree condition.  

I need a figure showing the neighborhood inventories and the street
tree inventories too.


Also shorewood's inventory. 2015.
https://www.shorewood-hills.org/?SEC=C2F05A70-9E0E-4D5B-A596-FD0AC2F72227
116 different tree species were found within Shorewood Hills.

The top five most common tree species found were hackberry (8.7%), Norway maple (7.9%), black locust (5.7%), white oak (5.7%), and green ash (5.7%).

There were 360 trees in need of removal and 108 trees in need of safety prunes.

63% of the trees inventoried were considered mature or old.

65% of public trees inventoried were in good or excellent condition, while 8% were rated in poor or very poor condition.

872 trees were located underneath or near utility lines (14% of the trees inventoried).





How did we remove trees

- lidar point clouds were unreliable, too close to other trees, tall
  buildings,
- trees were removed or replanted indicated by large decreases in height




*** Light detection and ranging (lidar)

**** look at huan's dissertation.
Lidar data
The county-wide lidar collection was contracted by the Dane County Land Information Office
to develop a high resolution county-wide digital elevation model (DEM). Ayres Associates
(Madison, Wisconsin) used a 1064 nm Leica ALS70 laser scanner with scan rate of 69.00 Hz and
scan angle between -17 o and +18 o , and flew at an altitude of 1750 m above ground level with
flight speed of 248.40 km/h during leaf-off conditions in April, 2009, producing discrete-return
point clouds with a point density of 1 point per square meter (ppm). Ayres also processed raw
data and generated all-return, first-return and 3m DEM data products for 1248 tiles in total. All-
return and first-return points were stored in LAS (ASPRS, 2010)

1064 nm


**** COMMENT overview
What instrument?
when flown?
altitude? avg pulse density? footprint size?

2009 lidar is .75 points per square meter. 2016 lidar is 

2016 - 


I need a figure or representation of within year pulse density
variability.  esp 2009.

We clip lidar point clouds to within 2.4 m (8 ft) from the center of
the inventoried tree as identified in the inventory point shapefile.
Table .. shows the 


#+name: tab:lidar_sum_stats
#+caption: summary statistics for the number of points per tree for each year of ALS data.  Pulse density increased greatly through time, but there is also considerable intraannual variation from tree to tree.
|                   | 2005 | 2009 | 2016 | 2017 |
|-------------------+------+------+------+------|
| n min             |      |      |      |      |
| n 25% percentile  |      |      |      |      |
| n median          |      |      |      |      |
| n mean            |      |      |      |      |
| n 75th percentile |      |      |      |      |
| n max             |      |      |      |      |


|                                     | 2005 |        2009 | 2016 | 2017 |
|-------------------------------------+------+-------------+------+------|
| Intrument                           |      | Leica ALS70 |      |      |
| wavelength (nm)                     |      |        1064 |      |      |
| altitude (m)                        |      |        1750 |      |      |
| scan rate (Hz)                      |      |       69.00 |      |      |
| scan angle range (degrees)          |      |     -17, 18 |      |      |
| Date                                |      |  April 2009 |      |      |
| Average pulse density (pulses / m^2) |      |        1    |      |      |


**** corrections for maximum height and estimating tree growth

The estimated maximum height of trees derived from ALS is always lower
than the true maximum height, that is, it is biased downward.  The
magnitude of this bias is a function of the ALS and the tree
architecture.  Greater density of lidar pulses will have less bias
since the probability of hitting a branch near the top of the tree
increases.  Trees with less conical and flatter tops - those with weak
apical dominance - will have less bias because there are more branches
close to the highest branch of the tree.  Twig size also plays a
role. Generally, taxa with thinner twigs have denser branching so
while a single twig may not reflect enough energy from a lidar pulse
to trigger a return, there are many more twigs close togther.  Taxa
with thicker twigs will have stronger returns, but since thicker twigs tend to
be less dense, the probability of hitting a thick twig is lower.
Exactly how these negatively correlated traits (twig thickness and
density) interact to influence the bias in maximum height estimates is
mediated by the algorithms used to convert full waveform lidar into
point clouds.  Thus, in our attempt to correct for the bias in maximum
height estimation and - by extension across multiple years - tree height
growth, we used a bootstrap resampling technique to estimate bias at
different pulse densities for each genera in our dataset.  Other
characteristics of the ALS, such as footprint size are important in
correcting bias, but we did not have this information for all our
datasets. https://www.tandfonline.com/doi/abs/10.5589/m06-030

Our goal is to estimate tree growth from multiple years of ALS.  The
primary issue with this endeavor is that tree growth and the size of
the bias are confounded.  In 2005, average pulse density was very low and so
bias was large.  By 2017, average pulse density had increased and so
bias decreased.  The challenge therefore is to identify how much of
the observed maximum height difference is due to growth over those 12
years and how much is due to a decrease in bias.  

To do this, we estimated the bias for trees that were no longer
growing and then applied the bias correction to all other trees. We
selected the tallest trees of each genera that had essentially reached
their maximum height and stopped growing (differences in observed
maximum height between 2009, 2016, and 2017 were all less than 1
meter).  We then combined all returns across years for each tree,
assuming that other than pulse density all else was equal across ALS
aquisitions.  We then sampled 1000 times with replacement from each
tree's point cloud samples of size 1 to the original size.  For each
of the 1000 samples at each sample size, we calculated the maximum
height.  Averaging the maximum heights across the 1000 samples for
each sample size we estimated how bias changes with sample size /
pulse density.

We then averaged the bias curves for each genera and applied this mean
bias correction to each tree according to its genus and number of
pulses.  We also averaged the standard deviation of the bias estimates
and assigned them to each tree in order to provide information on the
amount of uncertainty in each correction.

This method assumes that the relationship between pulse density and
bias is the same for large trees as it is for small trees of the same
genus.  This assumption may not be true, but it is difficult to test
with the existing data.  We also tested estimating the bias correction
for each tree individually, so that the bias by sample size curve was
specific to that tree.  This may have minimized the issue with the
assumption that bias is not a function of tree height, but bias and
growth were confounded.  Nevertheless, results from both corrections
were similar, suggesting our findings are robust to the method of
correction.  Recognizing that there is a bias in the observed maximum
height and that the uncertainty in the bias is a function of sample
size is what appears to be crucial.


pulse density varies within year too (see tree ST55248).

**** Weighted regression for height growth rates

After the bias correction, we had an estimated bias-corrected height
for each year and the standard deviation of this height derived from
the bootstrap resampling procedure.  We then fit a weighted linear
regression for each tree with height as the response and year as the
predictor.  Weights were inversely proportional to the variance of
each bias-corrected height.  The result was an estimate of annual
growth rate for each tree.  The advantage of the weighted regression
is that we were able to include data points in the regression even if
they were highly uncertain rather than removing them completely.  ALS
from 2005 generally is very sparse in density, but there were some
trees for which the sample size was sufficiently large to provide some
information on growth.

Due to the nature of the measurement error and correcting for the mean
bias, at times a tree's height was over or under corrected.  Over
correction explains some of the slightly negative growth rates, while
under correction explains some of the high growth rates.  On average
we assume these errors cancel out.


**** COMMENT comments on lidar
2009 lidar is not well documented.  I think it appers as 2010 lidar on
the wisconsinview website.

i need to get the average point density across all the tiles because
it varies.

.07 pts per sq ft.  = .75 pts per sq meter
.06 

finding buildings: https://github.com/Jean-Romain/lidR/issues/209

2005 lidar might not be good enough for a general tree canopy layer,
but it should still be reliable for treee heights if I know the trees
location ( street trees).


*** Hyperspectral imagery

plot of flightlines.

*** other
- street tree inventory, hill farms and atwood inventories
- lidar
  - how modified to create heights
- imaging spectrsopty
  - modified to create indicies of canopy foliar traits
  - because of variations across images, we adjusted trait maps to one
    image and derived indicies of  foliar tratis.
- dem?
  - topographic position.

** Modeling
We first fit a random forest as an exploratory exercise to find
important variables, detect any important interactions between
variables and better handle nonlinear relationships between covariates
and the response cite:breiman01_Random_forests.  We used the default
tuning parameters in the R package =randomForest= cite:randomForest_Rpackage.  

Multiple lienar regression
- covariates, no genus no interactions
- relevant interactions added
- genus added, intercepts and interactions with some covariates

Second we fit a multiple linear regression model with all covariates,
but no interactions in order to understand how well a relatively
simple model explained the data.  We then added a polynomial term for
the height 2005 covariate to account for the nonlinear relationship
between height and growth rate.  We selected a 4th order polynomial
because it was significant at the alpha = .05 level.  If the focus of
our study were to develop growth equations a more biologically
realistic nonlinear function would have been more appropriate, but we
found the polynomial fit the data well over its range.  We then added
interaction terms to the model based upon hypothesized interactions,
while striving for a model that was parsimonius and relatively simple
to explain.  We also dropped groups of covariates, such as foliar
canopy traits, from the model to see how much they contributed to a
model.  
* Results
** Tree Height Bias Correction and Growth Rate Estimation
The results of our bias correction technique are demonstrated in
figures [[fig:pulse_by_bias_by_genus]], [[fig:mean_pulse_by_bias_by_genus]],
and [[fig:year_by_height]].  Figure [[fig:pulse_by_bias_by_genus]] demontrates
how height bias increases in magnitude as pulse density decreases.
Each curve in the figure is an individual tree that has had its points
resampled at varying densities 1000 times.  Bias curves were created
for 17 genera.  All Genera showed the same general trend, but there
was significant variability in the mean bias curves across genera as
seen in figure [[fig:mean_pulse_by_bias_by_genus]].

#+name: fig:pulse_by_bias_by_genus
#+caption: Empirical height bias by pulse density curves for individual trees of eight example genera.
[[file:figs/ng_bias_n.png]]

#+name: fig:mean_pulse_by_bias_by_genus
#+caption: Mean height bias by pulse density curves for individual trees of eight example genera.  Colored regions are +/- 1 standard error for the mean bias curve.  Pinus has the largest standard error because of the smaller sample size.
[[file:figs/avg_bias_focus1_otherGenera2_n.png]]

Figure [[fig:year_by_height]] compares the uncorrected estimates of growth
rates to our bias corrected and weighted regression approach for 5
sample trees.  The underestimation of height in 2005 due to low pulse
density is evident in most trees by the large drop in height compared
to the trend from the other three years ("ST89566" is a particularly
stark example).  The red bias corrected lines appear to be more
realistic growth rates than the gray uncorrected lines.  However,
there are times when the bias is overcorrected (see "ST03542" and
"ST20636"). Weighting years in the regression by their bias correction
uncertainty can diminish the overcorrection issues, but some years
will be overcorrected (likely "ST05216") and some will be
undercorrected). See supplementary materials for a similar plot of a
random sample of 80 trees.

#+name: fig:year_by_height
#+caption: Heights of 5 trees in 2005, 2009, 2016, and 2017.  Grey points are observed height from ALS; grey line is unweighted linear regression for the observed heights.  Red points are bias-corrected heights; red line is weighted linear regression trend line for the corrected heights.
[[file:figs/correction_nogrowth_m_smooth_lm_specificsample.png]]

** Growth Rates

The mean height growth rate of the 21 thousand trees in our sample was
12.8 cm per year. Performing an unweighted regression with no bias
correction, the growth rate was 22.8 cm per year.  Without the
weighted regression but with the bias correction the mean growth rate
was 8.7 cm per year.  We only analysed in depth the bias corrected
weighted regression growth rate estimates, but the direction and
significance of most model coefficient estimates were the same
regardless of which growth rates were used.

Figure [[fig:growthratehist]] shows the distribution of growth rates.
The large variability and biologically unlikely estimates (e.g. -10
cm/yr or 50 cm/yr) suggest there is considerable measurement error in
growth rate.

#+name: fig:growthratehist
#+caption: Histogram of estimated growth rates for nearly 42,000 urban trees.  The sample mean growth rate is 8.7 cm / year.
[[file:figs/growthrate_histogram_w.png]]

** Random Forest

The random forest model explained 24.11% of the variance in growth
rates.  Table [[tab:rf_importance]] shows explanatory variables ranked in
order of importance as determined by percent increase in mean squared
error.  The genus, height of a tree in 2005, impervious cover within
100m, and the average height of the surrounding 20m were the most
important variables.  Traits and surrounding impervious cover within
20m were next in importance.  Topographic variables were least
important.

#+name: tab:rf_importance
|                               | Percent Increase Mean Squared Error |
|-------------------------------+-------------------------------------|
| Genus                         |                                 118 |
| height 2005                   |                                 110 |
| percent impervious 100 m      |                                  57 |
| height within 20m             |                                  55 |
| lignin                        |                                  49 |
| chlorophyll                   |                                  45 |
| percent impervious 20 m       |                                  43 |
| nitrogen                      |                                  42 |
| Sugar                         |                                  41 |
| neighborhood street utilities |                                  38 |
| total phenolics               |                                  38 |
| elevation                     |                                  37 |
| slope 61 m                    |                                  37 |
| leaf mass per area            |                                  33 |
| TPI 61 m                      |                                  23 |
| aspect 61 m                   |                                  18 |
| slope 1.5 m                   |                                  15 |
| TPI 1.5 m                     |                                   5 |
| aspect 1.5 m                  |                                   4 |

The two-way interactions that occured on average at the lowest depths
in the regression trees were between Genus and height 2005; height
2005 and itself; and Genus and itself; and Genus and height within 20
m.  Genus had the most interactions as might be expected since so many
of the associations of other variables with height growth likely vary
due to the genetic factors encoded in Genus.  

** Multiple linear regression results

The multiple linear regression model with all covariates, but no
interactions had an R^2 of 0.2008, and an adjusted R^2 of 0.1994.  Since
the flexible random forest explained 24% of the variation, this
suggests that there is not a very large amount of variation left to be
explained by more complex interactions.  

After plotting the data and testing for various interactions we
settled on two models to communicate the results.  The first contained
a fourth order polynomial term for the 2005 height covariate, an
interaction between 2005 height and the neighborhood/street/utility
line indicator variable, and an interaction between the two scales of
percent impervious cover. But it did not contain the genus covariate
in order to identify broad patterns between covariates and growth
rates for all trees in our sample.

Next we added the genus covariate which shifted the intercept of the
model and 


: 
:            df      AIC
: m_nogenus  27 169504.6
: m_genus   342 167381.3


The second model was the same as model one, but with interactions between
genus and several covariates: the lidar derived variables, percent impervious cover, and
foliar canopy traits.  

The first model shows overall trends, the second provides information
on differences by Genus.  The AIC for the first model was -27617, and
was -28308 for the second.  The coefficients of covariates clearly
differ by genus.  The first model had 24 non genus parameters shown in table
[[tab:m_nogenusInteractions_summary_coef]].  The second model had 341
parameters and is a table of coeffiecients is available in
supplementary materials.  Coeffiencients or model predictions from the
first model and (when appropriate) the second model are presented in
figures ????????????????  below.  

#+name: tab:m_nogenusInteractions_summary_coef
#+caption: Summary of first model coefficients excluding genera.
| term                                             | estimate | std.error | statistic | p.value |
|--------------------------------------------------+----------+-----------+-----------+---------|
| neighborhood tree                                |    77.51 |       6.1 |      12.6 |  <0.001 |
| street tree, no utilities overhead               |     66.5 |       6.1 |        11 |  <0.001 |
| street tree, with utilities overhead             |    66.82 |       6.1 |      10.9 |  <0.001 |
| height 2005                                      |   -12.21 |       1.4 |      -8.6 |  <0.001 |
| height 2005^2                                     |     0.82 |       0.1 |       6.5 |  <0.001 |
| height 2005^3                                     |  -2.8e-2 |         0 |      -5.7 |  <0.001 |
| height 2005^4                                     |   3.4e-4 |         0 |       5.1 |  <0.001 |
| street tree, no utilities overhead:height 2005   |     0.37 |       0.1 |         5 |  <0.001 |
| street tree, with utilities overhead:height 2005 |     0.31 |       0.1 |       3.2 |  <0.001 |
| mean height within 20 m                          |     0.85 |       0.1 |      13.6 |  <0.001 |
| percent impervious within 20 m                   |     1.41 |       1.4 |         1 |    0.31 |
| percent impervious within 100 m                  |     2.16 |       1.4 |       1.5 |    0.12 |
| % impervious 20m : % impervious 100m             |   -12.37 |       2.5 |      -4.9 |  <0.001 |
| total phenolics                                  |    -2.96 |       0.2 |     -16.8 |  <0.001 |
| nitrogen                                         |    -2.92 |       0.2 |     -16.9 |  <0.001 |
| sugar                                            |    -0.17 |       0.2 |      -0.8 |     0.4 |
| leaf mass per area                               |    -0.08 |       0.1 |      -0.6 |    0.52 |
| lignin                                           |    -3.07 |       0.2 |     -14.6 |  <0.001 |
| chlorophyll                                      |     2.54 |       0.2 |        13 |  <0.001 |
| topographic position index (1.5 m)               |    -1.72 |       0.4 |      -4.3 |  <0.001 |
| transformed aspect (1.5 m)                       |     0.45 |       0.1 |       3.4 |  <0.001 |
| slope (1.5 m)                                    |    -4.95 |       1.7 |      -2.9 |   0.004 |
| topographic position index (61 m)                |    -0.18 |         0 |      -5.7 |  <0.001 |
| transformed aspect (61 m)                        |    -0.11 |       0.1 |      -0.9 |    0.38 |
| slope (61 m)                                     |    -6.06 |       4.1 |      -1.5 |    0.14 |
| elev                                             |      1.4 |       0.5 |       2.6 |    0.01 |

#+end_example

*** COMMENT make table
#+begin_src R :exports none
        tidy(m_nogenus) %>% 
            data.frame %>% 
            mutate(estimate = round(estimate, 2),
                 std.error = round(std.error, 1),
                 statistic = round(statistic, 1),
               p.value = round(p.value, 3)) %>%
  toOrg
#+end_src

#+RESULTS:
#+begin_example

| term                        | estimate | std.error | statistic | p.value |
|-----------------------------+----------+-----------+-----------+---------|
| st_poneighborhood           |    77.51 |       6.1 |      12.6 |       0 |
| st_post no util             |     66.5 |       6.1 |        11 |       0 |
| st_post w util              |    66.82 |       6.1 |      10.9 |       0 |
| cor_max2005                 |   -12.21 |       1.4 |      -8.6 |       0 |
| height2005_2                |     0.82 |       0.1 |       6.5 |       0 |
| height2005_3                |    -0.03 |         0 |      -5.7 |       0 |
| height2005_4                |        0 |         0 |       5.1 |       0 |
| mean_height_wn20m           |     0.85 |       0.1 |      13.6 |       0 |
| pct_imp_20m                 |     1.41 |       1.4 |         1 |   0.307 |
| pct_imp_100m                |     2.16 |       1.4 |       1.5 |   0.122 |
| TotPhen                     |    -2.96 |       0.2 |     -16.8 |       0 |
| N                           |    -2.92 |       0.2 |     -16.9 |       0 |
| Sugar                       |    -0.17 |       0.2 |      -0.8 |   0.396 |
| LMA                         |    -0.08 |       0.1 |      -0.6 |   0.521 |
| lignin                      |    -3.07 |       0.2 |     -14.6 |       0 |
| chl                         |     2.54 |       0.2 |        13 |       0 |
| tpi_5ft                     |    -1.72 |       0.4 |      -4.3 |       0 |
| aspect_trans_5ft            |     0.45 |       0.1 |       3.4 |   0.001 |
| tpi_200ft                   |    -0.18 |         0 |      -5.7 |       0 |
| aspect_trans_200ft          |    -0.11 |       0.1 |      -0.9 |   0.378 |
| elev                        |      1.4 |       0.5 |       2.6 |   0.008 |
| slope_5ft                   |    -4.95 |       1.7 |      -2.9 |   0.004 |
| slope_200ft                 |    -6.06 |       4.1 |      -1.5 |    0.14 |
| st_post no util:cor_max2005 |     0.37 |       0.1 |         5 |       0 |
| st_post w util:cor_max2005  |     0.31 |       0.1 |       3.2 |   0.001 |
| pct_imp_20m:pct_imp_100m    |   -12.37 |       2.5 |      -4.9 |       0 |
#+end_example

** height in 2005 by street/neighborhood tree interaction
[[file:figs/first_model_predict_height_by_stpo_int.png]]
** impervious surfaces
[[file:figs/impervious_street_neighborhood_ribbon.png]]
** topography

NE versus sw is almost a 1 cm difference in growth rate per year.

topographic position index (TPI), the higher you are relative to your
surroundings the less you grow.  each meter higher than the 8
surrounding 1.5 m pixels decreases height growth by 

[[file:figs/first_model_topo_coef_plots.png]]


** mean height within 20m


I just might not have a figure for this.  There isn't much of an
interaction by genera.

[[file:figs/mean_height_20m_coefs.png]]

** foliar canopy traits

[[file:figs/traits_coef_comparison.png]]


** Marginal Means by Genus

[[file:figs/genus_comparisons_full model.png]]
** Genus by Height predicted growth rates

file:figs/height_genus_int_stpoNeighborhood.png]]

[[file:figs/height_genus_int_stpo_genussub1.png]]


** 



marginal effects of genera from the second model are shown in figure ...




WE likely could have found a model that had a lower AIC by fitting
more interaction terms, but we wanted to keep the model within our
existing hypotheses and explainable.


R^2?

We present below the results for two models.  The first does not have
interactions by genus and so provides a general 

A slightly more complex model which included a fourth order polynomial for
the 2005 height term and an interaction between the impervious cover
terms had an R^2 of .2063 and adjusted R^2 of .2048, showing an
improvement when considering the nonlinear effect of height on growth
and multiscale effect of impervious cover.





We tested for interactions between other covariates and the neighborhood, street, and
utility line term.  The only height and neightborhood, street
poerline.  (street asympototes sooner?)



Genus interactions and no Genus interactions


Results from the simpler model with few interactions are presented to make overall

We




** 



A multiple linear regression with 

nonlinear height effect on growth as expected.  In the linear model we
accounted for this with a 4th order polynomial, since characterising
the the height growth curves is not the targe of this paper.
** growth rate as function of height 2005 
[[file:figs/partial_genus_height2.png]]

** As a function of initial height
- Show graphs, overall, by genera, by other things
- At what height are the growth rates essentially zero?
** Variation by Genera
- Which genera are fast growing, which aren't,
- separate out by tree size and by neighborhood/street.


How do the estimates of the effect of environment and traits on grwoth
vary by genus?  Where are there genera by other factor interactions?
There are many.  Random Forest suggests it happens very common.
** 

* Discussion

** bias
it appears that twig size may be related to the bias curves.
Something that should be explored further.

also how pointy the trees are conical

This potentially large measurement error contri


** growth rate estimates

We treated it with a 4th order polynomial.  A better treatment would
consider a more biologicically realistic nonlinear growth function.

This potentially large measurement error 

cite:song_e_2016 estimated canopy height growth of urban trees in
Osaka, Japan using repeat lidar.  Like our study their later
collections had higher pulse densities (in their case, 52 pulses/m^2
versus 11 pulses/m^2).  The relatively high pulse density across all
their years likely means that the bias in height estimation is small,
but the 

If their early date collections are biased low, it makes growth appear
higher than it would be in the field.  

For example: mean growth from 2008-2010 (when pulse density was 52
pulses / m^2) was 0.02+- .19 m m^{-2} yr^{-1}, and
from 2004-2008 (when pulse density increased from 11 to 52 pulses /
m^2) mean growth was .37 +/- .14 m m^{-2} yr^{-1}.  This has got to be due to
the pulse density bias.

They found that lidar estimattes of growth were much greater than
field estimates, but they didn't consider that it could be due to the
difference in pulse density.

Our work is therefore a contribution to the science.



Estimating canopy height from lidar has a greater bias over smaller
areas (individual trees) compared to larger areas
(stands) citep:song_e_2016,roussel_e_2017.
** Terrain effects

what does the aspect transformation correspond to?



- no slope
- 

* conclusion


* supplementary 

** full model

The full summary of the model with genus included can be found in [[file:full_model_summary.txt]]

#+begin_src R :file full_model_summary.txt :exports none
tidy(m_genus) %>% data.frame %>% toOrg
#+end_src

#+RESULTS:
[[file:full_model_summary.txt]]



** figures
#+name: fig:80randomtreescorrected
#+caption: As in figure [[fig:year_by_height]] but with a random sample of 80 trees.
[[file:figs/correction_nogrowth_80_m_smooth_lm.png]]
* COMMENT papers
https://link.springer.com/article/10.1186/s40663-018-0146-y

file:///home/erker/Downloads/remotesensing-10-00347.pdf


https://www.sciencedirect.com/science/article/pii/S0034425717302316#f0005

https://www.tandfonline.com/doi/abs/10.5589/m06-030

Assessing species-level biases in tree heights
estimated from terrain-optimized leaf-off airborne
laser scanner (ALS) data


** cite:parent_volin_2015

ALS optimized for terrain underestimates tree height.

They did find statistically significant differences between species in
estimating height, but they were small (<2m)

#+BEGIN_QUOTE
Variation in the accuracies of ALS-estimated tree heights are presumably due to
differences in branching architecture among species – laser pulses may pass more easily
through leaf-off canopies with lower branch densities. Compound-leaf species tend to
have lower branch densities (i.e. twigs/leaf area; twig mass/leaf area) than simple-leaf
species (Yang, Li, and Sun 2009; White 1983) and, thus, may be expected to have greater
bias in ALS-based heights. This expectation was supported by Wasser et al. (2013) who
found that plot average height biases were greater for compound-leaf plots, dominated by
black walnut (Juglans nigra), green ash (Fraxinus pennsylvanica), and honey locust
(Gleditsia triacanthos), than for simple-leaf plots dominated by red maple, black cherry,
and red oak. However, for tree height estimates, our data did not find greater bias for
compound-leaf species (i.e. white ash, hickories, honey locust) as a whole and we found
considerable overlap between compound-, simple-, and needle-leaf species. These results
suggest that branching density may not be a separable characteristic between compound-
and simple-leaf species – the majority of species in our study were not included in Yang,
Li, and Sun (2009) and White (1983). Another possible interpretation is that ALS-based
tree height estimates are not particularly sensitive to species-specific variations in branch
density given the resolution of our data. Although significant, the differences we found
among the species we studied were relatively small (bias < 2 m). With higher resolution
ALS data, Brandtberg et al. (2003) found no significant differences in ALS tree height
biases among oaks, maple, and yellow poplar (Liriodendron tulipifera). With moderate
resolution ALS data, Ørka, Næsset, and Bollandsås (2010) did find species to be a
significant co-predictor of tree height but it had a negligible effect on the model
performance.

#+END_QUOTE

** lidar and tree growth


*** cite:choi_e_2019

**** abstract
#+BEGIN_QUOTE
Understanding forest dynamics is important for assessing the health of
urban forests, which experience various disturbances, both natural
(e.g., treefall events) and artificial (e.g., making space for
agricultural fields). Therefore, quantifying three-dimensional changes
in canopies is a helpful way to manage and understand urban forests
better. Multitemporal airborne light detection and ranging (LiDAR)
datasets enable us to quantify the vertical and lateral growth of
trees across a landscape scale. The goal of this study is to assess
the annual changes in the 3-D structures of canopies and forest gaps
in an urban forest using annual airborne LiDAR datasets for
2012–2015. The canopies were classified as high canopies and low
canopies by a 5 m height threshold. Then, we generated pixel- and
plot-level canopy height models and conducted change detection
annually. The vertical growth rates and leaf area index showed
consistent values year by year in both canopies, while the spatial
distributions of the canopy and leaf area profile (e.g., leaf area
density) showed inconsistent changes each year in both canopies. In
total, high canopies expanded their foliage from 12 m height, while
forest gap edge canopies (including low canopies) expanded their
canopies from 5 m height. Annual change detection with LiDAR datasets
might inform about both steady growth rates and different
characteristics in the changes of vertical canopy structures for both
high and low canopies in urban forests.
#+END_QUOTE

**** notes

point density > 8 /m^2

leaf on

small spatial extent

4 years of data (2012-2015)

lidar is more or less consistent from year to year.

their annual growth rates in "high canopy" areas is around .3 m/year.

I'm having a hard time with their figures and tables, they are a bit
out of wack.

*** cite:ossola_hopton_2018

https://www.sciencedirect.com/science/article/pii/S0048969717321010#f1010

**** abstract
#+BEGIN_QUOTE
The spatial arrangement of urban vegetation depends on urban
morphology and socio-economic settings. Urban vegetation changes over
time because of human management. Urban trees are removed due to
hazard prevention or aesthetic preferences. Previous research
attributed tree loss to decreases in canopy cover. However, this
provides little information about location and structural
characteristics of trees lost, as well as environmental and social
factors affecting tree loss dynamics. This is particularly relevant in
residential landscapes where access to residential parcels for field
surveys is limited. We tested whether multi-temporal airborne LiDAR
and multi-spectral imagery collected at a 5-year interval can be used
to investigate urban tree loss dynamics across residential landscapes
in Denver, CO and Milwaukee, WI, covering 400,705 residential parcels
in 444 census tracts. Position and stem height of trees lost were
extracted from canopy height models calculated as the difference
between final (year 5) and initial (year 0) vegetation height derived
from LiDAR. Multivariate regression models were used to predict number
and height of tree stems lost in residential parcels in each census
tract based on urban morphological and socio-economic variables. A
total of 28,427 stems were lost from residential parcels in Denver and
Milwaukee over 5 years. Overall, 7% of residential parcels lost one
stem, averaging 90.87 stems per km2. Average stem height was 10.16 m,
though trees lost in Denver were taller compared to Milwaukee. The
number of stems lost was higher in neighborhoods with higher canopy
cover and developed before the 1970s. However, socio-economic
characteristics had little effect on tree loss dynamics. The study
provides a simple method for measuring urban tree loss dynamics within
and across entire cities, and represents a further step toward high
resolution assessments of the three-dimensional change of urban
vegetation at large spatial scales.
#+END_QUOTE

**** notes
2010 and 2015 lidar in MKE, 2008 and 2013 lidar in denver

all years have the same nominal spacing (.7 points per m)

they had no need to do a correction for their chm

they did what i was thinking of and created 2 chms then found their
difference. 

they didn't worry about lidar underestimating height.  While the point
densities are on average the same across years, there is variability
across years which could be importnat (though not for their analysis
really I don't think since their target was mostly stems).


#+BEGIN_QUOTE
A total of 13,427 and 15,000 tree stems (height > 5 m) were lost in
the 5-year period from residential parcels in Denver (2008–2013) and
Milwaukee (2010–2015), respectively. On a per area basis, this
corresponds to an average of 99.33 ± 3.49 (Denver) and 82.41 ± 2.14
(Milwaukee) tree stems per km2 of residential area. The tallest stems
lost in Denver and Milwaukee were 28.04 and 23.82 m high,
respectively. Tree stems lost in Denver were taller on average (11.42
± 0.03 m) compared to those lost in Milwaukee (8.95 ± 0.02 m)
(Fig. 3).
#+END_QUOTE

*** cite:song_e_2016
https://www.sciencedirect.com/science/article/pii/S1618866716000273#fig0010

**** abstract
#+BEGIN_QUOTE
Inter-annual canopy growth is one of the key indicators for assessing
forest conditions, but the measurements require laborious field
surveys. Up-to-date LiDAR remote sensing provides sufficient
three-dimensional morphological information of the ground to monitor
canopy heights on a broad scale. Thus, we attempted to use
multi-temporal airborne LiDAR datasets in the estimation of vertical
canopy growth, across various types of broad-leaved trees in a large
urban park.

The growth of broad-leaved canopies in the EXPO '70 urban forest in
Osaka, Japan was assessed with 19 plots at the stand level and 39
selected trees at the individual-tree level. Airborne LiDAR campaigns
repeatedly observed the park in the summers of 2004, 2008,
and 2010. We acquired canopy height models (CHMs) for each year from
the height values of the uppermost laser returns at every 0.5 m
grid. The annual canopy growth was calculated by the differences in
CHMs and validated with the annual changes in field-measured basal
areas and tree heights.


LiDAR estimations revealed that the average annual canopy growth from
2004 to 2010 was 0.26 ± 0.11 m m−2 yr−1 at the plot level and 0.26 ±
0.10 m m−2 yr−1 at the individual-tree level. This result showed that
growing trends were consistent at different scales through 2004 to
2010 despite uncertainty in estimating short-term growth for small
crown areas at the individual-tree level. This LiDAR-estimated canopy
growth shows a moderate relation to field-measured increase of basal
areas and average heights. The estimation uncertainties seem to result
from the complex canopy structure and irregular crown shape of
broad-leaved trees. Challenges still remain on how to incorporate the
growth of understory trees, growth in the lateral direction, and gap
dynamics inside the canopy, particularly in applying multi-temporal
LiDAR datasets to the large-scale growth assessment.
#+END_QUOTE

**** notes  
- small geographic area in osaka
  - assess 39 trees and 19 plots
- 3 years of lidar 2004 2008 2010
- validated growth with ground measurements at plot and individual
  tree level.
- trees grow .26 m / year
  - This is high, could it be due to underestimating height in early years?
- great table with previous studies looking at canopy growth.
  - none of the studies in the table, except the study itself were urban.
- note the uncertainties in estimateing height from lidar, but don't
  correct for it.

- in 2004 lidar had 11 pulses /m^2, in 2008 and 2010 it was 52.  So
  there would definitely be a greater bias in 2004, which they didn't
  correct for.  BUt it might be insignificant since their point cloud
  density was so high.

- they note the bias is greater for individual trees than plots,
  because the area is smaller.

- their table 7 doesn't show the 2004-2008 combination.  ugh.
  - "At the scale of individual trees, the growth trend was not clear for every period"
  - field measures didn't agree with lidar measures over every period
    for individual trees.

- they saw trees always measure taller in 2008 than 2004.  This is
  more evidence that there is a bias in the lidar.

- field measured growth: is much lower than they found:
#+BEGIN_QUOTE
Field-measured
heights of plants since 1972 in the selected long-term monitoring
plots show the decrease in the annual growing trends, aver-
aging from 0.24 m yr −1 during 1972–1982 to 0.10 m yr −1 during
1995–2004.
#+END_QUOTE

but instead of recognizing the potneital bias, they think that it's
because that's for all trees not the top of canopy trees.

**** papers that cite song: https://scholar.google.com/scholar?cites=14673389929199120395&as_sdt=5,50&sciodt=0,50&hl=en
*** cite:roussel_e_2017 
*** https://www.researchgate.net/profile/Qin_Ma2/publication/317349956_Quantifying_individual_tree_growth_and_tree_competition_using_bi-temporal_airborne_laser_scanning_data_a_case_study_in_the_Sierra_Nevada_Mountains_California/links/59ed1e510f7e9bfdeb71accf/Quantifying-individual-tree-growth-and-tree-competition-using-bi-temporal-airborne-laser-scanning-data-a-case-study-in-the-Sierra-Nevada-Mountains-California.pdf

an example of repeat lidar, but in sierra mountains.  they cite
cite:song_e_2016.  But not urban

Quantifying individual tree growth and tree competition using
bi-temporal airborne laser scanning data: a case study in the Sierra
Nevada Mountains, California
Qin Ma a
, Yanjun Su a
, Shengli Taob,c and Qinghua Guo a,b
*** cite:marinelli_e_2019
**** abstract
#+BEGIN_QUOTE
Abstract—The repetitive acquisition of airborne Light Detection and Ranging (LiDAR) data for forest surveys is rapidly
increasing, thus making possible the forest dynamic analysis.
Moreover, the availability of multitemporal data enables the
possibility to improve the forest attribute estimates performed at
single date, especially when one LiDAR acquisition has a lower
pulse density with respect to the other. This letter presents a
novel approach that exploits the bi-temporal data information
to: (i) improve the tree detection at both dates, and (ii) identify
forest changes at single tree level. This is done by using a novel
compound approach to the detection of trees in bi-temporal data
based on the Bayes rule for minimum error. Significant geometric
features are extracted for each candidate tree-top and are used to
estimate statistical terms employed in the compound approach.
The multitemporal information is considered by estimating (in an
iterative way) the probabilities of transition, which take into account the temporal dependence between the LiDAR acquisitions.
The proposed approach is evaluated on multitemporal LiDAR
data acquired in a coniferous forest located in the Southern
Italian Alps. Experimental results confirm the effectiveness of
the compound detection that increases the overall accuracy (OA)
up to 8.6% with respect to the single-date detection.
#+END_QUOTE
**** notes
They note the issue with multi temporal lidar is that the pulse
density increases in time and needs to be dealt with


#+BEGIN_QUOTE
years medium (e.g., 10 pulses/m2
) and high pulse density
(≥ 20 pulses/m2
) data are typically acquired, older data may
be characterized by low pulse densities (≤ 5 pulses/m2
),
which prevent such refined multitemporal analysis. At plot
scale, different pulse densities do not heavily impact on the
estimation of forest attributes [4]. In contrast, at tree level
low pulse density acquisitions strongly affect forest dynamic
parameters estimation
#+END_QUOTE

But I don't think they corrected for the height bias.

*** cite:paris_bruzzone_2015
*** cite:zhao_e_2018
** Multi-scale analysis of relationship between imperviousness and urban tree height using airborne remote sensing

found imperviousness wasn't related to tree height at local scale, but
was at large scale.
** remote sensing is important for urban forest carbon life cycle assessments.
https://link.springer.com/article/10.1186/s13021-017-0085-x
** aspect transformation
https://academic.oup.com/jof/article-abstract/64/10/691/4672693?redirectedFrom=fulltext
** cite:reich_2012 Reich, P. B. Key canopy traits drive forest productivity. Proc Roy Soc B-Biol Sci 279, 2128-2134 (2012).
